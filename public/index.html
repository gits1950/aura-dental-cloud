<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>Aura Dental Care - Clinic Management</title>

<!-- Basic Meta Tags -->
<meta name="theme-color" content="#667eea">
<meta name="description" content="Complete dental clinic management system for Aura Dental Care, Raipur">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Aura Dental">
<link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' viewBox='0 0 192 192'%3E%3Cdefs%3E%3ClinearGradient id='grad1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='192' height='192' fill='url(%23grad1)' rx='20'/%3E%3Cpath d='M96 40 C80 40 68 52 68 68 L68 124 C68 140 80 152 96 152 C112 152 124 140 124 124 L124 68 C124 52 112 40 96 40 Z' fill='white'/%3E%3Ctext x='96' y='175' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-size='16' font-weight='bold'%3EAURA%3C/text%3E%3C/svg%3E">
  <link rel="icon" type="image/svg+xml" sizes="512x512" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='grad2' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' fill='url(%23grad2)' rx='50'/%3E%3Cpath d='M256 100 C220 100 190 130 190 190 L190 322 C190 382 220 412 256 412 C292 412 322 382 322 322 L322 190 C322 130 292 100 256 100 Z' fill='white'/%3E%3Ctext x='256' y='460' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-size='42' font-weight='bold'%3EAURA%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' viewBox='0 0 192 192'%3E%3Cdefs%3E%3ClinearGradient id='grad1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='192' height='192' fill='url(%23grad1)' rx='20'/%3E%3Cpath d='M96 40 C80 40 68 52 68 68 L68 124 C68 140 80 152 96 152 C112 152 124 140 124 124 L124 68 C124 52 112 40 96 40 Z' fill='white'/%3E%3Ctext x='96' y='175' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-size='16' font-weight='bold'%3EAURA%3C/text%3E%3C/svg%3E">
  
  
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<!-- External Libraries for Enhanced Features -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR FEATURE - Complete Implementation
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderCalendar() {
  if (typeof state === 'undefined' || !state.currentUser) return;
  const role = state.currentUser.role;
  
  // Initialize calendar state if not exists
  if (!state.calendar) {
    const now = new Date();
    state.calendar = {
      currentMonth: now.getMonth(),
      currentYear: now.getFullYear(),
      selectedDoctor: 'all'
    };
  }
  
  const { currentMonth, currentYear, selectedDoctor } = state.calendar;
  
  // Get calendar data
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const today = new Date();
  const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
  const todayDate = today.getDate();
  
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
  
  // Get appointments for this month
  let appointments = (state.appointments && Array.isArray(state.appointments)) ? state.appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
  }) : [];
  
  // Filter by doctor if selected
  if (selectedDoctor !== 'all') {
    appointments = appointments.filter(function(apt) {
      return apt.doctorId === parseInt(selectedDoctor);
    });
  }
  
  // Separate today's and upcoming appointments
  const todaysApts = appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate.toDateString() === today.toDateString();
  });
  
  const upcomingApts = appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate > today && aptDate.toDateString() !== today.toDateString();
  }).sort(function(a, b) {
    return new Date(a.date) - new Date(b.date);
  });
  
  const html = '<div class="app-layout">' +
    renderSidebar('#calendar') +
    '<div class="main-wrapper">' +
    '<div class="top-bar">' +
    mobileMenuButton() +
    '<h1 class="page-title">üìÖ Appointment Calendar</h1>' +
    '<div class="user-profile">' +
    '<div class="user-avatar">' + state.currentUser.name.charAt(0) + '</div>' +
    '<div class="user-name">' + state.currentUser.name + '</div>' +
    '</div></div>' +
    '<div class="content-area">' +
    
    // Calendar Controls
    '<div class="card">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px;">' +
    
    // Month/Year Navigation
    '<div style="display:flex;align-items:center;gap:10px;">' +
    '<button onclick="changeMonth(-1)" style="padding:10px 15px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;">‚óÄ</button>' +
    '<h2 style="margin:0;font-size:24px;font-weight:700;min-width:200px;text-align:center;">' +
    monthNames[currentMonth] + ' ' + currentYear +
    '</h2>' +
    '<button onclick="changeMonth(1)" style="padding:10px 15px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;">‚ñ∂</button>' +
    '<button onclick="goToToday()" style="padding:10px 20px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin-left:10px;">Today</button>' +
    '</div>' +
    
    // Doctor Filter
    '<div style="display:flex;align-items:center;gap:10px;">' +
    '<label style="font-weight:600;">Filter by Doctor:</label>' +
    '<select onchange="filterByDoctor(this.value)" style="padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;">' +
    '<option value="all"' + (selectedDoctor === 'all' ? ' selected' : '') + '>All Doctors</option>' +
    state.doctors.map(function(d) {
      return '<option value="' + d.id + '"' + (selectedDoctor === d.id ? ' selected' : '') + '>' + d.name + '</option>';
    }).join('') +
    '</select>' +
    '</div>' +
    
    '</div>' +
    // Calendar Grid
    '<div style="background:#f8fafc;border-radius:12px;padding:20px;">' +
    
    // Day Headers
    '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:10px;">' +
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(function(day, i) {
      return '<div style="text-align:center;font-weight:700;font-size:14px;padding:10px;color:' + (i === 0 ? '#ef4444' : '#64748b') + ';">' + day + '</div>';
    }).join('') +
    '</div>' +
    // Calendar Days
    '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;">' +
    (function() {
      let days = '';
      
      // Empty cells before first day
      for (let i = 0; i < firstDay; i++) {
        days += '<div style="padding:40px 10px;"></div>';
      }
      
      // Days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dayOfWeek = date.getDay();
        const isSunday = dayOfWeek === 0;
        const isToday = isCurrentMonth && day === todayDate;
        const isPast = date < today && !isToday;
        const dateStr = currentYear + '-' + String(currentMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        
        // Count appointments for this date
        const dayApts = appointments.filter(function(apt) {
          return apt.date === dateStr;
        });
        
        const bgColor = isToday ? '#ef4444' : (isSunday ? '#fee2e2' : (isPast ? '#f1f5f9' : 'white'));
        const textColor = isToday ? 'white' : (isPast ? '#94a3b8' : (isSunday ? '#dc2626' : '#1e293b'));
        const cursor = isPast ? 'not-allowed' : 'pointer';
        const onClick = isPast ? '' : `onclick="openRegistrationForDate('${dateStr}')"`;
        
        days += '<div ' + onClick + ' style="' +
          'background:' + bgColor + ';' +
          'color:' + textColor + ';' +
          'padding:10px;' +
          'border-radius:8px;' +
          'text-align:center;' +
          'cursor:' + cursor + ';' +
          'border:2px solid ' + (isToday ? '#dc2626' : (dayApts.length > 0 ? '#3b82f6' : '#e2e8f0')) + ';' +
          'transition:all 0.2s;' +
          'min-height:80px;' +
          'display:flex;' +
          'flex-direction:column;' +
          'justify-content:space-between;' +
          (isPast ? 'opacity:0.5;' : '') +
          '"' +
          (isPast ? '' : ' onmouseover="this.style.transform=\'scale(1.05)\'" onmouseout="this.style.transform=\'scale(1)\'"') +
          '>' +
          '<div style="font-size:18px;font-weight:700;">' + day + '</div>' +
          (dayApts.length > 0 ? '<div style="font-size:11px;background:' + (isToday ? 'rgba(255,255,255,0.3)' : '#3b82f6') + ';color:' + (isToday ? 'white' : 'white') + ';padding:3px 6px;border-radius:4px;margin-top:5px;">' + dayApts.length + ' apt' + (dayApts.length > 1 ? 's' : '') + '</div>' : '') +
          '</div>';
      }
      
      return days;
    })() +
    '</div>' +
    '</div>' +
    '</div>' +
    
    // Today's Appointments
    '<div class="card" style="margin-top:20px;border-top:4px solid #10b981;">' +
    '<h3 style="margin:0 0 15px 0;font-size:18px;font-weight:700;color:#065f46;">üìå Today\'s Appointments (' + todaysApts.length + ')</h3>' +
    (todaysApts.length === 0 ?
      '<div style="text-align:center;padding:30px;color:#94a3b8;">No appointments today</div>' :
      '<div style="display:grid;gap:10px;">' +
      todaysApts.map(function(apt) {
        const patient = state.patients.find(function(p) { return p.id === apt.patientId; });
        const doctor = state.doctors.find(function(d) { return d.id === apt.doctorId; });
        return '<div style="padding:12px;background:#f0fdf4;border-left:4px solid #10b981;border-radius:8px;">' +
          '<div style="font-weight:600;color:#065f46;">' + (patient ? patient.name : 'Unknown') + '</div>' +
          '<div style="font-size:13px;color:#64748b;margin-top:4px;">' +
          'Doctor: ' + (doctor ? doctor.name : 'N/A') + ' | Time: ' + (apt.time || 'Not set') +
          '</div>' +
          '</div>';
      }).join('') +
      '</div>') +
    '</div>' +
    
    // Upcoming Appointments
    '<div class="card" style="margin-top:20px;border-top:4px solid #3b82f6;">' +
    '<h3 style="margin:0 0 15px 0;font-size:18px;font-weight:700;color:#1e40af;">üìÖ Upcoming Appointments (' + upcomingApts.length + ')</h3>' +
    (upcomingApts.length === 0 ?
      '<div style="text-align:center;padding:30px;color:#94a3b8;">No upcoming appointments this month</div>' :
      '<div style="display:grid;gap:10px;">' +
      upcomingApts.slice(0, 10).map(function(apt) {
        const patient = state.patients.find(function(p) { return p.id === apt.patientId; });
        const doctor = state.doctors.find(function(d) { return d.id === apt.doctorId; });
        const aptDate = new Date(apt.date);
        return '<div style="padding:12px;background:#eff6ff;border-left:4px solid #3b82f6;border-radius:8px;">' +
          '<div style="font-weight:600;color:#1e40af;">' + (patient ? patient.name : 'Unknown') + '</div>' +
          '<div style="font-size:13px;color:#64748b;margin-top:4px;">' +
          formatIndianDate(apt.date) + ' | Doctor: ' + (doctor ? doctor.name : 'N/A') + ' | Time: ' + (apt.time || 'Not set') +
          '</div>' +
          '</div>';
      }).join('') +
      (upcomingApts.length > 10 ? '<div style="text-align:center;padding:10px;color:#64748b;font-size:14px;">... and ' + (upcomingApts.length - 10) + ' more</div>' : '') +
      '</div>') +
    '</div></div></div>';
  
 document.getElementById("app").innerHTML = html;


// Calendar helper functions
function changeMonth(delta) {
  if (typeof state === 'undefined' || !state.calendar) {
    console.error('State or calendar not available');
    return;
  }
  state.calendar.currentMonth += delta;
  if (state.calendar.currentMonth > 11) {
    state.calendar.currentMonth = 0;
    state.calendar.currentYear++;
  } else if (state.calendar.currentMonth < 0) {
    state.calendar.currentMonth = 11;
    state.calendar.currentYear--;
  }
  renderCalendar();
}

function goToToday() {
  const now = new Date();
  state.calendar.currentMonth = now.getMonth();
  state.calendar.currentYear = now.getFullYear();
  renderCalendar();
}

function filterByDoctor(doctorId) {
  state.calendar.selectedDoctor = doctorId === 'all' ? 'all' : parseInt(doctorId);
  renderCalendar();
}

function openRegistrationForDate(dateStr) {
  // Store selected date
  state.selectedDate = dateStr;
  
  // Navigate to walk-in/registration page
  window.location.hash = '#dashboard';
  
  // Show notification
  showToast('üìÖ Date selected: ' + dateStr + ' - Register patient now');
  
  // Pre-fill date in appointment if possible
  setTimeout(function() {
    const dateInput = document.getElementById('appointment-date');
    if (dateInput) {
      dateInput.value = dateStr;
    }
  }, 100);
}


// Advanced Notification System
function showNotification(message, type, duration) {
  type = type || 'info';
  duration = duration || 3000;
  
  const colors = {
    success: '#10b981',
    error: '#ef4444',
    warning: '#f59e0b',
    info: '#3b82f6'
  };
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  const notification = document.createElement('div');
  notification.innerHTML = icons[type] + ' ' + message;
  notification.style.cssText = 
    'position:fixed;top:80px;right:20px;background:' + colors[type] + ';' +
    'color:white;padding:16px 24px;border-radius:8px;font-weight:600;' +
    'z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.2);' +
    'animation:slideInRight 0.3s ease;max-width:400px;';
  
  document.body.appendChild(notification);
  
  setTimeout(function() {
    notification.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(function() {
      if (notification.parentNode) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, duration);
}

// Notification animations
if (!document.getElementById('notification-styles')) {
  const style = document.createElement('style');
  style.id = 'notification-styles';
  style.textContent = `
    @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
}


// Form Validation Helpers
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function validatePhone(phone) {
  const re = /^[6-9]\d{9}$/;
  return re.test(phone.replace(/\s+/g, ''));
}

function validateRequired(value, fieldName) {
  if (!value || value.trim() === '') {
    showNotification(fieldName + ' is required', 'error');
    return false;
  }
  return true;
}

function formatPhone(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length > 10) value = value.slice(0, 10);
  input.value = value;
}

function formatAge(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length > 3) value = value.slice(0, 3);
  if (parseInt(value) > 150) value = '150';
  input.value = value;
}

// Auto-capitalize name fields
function capitalizeName(input) {
  const words = input.value.split(' ');
  const capitalized = words.map(word => {
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  }).join(' ');
  input.value = capitalized;
}


// Print & Export Utilities

// Export to CSV
function exportToCSV(data, filename) {
  if (!data || data.length === 0) {
    showNotification('No data to export', 'warning');
    return;
  }
  
  const headers = Object.keys(data[0]);
  let csv = headers.join(',') + '\n';
  
  data.forEach(function(row) {
    const values = headers.map(function(header) {
      const val = row[header] || '';
      return '"' + String(val).replace(/"/g, '""') + '"';
    });
    csv += values.join(',') + '\n';
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename + '.csv';
  a.click();
  window.URL.revokeObjectURL(url);
  
  showNotification('Exported ' + data.length + ' records', 'success');
}

// Export patients to CSV
function exportPatients() {
  const data = state.patients.map(function(p) {
    return {
      ID: p.id,
      Name: p.name,
      Age: p.age,
      Gender: p.gender,
      Contact: p.contact,
      Email: p.email,
      'Created Date': formatIndianDate(p.createdAt)
    };
  });
  exportToCSV(data, 'patients_' + new Date().toISOString().split('T')[0]);
}

// Export treatments to CSV
function exportTreatments() {
  const data = state.treatmentPlans.map(function(tp) {
    const patient = state.patients.find(p => p.id === tp.patientId);
    const doctor = state.doctors.find(d => d.id === tp.doctorId);
    return {
      ID: tp.id,
      Patient: patient ? patient.name : 'Unknown',
      Doctor: doctor ? doctor.name : 'Unknown',
      Date: formatIndianDate(tp.visitDate),
      'Chief Complaint': tp.chiefComplaint,
      Status: tp.status,
      'Total Cost': tp.totalCost,
      'Amount Paid': tp.amountPaid
    };
  });
  exportToCSV(data, 'treatments_' + new Date().toISOString().split('T')[0]);
}

// Enhanced print with better formatting
function printWithLogo(title, content) {
  const printWindow = window.open('', '', 'width=800,height=600');
  printWindow.document.write('<html><head><title>' + title + '</title>');
  printWindow.document.write('<style>');
  printWindow.document.write('body { font-family: Arial, sans-serif; padding: 20px; }');
  printWindow.document.write('.header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }');
  printWindow.document.write('.clinic-name { font-size: 28px; font-weight: bold; color: #667eea; }');
  printWindow.document.write('.content { margin-top: 20px; }');
  printWindow.document.write('table { width: 100%; border-collapse: collapse; margin-top: 20px; }');
  printWindow.document.write('th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }');
  printWindow.document.write('th { background: #f8fafc; font-weight: bold; }');
  printWindow.document.write('@media print { button { display: none; } }');
  printWindow.document.write('</style></head><body>');
  printWindow.document.write('<div class="header">');
  printWindow.document.write('<div class="clinic-name">ü¶∑ AURA DENTAL CARE</div>');
  printWindow.document.write('<div>' + title + '</div>');
  printWindow.document.write('</div>');
  printWindow.document.write('<div class="content">');
  printWindow.document.write(content);
  printWindow.document.write('</div>');
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.print();
}


// Advanced Search Functionality

// Search patients by multiple criteria
function searchPatients(query) {
  if (!query || query.trim() === '') {
    return state.patients;
  }
  
  query = query.toLowerCase().trim();
  
  return state.patients.filter(function(p) {
    return (
      (p.name && p.name.toLowerCase().includes(query)) ||
      (p.contact && p.contact.includes(query)) ||
      (p.email && p.email.toLowerCase().includes(query)) ||
      (p.id && p.id.toString() === query)
    );
  });
}

// Search treatments
function searchTreatments(query) {
  if (!query || query.trim() === '') {
    return state.treatmentPlans;
  }
  
  query = query.toLowerCase().trim();
  
  return state.treatmentPlans.filter(function(tp) {
    const patient = state.patients.find(p => p.id === tp.patientId);
    const patientName = patient ? patient.name.toLowerCase() : '';
    
    return (
      (tp.chiefComplaint && tp.chiefComplaint.toLowerCase().includes(query)) ||
      (tp.diagnosis && tp.diagnosis.toLowerCase().includes(query)) ||
      patientName.includes(query) ||
      (tp.id && tp.id.toString() === query)
    );
  });
}

// Global search across all entities
function globalSearch(query) {
  if (!query || query.trim() === '') {
    return { patients: [], treatments: [], appointments: [] };
  }
  
  return {
    patients: searchPatients(query).slice(0, 5),
    treatments: searchTreatments(query).slice(0, 5),
    appointments: []
  };
}

// Debounce function for search
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = function() {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}


// Keyboard Shortcuts
document.addEventListener('keydown', function(e) {
  // Alt + shortcuts
  if (e.altKey) {
    switch(e.key) {
      case 'h': // Alt+H: Home/Dashboard
        e.preventDefault();
        window.location.hash = state.currentUser.role === 'doctor' ? '#doctors-section' : '#walkin';
        break;
      case 'p': // Alt+P: Patients
        e.preventDefault();
        window.location.hash = '#patients';
        break;
      case 'c': // Alt+C: Calendar
        e.preventDefault();
        window.location.hash = '#calendar';
        break;
      case 's': // Alt+S: Settings
        e.preventDefault();
        window.location.hash = '#settings';
        break;
      case 'l': // Alt+L: Logout
        e.preventDefault();
        if (confirm('Are you sure you want to logout?')) {
          logout();
        }
        break;
    }
  }
  
  // Escape key: Close modals
  if (e.key === 'Escape') {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
      modal.style.display = 'none';
    });
  }
});

// Show keyboard shortcuts help
function showKeyboardShortcuts() {
  const shortcuts = [
    { keys: 'Alt + H', action: 'Go to Home/Dashboard' },
    { keys: 'Alt + P', action: 'Go to Patients' },
    { keys: 'Alt + C', action: 'Go to Calendar' },
    { keys: 'Alt + S', action: 'Go to Settings' },
    { keys: 'Alt + L', action: 'Logout' },
    { keys: 'Esc', action: 'Close modals' }
  ];
  
  let html = '<div style="padding:20px;">';
  html += '<h2 style="margin-top:0;">‚å®Ô∏è Keyboard Shortcuts</h2>';
  html += '<table style="width:100%;"><tr><th>Keys</th><th>Action</th></tr>';
  shortcuts.forEach(function(s) {
    html += '<tr><td><code style="background:#f1f5f9;padding:4px 8px;border-radius:4px;">' + 
            s.keys + '</code></td><td>' + s.action + '</td></tr>';
  });
  html += '</table></div>';
  
  showModal('Keyboard Shortcuts', html);
}


// Loading Indicators & UI Feedback

// Show loading overlay
function showLoading(message) {
  message = message || 'Loading...';
  
  let loader = document.getElementById('global-loader');
  if (!loader) {
    loader = document.createElement('div');
    loader.id = 'global-loader';
    loader.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    `;
    
    loader.innerHTML = `
      <div style="background: white; padding: 30px 50px; border-radius: 12px; text-align: center;">
        <div class="spinner" style="margin: 0 auto 15px; width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <div style="font-size: 16px; font-weight: 600; color: #1e293b;">${message}</div>
      </div>
    `;
    
    document.body.appendChild(loader);
    
    // Add spinner animation if not exists
    if (!document.getElementById('spinner-animation')) {
      const style = document.createElement('style');
      style.id = 'spinner-animation';
      style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
      document.head.appendChild(style);
    }
  }
  
  loader.style.display = 'flex';
}

// Hide loading overlay
function hideLoading() {
  const loader = document.getElementById('global-loader');
  if (loader) {
    loader.style.display = 'none';
  }
}

// Progress bar for operations
function showProgress(percent, message) {
  let progress = document.getElementById('global-progress');
  if (!progress) {
    progress = document.createElement('div');
    progress.id = 'global-progress';
    progress.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 99998;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
    `;
    
    progress.innerHTML = `
      <div id="progress-message" style="font-size: 14px; margin-bottom: 8px; color: #64748b;"></div>
      <div style="width: 100%; background: #e2e8f0; border-radius: 10px; overflow: hidden;">
        <div id="progress-bar" style="height: 8px; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease;"></div>
      </div>
    `;
    
    document.body.appendChild(progress);
  }
  
  document.getElementById('progress-message').textContent = message || 'Processing...';
  document.getElementById('progress-bar').style.width = percent + '%';
  progress.style.display = 'block';
  
  if (percent >= 100) {
    setTimeout(function() {
      progress.style.display = 'none';
    }, 500);
  }
}


// Data Backup & Restore System

// Backup all data
function backupAllData() {
  showLoading('Creating backup...');
  
  try {
    const backup = {
      version: '2.0',
      timestamp: new Date().toISOString(),
      data: {
        patients: state.patients,
        doctors: state.doctors,
        treatments: state.treatments,
        medicines: state.medicines,
        treatmentPlans: state.treatmentPlans,
        doctorQueue: state.doctorQueue,
        chairs: state.chairs,
        appointments: state.appointments || [],
        bills: state.bills || [],
        treatmentMappings: state.treatmentMappings || {}
      }
    };
    
    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'aura-dental-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    
    URL.revokeObjectURL(url);
    hideLoading();
    showNotification('‚úÖ Backup created successfully!', 'success');
    
  } catch (error) {
    hideLoading();
    showNotification('‚ùå Backup failed: ' + error.message, 'error');
  }
}

// Restore from backup
function restoreFromBackup() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    showLoading('Restoring backup...');
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const backup = JSON.parse(event.target.result);
        
        if (!backup.version || !backup.data) {
          throw new Error('Invalid backup file');
        }
        
        // Restore data
        state.patients = backup.data.patients || [];
        state.doctors = backup.data.doctors || [];
        state.treatments = backup.data.treatments || [];
        state.medicines = backup.data.medicines || [];
        state.treatmentPlans = backup.data.treatmentPlans || [];
        state.doctorQueue = backup.data.doctorQueue || [];
        state.chairs = backup.data.chairs || [];
        state.appointments = backup.data.appointments || [];
        state.bills = backup.data.bills || [];
        state.treatmentMappings = backup.data.treatmentMappings || {};
        
        // Save to localStorage
        DataStore.save('patients', state.patients);
        DataStore.save('doctors', state.doctors);
        DataStore.save('treatments', state.treatments);
        DataStore.save('medicines', state.medicines);
        DataStore.save('treatmentPlans', state.treatmentPlans);
        DataStore.save('doctorQueue', state.doctorQueue);
        DataStore.save('chairs', state.chairs);
        DataStore.save('appointments', state.appointments);
        DataStore.save('bills', state.bills);
        DataStore.save('treatmentMappings', state.treatmentMappings);
        
        hideLoading();
        showNotification('‚úÖ Backup restored successfully! Reloading...', 'success');
        
        setTimeout(function() {
          location.reload();
        }, 1500);
        
      } catch (error) {
        hideLoading();
        showNotification('‚ùå Restore failed: ' + error.message, 'error');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}
}

// Auto-backup reminder
function checkAutoBackup() {
  const lastBackup = localStorage.getItem('lastBackupDate');
  const today = new Date().toDateString();
  
  if (lastBackup !== today) {
    const daysSinceBackup = lastBackup ? 
      Math.floor((new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24)) : 999;
    
    if (daysSinceBackup >= 7) {
      showNotification('‚ö†Ô∏è Backup reminder: Last backup was ' + daysSinceBackup + ' days ago', 'warning', 5000);
    }
  }
}

// Mark backup as done
function markBackupDone() {
  localStorage.setItem('lastBackupDate', new Date().toDateString());
}

// Check on load
if (typeof state !== 'undefined' && state.currentUser) {
  setTimeout(checkAutoBackup, 3000);
}


// Performance Optimizations

// Lazy load images
function lazyLoadImages() {
  const images = document.querySelectorAll('img[data-src]');
  const imageObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.removeAttribute('data-src');
        imageObserver.unobserve(img);
      }
    });
  });
  
  images.forEach(function(img) {
    imageObserver.observe(img);
  });
}



// Cleanup old data
function cleanupOldData() {
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
  
  // Clean old treatment plans (keep last year only)
  if (typeof state !== 'undefined' && state.treatmentPlans) {
    const oldCount = state.treatmentPlans.length;
    state.treatmentPlans = state.treatmentPlans.filter(function(tp) {
      return new Date(tp.visitDate) > oneYearAgo;
    });
    const removed = oldCount - state.treatmentPlans.length;
    if (removed > 0) {
      DataStore.save('treatmentPlans', state.treatmentPlans);
      console.log('Cleaned up ' + removed + ' old treatment records');
    }
  }
}

// Auto-cleanup on load (for admin only)
if (typeof state !== 'undefined' && state.currentUser && state.currentUser.role === 'admin') {
  setTimeout(cleanupOldData, 5000);
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>

function renderCalendar() {
  // Check if state and currentUser exist
  if (typeof state === 'undefined' || !state.currentUser) {
    console.error('State or currentUser not available');
    return;
  }
  
  const role = state.currentUser.role;
  
  // Initialize calendar state if not exists
  if (!state.calendar) {
    const now = new Date();
    state.calendar = {
      currentMonth: now.getMonth(),
      currentYear: now.getFullYear(),
      selectedDoctor: 'all'
    };
  }
  
  const { currentMonth, currentYear, selectedDoctor } = state.calendar;
  
  // Get calendar data
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const today = new Date();
  const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
  const todayDate = today.getDate();
  
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
  
  // Get appointments for this month
  let appointments = state.appointments ? state.appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
  }) : [];
  
  // Filter by doctor if selected
  if (selectedDoctor !== 'all') {
    appointments = appointments.filter(function(apt) {
      return apt.doctorId === parseInt(selectedDoctor);
    });
  }
  
  // Separate today's and upcoming appointments
  const todaysApts = appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate.toDateString() === today.toDateString();
  });
  
  const upcomingApts = appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate > today && aptDate.toDateString() !== today.toDateString();
  }).sort(function(a, b) {
    return new Date(a.date) - new Date(b.date);
  });
  
  const html = '<div class="app-layout">' +
    renderSidebar('#calendar') +
    '<div class="main-wrapper">' +
    '<div class="top-bar">' +
    mobileMenuButton() +
    '<h1 class="page-title">üìÖ Appointment Calendar</h1>' +
    '<div class="user-profile">' +
    '<div class="user-avatar">' + state.currentUser.name.charAt(0) + '</div>' +
    '<div class="user-name">' + state.currentUser.name + '</div>' +
    '</div></div>' +
    '<div class="content-area">' +
    
    // Calendar Controls
    '<div class="card">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px;">' +
    
    // Month/Year Navigation
    '<div style="display:flex;align-items:center;gap:10px;">' +
    '<button onclick="changeMonth(-1)" style="padding:10px 15px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;">‚óÄ</button>' +
    '<h2 style="margin:0;font-size:24px;font-weight:700;min-width:200px;text-align:center;">' +
    monthNames[currentMonth] + ' ' + currentYear +
    '</h2>' +
    '<button onclick="changeMonth(1)" style="padding:10px 15px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;">‚ñ∂</button>' +
    '<button onclick="goToToday()" style="padding:10px 20px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin-left:10px;">Today</button>' +
    '</div>' +
    
    // Doctor Filter
    '<div style="display:flex;align-items:center;gap:10px;">' +
    '<label style="font-weight:600;">Filter by Doctor:</label>' +
    '<select onchange="filterByDoctor(this.value)" style="padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;">' +
    '<option value="all"' + (selectedDoctor === 'all' ? ' selected' : '') + '>All Doctors</option>' +
    state.doctors.map(function(d) {
      return '<option value="' + d.id + '"' + (selectedDoctor === d.id ? ' selected' : '') + '>' + d.name + '</option>';
    }).join('') +
    '</select>' +
    '</div>' +
    
    '</div>' +
    
    // Calendar Grid
    '<div style="background:#f8fafc;border-radius:12px;padding:20px;">' +
    
    // Day Headers
    '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:10px;">' +
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(function(day, i) {
      return '<div style="text-align:center;font-weight:700;font-size:14px;padding:10px;color:' + (i === 0 ? '#ef4444' : '#64748b') + ';">' + day + '</div>';
    }).join('') +
    '</div>' +
    
    // Calendar Days
    '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;">' +
    (function() {
      let days = '';
      
      // Empty cells before first day
      for (let i = 0; i < firstDay; i++) {
        days += '<div style="padding:40px 10px;"></div>';
      }
      
      // Days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dayOfWeek = date.getDay();
        const isSunday = dayOfWeek === 0;
        const isToday = isCurrentMonth && day === todayDate;
        const isPast = date < today && !isToday;
        const dateStr = currentYear + '-' + String(currentMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        
        // Count appointments for this date
        const dayApts = appointments.filter(function(apt) {
          return apt.date === dateStr;
        });
        
        const bgColor = isToday ? '#ef4444' : (isSunday ? '#fee2e2' : (isPast ? '#f1f5f9' : 'white'));
        const textColor = isToday ? 'white' : (isPast ? '#94a3b8' : (isSunday ? '#dc2626' : '#1e293b'));
        const cursor = isPast ? 'not-allowed' : 'pointer';
        const onClick = isPast ? '' : `onclick="openRegistrationForDate('${dateStr}')"`;
        
        days += '<div ' + onClick + ' style="' +
          'background:' + bgColor + ';' +
          'color:' + textColor + ';' +
          'padding:10px;' +
          'border-radius:8px;' +
          'text-align:center;' +
          'cursor:' + cursor + ';' +
          'border:2px solid ' + (isToday ? '#dc2626' : (dayApts.length > 0 ? '#3b82f6' : '#e2e8f0')) + ';' +
          'transition:all 0.2s;' +
          'min-height:80px;' +
          'display:flex;' +
          'flex-direction:column;' +
          'justify-content:space-between;' +
          (isPast ? 'opacity:0.5;' : '') +
          '"' +
          (isPast ? '' : ' onmouseover="this.style.transform=\'scale(1.05)\'" onmouseout="this.style.transform=\'scale(1)\'"') +
          '>' +
          '<div style="font-size:18px;font-weight:700;">' + day + '</div>' +
          (dayApts.length > 0 ? '<div style="font-size:11px;background:' + (isToday ? 'rgba(255,255,255,0.3)' : '#3b82f6') + ';color:' + (isToday ? 'white' : 'white') + ';padding:3px 6px;border-radius:4px;margin-top:5px;">' + dayApts.length + ' apt' + (dayApts.length > 1 ? 's' : '') + '</div>' : '') +
          '</div>';
      }
      
      return days;
    })() +
    '</div>' +
    '</div>' +
    '</div>' +
    
    // Today's Appointments
    '<div class="card" style="margin-top:20px;border-top:4px solid #10b981;">' +
    '<h3 style="margin:0 0 15px 0;font-size:18px;font-weight:700;color:#065f46;">üìå Today\'s Appointments (' + todaysApts.length + ')</h3>' +
    (todaysApts.length === 0 ?
      '<div style="text-align:center;padding:30px;color:#94a3b8;">No appointments today</div>' :
      '<div style="display:grid;gap:10px;">' +
      todaysApts.map(function(apt) {
        const patient = state.patients.find(function(p) { return p.id === apt.patientId; });
        const doctor = state.doctors.find(function(d) { return d.id === apt.doctorId; });
        return '<div style="padding:12px;background:#f0fdf4;border-left:4px solid #10b981;border-radius:8px;">' +
          '<div style="font-weight:600;color:#065f46;">' + (patient ? patient.name : 'Unknown') + '</div>' +
          '<div style="font-size:13px;color:#64748b;margin-top:4px;">' +
          'Doctor: ' + (doctor ? doctor.name : 'N/A') + ' | Time: ' + (apt.time || 'Not set') +
          '</div>' +
          '</div>';
      }).join('') +
      '</div>') +
    '</div>' +
    
    // Upcoming Appointments
    '<div class="card" style="margin-top:20px;border-top:4px solid #3b82f6;">' +
    '<h3 style="margin:0 0 15px 0;font-size:18px;font-weight:700;color:#1e40af;">üìÖ Upcoming Appointments (' + upcomingApts.length + ')</h3>' +
    (upcomingApts.length === 0 ?
      '<div style="text-align:center;padding:30px;color:#94a3b8;">No upcoming appointments this month</div>' :
      '<div style="display:grid;gap:10px;">' +
      upcomingApts.slice(0, 10).map(function(apt) {
        const patient = state.patients.find(function(p) { return p.id === apt.patientId; });
        const doctor = state.doctors.find(function(d) { return d.id === apt.doctorId; });
        const aptDate = new Date(apt.date);
        return '<div style="padding:12px;background:#eff6ff;border-left:4px solid #3b82f6;border-radius:8px;">' +
          '<div style="font-weight:600;color:#1e40af;">' + (patient ? patient.name : 'Unknown') + '</div>' +
          '<div style="font-size:13px;color:#64748b;margin-top:4px;">' +
          formatIndianDate(apt.date) + ' | Doctor: ' + (doctor ? doctor.name : 'N/A') + ' | Time: ' + (apt.time || 'Not set') +
          '</div>' +
          '</div>';
      }).join('') +
      (upcomingApts.length > 10 ? '<div style="text-align:center;padding:10px;color:#64748b;font-size:14px;">... and ' + (upcomingApts.length - 10) + ' more</div>' : '') +
      '</div>') +
    '</div>' +
    
    '</div></div></div>';
  
  document.getElementById('app').innerHTML = html;
}



function openRegistrationForDate(dateStr) {
  // Store selected date
  state.selectedDate = dateStr;
  
  // Navigate to walk-in/registration page
  window.location.hash = '#dashboard';
  
  // Show notification
  showToast('üìÖ Date selected: ' + dateStr + ' - Register patient now');
  
  // Pre-fill date in appointment if possible
  setTimeout(function() {
    const dateInput = document.getElementById('appointment-date');
    if (dateInput) {
      dateInput.value = dateStr;
    }
  }, 100);
}


// Advanced Notification System
function showNotification(message, type, duration) {
  type = type || 'info';
  duration = duration || 3000;
  
  const colors = {
    success: '#10b981',
    error: '#ef4444',
    warning: '#f59e0b',
    info: '#3b82f6'
  };
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  const notification = document.createElement('div');
  notification.innerHTML = icons[type] + ' ' + message;
  notification.style.cssText = 
    'position:fixed;top:80px;right:20px;background:' + colors[type] + ';' +
    'color:white;padding:16px 24px;border-radius:8px;font-weight:600;' +
    'z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.2);' +
    'animation:slideInRight 0.3s ease;max-width:400px;';
  
  document.body.appendChild(notification);
  
  setTimeout(function() {
    notification.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(function() {
      if (notification.parentNode) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, duration);
}

// Notification animations
if (!document.getElementById('notification-styles')) {
  const style = document.createElement('style');
  style.id = 'notification-styles';
  style.textContent = `
    @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
}


// Form Validation Helpers
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function validatePhone(phone) {
  const re = /^[6-9]\d{9}$/;
  return re.test(phone.replace(/\s+/g, ''));
}

function validateRequired(value, fieldName) {
  if (!value || value.trim() === '') {
    showNotification(fieldName + ' is required', 'error');
    return false;
  }
  return true;
}

function formatPhone(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length > 10) value = value.slice(0, 10);
  input.value = value;
}

function formatAge(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length > 3) value = value.slice(0, 3);
  if (parseInt(value) > 150) value = '150';
  input.value = value;
}

// Auto-capitalize name fields
function capitalizeName(input) {
  const words = input.value.split(' ');
  const capitalized = words.map(word => {
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  }).join(' ');
  input.value = capitalized;
}


// Print & Export Utilities

// Export to CSV
function exportToCSV(data, filename) {
  if (!data || data.length === 0) {
    showNotification('No data to export', 'warning');
    return;
  }
  
  const headers = Object.keys(data[0]);
  let csv = headers.join(',') + '\n';
  
  data.forEach(function(row) {
    const values = headers.map(function(header) {
      const val = row[header] || '';
      return '"' + String(val).replace(/"/g, '""') + '"';
    });
    csv += values.join(',') + '\n';
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename + '.csv';
  a.click();
  window.URL.revokeObjectURL(url);
  
  showNotification('Exported ' + data.length + ' records', 'success');
}

// Export patients to CSV
function exportPatients() {
  const data = state.patients.map(function(p) {
    return {
      ID: p.id,
      Name: p.name,
      Age: p.age,
      Gender: p.gender,
      Contact: p.contact,
      Email: p.email,
      'Created Date': formatIndianDate(p.createdAt)
    };
  });
  exportToCSV(data, 'patients_' + new Date().toISOString().split('T')[0]);
}

// Export treatments to CSV
function exportTreatments() {
  const data = state.treatmentPlans.map(function(tp) {
    const patient = state.patients.find(p => p.id === tp.patientId);
    const doctor = state.doctors.find(d => d.id === tp.doctorId);
    return {
      ID: tp.id,
      Patient: patient ? patient.name : 'Unknown',
      Doctor: doctor ? doctor.name : 'Unknown',
      Date: formatIndianDate(tp.visitDate),
      'Chief Complaint': tp.chiefComplaint,
      Status: tp.status,
      'Total Cost': tp.totalCost,
      'Amount Paid': tp.amountPaid
    };
  });
  exportToCSV(data, 'treatments_' + new Date().toISOString().split('T')[0]);
}

// Enhanced print with better formatting
function printWithLogo(title, content) {
  const printWindow = window.open('', '', 'width=800,height=600');
  printWindow.document.write('<html><head><title>' + title + '</title>');
  printWindow.document.write('<style>');
  printWindow.document.write('body { font-family: Arial, sans-serif; padding: 20px; }');
  printWindow.document.write('.header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }');
  printWindow.document.write('.clinic-name { font-size: 28px; font-weight: bold; color: #667eea; }');
  printWindow.document.write('.content { margin-top: 20px; }');
  printWindow.document.write('table { width: 100%; border-collapse: collapse; margin-top: 20px; }');
  printWindow.document.write('th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }');
  printWindow.document.write('th { background: #f8fafc; font-weight: bold; }');
  printWindow.document.write('@media print { button { display: none; } }');
  printWindow.document.write('</style></head><body>');
  printWindow.document.write('<div class="header">');
  printWindow.document.write('<div class="clinic-name">ü¶∑ AURA DENTAL CARE</div>');
  printWindow.document.write('<div>' + title + '</div>');
  printWindow.document.write('</div>');
  printWindow.document.write('<div class="content">');
  printWindow.document.write(content);
  printWindow.document.write('</div>');
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.print();
}


// Advanced Search Functionality

// Search patients by multiple criteria
function searchPatients(query) {
  if (!query || query.trim() === '') {
    return state.patients;
  }
  
  query = query.toLowerCase().trim();
  
  return state.patients.filter(function(p) {
    return (
      (p.name && p.name.toLowerCase().includes(query)) ||
      (p.contact && p.contact.includes(query)) ||
      (p.email && p.email.toLowerCase().includes(query)) ||
      (p.id && p.id.toString() === query)
    );
  });
}

// Search treatments
function searchTreatments(query) {
  if (!query || query.trim() === '') {
    return state.treatmentPlans;
  }
  
  query = query.toLowerCase().trim();
  
  return state.treatmentPlans.filter(function(tp) {
    const patient = state.patients.find(p => p.id === tp.patientId);
    const patientName = patient ? patient.name.toLowerCase() : '';
    
    return (
      (tp.chiefComplaint && tp.chiefComplaint.toLowerCase().includes(query)) ||
      (tp.diagnosis && tp.diagnosis.toLowerCase().includes(query)) ||
      patientName.includes(query) ||
      (tp.id && tp.id.toString() === query)
    );
  });
}

// Global search across all entities
function globalSearch(query) {
  if (!query || query.trim() === '') {
    return { patients: [], treatments: [], appointments: [] };
  }
  
  return {
    patients: searchPatients(query).slice(0, 5),
    treatments: searchTreatments(query).slice(0, 5),
    appointments: []
  };
}

// Debounce function for search
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = function() {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}


// Keyboard Shortcuts
document.addEventListener('keydown', function(e) {
  // Alt + shortcuts
  if (e.altKey) {
    switch(e.key) {
      case 'h': // Alt+H: Home/Dashboard
        e.preventDefault();
        window.location.hash = state.currentUser.role === 'doctor' ? '#doctors-section' : '#walkin';
        break;
      case 'p': // Alt+P: Patients
        e.preventDefault();
        window.location.hash = '#patients';
        break;
      case 'c': // Alt+C: Calendar
        e.preventDefault();
        window.location.hash = '#calendar';
        break;
      case 's': // Alt+S: Settings
        e.preventDefault();
        window.location.hash = '#settings';
        break;
      case 'l': // Alt+L: Logout
        e.preventDefault();
        if (confirm('Are you sure you want to logout?')) {
          logout();
        }
        break;
    }
  }
  
  // Escape key: Close modals
  if (e.key === 'Escape') {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
      modal.style.display = 'none';
    });
  }
});

// Show keyboard shortcuts help
function showKeyboardShortcuts() {
  const shortcuts = [
    { keys: 'Alt + H', action: 'Go to Home/Dashboard' },
    { keys: 'Alt + P', action: 'Go to Patients' },
    { keys: 'Alt + C', action: 'Go to Calendar' },
    { keys: 'Alt + S', action: 'Go to Settings' },
    { keys: 'Alt + L', action: 'Logout' },
    { keys: 'Esc', action: 'Close modals' }
  ];
  
  let html = '<div style="padding:20px;">';
  html += '<h2 style="margin-top:0;">‚å®Ô∏è Keyboard Shortcuts</h2>';
  html += '<table style="width:100%;"><tr><th>Keys</th><th>Action</th></tr>';
  shortcuts.forEach(function(s) {
    html += '<tr><td><code style="background:#f1f5f9;padding:4px 8px;border-radius:4px;">' + 
            s.keys + '</code></td><td>' + s.action + '</td></tr>';
  });
  html += '</table></div>';
  
  showModal('Keyboard Shortcuts', html);
}


// Loading Indicators & UI Feedback

// Show loading overlay
function showLoading(message) {
  message = message || 'Loading...';
  
  let loader = document.getElementById('global-loader');
  if (!loader) {
    loader = document.createElement('div');
    loader.id = 'global-loader';
    loader.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    `;
    
    loader.innerHTML = `
      <div style="background: white; padding: 30px 50px; border-radius: 12px; text-align: center;">
        <div class="spinner" style="margin: 0 auto 15px; width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <div style="font-size: 16px; font-weight: 600; color: #1e293b;">${message}</div>
      </div>
    `;
    
    document.body.appendChild(loader);
    
    // Add spinner animation if not exists
    if (!document.getElementById('spinner-animation')) {
      const style = document.createElement('style');
      style.id = 'spinner-animation';
      style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
      document.head.appendChild(style);
    }
  }
  
  loader.style.display = 'flex';
}

// Hide loading overlay
function hideLoading() {
  const loader = document.getElementById('global-loader');
  if (loader) {
    loader.style.display = 'none';
  }
}

// Progress bar for operations
function showProgress(percent, message) {
  let progress = document.getElementById('global-progress');
  if (!progress) {
    progress = document.createElement('div');
    progress.id = 'global-progress';
    progress.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 99998;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
    `;
    
    progress.innerHTML = `
      <div id="progress-message" style="font-size: 14px; margin-bottom: 8px; color: #64748b;"></div>
      <div style="width: 100%; background: #e2e8f0; border-radius: 10px; overflow: hidden;">
        <div id="progress-bar" style="height: 8px; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease;"></div>
      </div>
    `;
    
    document.body.appendChild(progress);
  }
  
  document.getElementById('progress-message').textContent = message || 'Processing...';
  document.getElementById('progress-bar').style.width = percent + '%';
  progress.style.display = 'block';
  
  if (percent >= 100) {
    setTimeout(function() {
      progress.style.display = 'none';
    }, 500);
  }
}


// Data Backup & Restore System

// Backup all data
function backupAllData() {
  showLoading('Creating backup...');
  
  try {
    const backup = {
      version: '2.0',
      timestamp: new Date().toISOString(),
      data: {
        patients: state.patients,
        doctors: state.doctors,
        treatments: state.treatments,
        medicines: state.medicines,
        treatmentPlans: state.treatmentPlans,
        doctorQueue: state.doctorQueue,
        chairs: state.chairs,
        appointments: state.appointments || [],
        bills: state.bills || [],
        treatmentMappings: state.treatmentMappings || {}
      }
    };
    
    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'aura-dental-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    
    URL.revokeObjectURL(url);
    hideLoading();
    showNotification('‚úÖ Backup created successfully!', 'success');
    
  } catch (error) {
    hideLoading();
    showNotification('‚ùå Backup failed: ' + error.message, 'error');
  }
}

// Restore from backup
function restoreFromBackup() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    showLoading('Restoring backup...');
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const backup = JSON.parse(event.target.result);
        
        if (!backup.version || !backup.data) {
          throw new Error('Invalid backup file');
        }
        
        // Restore data
        state.patients = backup.data.patients || [];
        state.doctors = backup.data.doctors || [];
        state.treatments = backup.data.treatments || [];
        state.medicines = backup.data.medicines || [];
        state.treatmentPlans = backup.data.treatmentPlans || [];
        state.doctorQueue = backup.data.doctorQueue || [];
        state.chairs = backup.data.chairs || [];
        state.appointments = backup.data.appointments || [];
        state.bills = backup.data.bills || [];
        state.treatmentMappings = backup.data.treatmentMappings || {};
        
        // Save to localStorage
        DataStore.save('patients', state.patients);
        DataStore.save('doctors', state.doctors);
        DataStore.save('treatments', state.treatments);
        DataStore.save('medicines', state.medicines);
        DataStore.save('treatmentPlans', state.treatmentPlans);
        DataStore.save('doctorQueue', state.doctorQueue);
        DataStore.save('chairs', state.chairs);
        DataStore.save('appointments', state.appointments);
        DataStore.save('bills', state.bills);
        DataStore.save('treatmentMappings', state.treatmentMappings);
        
        hideLoading();
        showNotification('‚úÖ Backup restored successfully! Reloading...', 'success');
        
        setTimeout(function() {
          location.reload();
        }, 1500);
        
      } catch (error) {
        hideLoading();
        showNotification('‚ùå Restore failed: ' + error.message, 'error');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

// Auto-backup reminder
function checkAutoBackup() {
  const lastBackup = localStorage.getItem('lastBackupDate');
  const today = new Date().toDateString();
  
  if (lastBackup !== today) {
    const daysSinceBackup = lastBackup ? 
      Math.floor((new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24)) : 999;
    
    if (daysSinceBackup >= 7) {
      showNotification('‚ö†Ô∏è Backup reminder: Last backup was ' + daysSinceBackup + ' days ago', 'warning', 5000);
    }
  }
}

// Mark backup as done
function markBackupDone() {
  localStorage.setItem('lastBackupDate', new Date().toDateString());
}

// Check on load
if (typeof state !== 'undefined' && state.currentUser) {
  setTimeout(checkAutoBackup, 3000);
}


// Performance Optimizations

// Lazy load images
function lazyLoadImages() {
  const images = document.querySelectorAll('img[data-src]');
  const imageObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.removeAttribute('data-src');
        imageObserver.unobserve(img);
      }
    });
  });
  
  images.forEach(function(img) {
    imageObserver.observe(img);
  });
}

</script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --primary: #6366f1;
  --primary-dark: #4f46e5;
  --primary-light: #818cf8;
  --secondary: #ec4899;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --gray-50: #f8fafc;
  --gray-100: #f1f5f9;
  --gray-200: #e2e8f0;
  --gray-300: #cbd5e1;
  --gray-400: #94a3b8;
  --gray-500: #64748b;
  --gray-600: #475569;
  --gray-700: #334155;
  --gray-800: #1e293b;
  --gray-900: #0f172a;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
}

/* ========== LOGIN SCREEN ========== */
.aura-logo {
  width: 100%;
  max-width: 280px;
  height: auto;
  margin: 0 auto 20px auto;
  display: block;
  filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.15));
  animation: logoFloat 3s ease-in-out infinite;
}

@keyframes logoFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

.login-page {
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.login-container { box-sizing: border-box;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  padding: 50px 40px;
  border-radius: 24px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  width: 100%;
  max-width: 440px;
  text-align: center;
  animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.tooth-logo {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  margin-bottom: 24px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.login-title {
  font-size: 48px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
  letter-spacing: -1px;
}

.login-subtitle {
  font-size: 22px;
  color: var(--gray-600);
  font-weight: 500;
  margin-bottom: 40px;
}

.login-heading {
  font-size: 28px;
  color: var(--gray-900);
  font-weight: 700;
  margin-bottom: 30px;
}

.input-group {
  margin-bottom: 20px;
  position: relative;
}

.input-group input,
.input-group select {
  width: 100%;
  padding: 16px 20px 16px 52px;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  font-size: 15px;
  font-weight: 500;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  background: white;
  color: var(--gray-900);
  font-family: 'Inter', sans-serif;
}

.input-group input:focus,
.input-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
  transform: translateY(-1px);
}

.input-icon {
  position: absolute;
  left: 18px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 20px;
  color: var(--gray-400);
  transition: color 0.3s;
}

.input-group input:focus ~ .input-icon,
.input-group select:focus ~ .input-icon {
  color: var(--primary);
}

.login-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  margin-top: 10px;
  box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
}

.login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 25px -5px rgba(99, 102, 241, 0.4);
}

.login-btn:active {
  transform: translateY(0);
}

.forgot-password {
  color: var(--primary);
  text-decoration: none;
  font-size: 14px;
  margin-top: 16px;
  display: inline-block;
  font-weight: 600;
  transition: color 0.3s;
}

.forgot-password:hover {
  color: var(--primary-dark);
}

.login-footer {
  margin-top: 30px;
  color: var(--gray-500);
  font-size: 13px;
  line-height: 1.8;
}

.login-footer p {
  margin-bottom: 6px;
}

.login-footer strong {
  color: var(--gray-700);
  font-weight: 600;
}

/* ========== DASHBOARD LAYOUT ========== */
.app-layout {
  display: flex;
  min-height: 100vh;
  background: var(--gray-50);
}

.sidebar {
  width: 280px;
  background: white;
  border-right: 1px solid var(--gray-200);
  padding: 24px 0;
  position: fixed;
  height: 100vh;
  overflow-y: auto;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}

.sidebar-logo {
  padding: 0 24px 24px 24px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 24px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.sidebar-logo-icon {
  font-size: 32px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}

.sidebar-menu {
  padding: 10px 0;
}

.sidebar-item {
  padding: 14px 24px;
  margin: 4px 12px;
  display: flex;
  align-items: center;
  gap: 14px;
  color: var(--gray-600);
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
  font-size: 15px;
  font-weight: 500;
  border-radius: 12px;
  position: relative;
}

.sidebar-item:hover {
  background: var(--gray-100);
  color: var(--primary);
  transform: translateX(4px);
}

.sidebar-item.active {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  font-weight: 600;
  box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
}

/* Disabled sidebar items */
.sidebar-item.disabled {
  opacity: 0.45;
  cursor: not-allowed;
  background: transparent !important;
  transform: none !important;
}

.sidebar-item.disabled:hover {
  background: transparent !important;
  color: var(--gray-400);
}

/* Tooltip for disabled items */
.sidebar-item.disabled::after {
  content: attr(data-tooltip);
  position: absolute;
  left: 100%;
  top: 50%;
  transform: translateY(-50%);
  margin-left: 12px;
  background: #1e293b;
  color: #fff;
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 6px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
  z-index: 1000;
}

.sidebar-item.disabled:hover::after {
  opacity: 1;
}

.sidebar-item-icon {
  font-size: 20px;
  width: 24px;
  text-align: center;
}

.main-wrapper { margin-left: 250px; min-height: 100vh; background: #f8fafc; }

.top-bar {
  background: white;
  padding: 20px 32px;
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  position: sticky;
  top: 0;
  z-index: 10;
}

.header-logo {
  height: 45px;
  width: auto;
  margin-right: 15px;
}

.header-logo-mobile {
  height: 35px;
  width: auto;
  margin-right: 10px;
}

.doctor-selector {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 18px;
  font-weight: 500;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 16px;
  border-radius: 12px;
  transition: all 0.2s;
  cursor: pointer;
}

.user-profile:hover {
  background: var(--gray-100);
}

.user-avatar {
  width: 42px;
  height: 42px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.user-name {
  font-size: 15px;
  font-weight: 600;
  color: var(--gray-900);
}

.content-area {
  padding: 32px;
  flex: 1;
  background: var(--gray-50);
}

.page-title {
  font-size: 32px;
  font-weight: 800;
  color: var(--gray-900);
  margin-bottom: 28px;
  letter-spacing: -0.5px;
}

.dashboard-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 25px;
}

.card {
  background: white;
  border-radius: 16px;
  padding: 28px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  margin-bottom: 24px;
  border: 1px solid var(--gray-200);
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.card:hover {
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.appointments-table {
  width: 100%;
  border-collapse: collapse;
}

.appointments-table th {
  text-align: left;
  padding: 15px 20px;
  border-bottom: 2px solid var(--gray-200);
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-600);
}

.appointments-table td {
  padding: 18px 20px;
  border-bottom: 1px solid var(--gray-100);
  font-size: 15px;
  color: var(--gray-700);
}

.chair-status-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 25px;
}

.chair-card {
  padding: 15px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
  font-weight: 500;
}

.chair-card.occupied {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
  border: 2px solid rgba(239, 68, 68, 0.2);
}

.chair-card.available {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
  border: 2px solid rgba(16, 185, 129, 0.2);
}

.chair-icon {
  font-size: 24px;
}

.quick-actions {
  margin-bottom: 25px;
}

.action-btn {
  width: 100%;
  padding: 15px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
}

.calendar-widget {
  background: white;
  padding: 20px;
  border-radius: 15px;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  font-size: 18px;
  font-weight: 600;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  text-align: center;
}

.calendar-day-header {
  font-size: 12px;
  color: var(--gray-600);
  padding: 8px 0;
  font-weight: 600;
}

.calendar-day {
  padding: 10px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.calendar-day:hover {
  background: rgba(99, 102, 241, 0.1);
}

.calendar-day.today {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  font-weight: 600;
}

.section-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--gray-900);
  margin-bottom: 20px;
}

.btn-primary {
  padding: 12px 24px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
  margin-bottom: 20px;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-secondary {
  padding: 10px 20px;
  background: var(--gray-600);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-secondary:hover {
  background: var(--gray-700);
  transform: translateY(-2px);
}

.btn-danger {
  padding: 8px 16px;
  background: var(--danger);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-danger:hover {
  background: #dc2626;
  transform: translateY(-2px);
}

.data-table {
  overflow-x: auto;
  border-radius: 12px;
  border: 1px solid var(--gray-200);
}

.data-table table {
  width: 100%;
  border-collapse: collapse;
}

.data-table th {
  text-align: left;
  padding: 16px 20px;
  background: var(--gray-50);
  border-bottom: 1px solid var(--gray-200);
  font-size: 13px;
  font-weight: 700;
  color: var(--gray-600);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.data-table td {
  padding: 16px 20px;
  border-bottom: 1px solid var(--gray-100);
  font-size: 14px;
  color: var(--gray-700);
}

.data-table tr:last-child td {
  border-bottom: none;
}

.data-table tr:hover {
  background: var(--gray-50);
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--gray-700);
  font-size: 14px;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--gray-200);
  border-radius: 10px;
  font-size: 15px;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  font-family: 'Inter', sans-serif;
  background: white;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 28px;
}

.stat-card {
  background: white;
  padding: 24px;
  border-radius: 16px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  border: 1px solid var(--gray-200);
  position: relative;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.stat-label {
  font-size: 13px;
  color: var(--gray-600);
  margin-bottom: 8px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-value {
  font-size: 32px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.6);
  backdrop-filter: blur(4px);
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal.show {
  display: flex;
}

.modal-content {
  background: white;
  padding: 32px;
  border-radius: 20px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.modal-header h2 {
  font-size: 24px;
  font-weight: 800;
  color: var(--gray-900);
}

.close-modal {
  font-size: 32px;
  cursor: pointer;
  color: var(--gray-400);
  background: none;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.close-modal:hover {
  background: var(--gray-100);
  color: var(--gray-700);
}

.badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.3px;
}

.badge-success {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
  border: 1px solid rgba(16, 185, 129, 0.2);
}

.badge-warning {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning);
  border: 1px solid rgba(245, 158, 11, 0.2);
}

.badge-info {
  background: rgba(99, 102, 241, 0.1);
  color: var(--primary);
  border: 1px solid rgba(99, 102, 241, 0.2);
}

.form-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.alert {
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  font-weight: 500;
  border: 2px solid;
}

.alert-success {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
  border-color: rgba(16, 185, 129, 0.3);
}

.alert-error {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
  border-color: rgba(239, 68, 68, 0.3);
}

/* Custom Scrollbar */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: var(--gray-100);
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);
}

/* Responsive */
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
  }
  
  .main-wrapper { margin-left: 250px; min-height: 100vh; background: #f8fafc; }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .aura-logo {
    max-width: 200px;
  }
  
  .header-logo {
    height: 35px;
  }
  
  .top-bar {
    padding: 15px 20px;
  }
  
  .page-title {
    font-size: 18px !important;
  }
}


/* Tooth Chart */
.tooth-container { background: #fffbeb; padding: 24px; border-radius: 16px; border: 2px solid #fbbf24; margin: 20px 0; }
.quadrant-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
.quadrant { text-align: center; }
.quadrant-label { font-size: 12px; font-weight: 700; margin-bottom: 10px; color: #64748b; text-transform: uppercase; }
.tooth-row { display: flex; gap: 6px; justify-content: center; margin-bottom: 6px; }
.tooth { width: 40px; height: 40px; border: 2px solid #f59e0b; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; cursor: pointer; background: white; transition: all 0.2s; color: #f59e0b; }
.tooth:hover { background: #fef3c7; transform: scale(1.05); }
.tooth.selected { background: #f59e0b; color: white; border-color: #d97706; box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3); }

/* Display Screen */
.display-screen { background: #1e293b; color: #cbd5e0; min-height: 600px; border-radius: 20px; padding: 40px; text-align: center; }
.display-title { font-size: 48px; font-weight: 900; color: white; margin-bottom: 20px; }
.token-display { font-size: 120px; font-weight: 900; color: #10b981; margin: 40px 0; text-shadow: 0 0 30px rgba(16, 185, 129, 0.5); }
.chair-status-display { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 40px; }
.status-badge { padding: 16px 24px; border-radius: 12px; font-weight: 700; border: 2px solid; }
.status-available { border-color: var(--success); color: var(--success); background: rgba(16, 185, 129, 0.1); }
.status-occupied { border-color: var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.1); }

/* Billing Receipt */
.receipt { max-width: 800px; margin: 0 auto; padding: 40px; background: white; border: 2px solid var(--gray-300); }
.receipt-header { text-align: center; border-bottom: 3px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px; }
.receipt-title { font-size: 32px; font-weight: 900; color: var(--primary); }
.receipt-section { margin-bottom: 24px; }
.receipt-section h3 { font-size: 16px; font-weight: 700; margin-bottom: 12px; border-bottom: 2px solid var(--gray-200); padding-bottom: 8px; }
.receipt-row { display: flex; justify-content: space-between; padding: 8px 0; }
.receipt-total { font-size: 24px; font-weight: 900; color: var(--success); text-align: right; margin-top: 20px; padding-top: 20px; border-top: 3px solid var(--gray-900); }

/* Medicine Selection Grid */
.medicine-selection-grid { display: grid; gap: 12px; max-height: 400px; overflow-y: auto; padding: 12px; background: var(--gray-50); border-radius: 12px; }
.medicine-selection-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 10px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s; }
.medicine-selection-item.disabled { opacity: 0.5; cursor: not-allowed; background: #f1f5f9; }
.medicine-selection-item.disabled:hover { border-color: var(--gray-200); transform: none; }
.medicine-selection-item:hover { border-color: var(--primary); }
.medicine-selection-item.selected { border-color: var(--success); background: #f0fdf4; }

/* Auto uppercase for all text inputs */
input[type="text"], 
input[type="tel"], 
input[type="email"],
textarea {
  text-transform: uppercase;
}

input[type="text"]::placeholder,
input[type="tel"]::placeholder,
input[type="email"]::placeholder,
textarea::placeholder {
  text-transform: none;
}

/* Form validation styling */
input:invalid, select:invalid, textarea:invalid {
  border-color: #ef4444 !important;
}

input:valid, select:valid, textarea:valid {
  border-color: #10b981 !important;
}

.field-error {
  color: #ef4444;
  font-size: 12px;
  margin-top: 4px;
  display: block;
  font-weight: 600;
}

.success-message {
  background: #d1fae5;
  color: #065f46;
  padding: 16px;
  border-radius: 12px;
  margin: 16px 0;
  font-weight: 600;
  text-align: center;
  border: 2px solid #10b981;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* ========== MOBILE RESPONSIVE STYLES ========== */
.mobile-menu-btn { display: none !important; }

.mobile-menu-btn:active {
  transform: scale(0.95);
  box-shadow: 0 1px 4px rgba(102, 126, 234, 0.3);
}

.mobile-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  z-index: 998;
  backdrop-filter: blur(2px);
}

.mobile-overlay.visible {
  display: block;
}

.uppercase { text-transform: uppercase !important; }

@media (max-width: 768px) {
  /* Sidebar - slides in from left */
  .sidebar {
    position: fixed;
    left: -100%;
    top: 0;
    bottom: 0;
    width: 280px;
    transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 999;
    box-shadow: 0 0 0 rgba(0,0,0,0);
  }
  
  .sidebar.mobile-open {
    left: 0;
    box-shadow: 4px 0 20px rgba(0,0,0,0.3);
  }
  
  /* Main content takes full width on mobile */
  .main-wrapper { margin-left: 250px; min-height: 100vh; background: #f8fafc; }
  
  /* Show hamburger menu */
  .mobile-menu-btn { display: none !important; }
  
  /* Top bar adjustments */
  .top-bar { 
    padding: 12px 16px;
    flex-wrap: nowrap;
  }
  
  .page-title { 
    font-size: 18px !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Tables - horizontal scroll */
  .data-table { 
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  table { 
    font-size: 13px;
    min-width: 600px; /* Prevent extreme squishing */
  }
  
  /* Cards - better mobile spacing */
  .card { 
    padding: 16px;
    margin: 12px 8px;
    border-radius: 12px;
  }
  
  /* Form rows stack vertically */
  .form-row { 
    flex-direction: column;
    gap: 12px;
  }
  
  .input-group { 
    width: 100% !important;
  }
  
  /* Stats grid - single column */
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  /* User profile in top bar */
  .user-profile {
    font-size: 12px;
  }
  
  .user-avatar {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
}

@media (max-width: 480px) {
  /* Even smaller screens */
  .sidebar { 
    width: 260px;
  }
  
  .page-title { 
    font-size: 16px !important;
  }
  
  table { 
    font-size: 12px;
  }
  
  .card {
    margin: 8px 4px;
    padding: 12px;
  }
  
  .mobile-menu-btn { display: none !important; }
}

/* ========== MOBILE TOUCH IMPROVEMENTS ========== */
button, a, .sidebar-item, input, select, textarea, .tooth {
  -webkit-tap-highlight-color: rgba(102, 126, 234, 0.2);
  touch-action: manipulation;
  cursor: pointer;
}

@media (max-width: 768px) {
  /* Larger touch targets for mobile */
  .btn-primary, .btn-secondary, .btn-small {
    min-height: 48px !important;
    padding: 14px 24px !important;
    font-size: 16px !important;
    width: 100%;
    margin: 6px 0;
    border-radius: 10px;
  }
  
  /* Sidebar items - easy to tap */
  .sidebar-item {
    min-height: 54px !important;
    padding: 16px 20px !important;
    font-size: 16px !important;
    cursor: pointer;
    display: flex;
    align-items: center;
  }
  
  /* Sidebar item active feedback */
  .sidebar-item:active {
    background: #5a67d8 !important;
    transform: scale(0.98);
  }
  
  /* Table action buttons */
  .data-table button {
    min-width: 90px;
    min-height: 44px;
    padding: 10px 16px !important;
    font-size: 14px !important;
    margin: 4px 2px;
  }
  
  /* Form inputs - prevent iOS zoom */
  input, select, textarea {
    min-height: 48px;
    font-size: 16px !important;
    padding: 12px 14px;
    border-radius: 8px;
  }
  
  /* Tooth chart - larger tap targets */
  .tooth {
    min-width: 44px !important;
    min-height: 44px !important;
    font-size: 14px !important;
  }
  
  /* Sidebar - smooth scrolling */
  .sidebar {
    touch-action: pan-y;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    overflow-y: auto;
  }
  
  /* Overlay - easy tap to close */
  .mobile-overlay {
    touch-action: auto;
    cursor: pointer;
  }
  
  /* Modal dialogs */
  .modal {
    padding: 0 !important;
  }
  
  .modal-content {
    width: 95% !important;
    max-width: 95% !important;
    margin: 20px auto !important;
    max-height: 90vh;
    overflow-y: auto;
  }
  
  /* Notification badge */
  .notification-badge {
    min-width: 24px;
    min-height: 24px;
    font-size: 12px;
    padding: 4px 8px;
  }
  
  /* Top bar layout */
  .top-bar {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* Dashboard cards */
  .stat-card {
    min-height: 100px;
  }
  
  /* Content area padding */
  .content-area {
    padding: 8px;
  }
  
  /* Touch feedback */
  button:active, a:active {
    opacity: 0.8;
    transform: scale(0.97);
  }
}

/* Prevent double-tap zoom */
* {
  touch-action: manipulation;
}

body {
  -webkit-touch-callout: none;
  -webkit-text-size-adjust: 100%;
  overscroll-behavior-y: none;
}

/* ========== CRITICAL MOBILE FIX - FORCE INTERACTIVITY ========== */
button, input, select, textarea, a, .sidebar-item, .btn-primary, .btn-secondary, .btn-small {
  pointer-events: auto !important;
  cursor: pointer !important;
}

/* Ensure no overlay blocks interaction */
.app-layout, .main-wrapper, .content-area, .card {
  pointer-events: auto !important;
}

/* Mobile-specific button fixes */
@media (max-width: 768px) {
  button {
    -webkit-appearance: button;
    appearance: button;
  }
  
  input, select, textarea {
    -webkit-appearance: none;
    appearance: none;
  }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js">
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR FEATURE - Complete Implementation
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderCalendar() {
  const role = state.currentUser.role;
  
  // Initialize calendar state if not exists
  if (!state.calendar) {
    const now = new Date();
    state.calendar = {
      currentMonth: now.getMonth(),
      currentYear: now.getFullYear(),
      selectedDoctor: 'all'
    };
  }
  
  const { currentMonth, currentYear, selectedDoctor } = state.calendar;
  
  // Get calendar data
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const today = new Date();
  const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
  const todayDate = today.getDate();
  
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
  
  // Get appointments for this month
  let appointments = state.appointments ? state.appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
  }) : [];
  
  // Filter by doctor if selected
  if (selectedDoctor !== 'all') {
    appointments = appointments.filter(function(apt) {
      return apt.doctorId === parseInt(selectedDoctor);
    });
  }
  
  // Separate today's and upcoming appointments
  const todaysApts = appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate.toDateString() === today.toDateString();
  });
  
  const upcomingApts = appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate > today && aptDate.toDateString() !== today.toDateString();
  }).sort(function(a, b) {
    return new Date(a.date) - new Date(b.date);
  });
  
  const html = '<div class="app-layout">' +
    renderSidebar('#calendar') +
    '<div class="main-wrapper">' +
    '<div class="top-bar">' +
    mobileMenuButton() +
    '<h1 class="page-title">üìÖ Appointment Calendar</h1>' +
    '<div class="user-profile">' +
    '<div class="user-avatar">' + state.currentUser.name.charAt(0) + '</div>' +
    '<div class="user-name">' + state.currentUser.name + '</div>' +
    '</div></div>' +
    '<div class="content-area">' +
    
    // Calendar Controls
    '<div class="card">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px;">' +
    
    // Month/Year Navigation
    '<div style="display:flex;align-items:center;gap:10px;">' +
    '<button onclick="changeMonth(-1)" style="padding:10px 15px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;">‚óÄ</button>' +
    '<h2 style="margin:0;font-size:24px;font-weight:700;min-width:200px;text-align:center;">' +
    monthNames[currentMonth] + ' ' + currentYear +
    '</h2>' +
    '<button onclick="changeMonth(1)" style="padding:10px 15px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;">‚ñ∂</button>' +
    '<button onclick="goToToday()" style="padding:10px 20px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin-left:10px;">Today</button>' +
    '</div>' +
    
    // Doctor Filter
    '<div style="display:flex;align-items:center;gap:10px;">' +
    '<label style="font-weight:600;">Filter by Doctor:</label>' +
    '<select onchange="filterByDoctor(this.value)" style="padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;">' +
    '<option value="all"' + (selectedDoctor === 'all' ? ' selected' : '') + '>All Doctors</option>' +
    state.doctors.map(function(d) {
      return '<option value="' + d.id + '"' + (selectedDoctor === d.id ? ' selected' : '') + '>' + d.name + '</option>';
    }).join('') +
    '</select>' +
    '</div>' +
    
    '</div>' +
    
    // Calendar Grid
    '<div style="background:#f8fafc;border-radius:12px;padding:20px;">' +
    
    // Day Headers
    '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:10px;">' +
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(function(day, i) {
      return '<div style="text-align:center;font-weight:700;font-size:14px;padding:10px;color:' + (i === 0 ? '#ef4444' : '#64748b') + ';">' + day + '</div>';
    }).join('') +
    '</div>' +
    
    // Calendar Days
    '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;">' +
    (function() {
      let days = '';
      
      // Empty cells before first day
      for (let i = 0; i < firstDay; i++) {
        days += '<div style="padding:40px 10px;"></div>';
      }
      
      // Days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dayOfWeek = date.getDay();
        const isSunday = dayOfWeek === 0;
        const isToday = isCurrentMonth && day === todayDate;
        const isPast = date < today && !isToday;
        const dateStr = currentYear + '-' + String(currentMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        
        // Count appointments for this date
        const dayApts = appointments.filter(function(apt) {
          return apt.date === dateStr;
        });
        
        const bgColor = isToday ? '#ef4444' : (isSunday ? '#fee2e2' : (isPast ? '#f1f5f9' : 'white'));
        const textColor = isToday ? 'white' : (isPast ? '#94a3b8' : (isSunday ? '#dc2626' : '#1e293b'));
        const cursor = isPast ? 'not-allowed' : 'pointer';
        const onClick = isPast ? '' : `onclick="openRegistrationForDate('${dateStr}')"`;
        
        days += '<div ' + onClick + ' style="' +
          'background:' + bgColor + ';' +
          'color:' + textColor + ';' +
          'padding:10px;' +
          'border-radius:8px;' +
          'text-align:center;' +
          'cursor:' + cursor + ';' +
          'border:2px solid ' + (isToday ? '#dc2626' : (dayApts.length > 0 ? '#3b82f6' : '#e2e8f0')) + ';' +
          'transition:all 0.2s;' +
          'min-height:80px;' +
          'display:flex;' +
          'flex-direction:column;' +
          'justify-content:space-between;' +
          (isPast ? 'opacity:0.5;' : '') +
          '"' +
          (isPast ? '' : ' onmouseover="this.style.transform=\'scale(1.05)\'" onmouseout="this.style.transform=\'scale(1)\'"') +
          '>' +
          '<div style="font-size:18px;font-weight:700;">' + day + '</div>' +
          (dayApts.length > 0 ? '<div style="font-size:11px;background:' + (isToday ? 'rgba(255,255,255,0.3)' : '#3b82f6') + ';color:' + (isToday ? 'white' : 'white') + ';padding:3px 6px;border-radius:4px;margin-top:5px;">' + dayApts.length + ' apt' + (dayApts.length > 1 ? 's' : '') + '</div>' : '') +
          '</div>';
      }
      
      return days;
    })() +
    '</div>' +
    '</div>' +
    '</div>' +
    
    // Today's Appointments
    '<div class="card" style="margin-top:20px;border-top:4px solid #10b981;">' +
    '<h3 style="margin:0 0 15px 0;font-size:18px;font-weight:700;color:#065f46;">üìå Today\'s Appointments (' + todaysApts.length + ')</h3>' +
    (todaysApts.length === 0 ?
      '<div style="text-align:center;padding:30px;color:#94a3b8;">No appointments today</div>' :
      '<div style="display:grid;gap:10px;">' +
      todaysApts.map(function(apt) {
        const patient = state.patients.find(function(p) { return p.id === apt.patientId; });
        const doctor = state.doctors.find(function(d) { return d.id === apt.doctorId; });
        return '<div style="padding:12px;background:#f0fdf4;border-left:4px solid #10b981;border-radius:8px;">' +
          '<div style="font-weight:600;color:#065f46;">' + (patient ? patient.name : 'Unknown') + '</div>' +
          '<div style="font-size:13px;color:#64748b;margin-top:4px;">' +
          'Doctor: ' + (doctor ? doctor.name : 'N/A') + ' | Time: ' + (apt.time || 'Not set') +
          '</div>' +
          '</div>';
      }).join('') +
      '</div>') +
    '</div>' +
    
    // Upcoming Appointments
    '<div class="card" style="margin-top:20px;border-top:4px solid #3b82f6;">' +
    '<h3 style="margin:0 0 15px 0;font-size:18px;font-weight:700;color:#1e40af;">üìÖ Upcoming Appointments (' + upcomingApts.length + ')</h3>' +
    (upcomingApts.length === 0 ?
      '<div style="text-align:center;padding:30px;color:#94a3b8;">No upcoming appointments this month</div>' :
      '<div style="display:grid;gap:10px;">' +
      upcomingApts.slice(0, 10).map(function(apt) {
        const patient = state.patients.find(function(p) { return p.id === apt.patientId; });
        const doctor = state.doctors.find(function(d) { return d.id === apt.doctorId; });
        const aptDate = new Date(apt.date);
        return '<div style="padding:12px;background:#eff6ff;border-left:4px solid #3b82f6;border-radius:8px;">' +
          '<div style="font-weight:600;color:#1e40af;">' + (patient ? patient.name : 'Unknown') + '</div>' +
          '<div style="font-size:13px;color:#64748b;margin-top:4px;">' +
          formatIndianDate(apt.date) + ' | Doctor: ' + (doctor ? doctor.name : 'N/A') + ' | Time: ' + (apt.time || 'Not set') +
          '</div>' +
          '</div>';
      }).join('') +
      (upcomingApts.length > 10 ? '<div style="text-align:center;padding:10px;color:#64748b;font-size:14px;">... and ' + (upcomingApts.length - 10) + ' more</div>' : '') +
      '</div>') +
    '</div>' +
    
    '</div></div></div>';
  
  document.getElementById('app').innerHTML = html;
}



function openRegistrationForDate(dateStr) {
  // Store selected date
  state.selectedDate = dateStr;
  
  // Navigate to walk-in/registration page
  window.location.hash = '#dashboard';
  
  // Show notification
  showToast('üìÖ Date selected: ' + dateStr + ' - Register patient now');
  
  // Pre-fill date in appointment if possible
  setTimeout(function() {
    const dateInput = document.getElementById('appointment-date');
    if (dateInput) {
      dateInput.value = dateStr;
    }
  }, 100);
}


// Advanced Notification System
function showNotification(message, type, duration) {
  type = type || 'info';
  duration = duration || 3000;
  
  const colors = {
    success: '#10b981',
    error: '#ef4444',
    warning: '#f59e0b',
    info: '#3b82f6'
  };
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  const notification = document.createElement('div');
  notification.innerHTML = icons[type] + ' ' + message;
  notification.style.cssText = 
    'position:fixed;top:80px;right:20px;background:' + colors[type] + ';' +
    'color:white;padding:16px 24px;border-radius:8px;font-weight:600;' +
    'z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.2);' +
    'animation:slideInRight 0.3s ease;max-width:400px;';
  
  document.body.appendChild(notification);
  
  setTimeout(function() {
    notification.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(function() {
      if (notification.parentNode) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, duration);
}

// Notification animations
if (!document.getElementById('notification-styles')) {
  const style = document.createElement('style');
  style.id = 'notification-styles';
  style.textContent = `
    @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
}


// Form Validation Helpers
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function validatePhone(phone) {
  const re = /^[6-9]\d{9}$/;
  return re.test(phone.replace(/\s+/g, ''));
}

function validateRequired(value, fieldName) {
  if (!value || value.trim() === '') {
    showNotification(fieldName + ' is required', 'error');
    return false;
  }
  return true;
}

function formatPhone(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length > 10) value = value.slice(0, 10);
  input.value = value;
}

function formatAge(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length > 3) value = value.slice(0, 3);
  if (parseInt(value) > 150) value = '150';
  input.value = value;
}

// Auto-capitalize name fields
function capitalizeName(input) {
  const words = input.value.split(' ');
  const capitalized = words.map(word => {
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  }).join(' ');
  input.value = capitalized;
}


// Print & Export Utilities

// Export to CSV
function exportToCSV(data, filename) {
  if (!data || data.length === 0) {
    showNotification('No data to export', 'warning');
    return;
  }
  
  const headers = Object.keys(data[0]);
  let csv = headers.join(',') + '\n';
  
  data.forEach(function(row) {
    const values = headers.map(function(header) {
      const val = row[header] || '';
      return '"' + String(val).replace(/"/g, '""') + '"';
    });
    csv += values.join(',') + '\n';
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename + '.csv';
  a.click();
  window.URL.revokeObjectURL(url);
  
  showNotification('Exported ' + data.length + ' records', 'success');
}

// Export patients to CSV
function exportPatients() {
  const data = state.patients.map(function(p) {
    return {
      ID: p.id,
      Name: p.name,
      Age: p.age,
      Gender: p.gender,
      Contact: p.contact,
      Email: p.email,
      'Created Date': formatIndianDate(p.createdAt)
    };
  });
  exportToCSV(data, 'patients_' + new Date().toISOString().split('T')[0]);
}

// Export treatments to CSV
function exportTreatments() {
  const data = state.treatmentPlans.map(function(tp) {
    const patient = state.patients.find(p => p.id === tp.patientId);
    const doctor = state.doctors.find(d => d.id === tp.doctorId);
    return {
      ID: tp.id,
      Patient: patient ? patient.name : 'Unknown',
      Doctor: doctor ? doctor.name : 'Unknown',
      Date: formatIndianDate(tp.visitDate),
      'Chief Complaint': tp.chiefComplaint,
      Status: tp.status,
      'Total Cost': tp.totalCost,
      'Amount Paid': tp.amountPaid
    };
  });
  exportToCSV(data, 'treatments_' + new Date().toISOString().split('T')[0]);
}

// Enhanced print with better formatting
function printWithLogo(title, content) {
  const printWindow = window.open('', '', 'width=800,height=600');
  printWindow.document.write('<html><head><title>' + title + '</title>');
  printWindow.document.write('<style>');
  printWindow.document.write('body { font-family: Arial, sans-serif; padding: 20px; }');
  printWindow.document.write('.header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }');
  printWindow.document.write('.clinic-name { font-size: 28px; font-weight: bold; color: #667eea; }');
  printWindow.document.write('.content { margin-top: 20px; }');
  printWindow.document.write('table { width: 100%; border-collapse: collapse; margin-top: 20px; }');
  printWindow.document.write('th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }');
  printWindow.document.write('th { background: #f8fafc; font-weight: bold; }');
  printWindow.document.write('@media print { button { display: none; } }');
  printWindow.document.write('</style></head><body>');
  printWindow.document.write('<div class="header">');
  printWindow.document.write('<div class="clinic-name">ü¶∑ AURA DENTAL CARE</div>');
  printWindow.document.write('<div>' + title + '</div>');
  printWindow.document.write('</div>');
  printWindow.document.write('<div class="content">');
  printWindow.document.write(content);
  printWindow.document.write('</div>');
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.print();
}


// Advanced Search Functionality

// Search patients by multiple criteria
function searchPatients(query) {
  if (!query || query.trim() === '') {
    return state.patients;
  }
  
  query = query.toLowerCase().trim();
  
  return state.patients.filter(function(p) {
    return (
      (p.name && p.name.toLowerCase().includes(query)) ||
      (p.contact && p.contact.includes(query)) ||
      (p.email && p.email.toLowerCase().includes(query)) ||
      (p.id && p.id.toString() === query)
    );
  });
}

// Search treatments
function searchTreatments(query) {
  if (!query || query.trim() === '') {
    return state.treatmentPlans;
  }
  
  query = query.toLowerCase().trim();
  
  return state.treatmentPlans.filter(function(tp) {
    const patient = state.patients.find(p => p.id === tp.patientId);
    const patientName = patient ? patient.name.toLowerCase() : '';
    
    return (
      (tp.chiefComplaint && tp.chiefComplaint.toLowerCase().includes(query)) ||
      (tp.diagnosis && tp.diagnosis.toLowerCase().includes(query)) ||
      patientName.includes(query) ||
      (tp.id && tp.id.toString() === query)
    );
  });
}

// Global search across all entities
function globalSearch(query) {
  if (!query || query.trim() === '') {
    return { patients: [], treatments: [], appointments: [] };
  }
  
  return {
    patients: searchPatients(query).slice(0, 5),
    treatments: searchTreatments(query).slice(0, 5),
    appointments: []
  };
}

// Debounce function for search
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = function() {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}


// Keyboard Shortcuts
document.addEventListener('keydown', function(e) {
  // Alt + shortcuts
  if (e.altKey) {
    switch(e.key) {
      case 'h': // Alt+H: Home/Dashboard
        e.preventDefault();
        window.location.hash = state.currentUser.role === 'doctor' ? '#doctors-section' : '#walkin';
        break;
      case 'p': // Alt+P: Patients
        e.preventDefault();
        window.location.hash = '#patients';
        break;
      case 'c': // Alt+C: Calendar
        e.preventDefault();
        window.location.hash = '#calendar';
        break;
      case 's': // Alt+S: Settings
        e.preventDefault();
        window.location.hash = '#settings';
        break;
      case 'l': // Alt+L: Logout
        e.preventDefault();
        if (confirm('Are you sure you want to logout?')) {
          logout();
        }
        break;
    }
  }
  
  // Escape key: Close modals
  if (e.key === 'Escape') {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
      modal.style.display = 'none';
    });
  }
});

// Show keyboard shortcuts help
function showKeyboardShortcuts() {
  const shortcuts = [
    { keys: 'Alt + H', action: 'Go to Home/Dashboard' },
    { keys: 'Alt + P', action: 'Go to Patients' },
    { keys: 'Alt + C', action: 'Go to Calendar' },
    { keys: 'Alt + S', action: 'Go to Settings' },
    { keys: 'Alt + L', action: 'Logout' },
    { keys: 'Esc', action: 'Close modals' }
  ];
  
  let html = '<div style="padding:20px;">';
  html += '<h2 style="margin-top:0;">‚å®Ô∏è Keyboard Shortcuts</h2>';
  html += '<table style="width:100%;"><tr><th>Keys</th><th>Action</th></tr>';
  shortcuts.forEach(function(s) {
    html += '<tr><td><code style="background:#f1f5f9;padding:4px 8px;border-radius:4px;">' + 
            s.keys + '</code></td><td>' + s.action + '</td></tr>';
  });
  html += '</table></div>';
  
  showModal('Keyboard Shortcuts', html);
}


// Loading Indicators & UI Feedback

// Show loading overlay
function showLoading(message) {
  message = message || 'Loading...';
  
  let loader = document.getElementById('global-loader');
  if (!loader) {
    loader = document.createElement('div');
    loader.id = 'global-loader';
    loader.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    `;
    
    loader.innerHTML = `
      <div style="background: white; padding: 30px 50px; border-radius: 12px; text-align: center;">
        <div class="spinner" style="margin: 0 auto 15px; width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <div style="font-size: 16px; font-weight: 600; color: #1e293b;">${message}</div>
      </div>
    `;
    
    document.body.appendChild(loader);
    
    // Add spinner animation if not exists
    if (!document.getElementById('spinner-animation')) {
      const style = document.createElement('style');
      style.id = 'spinner-animation';
      style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
      document.head.appendChild(style);
    }
  }
  
  loader.style.display = 'flex';
}

// Hide loading overlay
function hideLoading() {
  const loader = document.getElementById('global-loader');
  if (loader) {
    loader.style.display = 'none';
  }
}

// Progress bar for operations
function showProgress(percent, message) {
  let progress = document.getElementById('global-progress');
  if (!progress) {
    progress = document.createElement('div');
    progress.id = 'global-progress';
    progress.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 99998;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
    `;
    
    progress.innerHTML = `
      <div id="progress-message" style="font-size: 14px; margin-bottom: 8px; color: #64748b;"></div>
      <div style="width: 100%; background: #e2e8f0; border-radius: 10px; overflow: hidden;">
        <div id="progress-bar" style="height: 8px; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease;"></div>
      </div>
    `;
    
    document.body.appendChild(progress);
  }
  
  document.getElementById('progress-message').textContent = message || 'Processing...';
  document.getElementById('progress-bar').style.width = percent + '%';
  progress.style.display = 'block';
  
  if (percent >= 100) {
    setTimeout(function() {
      progress.style.display = 'none';
    }, 500);
  }
}


// Data Backup & Restore System

// Backup all data
function backupAllData() {
  showLoading('Creating backup...');
  
  try {
    const backup = {
      version: '2.0',
      timestamp: new Date().toISOString(),
      data: {
        patients: state.patients,
        doctors: state.doctors,
        treatments: state.treatments,
        medicines: state.medicines,
        treatmentPlans: state.treatmentPlans,
        doctorQueue: state.doctorQueue,
        chairs: state.chairs,
        appointments: state.appointments || [],
        bills: state.bills || [],
        treatmentMappings: state.treatmentMappings || {}
      }
    };
    
    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'aura-dental-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    
    URL.revokeObjectURL(url);
    hideLoading();
    showNotification('‚úÖ Backup created successfully!', 'success');
    
  } catch (error) {
    hideLoading();
    showNotification('‚ùå Backup failed: ' + error.message, 'error');
  }
}

// Restore from backup
function restoreFromBackup() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    showLoading('Restoring backup...');
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const backup = JSON.parse(event.target.result);
        
        if (!backup.version || !backup.data) {
          throw new Error('Invalid backup file');
        }
        
        // Restore data
        state.patients = backup.data.patients || [];
        state.doctors = backup.data.doctors || [];
        state.treatments = backup.data.treatments || [];
        state.medicines = backup.data.medicines || [];
        state.treatmentPlans = backup.data.treatmentPlans || [];
        state.doctorQueue = backup.data.doctorQueue || [];
        state.chairs = backup.data.chairs || [];
        state.appointments = backup.data.appointments || [];
        state.bills = backup.data.bills || [];
        state.treatmentMappings = backup.data.treatmentMappings || {};
        
        // Save to localStorage
        DataStore.save('patients', state.patients);
        DataStore.save('doctors', state.doctors);
        DataStore.save('treatments', state.treatments);
        DataStore.save('medicines', state.medicines);
        DataStore.save('treatmentPlans', state.treatmentPlans);
        DataStore.save('doctorQueue', state.doctorQueue);
        DataStore.save('chairs', state.chairs);
        DataStore.save('appointments', state.appointments);
        DataStore.save('bills', state.bills);
        DataStore.save('treatmentMappings', state.treatmentMappings);
        
        hideLoading();
        showNotification('‚úÖ Backup restored successfully! Reloading...', 'success');
        
        setTimeout(function() {
          location.reload();
        }, 1500);
        
      } catch (error) {
        hideLoading();
        showNotification('‚ùå Restore failed: ' + error.message, 'error');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

// Auto-backup reminder
function checkAutoBackup() {
  const lastBackup = localStorage.getItem('lastBackupDate');
  const today = new Date().toDateString();
  
  if (lastBackup !== today) {
    const daysSinceBackup = lastBackup ? 
      Math.floor((new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24)) : 999;
    
    if (daysSinceBackup >= 7) {
      showNotification('‚ö†Ô∏è Backup reminder: Last backup was ' + daysSinceBackup + ' days ago', 'warning', 5000);
    }
  }
}

// Mark backup as done
function markBackupDone() {
  localStorage.setItem('lastBackupDate', new Date().toDateString());
}

// Check on load
if (typeof state !== 'undefined' && state.currentUser) {
  setTimeout(checkAutoBackup, 3000);
}


// Performance Optimizations

// Lazy load images
function lazyLoadImages() {
  const images = document.querySelectorAll('img[data-src]');
  const imageObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.removeAttribute('data-src');
        imageObserver.unobserve(img);
      }
    });
  });
  
  images.forEach(function(img) {
    imageObserver.observe(img);
  });
}

// Optimize large list rendering


</script>
</head>
<body>

<div id="app"></div>

<script>

// ================================================================
// üöÄ APP INITIALIZATION - CORE CODE
// ================================================================

console.log('üîß Aura Dental - Starting initialization...');

// ================== STATE MANAGEMENT ==================
const state = {
  currentUser: null,
  patients: [],
  doctors: [
    { id: 1, name: 'Dr. Sahil Chawla', email: 'sahil@auradental.com', password: 'doctor123', specialty: 'General Dentistry' },
    { id: 2, name: 'Dr. Kiran Patel', email: 'kiran@auradental.com', password: 'doctor123', specialty: 'Orthodontics' },
    { id: 3, name: 'Dr. Priyal Shah', email: 'priyal@auradental.com', password: 'doctor123', specialty: 'Endodontics' }
  ],
  treatments: [
    { id: 1, name: 'Tooth Filling', cost: 1500 },
    { id: 2, name: 'Root Canal', cost: 5000 },
    { id: 3, name: 'Tooth Extraction', cost: 1000 },
    { id: 4, name: 'Scaling', cost: 800 },
    { id: 5, name: 'Gum Treatment', cost: 2000 },
    { id: 6, name: 'Teeth Cleaning', cost: 1200 },
    { id: 7, name: 'Consultation', cost: 500 },
    { id: 8, name: 'Crown/Bridge', cost: 8000 },
    { id: 9, name: 'Dental Implant', cost: 25000 },
    { id: 10, name: 'Dentures', cost: 15000 },
    { id: 11, name: 'TMJ Treatment', cost: 3000 }
  ],
  medicines: [
    { id: 1, name: 'Amoxicillin 500mg', dosage: '1-1-1 for 5 days' },
    { id: 2, name: 'Ibuprofen 400mg', dosage: '1-0-1 for 3 days' },
    { id: 3, name: 'Metronidazole 400mg', dosage: '1-1-1 for 5 days' },
    { id: 4, name: 'Chlorhexidine Mouthwash', dosage: 'Gargle twice daily' }
  ],
  treatmentPlans: [],
  doctorQueue: [],
  chairs: [],
  bills: [],
  appointments: [],
  
  // Consultation form state
  consultationForm: {
    patientId: null,
    doctorId: null,
    chairId: null,
    selectedTeeth: [],
    selectedMedicines: [],
    selectedTreatments: [],
    customTreatment: '',
    customCost: '',
    notes: '',
    nextVisit: '',
    chiefComplaint: '',  // Now filled by DOCTOR, not reception
    diagnosis: '',
    selectedTests: []
  }
};

// ================== DATA STORE ==================
const DataStore = {
  save: function(key, data) {
    try {
      localStorage.setItem('aura_' + key, JSON.stringify(data));
      return true;
    } catch (e) {
      console.error('Save failed:', e);
      return false;
    }
  },
  load: function(key) {
    try {
      const data = localStorage.getItem('aura_' + key);
      return data ? JSON.parse(data) : null;
    } catch (e) {
      console.error('Load failed:', e);
      return null;
    }
  },
  clear: function() {
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith('aura_')) localStorage.removeItem(key);
    });
  }
};

// ================== LOAD STATE ==================
function loadState() {
  console.log('üìÇ Loading saved data...');
  const savedPatients = DataStore.load('patients');
  const savedTreatmentPlans = DataStore.load('treatmentPlans');
  const savedQueue = DataStore.load('doctorQueue');
  const savedChairs = DataStore.load('chairs');
  const savedBills = DataStore.load('bills');
  const savedAppointments = DataStore.load('appointments');
  
  if (savedPatients) state.patients = savedPatients;
  if (savedTreatmentPlans) state.treatmentPlans = savedTreatmentPlans;
  if (savedQueue) state.doctorQueue = savedQueue;
  if (savedChairs) state.chairs = savedChairs;
  if (savedBills) state.bills = savedBills;
  if (savedAppointments) state.appointments = savedAppointments;
  
  console.log('‚úÖ Data loaded:', {
    patients: state.patients.length,
    treatments: state.treatmentPlans.length,
    queue: state.doctorQueue.length
  });
}

// ================== ROUTER ==================
const routes = {
  '#login': () => renderLogin(),
  '#dashboard': () => renderDashboard(),
  '#walkin': () => renderWalkInBooking ? renderWalkInBooking() : renderWalkin(),
  '#patients': () => renderPatients(),
  '#doctors-section': () => renderDoctorsSection ? renderDoctorsSection() : console.error('renderDoctorsSection not found'),
  '#billing-section': () => renderBillingSection ? renderBillingSection() : console.error('renderBillingSection not found'),
  '#appointments': () => renderAppointments ? renderAppointments() : console.log('Appointments'),
  '#calendar': () => renderCalendar ? renderCalendar() : console.log('Calendar'),
  '#prescription-section': () => renderPrescriptionSection(),
  '#bookings': () => renderOnlineBooking(),
  '#display': () => { renderDisplayScreen(); },
  '#reports': () => renderReports(),
  '#expenses': () => renderExpenses(),
  '#payroll': () => renderPayroll(),
  '#medicines': () => renderMedicines(),
  '#walkin': () => renderWalkInBooking ? renderWalkInBooking() : renderDashboard(),
  '#doctors-section': () => renderDoctorsSection ? renderDoctorsSection() : renderDashboard(),
  '#settings': () => renderSettings ? renderSettings() : console.log('Settings')
};

// ================== RENDER ==================
function render() {
  const hash = window.location.hash || '#walkin';
  const route = routes[hash];
  
  if (route) {
    route();
  } else {
    console.warn('Route not found:', hash);
    window.location.hash = '#dashboard';
  }
}

// ================== CHECK AUTH ==================
function checkAuth() {
  const savedUser = DataStore.load('currentUser');
  if (savedUser) {
    state.currentUser = savedUser;
    return true;
  }
  return false;
}

// ================== LOGOUT ==================
function logout() {
  state.currentUser = null;
  DataStore.save('currentUser', null);
  window.location.hash = '#login';
  renderLogin();
}

function login() {
  const email = (document.getElementById('login-email').value || '').trim().toLowerCase();
  const password = document.getElementById('login-password').value || '';
  const role = document.getElementById('login-role').value;

  if (!email || !password) {
    alert('Please enter email and password.');
    return;
  }

  let user = null;

  if (role === 'admin' && email === 'admin@auradental.com' && password === 'admin123') {
    user = { name: 'Admin', email, role: 'admin' };
  } else if (role === 'receptionist' && email === 'receptionist@auradental.com' && password === 'reception123') {
    user = { name: 'Receptionist', email, role: 'receptionist' };
  } else if (role === 'doctor') {
    const doc = state.doctors.find(function(d) {
      return d.email.toLowerCase() === email && d.password === password;
    });
    if (doc) user = { name: doc.name, email: doc.email, role: 'doctor', id: doc.id };
  }

  if (user) {
    state.currentUser = user;
    DataStore.save('currentUser', user);
    window.location.hash = '#dashboard';
    navigate();
  } else {
    alert('Invalid email, password, or role. Please try again.');
  }
}


function renderAppointments(){window.location.hash='#calendar';}
function renderBillingSection(){if(typeof renderTreatmentPlansReception==='function')renderTreatmentPlansReception();}

// ================== WORKING PAGE FUNCTIONS ==================

function renderDashboard() {
  const app = document.getElementById('app');
  if (!app) return;
  const today = new Date().toISOString().split('T')[0];
  const pts = state.patients || [];
  const queue = state.doctorQueue || [];
  const chairs = state.chairs || [];
  const bills = state.bills || [];
  const todayPts = pts.filter(p => p.registeredDate && p.registeredDate.startsWith(today)).length;
  const todayBills = bills.filter(b => b.date && b.date.startsWith(today));
  const todayRevenue = todayBills.reduce((s, b) => s + (parseFloat(b.totalAmount) || 0), 0);
  const occupied = queue.filter(q => q.status === 'in-consultation' || q.status === 'waiting').length;

  if (!state.dashCal) {
    const now = new Date();
    state.dashCal = { month: now.getMonth(), year: now.getFullYear() };
  }
  const calMonth = state.dashCal.month;
  const calYear  = state.dashCal.year;
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const firstDay   = new Date(calYear, calMonth, 1).getDay();
  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  const nowDate    = new Date();
  const isThisMonth = nowDate.getMonth() === calMonth && nowDate.getFullYear() === calYear;

  const monthApts = (state.appointments || []).filter(a => {
    const d = new Date(a.date);
    return d.getMonth() === calMonth && d.getFullYear() === calYear;
  });

  let dayCells = '';
  for (let i = 0; i < firstDay; i++) dayCells += '<div></div>';
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = calYear + '-' + String(calMonth+1).padStart(2,'0') + '-' + String(day).padStart(2,'0');
    const dayApts = monthApts.filter(a => a.date === dateStr);
    const cellDate = new Date(calYear, calMonth, day);
    const isPast   = cellDate < new Date(nowDate.getFullYear(), nowDate.getMonth(), nowDate.getDate());
    const isToday  = isThisMonth && day === nowDate.getDate();
    const bg       = isToday ? 'linear-gradient(135deg,#667eea,#764ba2)' : (isPast ? '#f8fafc' : 'white');
    const txtColor = isToday ? 'white' : (isPast ? '#cbd5e1' : '#1e293b');
    const border   = isToday ? '#667eea' : (dayApts.length > 0 ? '#10b981' : '#e2e8f0');
    const cursor   = isPast ? 'default' : 'pointer';
    const click    = isPast ? '' : `onclick="dashCalBookDate('${dateStr}')"`;
    const hover    = isPast ? '' : `onmouseover="this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'" onmouseout="this.style.boxShadow='none'"`;
    dayCells += `<div ${click} ${hover} style="border:2px solid ${border};background:${bg};border-radius:8px;padding:6px 4px;text-align:center;cursor:${cursor};min-height:54px;display:flex;flex-direction:column;align-items:center;justify-content:space-between;transition:box-shadow 0.2s;">
      <span style="font-size:14px;font-weight:700;color:${txtColor};">${day}</span>
      ${dayApts.length > 0 ? `<span style="font-size:10px;background:${isToday?'rgba(255,255,255,0.3)':'#10b981'};color:white;border-radius:4px;padding:1px 5px;">${dayApts.length} apt${dayApts.length>1?'s':''}</span>` : ''}
    </div>`;
  }

  const todayApts = (state.appointments || []).filter(a => a.date === today);

  app.innerHTML = renderSidebar('#dashboard') + `
    <div class="main-content" style="padding:24px;">
      <h2 style="color:#1e293b;margin-bottom:24px;font-size:24px;font-weight:700;">√∞≈∏‚Äú≈† Reception Dashboard</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:28px;">
        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:16px;">
          <div style="font-size:32px;font-weight:700;">${todayPts}</div>
          <div style="opacity:0.9;margin-top:4px;font-size:14px;">Today's Patients</div>
        </div>
        <div style="background:linear-gradient(135deg,#f093fb,#f5576c);color:white;padding:20px;border-radius:16px;">
          <div style="font-size:32px;font-weight:700;">${occupied}</div>
          <div style="opacity:0.9;margin-top:4px;font-size:14px;">In Queue / Consulting</div>
        </div>
        <div style="background:linear-gradient(135deg,#4facfe,#00f2fe);color:white;padding:20px;border-radius:16px;">
          <div style="font-size:32px;font-weight:700;">&#8377;${todayRevenue.toLocaleString()}</div>
          <div style="opacity:0.9;margin-top:4px;font-size:14px;">Today's Revenue</div>
        </div>
        <div style="background:linear-gradient(135deg,#43e97b,#38f9d7);color:white;padding:20px;border-radius:16px;">
          <div style="font-size:32px;font-weight:700;">${todayApts.length}</div>
          <div style="opacity:0.9;margin-top:4px;font-size:14px;">Today's Appointments</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 340px;gap:20px;margin-bottom:24px;">
        <div style="background:white;border-radius:16px;padding:20px;border:1px solid #e2e8f0;box-shadow:0 2px 8px rgba(0,0,0,0.06);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">&#128197; Book Appointment</h3>
            <button onclick="dashCalOpenBookModal()" style="padding:8px 16px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">+ New Booking</button>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
            <button onclick="dashCalChangeMonth(-1)" style="padding:6px 12px;background:#f1f5f9;border:none;border-radius:8px;cursor:pointer;font-size:16px;color:#667eea;font-weight:700;">&#9664;</button>
            <div style="display:flex;align-items:center;gap:10px;">
              <select onchange="dashCalSetMonth(parseInt(this.value))" style="padding:6px 10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;font-weight:600;">
                ${monthNames.map((m,i) => `<option value="${i}" ${i===calMonth?'selected':''}>${m}</option>`).join('')}
              </select>
              <select onchange="dashCalSetYear(parseInt(this.value))" style="padding:6px 10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;font-weight:600;">
                ${Array.from({length:6},(_,i)=>nowDate.getFullYear()-1+i).map(y=>`<option value="${y}" ${y===calYear?'selected':''}>${y}</option>`).join('')}
              </select>
            </div>
            <button onclick="dashCalChangeMonth(1)" style="padding:6px 12px;background:#f1f5f9;border:none;border-radius:8px;cursor:pointer;font-size:16px;color:#667eea;font-weight:700;">&#9654;</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:6px;">
            ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map((d,i)=>`<div style="text-align:center;font-size:12px;font-weight:700;padding:6px 0;color:${i===0?'#ef4444':'#94a3b8'};">${d}</div>`).join('')}
          </div>
          <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;">${dayCells}</div>
          <div style="display:flex;gap:16px;margin-top:14px;font-size:12px;color:#64748b;">
            <span><span style="display:inline-block;width:10px;height:10px;background:#10b981;border-radius:2px;margin-right:4px;"></span>Has appointments</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:2px;margin-right:4px;"></span>Today</span>
          </div>
        </div>
        <div style="background:white;border-radius:16px;padding:20px;border:1px solid #e2e8f0;box-shadow:0 2px 8px rgba(0,0,0,0.06);">
          <h3 style="margin:0 0 16px 0;font-size:18px;font-weight:700;color:#1e293b;">&#128205; Today's Appointments <span style="background:#667eea;color:white;font-size:12px;padding:2px 8px;border-radius:12px;margin-left:6px;">${todayApts.length}</span></h3>
          ${todayApts.length === 0
            ? '<div style="text-align:center;padding:40px 20px;color:#94a3b8;"><div style="font-size:40px;margin-bottom:8px;">&#128237;</div><div style="font-size:14px;">No appointments today</div></div>'
            : todayApts.map(a => {
                const pt = pts.find(p => p.id === a.patientId);
                const dr = (state.doctors||[]).find(d => d.id === a.doctorId);
                return `<div style="padding:10px 12px;background:#f8fafc;border-left:4px solid #667eea;border-radius:8px;margin-bottom:8px;">
                  <div style="font-weight:600;color:#1e293b;font-size:14px;">${pt?pt.name:'Unknown'}</div>
                  <div style="font-size:12px;color:#64748b;margin-top:3px;">&#128336; ${a.time||'Time N/A'} &middot; ${dr?dr.name:'N/A'}</div>
                  ${a.treatment?`<div style="font-size:11px;color:#94a3b8;margin-top:2px;">${a.treatment}</div>`:''}
                </div>`;
              }).join('')
          }
        </div>
      </div>
      <div style="background:white;border-radius:16px;padding:20px;border:1px solid #e2e8f0;">
        <h3 style="margin-bottom:16px;color:#1e293b;font-size:16px;font-weight:700;">&#129681; Chair Status</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
          ${(chairs.length?chairs:[{id:1,name:'Chair 1'},{id:2,name:'Chair 2'},{id:3,name:'Chair 3'}]).map(ch=>{
            const q=queue.find(q=>q.chairId===ch.id&&(q.status==='in-consultation'||q.status==='waiting'));
            const color=q?'#ef4444':'#10b981';
            const patient=q?pts.find(p=>p.id===q.patientId):null;
            return `<div style="padding:14px;border-radius:12px;border:2px solid ${color};text-align:center;">
              <div style="font-size:22px;">&#129681;</div>
              <div style="font-weight:600;color:#1e293b;font-size:14px;">${ch.name||'Chair '+ch.id}</div>
              <div style="color:${color};font-weight:600;font-size:12px;">${q?'Occupied':'Available'}</div>
              ${patient?`<div style="font-size:11px;color:#64748b;margin-top:3px;">${patient.name}</div>`:''}
            </div>`;
          }).join('')}
        </div>
      </div>
    </div>
    <div id="dashCalModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:white;border-radius:20px;padding:28px;width:480px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h3 style="margin:0;font-size:20px;font-weight:700;color:#1e293b;">&#128197; Book Appointment</h3>
          <button onclick="dashCalCloseModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#94a3b8;">&#x2715;</button>
        </div>
        <div style="margin-bottom:14px;">
          <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px;">Date *</label>
          <input type="date" id="dashCal_date" style="width:100%;padding:10px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;">
        </div>
        <div style="margin-bottom:14px;">
          <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px;">Time *</label>
          <select id="dashCal_time" style="width:100%;padding:10px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;">
            <option value="">-- Select Time --</option>
            <option>09:00 AM</option><option>09:30 AM</option><option>10:00 AM</option><option>10:30 AM</option>
            <option>11:00 AM</option><option>11:30 AM</option><option>12:00 PM</option><option>12:30 PM</option>
            <option>02:00 PM</option><option>02:30 PM</option><option>03:00 PM</option><option>03:30 PM</option>
            <option>04:00 PM</option><option>04:30 PM</option><option>05:00 PM</option><option>05:30 PM</option><option>06:00 PM</option>
          </select>
        </div>
        <div style="margin-bottom:14px;">
          <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px;">Patient *</label>
          <input type="text" id="dashCal_patSearch" placeholder="Search by name or phone..." oninput="dashCalSearchPat(this.value)"
            style="width:100%;padding:10px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;">
          <div id="dashCal_patResults" style="background:white;border:1px solid #e2e8f0;border-radius:8px;margin-top:4px;max-height:140px;overflow-y:auto;display:none;"></div>
          <input type="hidden" id="dashCal_patId">
          <div id="dashCal_patSelected" style="margin-top:6px;font-size:13px;color:#10b981;font-weight:600;"></div>
          <div style="margin-top:6px;font-size:12px;color:#94a3b8;">New patient? <a href="#" onclick="dashCalCloseModal();window.location.hash = '#dashboard';" style="color:#667eea;font-weight:600;">Register first &rarr;</a></div>
        </div>
        <div style="margin-bottom:14px;">
          <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px;">Doctor *</label>
          <select id="dashCal_doctor" style="width:100%;padding:10px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;">
            <option value="">-- Select Doctor --</option>
            ${(state.doctors||[]).map(d=>`<option value="${d.id}">${d.name}</option>`).join('')}
          </select>
        </div>
        <div style="margin-bottom:14px;">
          <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px;">Treatment / Reason</label>
          <input type="text" id="dashCal_treatment" placeholder="e.g. Scaling, Root Canal, Consultation..."
            style="width:100%;padding:10px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;">
        </div>
        <div style="margin-bottom:20px;">
          <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px;">Notes</label>
          <textarea id="dashCal_notes" rows="2" style="width:100%;padding:10px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;resize:vertical;"></textarea>
        </div>
        <div style="display:flex;gap:12px;">
          <button onclick="dashCalSaveBooking()" style="flex:1;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;cursor:pointer;font-size:15px;font-weight:700;">&#10003; Book Appointment</button>
          <button onclick="dashCalCloseModal()" style="padding:12px 20px;background:#f1f5f9;color:#64748b;border:none;border-radius:10px;cursor:pointer;font-size:15px;">Cancel</button>
        </div>
      </div>
    </div>`;
}

function dashCalChangeMonth(delta) {
  if (!state.dashCal) return;
  state.dashCal.month += delta;
  if (state.dashCal.month > 11) { state.dashCal.month = 0; state.dashCal.year++; }
  else if (state.dashCal.month < 0) { state.dashCal.month = 11; state.dashCal.year--; }
  renderDashboard();
}
function dashCalSetMonth(m) { if (!state.dashCal) return; state.dashCal.month = m; renderDashboard(); }
function dashCalSetYear(y)  { if (!state.dashCal) return; state.dashCal.year  = y; renderDashboard(); }
function dashCalBookDate(dateStr) {
  const modal = document.getElementById('dashCalModal');
  if (!modal) return;
  document.getElementById('dashCal_date').value = dateStr;
  document.getElementById('dashCal_patId').value = '';
  document.getElementById('dashCal_patSelected').textContent = '';
  document.getElementById('dashCal_patSearch').value = '';
  document.getElementById('dashCal_time').value = '';
  document.getElementById('dashCal_treatment').value = '';
  document.getElementById('dashCal_notes').value = '';
  modal.style.display = 'flex';
}
function dashCalOpenBookModal() { dashCalBookDate(new Date().toISOString().split('T')[0]); }
function dashCalCloseModal() { const m = document.getElementById('dashCalModal'); if (m) m.style.display = 'none'; }
function dashCalSearchPat(query) {
  const results = document.getElementById('dashCal_patResults');
  if (!query || query.length < 2) { results.style.display = 'none'; return; }
  const matches = (state.patients||[]).filter(p =>
    p.name.toLowerCase().includes(query.toLowerCase()) || (p.phone||'').includes(query) || (p.contact||'').includes(query)
  ).slice(0,8);
  if (!matches.length) { results.style.display = 'none'; return; }
  results.innerHTML = matches.map(p =>
    `<div onclick="dashCalSelectPat(${p.id},'${p.name.replace(/'/g,"\\'")}','${(p.phone||p.contact||'')}')"
      style="padding:10px 14px;cursor:pointer;border-bottom:1px solid #f1f5f9;font-size:14px;"
      onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
      <span style="font-weight:600;">${p.name}</span>
      <span style="color:#94a3b8;margin-left:8px;font-size:12px;">${p.phone||p.contact||''}</span>
    </div>`).join('');
  results.style.display = 'block';
}
function dashCalSelectPat(id, name, phone) {
  document.getElementById('dashCal_patId').value = id;
  document.getElementById('dashCal_patSearch').value = name;
  document.getElementById('dashCal_patSelected').textContent = '&#10003; ' + name + (phone?' √Ç¬∑ '+phone:'');
  document.getElementById('dashCal_patResults').style.display = 'none';
}
function dashCalSaveBooking() {
  const date     = document.getElementById('dashCal_date').value;
  const time     = document.getElementById('dashCal_time').value;
  const patId    = parseInt(document.getElementById('dashCal_patId').value);
  const doctorId = parseInt(document.getElementById('dashCal_doctor').value);
  const treatment= document.getElementById('dashCal_treatment').value;
  const notes    = document.getElementById('dashCal_notes').value;
  if (!date)    { alert('Please select a date.'); return; }
  if (!time)    { alert('Please select a time.'); return; }
  if (!patId)   { alert('Please select a patient.'); return; }
  if (!doctorId){ alert('Please select a doctor.'); return; }
  if (!state.appointments) state.appointments = [];
  const apt = { id: Date.now(), patientId: patId, doctorId: doctorId, date: date, time: time,
    treatment: treatment||'Consultation', status: 'scheduled', source: 'reception', notes: notes };
  state.appointments.push(apt);
  if (typeof DataStore !== 'undefined') DataStore.save('appointments', state.appointments);
  if (typeof saveAllData === 'function') saveAllData();
  dashCalCloseModal();
  renderDashboard();
  const pt = (state.patients||[]).find(p=>p.id===patId);
  const msg = 'Appointment booked for ' + (pt?pt.name:'Patient') + ' on ' + date + ' at ' + time;
  if (typeof showToast === 'function') showToast('&#10003; ' + msg); else alert(msg);
}

function renderPatients() {
  const app = document.getElementById('app');
  if (!app) return;
  const pts = state.patients || [];
  app.innerHTML = renderSidebar('#patients') + `
    <div class="main-content" style="padding:24px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
        <h2 style="color:#1e293b;font-size:24px;font-weight:700;">üë• Patients (${pts.length})</h2>
        <input type="text" placeholder="üîç Search patients..." onkeyup="filterPatientsList(this.value)"
          style="padding:10px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:14px;width:250px;">
      </div>
      <div id="patients-list">
        ${pts.length === 0 ? '<div style="text-align:center;padding:60px;color:#64748b;"><div style="font-size:48px;margin-bottom:16px;">üë•</div><p>No patients registered yet.</p><p>Use OPD Registration to add patients.</p></div>' :
          pts.map(p => `
          <div style="background:white;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div style="font-weight:600;color:#1e293b;font-size:16px;">${p.name}</div>
              <div style="color:#64748b;font-size:13px;margin-top:4px;">üìû ${p.phone||'-'} | Age: ${p.age||'-'} | ${p.gender||'-'}</div>
              ${p.registeredDate ? `<div style="color:#94a3b8;font-size:12px;margin-top:2px;">Registered: ${p.registeredDate}</div>` : ''}
            </div>
            <div style="color:#667eea;font-weight:600;font-size:13px;">ID: ${p.id||'-'}</div>
          </div>`).join('')}
      </div>
    </div>`;
}

function filterPatientsList(q) {
  const pts = (state.patients||[]).filter(p => !q || p.name.toLowerCase().includes(q.toLowerCase()) || (p.phone||'').includes(q));
  const el = document.getElementById('patients-list');
  if (!el) return;
  el.innerHTML = pts.length === 0 ? '<p style="color:#64748b;padding:20px;">No patients found.</p>' :
    pts.map(p => `<div style="background:white;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:12px;">
      <div style="font-weight:600;color:#1e293b;">${p.name}</div>
      <div style="color:#64748b;font-size:13px;">üìû ${p.phone||'-'} | Age: ${p.age||'-'}</div>
    </div>`).join('');
}

function renderPrescriptionSection() {
  const app = document.getElementById('app');
  if (!app) return;
  const bills = (state.bills||[]).filter(b => !b.prescriptionPrinted);
  app.innerHTML = renderSidebar('#prescription-section') + `
    <div class="main-content" style="padding:24px;">
      <h2 style="color:#1e293b;margin-bottom:24px;font-size:24px;font-weight:700;">üñ®Ô∏è Print Bills & Rx</h2>
      ${bills.length === 0 ? '<div style="text-align:center;padding:60px;color:#64748b;"><div style="font-size:48px;margin-bottom:16px;">üñ®Ô∏è</div><p>No pending bills to print.</p></div>' :
        bills.map(b => {
          const pt = (state.patients||[]).find(p=>p.id===b.patientId);
          return `<div style="background:white;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div style="font-weight:600;color:#1e293b;">${pt?pt.name:'Unknown'}</div>
              <div style="color:#64748b;font-size:13px;">Amount: ‚Çπ${b.totalAmount||0} | Date: ${b.date||'-'}</div>
            </div>
            <button onclick="window.print()" style="padding:8px 16px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;">Print</button>
          </div>`;
        }).join('')}
    </div>`;
}

function renderOnlineBooking() {
  const app = document.getElementById('app');
  if (!app) return;
  const bookings = state.bookingRequests || [];
  const pending = bookings.filter(b => b.status === 'pending');
  app.innerHTML = renderSidebar('#bookings') + `
    <div class="main-content" style="padding:24px;">
      <h2 style="color:#1e293b;margin-bottom:24px;font-size:24px;font-weight:700;">üì± Online Bookings</h2>
      ${pending.length === 0 ? '<div style="text-align:center;padding:60px;color:#64748b;"><div style="font-size:48px;margin-bottom:16px;">üì±</div><p>No pending booking requests.</p></div>' :
        pending.map(b => `<div style="background:white;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:12px;">
          <div style="font-weight:600;color:#1e293b;">${b.name||'Unknown'}</div>
          <div style="color:#64748b;font-size:13px;">üìû ${b.phone||'-'} | Date: ${b.date||'-'} | ${b.reason||'-'}</div>
        </div>`).join('')}
    </div>`;
}

function renderExpenses() {
  const app = document.getElementById('app');
  if (!app) return;
  const expenses = state.expenses || [];
  const total = expenses.reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
  app.innerHTML = renderSidebar('#expenses') + `
    <div class="main-content" style="padding:24px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
        <h2 style="color:#1e293b;font-size:24px;font-weight:700;">üí∏ Expenses</h2>
        <div style="background:linear-gradient(135deg,#f093fb,#f5576c);color:white;padding:12px 24px;border-radius:12px;font-weight:700;">Total: ‚Çπ${total.toLocaleString()}</div>
      </div>
      <button onclick="addExpenseForm()" style="margin-bottom:20px;padding:10px 20px;background:#667eea;color:white;border:none;border-radius:10px;cursor:pointer;font-size:14px;">+ Add Expense</button>
      <div id="expense-form" style="display:none;background:white;border:1px solid #e2e8f0;border-radius:12px;padding:20px;margin-bottom:20px;">
        <input id="exp-category" placeholder="Category (e.g. Supplies)" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:10px;box-sizing:border-box;">
        <input id="exp-amount" type="number" placeholder="Amount (‚Çπ)" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:10px;box-sizing:border-box;">
        <input id="exp-note" placeholder="Note" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:10px;box-sizing:border-box;">
        <button onclick="saveExpense()" style="padding:10px 20px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;">Save</button>
      </div>
      ${expenses.length === 0 ? '<div style="text-align:center;padding:40px;color:#64748b;">No expenses recorded yet.</div>' :
        expenses.map(e=>`<div style="background:white;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:10px;display:flex;justify-content:space-between;">
          <div><div style="font-weight:600;">${e.category||'General'}</div><div style="color:#64748b;font-size:13px;">${e.note||''} | ${e.date||''}</div></div>
          <div style="font-weight:700;color:#ef4444;">‚Çπ${parseFloat(e.amount||0).toLocaleString()}</div>
        </div>`).join('')}
    </div>`;
}

function addExpenseForm() {
  const f = document.getElementById('expense-form');
  if (f) f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function saveExpense() {
  const cat = document.getElementById('exp-category').value;
  const amt = document.getElementById('exp-amount').value;
  const note = document.getElementById('exp-note').value;
  if (!cat || !amt) { alert('Please fill category and amount.'); return; }
  if (!state.expenses) state.expenses = [];
  state.expenses.push({ id: Date.now(), category: cat, amount: parseFloat(amt), note: note, date: new Date().toLocaleDateString() });
  DataStore.save('expenses', state.expenses);
  renderExpenses();
}

function renderReports() {
  const app = document.getElementById('app');
  if (!app) return;
  const pts = state.patients || [];
  const bills = state.bills || [];
  const expenses = state.expenses || [];
  const revenue = bills.reduce((s,b)=>s+(parseFloat(b.totalAmount)||0),0);
  const expTotal = expenses.reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
  app.innerHTML = renderSidebar('#reports') + `
    <div class="main-content" style="padding:24px;">
      <h2 style="color:#1e293b;margin-bottom:24px;font-size:24px;font-weight:700;">üìà Reports</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
        <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:24px;text-align:center;">
          <div style="font-size:36px;font-weight:700;color:#667eea;">${pts.length}</div>
          <div style="color:#64748b;margin-top:4px;">Total Patients</div>
        </div>
        <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:24px;text-align:center;">
          <div style="font-size:36px;font-weight:700;color:#10b981;">‚Çπ${revenue.toLocaleString()}</div>
          <div style="color:#64748b;margin-top:4px;">Total Revenue</div>
        </div>
        <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:24px;text-align:center;">
          <div style="font-size:36px;font-weight:700;color:#ef4444;">‚Çπ${expTotal.toLocaleString()}</div>
          <div style="color:#64748b;margin-top:4px;">Total Expenses</div>
        </div>
        <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:24px;text-align:center;">
          <div style="font-size:36px;font-weight:700;color:#f59e0b;">‚Çπ${(revenue-expTotal).toLocaleString()}</div>
          <div style="color:#64748b;margin-top:4px;">Net Profit</div>
        </div>
      </div>
    </div>`;
}

function renderPayroll() {
  const app = document.getElementById('app');
  if (!app) return;
  const staff = state.staff || [];
  app.innerHTML = renderSidebar('#payroll') + `
    <div class="main-content" style="padding:24px;">
      <h2 style="color:#1e293b;margin-bottom:24px;font-size:24px;font-weight:700;">üíº Payroll</h2>
      ${staff.length === 0 ? '<div style="text-align:center;padding:60px;color:#64748b;"><div style="font-size:48px;margin-bottom:16px;">üíº</div><p>No staff records. Add staff in Settings.</p></div>' :
        staff.map(s=>`<div style="background:white;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;">
          <div><div style="font-weight:600;">${s.name}</div><div style="color:#64748b;font-size:13px;">${s.role||'-'}</div></div>
          <div style="font-weight:700;color:#10b981;">‚Çπ${(s.salary||0).toLocaleString()}/mo</div>
        </div>`).join('')}
    </div>`;
}

function renderMedicines() {
  const app = document.getElementById('app');
  if (!app) return;
  const meds = state.medicines || [];
  app.innerHTML = renderSidebar('#medicines') + `
    <div class="main-content" style="padding:24px;">
      <h2 style="color:#1e293b;margin-bottom:24px;font-size:24px;font-weight:700;">üíä Medicines (${meds.length})</h2>
      ${meds.length === 0 ? '<div style="text-align:center;padding:60px;color:#64748b;"><div style="font-size:48px;margin-bottom:16px;">üíä</div><p>No medicines added yet.</p></div>' :
        meds.map(m=>`<div style="background:white;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:10px;display:flex;justify-content:space-between;">
          <div><div style="font-weight:600;">${m.name}</div><div style="color:#64748b;font-size:13px;">${m.type||''} | ${m.dosage||''}</div></div>
          <div style="color:#667eea;font-size:13px;">Stock: ${m.stock||0}</div>
        </div>`).join('')}
    </div>`;
}

function renderSettings() {
  const app = document.getElementById('app');
  if (!app) return;
  const cfg = state.config || {};
  app.innerHTML = renderSidebar('#settings') + `
    <div class="main-content" style="padding:24px;">
      <h2 style="color:#1e293b;margin-bottom:24px;font-size:24px;font-weight:700;">‚öôÔ∏è Settings</h2>
      <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:24px;max-width:600px;">
        <h3 style="margin-bottom:16px;color:#1e293b;">Clinic Information</h3>
        <div style="margin-bottom:12px;"><label style="color:#64748b;font-size:13px;">Clinic Name</label>
          <input id="cfg-name" value="${cfg.clinicName||'Aura Dental Care'}" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;margin-top:4px;box-sizing:border-box;"></div>
        <div style="margin-bottom:12px;"><label style="color:#64748b;font-size:13px;">Phone</label>
          <input id="cfg-phone" value="${cfg.clinicPhone||''}" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;margin-top:4px;box-sizing:border-box;"></div>
        <div style="margin-bottom:12px;"><label style="color:#64748b;font-size:13px;">Address</label>
          <input id="cfg-addr" value="${cfg.clinicAddress||''}" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;margin-top:4px;box-sizing:border-box;"></div>
        <button onclick="saveSettings()" style="padding:12px 24px;background:#667eea;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:600;">Save Settings</button>
      </div>
    </div>`;
}

function saveSettings() {
  if (!state.config) state.config = {};
  state.config.clinicName = document.getElementById('cfg-name').value;
  state.config.clinicPhone = document.getElementById('cfg-phone').value;
  state.config.clinicAddress = document.getElementById('cfg-addr').value;
  DataStore.save('config', state.config);
  alert('Settings saved!');
}

// ================== INIT FUNCTION ==================
function init() {
  console.log('üöÄ Initializing app...');
  
  loadState();
  
  if (checkAuth()) {
    console.log('‚úÖ User logged in:', state.currentUser.name);
    render();
  } else {
    console.log('‚ÑπÔ∏è No user logged in - showing login');
    renderLogin();
  }
  
  // Setup hash change listener
  window.addEventListener('hashchange', render);
  
  console.log('‚úÖ App initialized successfully!');
}

// ================== AUTO START ==================
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

console.log('‚úÖ Initialization code loaded');

// Initialize consultation form state
if (typeof state !== 'undefined') {
  state.consultationForm = {
    patientId: null,
    doctorId: null,
    chairId: null,
    selectedTeeth: [],
    selectedMedicines: [],
    selectedTreatments: [],
    customTreatment: '',
    customCost: '',
    notes: '',
    nextVisit: '',
    chiefComplaint: '',  // Now filled by DOCTOR, not reception
    diagnosis: '',
    selectedTests: []
  };
}

// ================== STATE EXTENSIONS ==================
// Add additional state properties after main initialization
if (typeof state !== 'undefined') {
  // Patient queue for doctors (after consultation payment)
  state.doctorQueue = [];  // Patients who paid consultation fee, waiting for doctor
  
  // NEW OPD WORKFLOW
  state.opdRecords = [];  // Complete OPD records (chief complaint, diagnosis, procedure)
  state.pendingBills = [];  // Bills sent to Print Bill Section (reception)
  state.pendingPrescriptions = [];  // Prescriptions sent to Print Prescription Section (reception)
  
  // Digital OPD workflow
  state.digitalOPDs = [];  // All digital OPD forms
  state.opdQueue = {};  // Queue organized by doctor ID
};

// ========== CHIEF COMPLAINT LIBRARY ==========
const chiefComplaintLibrary = [
  "Toothache / Severe Pain",
  "Bleeding Gums",
  "Cavity / Tooth Decay",
  "Missing Tooth",
  "Loose Tooth",
  "Swelling in Gums",
  "Sensitivity (Hot/Cold)",
  "Broken/Chipped Tooth",
  "Stained/Yellow Teeth",
  "Wisdom Tooth Pain",
  "Bad Breath (Halitosis)",
  "Braces / Orthodontic Query",
  "Scaling / Cleaning",
  "Routine Checkup"
];

// Alias for compatibility
const DENTAL_ISSUES = chiefComplaintLibrary;


// ========== ROLE-BASED PERMISSIONS SYSTEM ==========
const sidebarPermissions = {
  doctor: {
    dashboard: true,
    patients: true,
    appointments: true,
    doctorsSection: true,   // All clinical work here
    walkin: false,
    collectPayment: false,  // Reception only
    printBillRx: false,     // Reception only
    bookings: false,
    display: false,
    reports: true,
    expenses: false,
    payroll: false,
    medicines: true,
    settings: false
  },
  receptionist: {
    dashboard: true,
    patients: true,
    appointments: true,
    doctorsSection: false,
    walkin: true,           // Register patients + queue
    collectPayment: true,   // Collect payment + assign chair
    printBillRx: true,      // Print bill + prescription
    bookings: true,
    display: true,
    reports: false,
    expenses: true,
    payroll: false,
    medicines: false,
    settings: false
  },
  admin: {
    dashboard: true,
    patients: true,
    appointments: true,
    doctorsSection: true,
    walkin: true,
    collectPayment: true,
    printBillRx: true,
    bookings: true,
    display: true,
    reports: true,
    expenses: true,
    payroll: true,
    medicines: true,
    settings: true
  }
};

// Helper function for sidebar items
function sidebarItem({ allowed, active, hash, icon, label }) {
  if (allowed) {
    return `
      <div class="sidebar-item ${active ? 'active' : ''}"
           onclick="window.location.hash='${hash}'">
        <span class="sidebar-item-icon">${icon}</span>
        <span>${label}</span>
      </div>
    `;
  }
  return `
    <div class="sidebar-item disabled"
         data-tooltip="Access restricted for your role"
         onclick="event.preventDefault()">
      <span class="sidebar-item-icon">${icon}</span>
      <span>${label}</span>
    </div>
  `;
}

// ========== INITIALIZE DATA ==========
function initializeData() {
  // Load state from localStorage or use empty defaults
  state.prescriptions = DataStore.load('prescriptions', []);
  state.digitalOPDs = DataStore.load('digitalOPDs', []);
  state.opdQueue = DataStore.load('opdQueue', {});
  state.bookingRequests = DataStore.load('bookingRequests', []);
  state.patients = DataStore.load('patients', []);
  state.appointments = DataStore.load('appointments', []);
  state.expenses = DataStore.load('expenses', []);

  // Initialize Doctors - Updated for your Raipur Clinic
  const savedDoctors = DataStore.load('doctors', null);
  if (!savedDoctors || savedDoctors.length === 0) {
    state.doctors = [
      { id: 1, name: 'Dr. Sahil Chawla', specialty: 'Dental Surgeon', email: 'sahil@auradental.com', password: 'doctor123' },
      { id: 2, name: 'Dr. Kiran Kumar', specialty: 'Orthodontist', email: 'kiran@auradental.com', password: 'doctor123' },
      { id: 3, name: 'Dr. Priyal Sharma', specialty: 'Endodontist', email: 'priyal@auradental.com', password: 'doctor123' }
    ];
    DataStore.save('doctors', state.doctors);
  } else {
    state.doctors = savedDoctors;
  }

  // Initialize Staff
  const savedStaff = DataStore.load('staff', null);
  if (!savedStaff || savedStaff.length === 0) {
    state.staff = [
      { id: 1, name: 'Emma Wilson', role: 'Receptionist', salary: 25000 },
      { id: 2, name: 'James Brown', role: 'Dental Assistant', salary: 20000 }
    ];
    DataStore.save('staff', state.staff);
  } else {
    state.staff = savedStaff;
  }

  // Initialize Medicine Master List
  const savedMedicines = DataStore.load('medicines', null);
  if (!savedMedicines || savedMedicines.length === 0) {
    state.medicines = [
      { id: 1, name: 'IBUPROFEN', category: 'Analgesic', dosage: '400mg', frequency: 'TDS', duration: '3 days', cost: 80 },
      { id: 2, name: 'AMOXICILLIN', category: 'Antibiotic', dosage: '500mg', frequency: 'TDS', duration: '5 days', cost: 150 },
      { id: 3, name: 'PANTOPRAZOLE', category: 'Antacid', dosage: '40mg', frequency: 'OD', duration: '5 days', cost: 100 },
      { id: 4, name: 'CHLORHEXIDINE MOUTHWASH', category: 'Antiseptic', dosage: '10ml', frequency: 'BD', duration: '7 days', cost: 120 },
      { id: 5, name: 'PARACETAMOL', category: 'Analgesic', dosage: '650mg', frequency: 'TDS', duration: '3 days', cost: 50 },
      { id: 6, name: 'METRONIDAZOLE', category: 'Antibiotic', dosage: '400mg', frequency: 'TDS', duration: '5 days', cost: 90 },
      { id: 7, name: 'AMOXICILLIN + CLAVULANIC ACID', category: 'Antibiotic', dosage: '625mg', frequency: 'BD', duration: '5 days', cost: 200 }
    ];
    DataStore.save('medicines', state.medicines);
  } else {
    state.medicines = savedMedicines;
  }

  // Initialize Treatment Chairs
  const savedChairs = DataStore.load('chairs', null);
  if (!savedChairs || savedChairs.length === 0) {
    state.chairs = Array.from({ length: 6 }, (_, i) => ({ id: i + 1, status: 'available' }));
    DataStore.save('chairs', state.chairs);
  } else {
    state.chairs = savedChairs;
  }

  // Load Clinic Configuration
  state.config = DataStore.load('config', { 
    doctorSharePercent: 60, 
    receptionistCommissionPercent: 2,
    revenueShareModel: 'equal',
    numberOfDoctors: 3,
    clinicPhone: '91xxxxxxxxxx',
    clinicAddress: 'Aura Dental Care, Raipur, Chhattisgarh'
  });

  // Initialize Treatments Master List
  const savedTreatments = DataStore.load('treatments', null);
  if (!savedTreatments || savedTreatments.length === 0) {
    state.treatments = [
      { id: 1, name: 'Consultation', cost: 500 },
      { id: 2, name: 'Scaling & Polishing', cost: 1500 },
      { id: 3, name: 'Tooth Extraction (Simple)', cost: 2000 },
      { id: 4, name: 'Tooth Extraction (Surgical)', cost: 3500 },
      { id: 5, name: 'Root Canal Treatment (Single Root)', cost: 5000 },
      { id: 6, name: 'Root Canal Treatment (Multi Root)', cost: 7000 },
      { id: 7, name: 'Filling (Composite)', cost: 1200 },
      { id: 8, name: 'Filling (Amalgam)', cost: 800 },
      { id: 9, name: 'Crown (Ceramic)', cost: 8000 },
      { id: 10, name: 'Crown (Metal)', cost: 4000 },
      { id: 11, name: 'Crown (Zirconia)', cost: 12000 },
      { id: 12, name: 'Teeth Whitening', cost: 10000 },
      { id: 13, name: 'Braces Installation', cost: 35000 },
      { id: 14, name: 'Braces Adjustment', cost: 1000 },
      { id: 15, name: 'Dentures (Full Set)', cost: 25000 },
      { id: 16, name: 'Dentures (Partial)', cost: 15000 },
      { id: 17, name: 'Implant', cost: 30000 },
      { id: 18, name: 'Emergency Treatment', cost: 1500 },
      { id: 19, name: 'Teeth Cleaning (Deep)', cost: 2500 },
      { id: 20, name: 'X-Ray (Single)', cost: 300 },
      { id: 21, name: 'X-Ray (Full Mouth)', cost: 1200 },
      { id: 22, name: 'Custom Orthodontic Work', cost: 5000 },
      { id: 23, name: 'Gum Treatment', cost: 3000 },
      { id: 24, name: 'Wisdom Tooth Removal', cost: 4000 }
    ];
    DataStore.save('treatments', state.treatments);
  } else {
    state.treatments = savedTreatments;
  }
  
  // Initialize Bills History
  state.bills = DataStore.load('bills', []);
  
  // Initialize NEW workflow data structures
  state.doctorQueue = DataStore.load('doctorQueue', []);
  state.treatmentPlans = DataStore.load('treatmentPlans', []);
  
  // Initialize NEW OPD workflow
  state.opdRecords = DataStore.load('opdRecords', []);
  state.pendingBills = DataStore.load('pendingBills', []);
  state.pendingPrescriptions = DataStore.load('pendingPrescriptions', []);

  
}

// ========== UTILITY FUNCTIONS ==========
// ============================================================
// üì± MOBILE MENU FUNCTIONS
// ============================================================

function mobileMenuButton() {
  return '<button class="mobile-menu-btn" onclick="toggleMobileSidebar()" aria-label="Toggle Menu">‚ò∞</button>';
}

function toggleMobileSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.querySelector('.mobile-overlay');
  if (sidebar && overlay) {
    sidebar.classList.toggle('mobile-open');
    overlay.classList.toggle('visible');
  }
}

function closeMobileSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.querySelector('.mobile-overlay');
  if (sidebar && overlay) {
    sidebar.classList.remove('mobile-open');
    overlay.classList.remove('visible');
  }
}

// Auto-close sidebar on mobile when navigating
window.addEventListener('hashchange', () => {
  if (window.innerWidth <= 768) closeMobileSidebar();
});

// ============================================================
// üîß HELPER FUNCTIONS
// ============================================================

function formatIndianCurrency(amount) {
  if (!amount || amount === 0) return '‚Çπ 0';
  const num = parseInt(amount);
  
  // For amounts >= 1 crore, show in crores
  if (num >= 10000000) {
    const crores = (num / 10000000).toFixed(2);
    return '‚Çπ ' + crores + ' Cr';
  }
  
  // For amounts >= 1 lakh, show in lakhs
  if (num >= 100000) {
    const lakhs = (num / 100000).toFixed(2);
    return '‚Çπ ' + lakhs + ' L';
  }
  
  // For smaller amounts, use comma format
  const x = num.toString();
  let lastThree = x.substring(x.length - 3);
  const otherNumbers = x.substring(0, x.length - 3);
  if (otherNumbers !== '') {
    lastThree = ',' + lastThree;
  }
  const formatted = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + lastThree;
  return '‚Çπ ' + formatted;
}

function formatIndianDate(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}-${month}-${year}`;
}

function generateId(array) {
  return array.length > 0 ? Math.max(...array.map(item => item.id)) + 1 : 1;
}

function saveAllData() {
  DataStore.save('patients', state.patients);
  DataStore.save('appointments', state.appointments);
  DataStore.save('expenses', state.expenses);
  DataStore.save('medicines', state.medicines);
  DataStore.save('prescriptions', state.prescriptions);
  DataStore.save('bookingRequests', state.bookingRequests);
  DataStore.save('bills', state.bills);
  DataStore.save('treatments', state.treatments);
  DataStore.save('chairs', state.chairs);
  DataStore.save('config', state.config);
  DataStore.save('staff', state.staff);
  
  // Save NEW workflow data structures
  DataStore.save('doctorQueue', state.doctorQueue);
  DataStore.save('treatmentPlans', state.treatmentPlans);
  
  // Save NEW OPD workflow
  DataStore.save('opdRecords', state.opdRecords);
  DataStore.save('pendingBills', state.pendingBills);
  DataStore.save('pendingPrescriptions', state.pendingPrescriptions);
}

// ========== NAVIGATION ==========
function navigate() {
  const hash = window.location.hash || '#login';
  if (!state.currentUser && hash !== '#login') {
    window.location.hash = '#login';
    return;
  }
  
  switch (hash) {
    case '#login': renderLogin(); break;
    case '#calendar': renderCalendar(); break;
    case '#dashboard': renderDashboard(); break;
    case '#patients': renderPatients(); break;
    case '#appointments': renderAppointments(); break;
    case '#doctors-section': renderDoctorsSection(); break;
    case '#billing-section': renderTreatmentPlansReception(); break;  // Collect Payment
    case '#prescription-section': renderPrescriptionSection(); break;  // Print Bills & Rx
    case '#bookings': renderOnlineBooking(); break;
    case '#walkin': renderWalkInBooking(); break;
    case '#display': renderDisplayScreen(); break;
    case '#reports': renderReports(); break;
    case '#expenses': renderExpenses(); break;
    case '#payroll': renderPayroll(); break;
    case '#medicines': renderMedicines(); break;
    case '#settings': renderSettings(); break;
    // Legacy routes redirect to correct pages
    case '#opd-section': renderDoctorsSection(); break;
    case '#billing': renderTreatmentPlansReception(); break;
    case '#print-bill': renderPrescriptionSection(); break;
    case '#print-prescription': renderPrescriptionSection(); break;
    case '#billing-treatment': renderTreatmentPlansReception(); break;
    default: renderDashboard();
  }
}
function renderSidebar(activeItem) {
  const role = state.currentUser.role;
  const pendingBookings = state.bookingRequests ? state.bookingRequests.filter(b => b.status === 'pending').length : 0;
  const pendingRx = state.bills ? state.bills.filter(b => b.medicines && b.medicines.length > 0 && !b.prescriptionPrinted).length : 0;

  // Role-specific sidebar menus (clean & focused)
  let menuItems = '';
  
  if (role === 'receptionist') {
    // ‚ïê‚ïê‚ïê RECEPTIONIST SIDEBAR ‚ïê‚ïê‚ïê
    menuItems = `
      <div class="sidebar-item ${activeItem==='#dashboard' ? 'active' : ''}" onclick="window.location.hash='#dashboard'">
        <span class="sidebar-item-icon">üìä</span>
        <span>Dashboard</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#walkin' ? 'active' : ''}" onclick="window.location.hash='#walkin'">
        <span class="sidebar-item-icon">üìã</span>
        <span>OPD Registration</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#patients' ? 'active' : ''}" onclick="window.location.hash='#patients'">
        <span class="sidebar-item-icon">üë•</span>
        <span>Patients</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#appointments' ? 'active' : ''}" onclick="window.location.hash='#appointments'">
        <span class="sidebar-item-icon">üìÖ</span>
        <span>Appointments</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#billing-section' ? 'active' : ''}" onclick="window.location.hash='#billing-section'">
        <span class="sidebar-item-icon">üí∞</span>
        <span>Collect Payment</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#prescription-section' ? 'active' : ''}" onclick="window.location.hash='#prescription-section'">
        <span class="sidebar-item-icon">üñ®Ô∏è</span>
        <span>Print Bills & Rx</span>
        ${pendingRx > 0 ? '<span class="notification-badge">' + pendingRx + '</span>' : ''}
      </div>
      
      <div class="sidebar-item ${activeItem==='#bookings' ? 'active' : ''}" onclick="window.location.hash='#bookings'">
        <span class="sidebar-item-icon">üì±</span>
        <span>Online Bookings</span>
        ${pendingBookings > 0 ? '<span class="notification-badge" style="background:#3b82f6;">' + pendingBookings + '</span>' : ''}
      </div>
      
      <div class="sidebar-item ${activeItem==='#display' ? 'active' : ''}" onclick="window.location.hash='#display'">
        <span class="sidebar-item-icon">üñ•Ô∏è</span>
        <span>Display Screen</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#expenses' ? 'active' : ''}" onclick="window.location.hash='#expenses'">
        <span class="sidebar-item-icon">üí∏</span>
        <span>Expenses</span>
      </div>
    `;
    
  } else if (role === 'doctor') {
    // ‚ïê‚ïê‚ïê DOCTOR SIDEBAR ‚ïê‚ïê‚ïê
    menuItems = `
      <div class="sidebar-item ${activeItem==='#dashboard' ? 'active' : ''}" onclick="window.location.hash='#dashboard'">
        <span class="sidebar-item-icon">üìä</span>
        <span>Dashboard</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#doctors-section' ? 'active' : ''}" onclick="window.location.hash='#doctors-section'">
        <span class="sidebar-item-icon">üë®‚Äç‚öïÔ∏è</span>
        <span>Consultation</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#patients' ? 'active' : ''}" onclick="window.location.hash='#patients'">
        <span class="sidebar-item-icon">üë•</span>
        <span>My Patients</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#appointments' ? 'active' : ''}" onclick="window.location.hash='#appointments'">
        <span class="sidebar-item-icon">üìÖ</span>
        <span>My Schedule</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#medicines' ? 'active' : ''}" onclick="window.location.hash='#medicines'">
        <span class="sidebar-item-icon">üíä</span>
        <span>Drug Reference</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#reports' ? 'active' : ''}" onclick="window.location.hash='#reports'">
        <span class="sidebar-item-icon">üìà</span>
        <span>My Reports</span>
      </div>
    `;
    
  } else if (role === 'admin') {
    // ‚ïê‚ïê‚ïê ADMIN SIDEBAR (Complete Access) ‚ïê‚ïê‚ïê
    menuItems = `
      <div class="sidebar-item ${activeItem==='#dashboard' ? 'active' : ''}" onclick="window.location.hash='#dashboard'">
        <span class="sidebar-item-icon">üìä</span>
        <span>Dashboard</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#walkin' ? 'active' : ''}" onclick="window.location.hash='#walkin'">
        <span class="sidebar-item-icon">üìã</span>
        <span>OPD Registration</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#patients' ? 'active' : ''}" onclick="window.location.hash='#patients'">
        <span class="sidebar-item-icon">üë•</span>
        <span>Patients</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#appointments' ? 'active' : ''}" onclick="window.location.hash='#appointments'">
        <span class="sidebar-item-icon">üìÖ</span>
        <span>Appointments</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#doctors-section' ? 'active' : ''}" onclick="window.location.hash='#doctors-section'">
        <span class="sidebar-item-icon">üë®‚Äç‚öïÔ∏è</span>
        <span>Doctor Section</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#billing-section' ? 'active' : ''}" onclick="window.location.hash='#billing-section'">
        <span class="sidebar-item-icon">üí∞</span>
        <span>Collect Payment</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#prescription-section' ? 'active' : ''}" onclick="window.location.hash='#prescription-section'">
        <span class="sidebar-item-icon">üñ®Ô∏è</span>
        <span>Print Bills & Rx</span>
        ${pendingRx > 0 ? '<span class="notification-badge">' + pendingRx + '</span>' : ''}
      </div>
      
      <div class="sidebar-item ${activeItem==='#bookings' ? 'active' : ''}" onclick="window.location.hash='#bookings'">
        <span class="sidebar-item-icon">üì±</span>
        <span>Online Bookings</span>
        ${pendingBookings > 0 ? '<span class="notification-badge" style="background:#3b82f6;">' + pendingBookings + '</span>' : ''}
      </div>
      
      <div class="sidebar-item ${activeItem==='#display' ? 'active' : ''}" onclick="window.location.hash='#display'">
        <span class="sidebar-item-icon">üñ•Ô∏è</span>
        <span>Display Screen</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#reports' ? 'active' : ''}" onclick="window.location.hash='#reports'">
        <span class="sidebar-item-icon">üìà</span>
        <span>Reports</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#expenses' ? 'active' : ''}" onclick="window.location.hash='#expenses'">
        <span class="sidebar-item-icon">üí∏</span>
        <span>Expenses</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#medicines' ? 'active' : ''}" onclick="window.location.hash='#medicines'">
        <span class="sidebar-item-icon">üíä</span>
        <span>Medicines</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#payroll' ? 'active' : ''}" onclick="window.location.hash='#payroll'">
        <span class="sidebar-item-icon">üíº</span>
        <span>Payroll</span>
      </div>
      
      <div class="sidebar-item ${activeItem==='#settings' ? 'active' : ''}" onclick="window.location.hash='#settings'">
        <span class="sidebar-item-icon">‚öôÔ∏è</span>
        <span>Settings</span>
      </div>
    `;
  }

  return `
    <!-- Mobile Overlay (click to close sidebar) -->
    <div class="mobile-overlay" onclick="closeMobileSidebar()"></div>
    
    <div class="sidebar">
      <div class="sidebar-logo">
        <span class="sidebar-logo-icon">ü¶∑</span>
        <span>Aura Dental</span>
      </div>
      <div class="sidebar-menu">
        ${menuItems}
        
        <div class="sidebar-item" onclick="logout()">
          <span class="sidebar-item-icon">üö™</span>
          <span>Logout</span>
        </div>
      </div>
    </div>
  `;
}

// Helper function to auto-fill login credentials
function fillLogin(email, password, role) {
  document.getElementById('login-email').value = email;
  document.getElementById('login-password').value = password;
  document.getElementById('login-role').value = role;
}

// ========== LOGIN ==========
function renderLogin() {
  // Build dynamic user list
  const allUsers = [
    { name: 'Admin', email: 'admin@auradental.com', password: 'admin123', role: 'admin', icon: 'üëë', color: '#f59e0b' }
  ];
  
  state.doctors.forEach(doctor => {
    allUsers.push({
      name: doctor.name,
      email: doctor.email,
      password: doctor.password,
      role: 'doctor',
      icon: 'üë®‚Äç‚öïÔ∏è',
      color: '#3b82f6'
    });
  });
  
  allUsers.push({
    name: 'Receptionist',
    email: 'receptionist@auradental.com',
    password: 'reception123',
    role: 'receptionist',
    icon: 'üëî',
    color: '#10b981'
  });

  const html = `
    <div style="min-height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;padding:20px;">
      <div style="background:white;border-radius:24px;padding:40px;max-width:500px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        
        <div style="text-align:center;margin-bottom:30px;">
          <svg width="280" height="100" viewBox="0 0 280 100" xmlns="http://www.w3.org/2000/svg">
            <rect width="280" height="100" fill="#000000" rx="8"/>
            <defs>
              <linearGradient id="toothGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#4dd0e1"/>
                <stop offset="100%" style="stop-color:#9c27b0"/>
              </linearGradient>
            </defs>
            <ellipse cx="140" cy="40" rx="20" ry="25" fill="white" stroke="url(#toothGrad)" stroke-width="3"/>
            <circle cx="125" cy="25" r="2" fill="#4dd0e1"/><circle cx="130" cy="22" r="3" fill="#9c27b0"/>
            <circle cx="155" cy="25" r="2" fill="#4dd0e1"/><circle cx="150" cy="22" r="3" fill="#9c27b0"/>
            <text x="140" y="78" font-family="'Brush Script MT',cursive" font-size="32" fill="#4dd0e1" text-anchor="middle">Aura</text>
            <text x="140" y="92" font-family="Arial" font-size="9" fill="#d1d5db" text-anchor="middle" letter-spacing="2">‚Äî DENTAL CARE ‚Äî</text>
          </svg>
        </div>
        
        <h1 style="font-size:32px;font-weight:700;text-align:center;color:#1e293b;margin-bottom:30px;">Sign In</h1>
        
        <form onsubmit="login();return false;" autocomplete="on">
        <div style="margin-bottom:20px;position:relative;">
          <span style="position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:20px;">üìß</span>
          <input type="email" id="login-email" name="email" autocomplete="username" placeholder="email@example.com" 
                 style="width:100%;padding:16px 20px 16px 50px;border:2px solid #4ade80;border-radius:12px;font-size:16px;box-sizing:border-box;">
        </div>
        
        <div style="margin-bottom:20px;position:relative;">
          <span style="position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:20px;">üîí</span>
          <input type="password" id="login-password" name="password" autocomplete="current-password" placeholder="Password" 
                 style="width:100%;padding:16px 20px 16px 50px;border:2px solid #4ade80;border-radius:12px;font-size:16px;box-sizing:border-box;">
        </div>
        
        <div style="margin-bottom:20px;position:relative;">
          <span style="position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:20px;">üë§</span>
          <select id="login-role" name="role"
                  style="width:100%;padding:16px 20px 16px 50px;border:2px solid #4ade80;border-radius:12px;font-size:16px;box-sizing:border-box;">
            <option value="admin">Admin</option>
            <option value="doctor">Doctor</option>
            <option value="receptionist">Receptionist</option>
          </select>
        </div>
        
        <button type="submit"
                style="width:100%;padding:18px;background:linear-gradient(135deg,#667eea,#f093fb);color:white;border:none;border-radius:12px;font-size:18px;font-weight:700;cursor:pointer;margin-top:20px;">
          Sign In
        </button>
        </form>
        
        <div style="margin-top:30px;text-align:center;">
          <div style="font-size:14px;color:#64748b;margin-bottom:15px;">
            üìã Click to Auto-Fill Login:
          </div>
          
          ${allUsers.map(user => `
            <div onclick="fillLogin('${user.email}','${user.password}','${user.role}')" 
                 style="padding:12px 16px;border:2px solid #e2e8f0;border-left:4px solid ${user.color};border-radius:10px;background:#f8fafc;cursor:pointer;margin-bottom:10px;text-align:left;">
              <div style="font-weight:600;color:#1e293b;">
                <span>${user.icon}</span> ${user.name}
              </div>
              <div style="font-size:12px;color:#64748b;margin-top:4px;">
                Email: ${user.email} | Password: ${user.password}
              </div>
            </div>
          `).join('')}
        </div>
        
        <button onclick="if(confirm('Reset all app data?')) { localStorage.clear(); location.reload(); }" 
                style="margin-top:20px;padding:12px;background:transparent;border:2px solid #e2e8f0;border-radius:10px;color:#3b82f6;cursor:pointer;font-size:14px;width:100%;">
          üîÑ Reset App Data
        </button>
        
      </div>
    </div>
  `;
  
  document.getElementById('app').innerHTML = html;
}


function renderDisplayScreen() {
  var app = document.getElementById('app');
  if (!app) return;
  var queue = state.doctorQueue || [];
  var chairs = state.chairs || [];
  var pts = state.patients || [];
  var doctors = state.doctors || [];
  var cfg = state.config || {};
  var waiting = queue.filter(function(q){ return q.status==='waiting'; });
  var withDoctor = queue.filter(function(q){ return q.status==='with-doctor'||q.status==='in-consultation'; });
  var chairList = chairs.length ? chairs : [{id:1,name:'Chair 1'},{id:2,name:'Chair 2'},{id:3,name:'Chair 3'},{id:4,name:'Chair 4'},{id:5,name:'Chair 5'},{id:6,name:'Chair 6'}];
  var dotG = '<span style="display:inline-block;width:18px;height:18px;background:#22c55e;border-radius:50%;flex-shrink:0;"></span>';
  var dotR = '<span style="display:inline-block;width:18px;height:18px;background:#ef4444;border-radius:50%;flex-shrink:0;"></span>';
  var chairRows = '';
  chairList.forEach(function(ch) {
    var qe = queue.find(function(q){ return q.chairId===ch.id&&(q.status==='with-doctor'||q.status==='in-consultation'); });
    var pt = qe ? pts.find(function(p){ return p.id===qe.patientId; }) : null;
    var dr = qe ? doctors.find(function(d){ return d.id===qe.doctorId; }) : null;
    var occ = !!qe;
    var bg = occ?'linear-gradient(135deg,#ef4444,#dc2626)':'linear-gradient(135deg,#10b981,#059669)';
    chairRows += '<div style="background:'+bg+';border-radius:16px;padding:16px 18px;display:flex;align-items:center;gap:14px;box-shadow:0 4px 16px rgba(0,0,0,0.3);margin-bottom:10px;">'
      +'<div>'+(occ?dotR:dotG)+'</div>'
      +'<div style="flex:1;"><div style="font-size:15px;font-weight:800;color:white;">'+(ch.name||'Chair '+ch.id)+'</div>'
      +'<div style="font-size:20px;font-weight:700;color:white;margin-top:3px;">'+(occ?(pt?pt.name:'Patient'):'AVAILABLE')+'</div>'
      +(dr?'<div style="font-size:12px;color:rgba(255,255,255,0.8);margin-top:2px;">'+dr.name+'</div>':'')+'</div>'
      +'<div style="background:rgba(255,255,255,0.2);border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;color:white;">'+(occ?'OCCUPIED':'FREE')+'</div></div>';
  });
  var queueRows = '';
  if (waiting.length===0) {
    queueRows='<div style="text-align:center;padding:40px;color:#94a3b8;font-size:18px;">No patients waiting</div>';
  } else {
    waiting.forEach(function(q,idx){
      var pt=pts.find(function(p){return p.id===q.patientId;});
      var dr=doctors.find(function(d){return d.id===q.doctorId;});
      var isNext=idx===0;
      var bg=isNext?'linear-gradient(135deg,#667eea,#764ba2)':'rgba(255,255,255,0.05)';
      var border=isNext?'#667eea':'rgba(255,255,255,0.1)';
      queueRows+='<div style="display:flex;align-items:center;gap:14px;background:'+bg+';border:2px solid '+border+';border-radius:14px;padding:14px 16px;margin-bottom:10px;">'
        +'<div style="width:44px;height:44px;border-radius:50%;flex-shrink:0;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;color:white;">'+(idx+1)+'</div>'
        +'<div style="flex:1;"><div style="font-size:20px;font-weight:700;color:white;">'+(pt?pt.name:'Patient')+'</div>'
        +'<div style="font-size:13px;color:rgba(255,255,255,0.65);margin-top:3px;">'+(dr?dr.name:'')+(q.time?' - '+q.time:'')+'</div></div>'
        +(isNext?'<div style="background:rgba(255,255,255,0.25);border-radius:8px;padding:6px 12px;font-size:13px;font-weight:700;color:white;">NEXT</div>':'')
        +'</div>';
    });
  }
  var beingSeen='';
  if(withDoctor.length>0){
    beingSeen='<div style="margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1);"><div style="font-size:14px;font-weight:700;color:#f59e0b;margin-bottom:10px;">NOW BEING SEEN</div>';
    withDoctor.forEach(function(q){
      var pt=pts.find(function(p){return p.id===q.patientId;});
      var dr=doctors.find(function(d){return d.id===q.doctorId;});
      beingSeen+='<div style="background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:12px 16px;margin-bottom:8px;">'
        +'<div style="font-size:17px;font-weight:700;color:#fbbf24;">'+(pt?pt.name:'Patient')+'</div>'
        +'<div style="font-size:12px;color:rgba(255,255,255,0.6);">'+(dr?dr.name:'')+'</div></div>';
    });
    beingSeen+='</div>';
  }
  var oCount=chairList.filter(function(ch){return queue.find(function(q){return q.chairId===ch.id&&(q.status==='with-doctor'||q.status==='in-consultation');});}).length;
  var fCount=chairList.length-oCount;
  var phone=cfg.clinicPhone||'+91-XXXXXXXXXX';
  var wCount=waiting.length;
  app.innerHTML=
    '<div style="min-height:100vh;background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%);display:flex;flex-direction:column;">'
    +'<div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(0,0,0,0.4);">'
    +'<div><div style="font-size:24px;font-weight:900;color:white;letter-spacing:1px;">AURA DENTAL CARE</div>'
    +'<div style="font-size:13px;color:rgba(255,255,255,0.8);">Raipur, Chhattisgarh | '+phone+'</div></div>'
    +'<div style="text-align:right;"><div id="disp-time" style="font-size:30px;font-weight:800;color:white;"></div>'
    +'<div id="disp-date" style="font-size:13px;color:rgba(255,255,255,0.8);margin-top:2px;"></div></div></div>'
    +'<div style="flex:1;display:grid;grid-template-columns:1fr 1fr;gap:0;">'
    +'<div style="padding:24px;border-right:1px solid rgba(255,255,255,0.08);overflow-y:auto;">'
    +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">'
    +'<div><div style="font-size:20px;font-weight:800;color:white;">WAITING QUEUE</div>'
    +'<div style="font-size:13px;color:#94a3b8;">'+wCount+' patient'+(wCount!==1?'s':'')+' waiting</div></div>'
    +'<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-size:26px;font-weight:900;width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;">'+wCount+'</div></div>'
    +queueRows+beingSeen+'</div>'
    +'<div style="padding:24px;overflow-y:auto;">'
    +'<div style="margin-bottom:18px;"><div style="font-size:20px;font-weight:800;color:white;">CHAIR STATUS</div>'
    +'<div style="font-size:13px;color:#94a3b8;">'+oCount+' occupied - '+fCount+' available</div></div>'
    +chairRows+'</div></div>'
    +'<div style="background:rgba(0,0,0,0.4);padding:10px 28px;display:flex;align-items:center;justify-content:space-between;border-top:1px solid rgba(255,255,255,0.08);">'
    +'<div style="font-size:13px;color:#64748b;">Aura Dental Care - Raipur</div>'
    +'<div style="font-size:13px;color:#64748b;">Thank you for your patience</div>'
    +'<div style="display:flex;align-items:center;gap:8px;"><div style="width:8px;height:8px;background:#10b981;border-radius:50%;"></div>'
    +'<div style="font-size:12px;color:#94a3b8;">Live</div></div></div></div>';
  function updateClock(){
    var now=new Date();
    var t=document.getElementById('disp-time');
    var d=document.getElementById('disp-date');
    if(t)t.textContent=now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    if(d)d.textContent=now.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  }
  updateClock();
  if(window._dispClockInterval)clearInterval(window._dispClockInterval);
  window._dispClockInterval=setInterval(updateClock,1000);
  if(window._dispRefreshInterval)clearInterval(window._dispRefreshInterval);
  window._dispRefreshInterval=setInterval(function(){if(window.location.hash==='#display')renderDisplayScreen();},15000);
}

function approveBooking(bookingId) {
  const booking = state.bookingRequests.find(b => b.id === bookingId);
  if (!booking) return;

  // Create or find patient
  let patient = state.patients.find(p => p.contact === booking.phone);
  if (!patient) {
    patient = {
      id: generateId(state.patients),
      name: booking.patientName,
      age: booking.age || 0,
      gender: booking.gender || 'Not Specified',
      contact: booking.phone,
      email: booking.email || '',
      address: '',
      registrationDate: new Date().toISOString().split('T')[0],
      source: 'online'
    };
    state.patients.push(patient);
  }

  // Create appointment
  const newAppointment = {
    id: generateId(state.appointments),
    patientId: patient.id,
    doctorId: state.doctors[0].id,
    date: booking.preferredDate,
    time: booking.preferredTime,
    treatment: booking.treatment,
    chairId: 1,
    revenue: 0,
    labCost: 0,
    status: 'scheduled',
    source: 'online',
    notes: booking.notes || ''
  };
  state.appointments.push(newAppointment);

  // Update booking status
  booking.status = 'approved';
  booking.appointmentId = newAppointment.id;

  saveAllData();

  // Send WhatsApp confirmation
  sendBookingConfirmation(booking, newAppointment);

  alert('‚úÖ Booking approved! Patient and appointment created.');
  renderOnlineBooking();
}

function rejectBooking(bookingId) {
  if (confirm('Reject this booking request?')) {
    const booking = state.bookingRequests.find(b => b.id === bookingId);
    booking.status = 'rejected';
    saveAllData();
    alert('‚ùå Booking rejected');
    renderOnlineBooking();
  }
}

function sendBookingConfirmation(booking, apt) {
  const doctor = state.doctors.find(d => d.id === apt.doctorId);

  const message = `
‚úÖ APPOINTMENT CONFIRMED

Dear ${booking.patientName},

Your appointment is confirmed:

üìÖ Date: ${formatIndianDate(apt.date)}
‚è∞ Time: ${apt.time}
üë®‚Äç‚öïÔ∏è Doctor: ${doctor.name}
üè• Clinic: Aura Dental Care

Please arrive 10 minutes early.

For changes, call: ${state.config.clinicPhone}
  `.trim();

  let phone = booking.phone.replace(/[^0-9]/g, '');
  if (phone.length === 10) {
    phone = '91' + phone;
  }

  const encodedMessage = encodeURIComponent(message);
  const whatsappURL = `https://wa.me/${phone}?text=${encodedMessage}`;
  window.open(whatsappURL, '_blank');
}

// ========== MEDICINE MASTER CRUD ==========


function saveMedicineToMaster() {
  const id = document.getElementById('medicine-edit-id').value;
  const name = document.getElementById('medicine-name').value.trim();
  const dosage = document.getElementById('medicine-dosage').value.trim();
  const frequency = document.getElementById('medicine-frequency').value.trim();
  const duration = document.getElementById('medicine-duration').value.trim();
  const cost = parseInt(document.getElementById('medicine-cost').value) || 0;
  const category = document.getElementById('medicine-category').value;
  
  if (!name || !dosage || !frequency || !duration) {
    document.getElementById('medicine-form-error').innerHTML = '<div class="alert alert-error">Please fill all required fields</div>';
    return;
  }
  
  if (id) {
    // Update existing medicine
    const index = state.medicines.findIndex(m => m.id === parseInt(id));
    if (index !== -1) {
      state.medicines[index] = {
        ...state.medicines[index],
        name,
        dosage,
        frequency,
        duration,
        cost,
        category
      };
    }
  } else {
    // Add new medicine
    const newMedicine = {
      id: generateId(state.medicines),
      name,
      dosage,
      frequency,
      duration,
      cost,
      category
    };
    state.medicines.push(newMedicine);
  }
  
  saveAllData();
  closeModal('addMedicineModal');
  alert('‚úÖ Medicine saved successfully!');
  window.location.hash = '#settings'; // Refresh view
}

function deleteMedicineFromMaster(medicineId) {
  if (confirm('Are you sure you want to delete this medicine from the master list?')) {
    state.medicines = state.medicines.filter(m => m.id !== medicineId);
    saveAllData();
    alert('‚úÖ Medicine deleted successfully!');
    window.location.hash = '#settings'; // Refresh view
  }
}

// ========== TREATMENT MASTER CRUD ==========
function showAddTreatmentModal() {
  document.getElementById('treatmentModalTitle').textContent = 'Add Treatment';
  document.getElementById('treatment-edit-id').value = '';
  document.getElementById('treatment-name').value = '';
  document.getElementById('treatment-cost').value = '';
  document.getElementById('treatment-form-error').innerHTML = '';
  document.getElementById('addTreatmentModal').classList.add('show');
}

function editTreatment(treatmentId) {
  const treatment = state.treatments.find(t => t.id === treatmentId);
  if (!treatment) return;
  
  document.getElementById('treatmentModalTitle').textContent = 'Edit Treatment';
  document.getElementById('treatment-edit-id').value = treatment.id;
  document.getElementById('treatment-name').value = treatment.name;
  document.getElementById('treatment-cost').value = treatment.cost;
  document.getElementById('treatment-form-error').innerHTML = '';
  document.getElementById('addTreatmentModal').classList.add('show');
}

function saveTreatmentToMaster() {
  const id = document.getElementById('treatment-edit-id').value;
  const name = document.getElementById('treatment-name').value.trim();
  const cost = parseInt(document.getElementById('treatment-cost').value) || 0;
  
  if (!name || cost <= 0) {
    document.getElementById('treatment-form-error').innerHTML = '<div class="alert alert-error">Please fill all required fields</div>';
    return;
  }
  
  if (id) {
    // Update existing treatment
    const index = state.treatments.findIndex(t => t.id === parseInt(id));
    if (index !== -1) {
      state.treatments[index] = {
        ...state.treatments[index],
        name,
        cost
      };
    }
  } else {
    // Add new treatment
    const newTreatment = {
      id: generateId(state.treatments),
      name,
      cost
    };
    state.treatments.push(newTreatment);
  }
  
  saveAllData();
  closeModal('addTreatmentModal');
  alert('‚úÖ Treatment saved successfully!');
  window.location.hash = '#settings'; // Refresh view
}

function deleteTreatment(treatmentId) {
  if (confirm('Are you sure you want to delete this treatment?')) {
    state.treatments = state.treatments.filter(t => t.id !== treatmentId);
    saveAllData();
    alert('‚úÖ Treatment deleted successfully!');
    window.location.hash = '#settings'; // Refresh view
  }
}

// ========== BILL CRUD ==========
function viewBill(billId) {
  const bill = state.bills.find(b => b.id === billId);
  if (bill) {
    renderBillReceipt(bill);
  }
}

function editBill(billId) {
  const bill = state.bills.find(b => b.id === billId);
  if (!bill) return;
  
  // Populate the billing form with existing bill data
  state.currentBilling = {
    editingBillId: billId,
    patientId: bill.patientId,
    doctorId: bill.doctorId,
    chairId: bill.chairId || null,
    selectedTeeth: [...bill.teeth],
    selectedMedicines: bill.medicines.map(m => m.id),
    selectedTreatments: bill.treatments.map(t => t.id),
    customTreatment: bill.customTreatment || '',
    customCost: bill.customCost || '',
    notes: bill.notes || '',
    nextVisit: bill.nextVisit || ''
  };
  
  alert('üí° Bill loaded for editing. Update the details and generate a new bill.');
  window.location.hash = '#billing';
}

function deleteBill(billId) {
  if (confirm('Are you sure you want to delete this bill? This action cannot be undone.')) {
    state.bills = state.bills.filter(b => b.id !== billId);
    saveAllData();
    alert('‚úÖ Bill deleted successfully!');
    window.location.hash = '#settings'; // Refresh view
  }
}

// Update the generateBillAndPrint function to handle edits
function generateBillAndPrintUpdated() {
  
  
  
  try {
    const { editingBillId, patientId, doctorId, selectedTeeth, selectedMedicines, selectedTreatments, customTreatment, customCost, notes, nextVisit } = state.currentBilling;
    
    
    
    // Detailed validation
    let errors = [];
    if (!patientId) errors.push('‚Ä¢ Select Patient');
    if (!doctorId) errors.push('‚Ä¢ Select Doctor');
    
    if (errors.length > 0) {
      alert('‚ùå REQUIRED FIELDS MISSING:\n\n' + errors.join('\n') + '\n\nPlease complete these fields before generating bill.');
      return;
    }
    
    // Check if at least something is selected
    if (selectedTeeth.length === 0 && selectedMedicines.length === 0 && selectedTreatments.length === 0 && !customTreatment) {
      alert('‚ö†Ô∏è WARNING: No items selected!\n\nPlease select:\n‚Ä¢ Teeth (from tooth chart)\n‚Ä¢ Treatments (procedures)\n‚Ä¢ Medicines\nOR add a custom treatment\n\nAt least one item is required to generate a bill.');
      return;
    }
    
    const total = calculateCurrentBillTotal();
    
    
    if (total === 0) {
      if (!confirm('‚ö†Ô∏è Total amount is ‚Çπ 0\n\nAre you sure you want to generate a bill with zero amount?')) {
        return;
      }
    }
  
  if (editingBillId) {
    // Update existing bill
    const billIndex = state.bills.findIndex(b => b.id === editingBillId);
    if (billIndex !== -1) {
      state.bills[billIndex] = {
        ...state.bills[billIndex],
        teeth: selectedTeeth,
        medicines: selectedMedicines.map(id => state.medicines.find(m => m.id === id)),
        treatments: selectedTreatments.map(id => state.treatments.find(t => t.id === id)),
        customTreatment: customTreatment,
        customCost: customCost ? parseInt(customCost) : 0,
        total: total,
        notes: notes,
        nextVisit: nextVisit,
        lastModified: new Date().toISOString()
      };
      
      saveAllData();
      
      const patient = state.patients.find(p => p.id === patientId);
      alert('‚úÖ BILL UPDATED!\\n\\nPatient: ' + patient.name + '\\nTotal: ' + formatIndianCurrency(total) + '\\n\\nPrinting now...');
      renderBillReceipt(state.bills[billIndex]);
      
      // Reset form
      state.currentBilling = {
        patientId: null,
        doctorId: null,
        chairId: null,
        selectedTeeth: [],
        selectedMedicines: [],
        selectedTreatments: [],
        customTreatment: '',
        customCost: '',
        notes: '',
        nextVisit: ''
      };
      
      setTimeout(() => window.print(), 500);
      return;
    }
  }
  
  // Create new bill (original logic)
  const bill = {
    id: generateId(state.bills),
    billNumber: 'BILL' + Date.now(),
    patientId: patientId,
    doctorId: doctorId,
    date: new Date().toISOString().split('T')[0],
    time: new Date().toLocaleTimeString('en-IN'),
    teeth: selectedTeeth,
    medicines: selectedMedicines.map(id => state.medicines.find(m => m.id === id)),
    treatments: selectedTreatments.map(id => state.treatments.find(t => t.id === id)),
    customTreatment: customTreatment,
    customCost: customCost ? parseInt(customCost) : 0,
    total: total,
    notes: notes,
    nextVisit: nextVisit
  };
  
  state.bills.push(bill);
  saveAllData();
  
  // Auto-generate prescription if medicines selected
  if (selectedMedicines.length > 0) {
    const prescription = {
      id: generateId(state.prescriptions || []),
      billId: bill.id,
      patientId: patientId,
      doctorId: doctorId,
      date: bill.date,
      medicines: bill.medicines,
      teeth: bill.teeth,
      prescriptionNumber: 'PRX' + Date.now(),
      generalInstructions: notes || 'Take medicines as prescribed. Follow up if any issues.'
    };
    
    if (!state.prescriptions) state.prescriptions = [];
    state.prescriptions.push(prescription);
    saveAllData();
  }
  
  const patient = state.patients.find(p => p.id === patientId);
  alert('‚úÖ BILL GENERATED!\n\nPatient: ' + patient.name + '\nTotal: ' + formatIndianCurrency(total) + '\n\nPrinting now...');
  
  // Reset form
  state.currentBilling = {
    patientId: null,
    doctorId: null,
    chairId: null,
    selectedTeeth: [],
    selectedMedicines: [],
    selectedTreatments: [],
    customTreatment: '',
    customCost: '',
    notes: '',
    nextVisit: ''
  };
  
  renderBillReceipt(bill);
  setTimeout(() => window.print(), 500);
  
  } catch (error) {
    console.error('‚ùå ERROR in generateBillAndPrintUpdated:', error);
    alert('‚ùå ERROR GENERATING BILL:\n\n' + error.message + '\n\nCheck console (F12) for details.');
  }
}

function generateUPIQRCode(elementId, amount) {
  const upi = `upi://pay?pa=clinicupi@bank&pn=AURA%20Dental&am=${amount}&cu=INR`;

  const el = document.getElementById(elementId);
  if (!el) return;

  el.innerHTML = "";
  new QRCode(el, {
    text: upi,
    width: 120,
    height: 120
  });
}

function saveConsultationFormFromWalkIn() {
  try {
    const patientId = state.consultationForm.patientId;
    const doctorId = state.consultationForm.doctorId;
    const chairId = state.consultationForm.chairId;
    const selectedTeeth = state.consultationForm.selectedTeeth;
    const selectedMedicines = state.consultationForm.selectedMedicines;
    const selectedTreatments = state.consultationForm.selectedTreatments;
    const customTreatment = state.consultationForm.customTreatment;
    const customCost = state.consultationForm.customCost;
    const notes = state.consultationForm.notes;
    const nextVisit = state.consultationForm.nextVisit;

    if (!patientId || !doctorId) {
      alert('Please select patient and doctor first!');
      return;
    }

    const patient = state.patients.find(p => p.id === patientId);
    const doctor = state.doctors.find(d => d.id === doctorId);
    
    if (!patient || !doctor) {
      alert('Patient or doctor not found!');
      return;
    }

    // Calculate total
    let total = 0;
    
    // Add treatment costs
    selectedTreatments.forEach(treatmentId => {
      const treatment = state.treatments.find(t => t.id === treatmentId);
      if (treatment) total += treatment.cost;
    });
    
    // Add custom treatment cost
    if (customCost) total += parseInt(customCost);
    
    // Add medicine costs
    selectedMedicines.forEach(medicineId => {
      const medicine = state.medicines.find(m => m.id === medicineId);
      if (medicine) total += medicine.price;
    });

    // Create bill
    const bill = {
      id: generateId(state.bills || []),
      patientId: patientId,
      doctorId: doctorId,
      chairId: chairId,
      date: new Date().toLocaleDateString('en-IN'),
      time: new Date().toLocaleTimeString('en-IN'),
      teeth: selectedTeeth,
      medicines: selectedMedicines.map(id => state.medicines.find(m => m.id === id)),
      treatments: selectedTreatments.map(id => state.treatments.find(t => t.id === id)),
      customTreatment: customTreatment,
      customCost: customCost ? parseInt(customCost) : 0,
      total: total,
      notes: notes,
      nextVisit: nextVisit
    };
    
    state.bills.push(bill);
  
  // Auto-generate prescription if medicines selected
  if (selectedMedicines.length > 0) {
    const prescription = {
      id: generateId(state.prescriptions || []),
      billId: bill.id,
      patientId: patientId,
      doctorId: doctorId,
      date: bill.date,
      medicines: bill.medicines,
      teeth: bill.teeth,
      prescriptionNumber: 'PRX' + Date.now(),
      generalInstructions: notes || 'Take medicines as prescribed. Follow up if any issues.'
    };
    
    if (!state.prescriptions) state.prescriptions = [];
    state.prescriptions.push(prescription);
  }
  
  saveAllData();
  
  // Show success message
  const patientInfo = state.patients.find(p => p.id == patientId); // Use == for type coercion
  const doctorInfo = state.doctors.find(d => d.id == doctorId);
  
  if (!patientInfo) {
    console.error('Patient not found! patientId:', patientId, 'All patients:', state.patients);
    alert('ERROR: Patient not found. Please select patient again.');
    return;
  }
  
  if (!doctorInfo) {
    console.error('Doctor not found! doctorId:', doctorId, 'All doctors:', state.doctors);
    alert('ERROR: Doctor not found. Please select doctor again.');
    return;
  }
  
  let successMsg = '‚úÖ BILL GENERATED SUCCESSFULLY!\n\n' +
    'Bill Number: ' + bill.billNumber + '\n' +
    'Patient: ' + patientInfo.name + '\n' +
    'Doctor: ' + doctorInfo.name + '\n' +
    'Total Amount: ' + formatIndianCurrency(total);
  
  if (selectedMedicines.length > 0) {
    successMsg += '\n\nüìã Prescription also generated with medicines!';
  }
  
  
  alert(successMsg + '\n\nBill receipt will appear. Click Print buttons to print.');
  
  // Reset consultation form
  state.consultationForm = {
    patientId: null,
    doctorId: null,
    chairId: null,
    selectedTeeth: [],
    selectedMedicines: [],
    selectedTreatments: [],
    customTreatment: '',
    customCost: '',
    notes: '',
    nextVisit: ''
  };
  
  renderBillReceipt(bill);
  setTimeout(() => window.print(), 500);
  
} catch (error) {
  console.error('‚ùå ERROR in generateBillAndPrintUpdated:', error);
  alert('‚ùå ERROR GENERATING BILL:\n\n' + error.message + '\n\nCheck console (F12) for details.');
}
} // end saveConsultationFormFromWalkIn

// ========== WALK-IN APPOINTMENT CRUD ==========
function editWalkInAppointment(appointmentId) {
  const appointment = state.appointments.find(a => a.id === appointmentId);
  if (!appointment) return;
  
  const patient = state.patients.find(p => p.id === appointment.patientId);
  
  // Populate form
  document.getElementById('walkin-name').value = patient.name;
  document.getElementById('walkin-phone').value = patient.contact;
  document.getElementById('walkin-age').value = patient.age;
  document.getElementById('walkin-gender').value = patient.gender;
  document.getElementById('walkin-doctor').value = appointment.doctorId;
  document.getElementById('walkin-chair').value = appointment.chairId;
  
  // Store editing ID
  document.getElementById('walkin-name').dataset.editingId = appointmentId;
  
  alert('üí° Appointment loaded for editing. Update and click book to save changes.');
}

function deleteWalkInAppointment(appointmentId) {
  if (confirm('Are you sure you want to delete this appointment?')) {
    const appointment = state.appointments.find(a => a.id === appointmentId);
    
    // Free up the chair
    if (appointment) {
      const chair = state.chairs.find(c => c.id === appointment.chairId);
      if (chair) {
        chair.status = 'available';
      }
    }
    
    state.appointments = state.appointments.filter(a => a.id !== appointmentId);
    saveAllData();
    alert('‚úÖ Appointment deleted successfully!');
    renderWalkInBooking();
  }
}

// Update bookWalkInPatient to handle edits
function bookWalkInPatientUpdated() {
  const editingId = document.getElementById('walkin-name').dataset.editingId;
  const name = document.getElementById('walkin-name').value.trim();
  const phone = document.getElementById('walkin-phone').value.trim();
  const age = document.getElementById('walkin-age').value;
  const gender = document.getElementById('walkin-gender').value;
  const doctorId = parseInt(document.getElementById('walkin-doctor').value);
  const chairId = parseInt(document.getElementById('walkin-chair').value);
  
  // Detailed validation
  let errors = [];
  if (!name) errors.push('‚Ä¢ Patient Name');
  if (!phone) errors.push('‚Ä¢ Phone Number');
  if (!doctorId || isNaN(doctorId)) errors.push('‚Ä¢ Doctor Selection');
  if (!chairId || isNaN(chairId)) errors.push('‚Ä¢ Chair Assignment');
  
  if (errors.length > 0) {
    alert('‚ùå MISSING REQUIRED FIELDS:\n\n' + errors.join('\n') + '\n\nPlease fill all marked fields and try again.');
    return;
  }
  
  if (editingId) {
    // Update existing appointment
    const aptIndex = state.appointments.findIndex(a => a.id === parseInt(editingId));
    if (aptIndex !== -1) {
      const oldChairId = state.appointments[aptIndex].chairId;
      
      // Free old chair
      const oldChair = state.chairs.find(c => c.id === oldChairId);
      if (oldChair) oldChair.status = 'available';
      
      // Occupy new chair
      const newChair = state.chairs.find(c => c.id === chairId);
      if (newChair) newChair.status = 'occupied';
      
      // Update patient
      const patient = state.patients.find(p => p.id === state.appointments[aptIndex].patientId);
      if (patient) {
        patient.name = name;
        patient.phone = phone;
        patient.contact = phone;
        patient.age = parseInt(age) || 0;
        patient.gender = gender;
      }
      
      // Update appointment
      state.appointments[aptIndex].doctorId = doctorId;
      state.appointments[aptIndex].chairId = chairId;
      
      saveAllData();
      delete document.getElementById('walkin-name').dataset.editingId;
      alert('‚úÖ Appointment updated successfully!');
      renderWalkInBooking();
      return;
    }
  }
  
  // Original create logic (from bookWalkInPatient)
  let patient = state.patients.find(p => p.phone === phone);
  if (!patient) {
    patient = {
      id: generateId(state.patients),
      name: name,
      phone: phone,
      age: parseInt(age) || 0,
      gender: gender,
      contact: phone,
      email: '',
      address: '',
      registrationDate: new Date().toISOString().split('T')[0],
      source: 'walkin'
    };
    state.patients.push(patient);
  }
  
  const appointment = {
    id: generateId(state.appointments),
    patientId: patient.id,
    doctorId: doctorId,
    chairId: chairId,
    date: new Date().toISOString().split('T')[0],
    time: new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }),
    treatment: 'Walk-in Consultation',
    revenue: 0,
    labCost: 0,
    status: 'checked-in',
    source: 'walkin'
  };
  state.appointments.push(appointment);
  
  const chair = state.chairs.find(c => c.id === chairId);
  chair.status = 'occupied';
  
  state.currentToken = patient.name;
  
  saveAllData();
  
  // Generate payment code
  const paymentCode = 'PAY' + Date.now().toString().slice(-8);
  appointment.paymentCode = paymentCode;
  appointment.paymentStatus = 'pending';
  appointment.consultationFee = 500; // Default consultation fee
  
  saveAllData();
  
  // Generate QR Code for consultation payment
  showConsultationPaymentQR(patient.name, paymentCode, 500, appointment.id);
  
  // Success message with all details
  const doctor = state.doctors.find(d => d.id === doctorId);
  
  renderWalkInBooking();
}

// QR Code for Consultation Payment
function showConsultationPaymentQR(patientName, paymentCode, amount, appointmentId) {
  const upiString = 'upi://pay?pa=test@paytm&pn=Aura Dental Care&am=' + amount + '&cu=INR&tn=Consultation-' + paymentCode;
  
  // Create modal HTML properly
  const modalDiv = document.createElement('div');
  modalDiv.id = 'qr-modal';
  modalDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
  
  modalDiv.innerHTML = 
    '<div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 500px;">' +
    '<h2 style="color: #667eea; margin-bottom: 20px;">üí≥ Scan to Pay Consultation Fee</h2>' +
    '<div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin: 20px 0;">' +
    '<div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Patient: ' + patientName + '</div>' +
    '<div style="font-size: 16px; color: #64748b; margin-bottom: 10px;">Payment Code: ' + paymentCode + '</div>' +
    '<div style="font-size: 32px; font-weight: 900; color: #10b981;">‚Çπ' + amount + '</div>' +
    '</div>' +
    '<div id="qr-code-container" style="display: flex; justify-content: center; margin: 20px 0; background: white; padding: 20px; border-radius: 12px;"></div>' +
    '<p style="color: #64748b; margin: 15px 0; font-size: 14px;">Ask patient to scan QR with any UPI app (GPay, PhonePe, Paytm, etc.)</p>' +
    '<div style="margin-top: 20px; display: flex; gap: 10px;">' +
    '<button onclick="confirmConsultationPayment(' + appointmentId + ')" style="flex: 1; padding: 15px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚úÖ Payment Received</button>' +
    '<button onclick="closeQRModal()" style="flex: 1; padding: 15px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚ùå Cancel / Pay Later</button>' +
    '</div>' +
    '</div>';
  
  document.body.appendChild(modalDiv);
  
  // Generate QR Code
  setTimeout(function() {
    try {
      new QRCode(document.getElementById('qr-code-container'), {
        text: upiString,
        width: 250,
        height: 250,
        colorDark: "#000000",
        colorLight: "#ffffff"
      });
    } catch(e) {
      document.getElementById('qr-code-container').innerHTML = 
        '<div style="padding: 40px; background: #fef3c7; border-radius: 8px; color: #92400e;">QR Code library loading...<br>Please wait or pay manually</div>';
    }
  }, 100);
}

function closeQRModal() {
  const modal = document.getElementById('qr-modal');
  if (modal) modal.remove();
}

function confirmConsultationPayment(appointmentId) {
  const appointment = state.appointments.find(a => a.id === appointmentId);
  if (appointment) {
    appointment.paymentStatus = 'paid';
    appointment.consultationPaid = true;
    appointment.paidAt = new Date().toISOString();
    appointment.paymentMethod = 'UPI';
    saveAllData();
    
    closeQRModal();
    alert('‚úÖ PAYMENT CONFIRMED!\n\nConsultation fee: ‚Çπ500\nPayment Code: ' + appointment.paymentCode + '\n\nPatient can proceed to doctor.\nConsultation will NOT be charged again in billing.');
    
    // Ask about WhatsApp
    if (confirm('Send WhatsApp confirmation to patient?')) {
      sendWhatsAppBookingConfirmation(appointmentId);
    }
  }
  
  renderWalkInBooking();
}

function showPublicBookingForm() {
  const formHTML = `
<!DOCTYPE html>
<html>
<head>
  <title>Aura Dental Care - Book Appointment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .booking-form {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
    }
    h1 {
      text-align: center;
      color: #6366f1;
      margin-bottom: 10px;
      font-size: 32px;
    }
    h2 {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 18px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #6366f1;
    }
    button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #6366f1, #ec4899);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    .success-message {
      display: none;
      background: #d1fae5;
      color: #065f46;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="booking-form">
    <h1>ü¶∑ Aura Dental Care</h1>
    <h2>Book Your Appointment</h2>
    
    <div id="success-msg" class="success-message">
      ‚úÖ Request submitted successfully! You'll receive WhatsApp confirmation soon.
    </div>
    
    <form id="bookingForm">
      <div class="form-group">
        <label>Your Name *</label>
        <input type="text" id="name" required>
      </div>
      
      <div class="form-group">
        <label>Age</label>
        <input type="number" id="age" placeholder="Optional">
      </div>
      
      <div class="form-group">
        <label>Gender</label>
        <select id="gender">
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Phone Number (WhatsApp) *</label>
        <input type="tel" id="phone" required placeholder="+91-9876543210">
      </div>
      
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" placeholder="Optional">
      </div>
      
      <div class="form-group">
        <label>Preferred Date *</label>
        <input type="date" id="date" required>
      </div>
      
      <div class="form-group">
        <label>Preferred Time *</label>
        <input type="time" id="time" required>
      </div>
      
      <div class="form-group">
        <label>Treatment Needed *</label>
        <select id="treatment" required>
          <option>Consultation</option>
          <option>Teeth Cleaning</option>
          <option>Root Canal</option>
          <option>Tooth Extraction</option>
          <option>Filling</option>
          <option>Crown</option>
          <option>Braces</option>
          <option>Whitening</option>
          <option>Other</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Additional Notes</label>
        <textarea id="notes" rows="3" placeholder="Any specific concerns or requirements"></textarea>
      </div>
      
      <button type="submit">üìÖ Request Appointment</button>
    </form>
  </div>

  <scr' + 'ipt>
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Validate required fields
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const treatment = document.getElementById('treatment').value;
      
      if (!name || !phone || !date || !time || !treatment) {
        alert('‚ùå Please fill all required fields:\n\n‚Ä¢ Name\n‚Ä¢ Phone\n‚Ä¢ Date\n‚Ä¢ Time\n‚Ä¢ Treatment');
        return;
      }
      
      const booking = {
        patientName: name,
        age: document.getElementById('age').value,
        gender: document.getElementById('gender').value,
        phone: phone,
        email: document.getElementById('email').value,
        preferredDate: date,
        preferredTime: time,
        treatment: treatment,
        notes: document.getElementById('notes').value,
        status: 'pending',
        requestDate: new Date().toISOString()
      };

      let bookings = JSON.parse(localStorage.getItem('bookingRequests') || '[]');
      booking.id = bookings.length + 1;
      bookings.push(booking);
      localStorage.setItem('bookingRequests', JSON.stringify(bookings));

      // Show success message
      document.getElementById('success-msg').style.display = 'block';
      document.getElementById('success-msg').innerHTML = '‚úÖ BOOKING REQUEST SUBMITTED!<br><br>Patient: ' + name + '<br>Date: ' + date + ' at ' + time + '<br><br>You will receive confirmation via WhatsApp shortly.';
      
      this.reset();
      
      // Try to notify parent window
      if (window.opener && !window.opener.closed) {
        try {
          window.opener.location.reload();
        } catch(e) {
          
        }
      }
      
      setTimeout(() => {
        document.getElementById('success-msg').style.display = 'none';
        alert('Thank you! Your booking request has been submitted successfully.\n\nOur staff will contact you via WhatsApp for confirmation.');
      }, 3000);
    });
  <\/script>
</body>
</html>
  `;
  
  const newWindow = window.open('', '_blank', 'width=700,height=900');
  newWindow.document.write(formHTML);
  newWindow.document.close();
}


// ========== BLANK OPD FORM (Internal Clinical Use) ==========

// ========== BLANK OPD FORM REMOVED ==========
// Function removed to fix syntax errors and simplify workflow
// All OPD data is now in the main bill receipt with clinical fields


function printPrescriptionFromBill(billId) {
  const bill = state.bills.find(b => b.id === billId);
  if (!bill || !bill.medicines || bill.medicines.length === 0) {
    alert('‚ùå No medicines prescribed in this bill!');
    return;
  }
  
  const patient = state.patients.find(p => p.id == bill.patientId);
  const doctor = state.doctors.find(d => d.id == bill.doctorId);
  
  if (!patient) {
    alert('‚ùå ERROR: Patient not found!');
    return;
  }
  
  if (!doctor) {
    alert('‚ùå ERROR: Doctor not found!');
    return;
  }
  
  // Build medicines list
  let medicinesList = '';
  bill.medicines.forEach((med, idx) => {
    medicinesList += '<div class="medicine-item"><strong>' + (idx + 1) + '. ' + med.name + '</strong><br>' +
                     '<span class="dosage">' + med.dosage + '</span><br>' +
                     '<span class="frequency">' + med.frequency + ' - ' + med.duration + '</span></div>';
  });
  
  const prescriptionHTML = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Prescription - ' + patient.name + '</title>' +
    '<style>@media print{@page{size:A4;margin:20mm}body{margin:0}}' +
    'body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}' +
    '.header{text-align:center;border-bottom:3px solid #667eea;padding-bottom:20px;margin-bottom:30px}' +
    '.header h1{color:#667eea;margin:0;font-size:36px}.header p{margin:5px 0;color:#64748b}' +
    '.section{margin:25px 0}.section-title{font-size:16px;font-weight:bold;color:#334155;margin-bottom:15px;border-bottom:2px solid #e2e8f0;padding-bottom:5px}' +
    '.patient-info{background:#f8fafc;padding:15px;border-radius:8px;margin-bottom:20px}' +
    '.patient-info p{margin:5px 0}.rx-symbol{font-size:48px;color:#667eea;margin:20px 0}' +
    '.medicine-item{background:white;border-left:4px solid #667eea;padding:15px;margin:15px 0;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}' +
    '.medicine-item strong{font-size:18px;color:#1e293b}.dosage{color:#64748b;font-size:14px}' +
    '.frequency{color:#10b981;font-size:14px;font-weight:600}.advice{background:#fef3c7;padding:15px;border-radius:8px;border-left:4px solid #f59e0b}' +
    '.signature{margin-top:60px;text-align:right;border-top:2px solid #000;width:250px;margin-left:auto;padding-top:10px}' +
    '</style></head><body>' +
    '<div class="header"><h1>ü¶∑ AURA DENTAL CARE</h1>' +
    '<p>Dr. ' + doctor.name + ' (' + (doctor.specialty || 'Dental Surgeon') + ')</p>' +
    '<p>Raipur, Chhattisgarh | Contact: ' + (state.config.clinicPhone || '+91-XXXXXXXXXX') + '</p></div>' +
    '<div class="patient-info"><p><strong>Patient Name:</strong> ' + patient.name + '</p>' +
    '<p><strong>Age/Gender:</strong> ' + patient.age + ' / ' + patient.gender + '</p>' +
    '<p><strong>Contact:</strong> ' + patient.contact + '</p>' +
    '<p><strong>Date:</strong> ' + formatIndianDate(bill.date) + '</p>' +
    (bill.teeth && bill.teeth.length > 0 ? '<p><strong>Teeth:</strong> ' + bill.teeth.join(', ') + '</p>' : '') +
    '</div><div class="section"><div class="rx-symbol">‚Ñû</div></div>' +
    '<div class="section"><div class="section-title">PRESCRIPTION</div>' + medicinesList + '</div>' +
    (bill.notes ? '<div class="section"><div class="section-title">ADVICE / INSTRUCTIONS</div><div class="advice">' + bill.notes + '</div></div>' : '') +
    '<div class="signature"><strong>' + doctor.name + '</strong><br>' + (doctor.specialty || 'Dental Surgeon') + '</div>' +
    '<script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script>' +
    '</body></html>';
  
  const printWindow = window.open('', '_blank', 'width=800,height=900');
  printWindow.document.write(prescriptionHTML);
  printWindow.document.close();
}

// ========== X-RAY & TEST MANAGEMENT ==========

// Add to bill/patient data structure
function addTestsAdvised(billId, tests) {
  const bill = state.bills.find(b => b.id === billId);
  if (!bill) return;
  
  bill.testsAdvised = tests;
  bill.testReports = bill.testReports || [];
  saveAllData();
}

function uploadTestReport(billId, testName, fileData) {
  const bill = state.bills.find(b => b.id === billId);
  if (!bill) return;
  
  if (!bill.testReports) bill.testReports = [];
  
  bill.testReports.push({
    testName: testName,
    fileName: fileData.name,
    fileData: fileData.base64,
    uploadDate: new Date().toISOString(),
    uploadedBy: state.currentUser.name
  });
  
  saveAllData();
}

// Render Tests Section in Billing Page (for doctors)
function renderTestsSection(billId) {
  const bill = state.bills.find(b => b.id === billId);
  const testsAdvised = bill?.testsAdvised || [];
  
  return `
    <div class="card" style="margin-top: 20px;">
      <h3 class="section-title">üß™ Investigations / Tests Advised</h3>
      
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;">
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" class="test-checkbox" value="OPG" ${testsAdvised.includes('OPG') ? 'checked' : ''}>
          <span>OPG (Panoramic)</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" class="test-checkbox" value="IOPA" ${testsAdvised.includes('IOPA') ? 'checked' : ''}>
          <span>IOPA (Periapical)</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" class="test-checkbox" value="Bitewing" ${testsAdvised.includes('Bitewing') ? 'checked' : ''}>
          <span>Bitewing X-ray</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" class="test-checkbox" value="Cephalometric" ${testsAdvised.includes('Cephalometric') ? 'checked' : ''}>
          <span>Cephalometric</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" class="test-checkbox" value="CBCT" ${testsAdvised.includes('CBCT') ? 'checked' : ''}>
          <span>CBCT Scan</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" class="test-checkbox" value="TMJ" ${testsAdvised.includes('TMJ') ? 'checked' : ''}>
          <span>TMJ View</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" class="test-checkbox" value="Blood Test" ${testsAdvised.includes('Blood Test') ? 'checked' : ''}>
          <span>Blood Test</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" class="test-checkbox" value="Culture" ${testsAdvised.includes('Culture') ? 'checked' : ''}>
          <span>Culture & Sensitivity</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" class="test-checkbox" value="Biopsy" ${testsAdvised.includes('Biopsy') ? 'checked' : ''}>
          <span>Biopsy</span>
        </label>
      </div>
      
      <button class="btn-primary" onclick="saveTestsAdvised(${billId})" style="margin-top: 10px;">
        üíæ Save Tests Advised
      </button>
    </div>
  `;
}

function saveTestsAdvised(billId) {
  const checkboxes = document.querySelectorAll('.test-checkbox:checked');
  const tests = Array.from(checkboxes).map(cb => cb.value);
  
  addTestsAdvised(billId, tests);
  alert('‚úÖ Tests advised saved successfully!');
}

// Render Test Upload Section (for reception)
function renderTestUploadSection(billId) {
  const bill = state.bills.find(b => b.id === billId);
  const patient = state.patients.find(p => p.id == bill?.patientId);
  const testsAdvised = bill?.testsAdvised || [];
  const testReports = bill?.testReports || [];
  
  return `
    <div class="card" style="margin-top: 20px;">
      <h3 class="section-title">üß™ Tests Advised by Doctor</h3>
      
      ${testsAdvised.length === 0 ? `
        <p style="color: #64748b; padding: 15px; background: #f8fafc; border-radius: 8px;">
          No tests advised yet
        </p>
      ` : `
        <div style="display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
          ${testsAdvised.map(test => `
            <span style="background: #667eea; color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px;">
              üß™ ${test}
            </span>
          `).join('')}
        </div>
      `}
      
      <h3 class="section-title" style="margin-top: 25px;">üì§ Upload Test Reports / X-rays</h3>
      
      <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 10px;">
        <div style="display: grid; gap: 10px;">
          <div>
            <label style="font-weight: 600; display: block; margin-bottom: 5px;">Test Name:</label>
            <select id="test-name-upload-${billId}" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px;">
              <option value="">Select Test Type</option>
              ${testsAdvised.map(test => `<option value="${test}">${test}</option>`).join('')}
              <option value="Other">Other (specify below)</option>
            </select>
          </div>
          
          <div>
            <label style="font-weight: 600; display: block; margin-bottom: 5px;">Custom Test Name (if Other):</label>
            <input type="text" id="test-name-custom-${billId}" placeholder="Enter test name" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px;">
          </div>
          
          <div>
            <label style="font-weight: 600; display: block; margin-bottom: 5px;">Upload File (Image/PDF):</label>
            <input type="file" id="test-file-upload-${billId}" accept="image/*,.pdf" style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; background: white;">
          </div>
          
          <button class="btn-primary" onclick="uploadTestReportFile(${billId})" style="margin-top: 10px;">
            üì§ Upload Report
          </button>
        </div>
      </div>
      
      <h3 class="section-title" style="margin-top: 25px;">üìã Uploaded Reports</h3>
      
      ${testReports.length === 0 ? `
        <p style="color: #64748b; padding: 15px; background: #f8fafc; border-radius: 8px;">
          No reports uploaded yet
        </p>
      ` : `
        <div class="data-table" style="margin-top: 10px;">
          <table>
            <thead>
              <tr>
                <th>Test Name</th>
                <th>File Name</th>
                <th>Upload Date</th>
                <th>Uploaded By</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${testReports.map((report, idx) => `
                <tr>
                  <td><strong>${report.testName}</strong></td>
                  <td>${report.fileName}</td>
                  <td>${formatIndianDate(report.uploadDate.split('T')[0])}</td>
                  <td>${report.uploadedBy}</td>
                  <td>
                    <button class="btn-small btn-primary" onclick="viewTestReport(${billId}, ${idx})" title="View">üëÅÔ∏è View</button>
                    <button class="btn-small" onclick="deleteTestReport(${billId}, ${idx})" style="background: #ef4444; color: white;" title="Delete">üóëÔ∏è</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;
}

function uploadTestReportFile(billId) {
  const testNameSelect = document.getElementById(`test-name-upload-${billId}`);
  const testNameCustom = document.getElementById(`test-name-custom-${billId}`);
  const fileInput = document.getElementById(`test-file-upload-${billId}`);
  
  let testName = testNameSelect.value;
  if (testName === 'Other') {
    testName = testNameCustom.value.trim();
  }
  
  if (!testName) {
    alert('‚ö†Ô∏è Please select or enter test name!');
    return;
  }
  
  if (!fileInput.files.length) {
    alert('‚ö†Ô∏è Please select a file to upload!');
    return;
  }
  
  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = function(e) {
    const fileData = {
      name: file.name,
      base64: e.target.result
    };
    
    uploadTestReport(billId, testName, fileData);
    alert('‚úÖ Test report uploaded successfully!');
    
    // Refresh the page to show updated reports
    window.location.reload();
  };
  
  reader.readAsDataURL(file);
}

function viewTestReport(billId, reportIndex) {
  const bill = state.bills.find(b => b.id === billId);
  if (!bill || !bill.testReports || !bill.testReports[reportIndex]) {
    alert('‚ùå Report not found!');
    return;
  }
  
  const report = bill.testReports[reportIndex];
  
  // Open in new window
  const viewWindow = window.open('', '_blank', 'width=800,height=900');
  viewWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>${report.testName} - ${report.fileName}</title>
      <style>
        body { margin: 0; padding: 20px; text-align: center; background: #f8fafc; font-family: Arial; }
        h2 { color: #1e293b; }
        img { max-width: 100%; height: auto; border: 2px solid #cbd5e1; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .info { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

/* ===== MOBILE RESPONSIVE ===== */
@media (max-width: 768px) {
  .login-wrapper, .login-page { overflow-x: hidden !important; padding: 16px !important; box-sizing: border-box; }
  .login-container { width: 100% !important; max-width: 100% !important; padding: 30px 20px !important; box-sizing: border-box !important; }
}
.mobile-menu-btn {
  display: none;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: none;
  border: none;
  cursor: pointer;
  border-radius: 8px;
  color: #374151;
}
.mobile-menu-btn:hover { background: #f3f4f6; }
.mobile-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}
.mobile-overlay.active { display: block; }
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: 1000;
    width: 260px !important;
  }
  .sidebar.mobile-open { transform: translateX(0); }
  .mobile-menu-btn { display: flex !important; }
  .header { padding: 10px 12px !important; }
}

      </style>
    </head>
    <body>
      <div class="info">
        <h2>üß™ ${report.testName}</h2>
        <p><strong>File:</strong> ${report.fileName}</p>
        <p><strong>Upload Date:</strong> ${formatIndianDate(report.uploadDate.split('T')[0])}</p>
        <p><strong>Uploaded By:</strong> ${report.uploadedBy}</p>
      </div>
      ${report.fileData.includes('application/pdf') 
        ? `<iframe src="${report.fileData}" style="width: 100%; height: 80vh; border: none;"></iframe>`
        : `<img src="${report.fileData}" alt="${report.testName}">`
      }
    </body>
    </html>
  `);
  viewWindow.document.close();
}

function deleteTestReport(billId, reportIndex) {
  if (!confirm('Are you sure you want to delete this report?')) return;
  
  const bill = state.bills.find(b => b.id === billId);
  if (!bill || !bill.testReports) return;
  
  bill.testReports.splice(reportIndex, 1);
  saveAllData();
  
  alert('‚úÖ Report deleted successfully!');
  window.location.reload();
}


// ========== WHATSAPP INTEGRATION ==========
function sendWhatsAppBookingConfirmation(appointmentId) {
  const appointment = state.appointments.find(a => a.id === appointmentId);
  if (!appointment) return;
  
  const patient = state.patients.find(p => p.id === appointment.patientId);
  const doctor = state.doctors.find(d => d.id === appointment.doctorId);
  
  const message = `ü¶∑ *AURA DENTAL CARE*

‚úÖ APPOINTMENT CONFIRMED

*Patient:* ${patient.name}
*Date:* ${formatIndianDate(appointment.date)}
*Time:* ${appointment.time}
*Doctor:* ${doctor.name}
*Chair:* ${appointment.chairId}

*Address:* ${state.config.clinicAddress || 'Aura Dental Care, Raipur, Chhattisgarh'}
*Contact:* ${state.config.clinicPhone || '+91-XXXXXXXXXX'}

Please arrive 10 minutes early.

- Aura Dental Care Team`;
  
  // Clean patient phone number
  let phone = patient.contact.replace(/[^0-9]/g, '');
  if (phone.length === 10) phone = '91' + phone;
  
  // Open WhatsApp Web directly to patient\'s number with message pre-filled
  const whatsappURL = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
  window.open(whatsappURL, '_blank');
  
  alert('‚úÖ WhatsApp opened!\n\nMessage is pre-filled for: ' + patient.name + '\nPhone: ' + phone + '\n\nReview and click SEND in WhatsApp.');
  
  // Note: Staff must click send button in WhatsApp
}

// Phone number validation - restrict to 10 digits
function enforcePhoneFormat(inputElement) {
  inputElement.addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^0-9]/g, '');
    if (value.length > 10) {
      value = value.substring(0, 10);
    }
    e.target.value = value;
  });
}

// Apply to all phone inputs on page load
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('input[type="tel"]').forEach(input => {
    enforcePhoneFormat(input);
  });
});

// ========== PWA SERVICE WORKER (Only works on http/https servers) ==========
if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.protocol === 'http:')) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(() => {
        // Service Worker registered successfully
      })
      .catch(() => {
        // Service Worker registration failed - app will still work without it
      });
  });
}

// ========== NEW REDESIGNED WORKFLOW MODULES ==========
// ========== RECEPTION - WALK-IN BOOKING (REDESIGNED) ==========
function renderWalkInBooking() {
  const todayQueue = state.doctorQueue.filter(q => q.date === new Date().toISOString().split('T')[0]);
  
  const html = '<div class="app-layout">' +
    renderSidebar('#walkin') +
    '<div class="main-wrapper">' +
    '<div class="top-bar">' +
    mobileMenuButton() +
    '<h1 class="page-title" style="margin: 0;">üë• Patient Registration & Consultation Payment</h1>' +
    '<div class="user-profile">' +
    '<div class="user-avatar">' + state.currentUser.name.charAt(0) + '</div>' +
    '<div class="user-name">' + state.currentUser.name + '</div>' +
    '</div>' +
    '</div>' +
    '<div class="content-area">' +
    
    // PATIENT SEARCH/REGISTRATION CARD
    '<div class="card">' +
    '<h2 class="section-title">üîç Search or Register Patient</h2>' +
    '<div class="form-row">' +
    '<div class="form-group">' +
    '<label>Search by Name or Phone</label>' +
    '<input type="text" id="search-patient" placeholder="Enter name or phone number" oninput="searchPatientLive(this.value)">' +
    '</div>' +
    '</div>' +
    '<div id="search-results" style="margin-top: 15px;"></div>' +
    
    // REGISTRATION FORM (shows if not found)
    '<div id="registration-form" style="display: none; margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 8px;">' +
    '<h3 style="color: #667eea; margin-bottom: 15px;">üìù New Patient Registration</h3>' +
    '<div class="form-row">' +
    '<div class="form-group">' +
    '<label>Patient Name *</label>' +
    '<input type="text" id="new-patient-name" placeholder="Full name">' +
    '</div>' +
    '<div class="form-group">' +
    '<label>Phone Number *</label>' +
    '<input type="tel" id="new-patient-phone" placeholder="10 digits" maxlength="10">' +
    '</div>' +
    '</div>' +
    '<div class="form-row">' +
    '<div class="form-group">' +
    '<label>Age</label>' +
    '<input type="number" id="new-patient-age" placeholder="Age in years">' +
    '</div>' +
    '<div class="form-group">' +
    '<label>Gender</label>' +
    '<select id="new-patient-gender">' +
    '<option>Male</option>' +
    '<option>Female</option>' +
    '<option>Other</option>' +
    '</select>' +
    '</div>' +
    '</div>' +
    '<div class="form-group">' +
    '<label>Select Doctor * <span style="color:#10b981;font-size:12px;font-weight:600;">‚Üê Patient\'s Choice</span></label>' +
    '<select id="new-patient-doctor" style="padding:12px;border:2px solid #667eea;border-radius:8px;font-size:15px;font-weight:600;background:white;">' +
    '<option value="">-- Select Doctor --</option>' +
    state.doctors.map(function(d) {
      return '<option value="' + d.id + '">' + d.name + ' (' + d.specialty + ')</option>';
    }).join('') +
    '</select>' +
    '</div>' +
    '<button class="btn-primary" onclick="registerNewPatient()">‚úì Register Patient</button>' +
    '</div>' +
    
    // SELECTED PATIENT INFO (shows after search/registration)
    '<div id="selected-patient-info" style="display: none; margin-top: 20px;"></div>' +
    '</div>' +
    
    // TODAY'S QUEUE CARD
    '<div class="card">' +
    '<h2 class="section-title">üìã Today\'s Patient Queue (' + todayQueue.length + ')</h2>' +
    '<div class="data-table">' +
    '<table>' +
    '<thead>' +
    '<tr>' +
    '<th>Time</th>' +
    '<th>Patient</th>' +
    '<th>Phone</th>' +
    '<th>Doctor Assigned</th>' +
    '<th>Consultation Fee</th>' +
    '<th>Status</th>' +
    '<th>Actions</th>' +
    '</tr>' +
    '</thead>' +
    '<tbody>' +
    (todayQueue.length === 0 ? 
      '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #94a3b8;">No patients in queue yet</td></tr>' :
      todayQueue.map(function(q) {
        const patient = state.patients.find(function(p) { return p.id === q.patientId; });
        const doctor = state.doctors.find(function(d) { return d.id === q.doctorId; });
        return '<tr>' +
          '<td><strong>' + q.time + '</strong></td>' +
          '<td>' + (patient ? patient.name : 'N/A') + '</td>' +
          '<td>' + (patient ? patient.contact : 'N/A') + '</td>' +
          '<td><span style="background:#7c3aed;color:white;padding:6px 12px;border-radius:6px;font-weight:600;font-size:13px;">üë®‚Äç‚öïÔ∏è ' + (doctor ? doctor.name : 'Not Assigned') + '</span></td>' +
          '<td style="color: #10b981; font-weight: 600;">‚Çπ' + q.consultationFee + ' (' + q.paymentMethod + ')</td>' +
          '<td><span style="color: #10b981; font-weight: 700;">‚úì Paid</span></td>' +
          '<td>' +
          '<button class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="viewPatientDetails(' + q.patientId + ')">üëÅÔ∏è View</button>' +
          '</td>' +
          '</tr>';
      }).join('')) +
    '</tbody>' +
    '</table>' +
    '</div>' +
    '</div>' +
    
    '</div>' +
    '</div>' +
    '</div>';
  
  document.getElementById('app').innerHTML = html;
}

// Search patient as user types
function searchPatientLive(searchTerm) {
  if (!searchTerm || searchTerm.length < 2) {
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('registration-form').style.display = 'none';
    document.getElementById('selected-patient-info').style.display = 'none';
    return;
  }
  
  const term = searchTerm.toLowerCase();
  const results = state.patients.filter(function(p) {
    return p.name.toLowerCase().includes(term) || 
           (p.contact && p.contact.includes(term)) ||
           (p.phone && p.phone.includes(term));
  });
  
  if (results.length > 0) {
    // Show found patients
    let html = '<div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; padding: 15px;">' +
      '<h4 style="color: #065f46; margin-bottom: 10px;">‚úì Found ' + results.length + ' patient(s):</h4>';
    
    results.forEach(function(p) {
      html += '<div style="background: white; padding: 12px; margin: 8px 0; border-radius: 6px; cursor: pointer; border: 2px solid transparent;" ' +
        'onmouseover="this.style.borderColor=\'#667eea\'" onmouseout="this.style.borderColor=\'transparent\'" ' +
        'onclick="selectExistingPatient(' + p.id + ')">' +
        '<div style="font-weight: 600; color: #1e293b;">' + p.name + '</div>' +
        '<div style="font-size: 13px; color: #64748b;">Phone: ' + p.contact + ' | Age: ' + p.age + ' | Gender: ' + p.gender + '</div>' +
        '<div style="font-size: 12px; color: #10b981; margin-top: 4px;">Click to select ‚Üí</div>' +
        '</div>';
    });
    
    html += '</div>';
    document.getElementById('search-results').innerHTML = html;
    document.getElementById('registration-form').style.display = 'none';
  } else {
    // No patient found - show registration form
    document.getElementById('search-results').innerHTML = 
      '<div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 15px;">' +
      '<div style="color: #92400e; font-weight: 600;">‚ö†Ô∏è Patient not found</div>' +
      '<div style="color: #92400e; font-size: 14px; margin-top: 5px;">Register as new patient below</div>' +
      '</div>';
    
    document.getElementById('registration-form').style.display = 'block';
    
    // SMART FILL: Detect if search term is phone number or name
    const isPhoneNumber = /^\d+$/.test(searchTerm);
    
    if (isPhoneNumber) {
      // Fill phone field
      document.getElementById('new-patient-phone').value = searchTerm;
      document.getElementById('new-patient-name').value = '';
    } else {
      // Fill name field
      document.getElementById('new-patient-name').value = searchTerm;
      document.getElementById('new-patient-phone').value = '';
    }
  }
}

// Select existing patient
function selectExistingPatient(patientId) {
  const patient = state.patients.find(function(p) { return p.id === patientId; });
  if (!patient) return;
  
  // Show patient history
  const previousVisits = state.bills.filter(function(b) { return b.patientId === patientId; });
  
  let historyHTML = '';
  if (previousVisits.length > 0) {
    historyHTML = '<div style="background: #e0e7ff; padding: 12px; border-radius: 6px; margin-top: 10px;">' +
      '<div style="font-weight: 600; color: #3730a3; margin-bottom: 8px;">üìã Previous Visits (' + previousVisits.length + ')</div>';
    
    previousVisits.slice(0, 3).forEach(function(v) {
      historyHTML += '<div style="font-size: 13px; color: #4338ca; padding: 4px 0;">' +
        '‚Ä¢ ' + formatIndianDate(v.date) + ' - ' + (v.chiefComplaint || 'General consultation') + ' - ‚Çπ' + v.total.toLocaleString('en-IN') +
        '</div>';
    });
    
    if (previousVisits.length > 3) {
      historyHTML += '<div style="font-size: 12px; color: #6366f1; margin-top: 6px;">... and ' + (previousVisits.length - 3) + ' more visits</div>';
    }
    
    historyHTML += '</div>';
  }
  
  const html = '<div style="background: #f0fdf4; border: 3px solid #10b981; border-radius: 12px; padding: 20px;">' +
    '<h3 style="color: #065f46; margin-bottom: 15px;">‚úì Selected Patient</h3>' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">' +
    '<div><strong>Name:</strong> ' + patient.name + '</div>' +
    '<div><strong>Phone:</strong> ' + patient.contact + '</div>' +
    '<div><strong>Age:</strong> ' + patient.age + ' years</div>' +
    '<div><strong>Gender:</strong> ' + patient.gender + '</div>' +
    '</div>' +
    historyHTML +
    '<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #10b981;">' +
    '<h4 style="color: #065f46; margin-bottom: 10px;">üí∞ Consultation Fee Payment</h4>' +
    '<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">' +
    '<div style="font-size: 24px; font-weight: 900; color: #10b981; margin-bottom: 10px;">‚Çπ 500</div>' +
    '<div style="font-size: 13px; color: #64748b;">Standard consultation fee</div>' +
    '</div>' +
    '<div style="display: flex; gap: 10px;">' +
    '<button class="btn-primary" style="flex: 1;" onclick="collectConsultationFee(' + patientId + ', \'UPI\')">üì± Pay via UPI (QR Code)</button>' +
    '<button class="btn-primary" style="flex: 1; background: #10b981;" onclick="collectConsultationFee(' + patientId + ', \'Cash\')">üíµ Pay Cash</button>' +
    '</div>' +
    '</div>' +
    '</div>';
  
  document.getElementById('selected-patient-info').innerHTML = html;
  document.getElementById('selected-patient-info').style.display = 'block';
  document.getElementById('search-results').innerHTML = '';
  document.getElementById('registration-form').style.display = 'none';
}

// Register new patient
function registerNewPatient() {
  const name = document.getElementById('new-patient-name').value.trim();
  const phone = document.getElementById('new-patient-phone').value.trim();
  const age = document.getElementById('new-patient-age').value;
  const gender = document.getElementById('new-patient-gender').value;
  const doctorId = parseInt(document.getElementById('new-patient-doctor').value);
  
  if (!name || !phone) {
    alert('‚ùå Please enter patient name and phone number');
    return;
  }
  
  if (!doctorId) {
    alert('‚ùå Please select a doctor');
    return;
  }
  
  if (phone.length !== 10) {
    alert('‚ùå Phone number must be 10 digits');
    return;
  }
  
  const doctor = state.doctors.find(function(d) { return d.id === doctorId; });
  
  const newPatient = {
    id: generateId(state.patients),
    name: name,
    contact: phone,
    phone: phone,
    age: parseInt(age) || 0,
    gender: gender,
    email: '',
    address: '',
    registrationDate: new Date().toISOString().split('T')[0],
    source: 'walkin',
    preferredDoctorId: doctorId
  };
  
  state.patients.push(newPatient);
  saveAllData();
  
  alert('‚úÖ Patient registered successfully!\n\nName: ' + name + '\nPhone: ' + phone + '\nDoctor: ' + doctor.name);
  
  // Auto-select the new patient
  selectExistingPatient(newPatient.id);
}

// Collect consultation fee
function collectConsultationFee(patientId, paymentMethod) {
  const patient = state.patients.find(function(p) { return p.id === patientId; });
  if (!patient) return;
  
  if (paymentMethod === 'UPI') {
    // Show QR code for UPI payment
    showConsultationPaymentQRNew(patient.name, 'CONS' + Date.now().toString().slice(-8), 500, patientId);
  } else {
    // Cash payment - confirm and add to queue directly
    if (confirm('Confirm cash payment of ‚Çπ500 received from ' + patient.name + '?')) {
      addToDoctorQueue(patientId, 500, 'Cash');
    }
  }
}

// Show QR for consultation payment
function showConsultationPaymentQRNew(patientName, paymentCode, amount, patientId) {
  const upiString = 'upi://pay?pa=test@paytm&pn=Aura Dental Care&am=' + amount + '&cu=INR&tn=Consultation-' + paymentCode;
  
  const modalDiv = document.createElement('div');
  modalDiv.id = 'qr-modal';
  modalDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
  
  modalDiv.innerHTML = 
    '<div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 500px;">' +
    '<h2 style="color: #667eea; margin-bottom: 20px;">üí≥ Scan to Pay Consultation Fee</h2>' +
    '<div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin: 20px 0;">' +
    '<div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Patient: ' + patientName + '</div>' +
    '<div style="font-size: 16px; color: #64748b; margin-bottom: 10px;">Payment Code: ' + paymentCode + '</div>' +
    '<div style="font-size: 32px; font-weight: 900; color: #10b981;">‚Çπ' + amount + '</div>' +
    '</div>' +
    '<div id="qr-code-container" style="display: flex; justify-content: center; margin: 20px 0; background: white; padding: 20px; border-radius: 12px;"></div>' +
    '<p style="color: #64748b; margin: 15px 0; font-size: 14px;">Ask patient to scan QR with any UPI app</p>' +
    '<div style="margin-top: 20px; display: flex; gap: 10px;">' +
    '<button onclick="confirmConsultationPaymentNew(' + patientId + ', ' + amount + ', \'' + paymentCode + '\')" style="flex: 1; padding: 15px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚úÖ Payment Received</button>' +
    '<button onclick="closeQRModal()" style="flex: 1; padding: 15px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚ùå Cancel</button>' +
    '</div>' +
    '</div>';
  
  document.body.appendChild(modalDiv);
  
  setTimeout(function() {
    try {
      new QRCode(document.getElementById('qr-code-container'), {
        text: upiString,
        width: 250,
        height: 250,
        colorDark: "#000000",
        colorLight: "#ffffff"
      });
    } catch(e) {
      document.getElementById('qr-code-container').innerHTML = 
        '<div style="padding: 40px; background: #fef3c7; border-radius: 8px; color: #92400e;">QR Code library loading...</div>';
    }
  }, 100);
}

// Confirm consultation payment and add to queue
function confirmConsultationPaymentNew(patientId, amount, paymentCode) {
  closeQRModal();
  addToDoctorQueue(patientId, amount, 'UPI');
}

// Add patient to doctor queue
function addToDoctorQueue(patientId, amount, paymentMethod) {
  const patient = state.patients.find(function(p) { return p.id === patientId; });
  const doctorId = patient ? (patient.preferredDoctorId || state.doctors[0].id) : state.doctors[0].id;
  
  const queueEntry = {
    id: generateId(state.doctorQueue),
    patientId: patientId,
    doctorId: doctorId,
    date: new Date().toISOString().split('T')[0],
    time: new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }),
    consultationFee: amount,
    paymentMethod: paymentMethod,
    paymentCode: 'CONS' + Date.now().toString().slice(-8),
    status: 'waiting',  // waiting, with-doctor, completed
    addedAt: new Date().toISOString()
  };
  
  state.doctorQueue.push(queueEntry);
  saveAllData();
  alert('‚úÖ PAYMENT CONFIRMED!\n\n' +
        'Patient: ' + patient.name + '\n' +
        'Consultation Fee: ‚Çπ' + amount + '\n' +
        'Payment: ' + paymentMethod + '\n\n' +
        'Patient added to doctor queue!');
  
  renderWalkInBooking();
}
// ========== DOCTOR SECTION (REDESIGNED) ==========

// Start consultation with patient

// Render tooth chart for doctor
function renderToothChartForDoctor() {
  const quadrants = [
    { id: 'Q1', label: 'Upper Right', teeth: ["18","17","16","15","14","13","12","11"] },
    { id: 'Q2', label: 'Upper Left', teeth: ["21","22","23","24","25","26","27","28"] },
    { id: 'Q3', label: 'Lower Left', teeth: ["31","32","33","34","35","36","37","38"] },
    { id: 'Q4', label: 'Lower Right', teeth: ["41","42","43","44","45","46","47","48"] }
  ];
  
  let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';
  
  quadrants.forEach(function(q) {
    html += '<div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 2px solid #e2e8f0;">' +
      '<div style="font-weight: 600; color: #64748b; margin-bottom: 10px; font-size: 13px;">' + q.label + '</div>' +
      '<div style="display: flex; gap: 6px; flex-wrap: wrap;">';
    
    q.teeth.forEach(function(tooth) {
      html += '<div class="tooth-selector" data-tooth="' + tooth + '" onclick="toggleTooth(this)" ' +
        'style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; ' +
        'border: 2px solid #cbd5e1; border-radius: 6px; cursor: pointer; font-weight: 600; ' +
        'background: white; color: #475569; transition: all 0.2s;">' +
        tooth +
        '</div>';
    });
    
    html += '</div></div>';
  });
  
  html += '</div>' +
    '<div id="selected-teeth-display" style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 8px; display: none;">' +
    '<strong>Selected Teeth:</strong> <span id="selected-teeth-list"></span>' +
    '</div>';
  
  return html;
}

// Toggle tooth selection
function toggleTooth(element) {
  if (element.classList.contains('selected')) {
    element.classList.remove('selected');
    element.style.background = 'white';
    element.style.borderColor = '#cbd5e1';
    element.style.color = '#475569';
  } else {
    element.classList.add('selected');
    element.style.background = '#667eea';
    element.style.borderColor = '#667eea';
    element.style.color = 'white';
  }
  
  updateSelectedTeethDisplay();
}

// Update selected teeth display
function updateSelectedTeethDisplay() {
  const selected = Array.from(document.querySelectorAll('.tooth-selector.selected'))
    .map(function(el) { return el.getAttribute('data-tooth'); });
  
  if (selected.length > 0) {
    document.getElementById('selected-teeth-display').style.display = 'block';
    document.getElementById('selected-teeth-list').textContent = selected.join(', ');
  } else {
    document.getElementById('selected-teeth-display').style.display = 'none';
  }
}

// Update total cost as user selects treatments
function updateTotalCost() {
  let total = 0;
  
  document.querySelectorAll('.treatment-checkbox:checked').forEach(function(cb) {
    total += parseInt(cb.getAttribute('data-cost'));
  });
  
  document.getElementById('total-cost-display').textContent = '‚Çπ ' + total.toLocaleString('en-IN');
}

// Create treatment plan
function createTreatmentPlan(patientId, queueId) {
  const chiefComplaint = document.getElementById('chief-complaint').value;
  const diagnosis = document.getElementById('diagnosis').value.trim();
  const notes = document.getElementById('notes').value.trim();
  
  if (!chiefComplaint) {
    alert('‚ùå Please select Chief Complaint');
    return;
  }
  
  if (!diagnosis) {
    alert('‚ùå Please enter Diagnosis');
    return;
  }
  
  // Get selected lab tests
  const labTests = Array.from(document.querySelectorAll('.lab-test-checkbox:checked'))
    .map(function(cb) { return cb.value; });
  
  // Get selected teeth
  const teeth = Array.from(document.querySelectorAll('.tooth-selector.selected'))
    .map(function(el) { return el.getAttribute('data-tooth'); });
  
  // Get selected treatments
  const selectedTreatmentIds = Array.from(document.querySelectorAll('.treatment-checkbox:checked'))
    .map(function(cb) { return parseInt(cb.value); });
  
  const treatments = selectedTreatmentIds.map(function(id) {
    return state.treatments.find(function(t) { return t.id === id; });
  });
  
  if (treatments.length === 0) {
    alert('‚ùå Please select at least one treatment');
    return;
  }
  
  // Get selected medicines
  const selectedMedicineIds = Array.from(document.querySelectorAll('.medicine-checkbox:checked'))
    .map(function(cb) { return parseInt(cb.value); });
  
  const medicines = selectedMedicineIds.map(function(id) {
    return state.medicines.find(function(m) { return m.id === id; });
  });
  
  // Calculate total
  let totalCost = 0;
  treatments.forEach(function(t) {
    totalCost += t.cost;
  });
  
  if (totalCost === 0) {
    alert('‚ùå Total cost is ‚Çπ0. Please select treatments with costs.');
    return;
  }
  
  // Create treatment plan
  const treatmentPlan = {
    id: generateId(state.treatmentPlans),
    patientId: patientId,
    doctorId: state.currentUser.id,
    queueId: queueId,
    date: new Date().toISOString().split('T')[0],
    time: new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }),
    chiefComplaint: chiefComplaint,
    diagnosis: diagnosis,
    labTests: labTests,
    teeth: teeth,
    treatments: treatments,
    medicines: medicines,
    notes: notes,
    totalCost: totalCost,
    status: 'pending',  // pending ‚Üí paid ‚Üí completed
    paymentStatus: 'pending',
    chairAssigned: null,
    prescriptionGenerated: false,
    createdAt: new Date().toISOString()
  };
  
  state.treatmentPlans.push(treatmentPlan);
  
  // Update queue status
  const queueEntry = state.doctorQueue.find(function(q) { return q.id === queueId; });
  if (queueEntry) {
    queueEntry.status = 'completed';
    queueEntry.treatmentPlanId = treatmentPlan.id;
  }
  
  saveAllData();
  
  const patient = state.patients.find(function(p) { return p.id === patientId; });
  
  alert('‚úÖ TREATMENT PLAN CREATED!\n\n' +
        'Patient: ' + patient.name + '\n' +
        'Total Cost: ‚Çπ' + totalCost.toLocaleString('en-IN') + '\n\n' +
        'üëâ Tell patient to pay at reception.\n' +
        'Treatment will start after payment.');
  
  renderDoctorsSection();
}

// Cancel consultation
function cancelConsultation(queueId) {
  const queueEntry = state.doctorQueue.find(function(q) { return q.id === queueId; });
  if (queueEntry) {
    queueEntry.status = 'waiting';
    saveAllData();
  }
  renderDoctorsSection();
}

// Generate prescription after treatment
function generatePrescriptionForPlan(treatmentPlanId) {
  const plan = state.treatmentPlans.find(function(tp) { return tp.id === treatmentPlanId; });
  if (!plan) return;
  
  if (!plan.medicines || plan.medicines.length === 0) {
    alert('‚ùå No medicines prescribed in this treatment plan!');
    return;
  }
  
  const patient = state.patients.find(function(p) { return p.id === plan.patientId; });
  const doctor = state.doctors.find(function(d) { return d.id === plan.doctorId; });
  
  // Build medicines list
  let medicinesList = '';
  plan.medicines.forEach(function(med, idx) {
    medicinesList += '<div class="medicine-item"><strong>' + (idx + 1) + '. ' + med.name + '</strong><br>' +
                     '<span class="dosage">' + med.dosage + '</span><br>' +
                     '<span class="frequency">' + med.frequency + ' - ' + med.duration + '</span></div>';
  });
  
  const prescriptionHTML = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Prescription - ' + patient.name + '</title>' +
    '<style>@media print{@page{size:A4;margin:20mm}body{margin:0}}' +
    'body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}' +
    '.header{text-align:center;border-bottom:3px solid #667eea;padding-bottom:20px;margin-bottom:30px}' +
    '.header h1{color:#667eea;margin:0;font-size:36px}.header p{margin:5px 0;color:#64748b}' +
    '.section{margin:25px 0}.section-title{font-size:16px;font-weight:bold;color:#334155;margin-bottom:15px;border-bottom:2px solid #e2e8f0;padding-bottom:5px}' +
    '.patient-info{background:#f8fafc;padding:15px;border-radius:8px;margin-bottom:20px}' +
    '.patient-info p{margin:5px 0}.rx-symbol{font-size:48px;color:#667eea;margin:20px 0}' +
    '.medicine-item{background:white;border-left:4px solid #667eea;padding:15px;margin:15px 0;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}' +
    '.medicine-item strong{font-size:18px;color:#1e293b}.dosage{color:#64748b;font-size:14px}' +
    '.frequency{color:#10b981;font-size:14px;font-weight:600}.advice{background:#fef3c7;padding:15px;border-radius:8px;border-left:4px solid #f59e0b}' +
    '.signature{margin-top:60px;text-align:right;border-top:2px solid #000;width:250px;margin-left:auto;padding-top:10px}' +
    '</style></head><body>' +
    '<div class="header"><h1>ü¶∑ AURA DENTAL CARE</h1>' +
    '<p>Dr. ' + doctor.name + ' (' + (doctor.specialty || 'Dental Surgeon') + ')</p>' +
    '<p>Raipur, Chhattisgarh | Contact: ' + (state.config.clinicPhone || '+91-XXXXXXXXXX') + '</p></div>' +
    '<div class="patient-info"><p><strong>Patient Name:</strong> ' + patient.name + '</p>' +
    '<p><strong>Age/Gender:</strong> ' + patient.age + ' / ' + patient.gender + '</p>' +
    '<p><strong>Contact:</strong> ' + patient.contact + '</p>' +
    '<p><strong>Date:</strong> ' + formatIndianDate(plan.date) + '</p>' +
    (plan.teeth && plan.teeth.length > 0 ? '<p><strong>Teeth:</strong> ' + plan.teeth.join(', ') + '</p>' : '') +
    '</div><div class="section"><div class="rx-symbol">‚Ñû</div></div>' +
    '<div class="section"><div class="section-title">PRESCRIPTION</div>' + medicinesList + '</div>' +
    (plan.notes ? '<div class="section"><div class="section-title">ADVICE / INSTRUCTIONS</div><div class="advice">' + plan.notes + '</div></div>' : '') +
    '<div class="signature"><strong>' + doctor.name + '</strong><br>' + (doctor.specialty || 'Dental Surgeon') + '</div>' +
    '<script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script>' +
    '</body></html>';
  
  const printWindow = window.open('', '_blank', 'width=800,height=900');
  printWindow.document.write(prescriptionHTML);
  printWindow.document.close();
  
  // Mark prescription as generated
  plan.prescriptionGenerated = true;
  plan.status = 'completed';
  saveAllData();
  
  alert('‚úÖ Prescription generated and sent to print!');
  renderDoctorsSection();
}
// ========== RECEPTION - TREATMENT PLANS (PAYMENT & CHAIR ASSIGNMENT) ==========
function renderTreatmentPlansReception() {
  const pendingPlans = state.treatmentPlans.filter(function(tp) {
    return tp.status === 'pending' || tp.status === 'paid';
  });
  
  const availableChairs = state.chairs.filter(function(c) { return c.status === 'available'; });
  
  const html = '<div class="app-layout">' +
    renderSidebar('#billing-section') +
    '<div class="main-wrapper">' +
    '<div class="top-bar">' +
    mobileMenuButton() +
    '<h1 class="page-title" style="margin: 0;">üí∞ Collect Payment & Assign Chair</h1>' +
    '<div class="user-profile">' +
    '<div class="user-avatar">' + state.currentUser.name.charAt(0) + '</div>' +
    '<div class="user-name">' + state.currentUser.name + '</div>' +
    '</div>' +
    '</div>' +
    '<div class="content-area">' +
    
    // CHAIR STATUS DISPLAY (NEW)
    '<div class="card" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; margin-bottom: 20px;">' +
    '<h2 style="margin: 0 0 15px 0; font-size: 18px;">üí∫ Chair Status (' + state.chairs.filter(function(c) { return c.status === 'available'; }).length + ' available)</h2>' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">' +
    state.chairs.map(function(chair) {
      const isOccupied = chair.status === 'occupied';
      return '<div style="background: ' + (isOccupied ? 'rgba(239, 68, 68, 0.9)' : 'rgba(16, 185, 129, 0.9)') + '; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid ' + (isOccupied ? '#dc2626' : '#059669') + ';">' +
        '<div style="font-size: 24px; margin-bottom: 8px;">' + (isOccupied ? 'üî¥' : 'üü¢') + '</div>' +
        '<div style="font-weight: 700; font-size: 16px;">Chair ' + chair.id + '</div>' +
        '<div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">' + 
        (isOccupied ? 
          (chair.patientName || 'Occupied') + '<br>' + (chair.startTime || '') :
          'Available') +
        '</div>' +
        '</div>';
    }).join('') +
    '</div>' +
    '</div>' +
    
    '<div class="card">' +
    '<h2 class="section-title">üìã Treatment Plans Awaiting Payment/Chair (' + pendingPlans.length + ')</h2>' +
    (pendingPlans.length === 0 ?
      '<div style="text-align: center; padding: 40px; color: #94a3b8;">No pending treatment plans</div>' :
      '<div class="data-table">' +
      '<table>' +
      '<thead>' +
      '<tr>' +
      '<th>Date</th>' +
      '<th>Patient</th>' +
      '<th>Doctor</th>' +
      '<th>Chief Complaint</th>' +
      '<th>Total Cost</th>' +
      '<th>Status</th>' +
      '<th>Actions</th>' +
      '</tr>' +
      '</thead>' +
      '<tbody>' +
      pendingPlans.map(function(tp) {
        const patient = state.patients.find(function(p) { return p.id === tp.patientId; });
        const doctor = state.doctors.find(function(d) { return d.id === tp.doctorId; });
        
        return '<tr>' +
          '<td>' + formatIndianDate(tp.date) + ' ' + tp.time + '</td>' +
          '<td><strong>' + (patient ? patient.name : 'N/A') + '</strong><br>' +
          '<span style="font-size: 12px; color: #64748b;">' + (patient ? patient.contact : '') + '</span></td>' +
          '<td>' + (doctor ? doctor.name : 'N/A') + '</td>' +
          '<td>' + tp.chiefComplaint + '</td>' +
          '<td style="font-size: 18px; font-weight: 700; color: #10b981;">‚Çπ' + tp.totalCost.toLocaleString('en-IN') + '</td>' +
          '<td>' +
          (tp.status === 'pending' ? '<span style="color: #f59e0b; font-weight: 600;">‚è≥ Payment Pending</span>' : 
           tp.status === 'paid' ? '<span style="color: #3b82f6; font-weight: 600;">üí∫ Need Chair Assignment</span>' :
           '<span style="color: #10b981; font-weight: 600;">‚úì In Treatment</span>') +
          '</td>' +
          '<td>' +
          (tp.status === 'pending' ? 
            '<button class="btn-primary" onclick="collectTreatmentPayment(' + tp.id + ')" style="margin-right: 5px;">üí∞ Collect Payment</button>' :
            tp.status === 'paid' && !tp.chairAssigned ?
            '<button class="btn-primary" style="background: #3b82f6;" onclick="assignChairModal(' + tp.id + ')">üí∫ Assign Chair</button>' :
            '<button class="btn" onclick="viewTreatmentPlanDetails(' + tp.id + ')">üëÅÔ∏è View Details</button>') +
          '</td>' +
          '</tr>';
      }).join('') +
      '</tbody>' +
      '</table>' +
      '</div>') +
    '</div>' +
    
    '</div></div></div>';
  
  document.getElementById('app').innerHTML = html;
}

// Collect treatment payment
function collectTreatmentPayment(planId) {
  const plan = state.treatmentPlans.find(function(tp) { return tp.id === planId; });
  if (!plan) return;
  
  const patient = state.patients.find(function(p) { return p.id === plan.patientId; });
  
  const paymentMethod = confirm('Payment Method:\n\nOK = UPI (QR Code)\nCancel = Cash');
  
  if (paymentMethod) {
    // UPI payment
    showTreatmentPaymentQR(patient.name, 'TREAT' + Date.now().toString().slice(-8), plan.totalCost, planId);
  } else {
    // Cash payment
    if (confirm('Confirm cash payment of ‚Çπ' + plan.totalCost.toLocaleString('en-IN') + ' received from ' + patient.name + '?')) {
      completeTreatmentPayment(planId, 'Cash');
    }
  }
}

// Show QR for treatment payment
function showTreatmentPaymentQR(patientName, paymentCode, amount, planId) {
  const upiString = 'upi://pay?pa=test@paytm&pn=Aura Dental Care&am=' + amount + '&cu=INR&tn=Treatment-' + paymentCode;
  
  const modalDiv = document.createElement('div');
  modalDiv.id = 'qr-modal';
  modalDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
  
  modalDiv.innerHTML = 
    '<div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 500px;">' +
    '<h2 style="color: #667eea; margin-bottom: 20px;">üí≥ Scan to Pay Treatment Cost</h2>' +
    '<div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin: 20px 0;">' +
    '<div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Patient: ' + patientName + '</div>' +
    '<div style="font-size: 16px; color: #64748b; margin-bottom: 10px;">Payment Code: ' + paymentCode + '</div>' +
    '<div style="font-size: 32px; font-weight: 900; color: #10b981;">‚Çπ' + amount.toLocaleString('en-IN') + '</div>' +
    '</div>' +
    '<div id="qr-code-container" style="display: flex; justify-content: center; margin: 20px 0; background: white; padding: 20px; border-radius: 12px;"></div>' +
    '<p style="color: #64748b; margin: 15px 0; font-size: 14px;">Ask patient to scan QR with any UPI app</p>' +
    '<div style="margin-top: 20px; display: flex; gap: 10px;">' +
    '<button onclick="completeTreatmentPayment(' + planId + ', \'UPI\')" style="flex: 1; padding: 15px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚úÖ Payment Received</button>' +
    '<button onclick="closeQRModal()" style="flex: 1; padding: 15px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚ùå Cancel</button>' +
    '</div>' +
    '</div>';
  
  document.body.appendChild(modalDiv);
  
  setTimeout(function() {
    try {
      new QRCode(document.getElementById('qr-code-container'), {
        text: upiString,
        width: 250,
        height: 250,
        colorDark: "#000000",
        colorLight: "#ffffff"
      });
    } catch(e) {
      document.getElementById('qr-code-container').innerHTML = 
        '<div style="padding: 40px; background: #fef3c7; border-radius: 8px; color: #92400e;">QR Code library loading...</div>';
    }
  }, 100);
}

// Complete treatment payment
function completeTreatmentPayment(planId, paymentMethod) {
  closeQRModal();
  
  const plan = state.treatmentPlans.find(function(tp) { return tp.id === planId; });
  if (!plan) return;
  
  plan.paymentStatus = 'paid';
  plan.paymentMethod = paymentMethod;
  plan.paidAt = new Date().toISOString();
  plan.status = 'paid';
  
  saveAllData();
  
  const patient = state.patients.find(function(p) { return p.id === plan.patientId; });
  
  alert('‚úÖ PAYMENT CONFIRMED!\n\n' +
        'Patient: ' + patient.name + '\n' +
        'Amount: ‚Çπ' + plan.totalCost.toLocaleString('en-IN') + '\n' +
        'Method: ' + paymentMethod + '\n\n' +
        'üëâ Now assign a chair for treatment');
  
  renderTreatmentPlansReception();
}

// Assign chair modal
function assignChairModal(planId) {
  const plan = state.treatmentPlans.find(function(tp) { return tp.id === planId; });
  if (!plan) return;
  
  const patient = state.patients.find(function(p) { return p.id === plan.patientId; });
  const availableChairs = state.chairs.filter(function(c) { return c.status === 'available'; });
  
  if (availableChairs.length === 0) {
    alert('‚ùå No chairs available!\n\nPlease wait for a chair to become free.');
    return;
  }
  
  let chairOptions = 'Select Chair:\n\n';
  availableChairs.forEach(function(c, idx) {
    chairOptions += (idx + 1) + '. Chair ' + c.id + '\n';
  });
  
  const selection = prompt(chairOptions + '\nEnter chair number (1-' + availableChairs.length + '):');
  
  if (!selection) return;
  
  const chairIndex = parseInt(selection) - 1;
  if (chairIndex < 0 || chairIndex >= availableChairs.length) {
    alert('‚ùå Invalid selection');
    return;
  }
  
  const selectedChair = availableChairs[chairIndex];
  
  // Assign chair with patient tracking
  plan.chairAssigned = selectedChair.id;
  plan.status = 'in-treatment';
  selectedChair.status = 'occupied';
  selectedChair.patientName = patient.name;
  selectedChair.patientId = patient.id;
  selectedChair.startTime = new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
  selectedChair.treatmentPlanId = planId;
  
  saveAllData();
  
  alert('‚úÖ CHAIR ASSIGNED!\n\n' +
        'Patient: ' + patient.name + '\n' +
        'Chair: ' + selectedChair.id + '\n' +
        'Time: ' + selectedChair.startTime + '\n\n' +
        'üëâ Patient can proceed to chair ' + selectedChair.id + '\n' +
        'üëâ Treatment ready to begin');
  
  renderTreatmentPlansReception();
}

// View patient details from queue
function viewPatientDetails(patientId) {
  const patient = state.patients.find(function(p) { return p.id === patientId; });
  if (!patient) {
    alert('‚ùå Patient not found');
    return;
  }
  
  // Get patient history
  const previousVisits = state.bills.filter(function(b) { return b.patientId === patientId; });
  const treatmentPlans = state.treatmentPlans.filter(function(tp) { return tp.patientId === patientId; });
  
  let details = 'üë§ PATIENT DETAILS\n\n';
  details += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
  details += 'Name: ' + patient.name + '\n';
  details += 'Age: ' + patient.age + ' | Gender: ' + patient.gender + '\n';
  details += 'Contact: ' + patient.contact + '\n';
  
  if (patient.address) {
    details += 'Address: ' + patient.address + '\n';
  }
  
  if (patient.medicalHistory) {
    details += '\nüè• Medical History:\n' + patient.medicalHistory + '\n';
  }
  
  details += '\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
  details += 'üìä VISIT HISTORY: ' + previousVisits.length + ' visits\n';
  details += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
  
  if (previousVisits.length > 0) {
    previousVisits.slice(-5).reverse().forEach(function(v) {
      details += '\nüìÖ ' + formatIndianDate(v.date) + '\n';
      details += '   Complaint: ' + (v.chiefComplaint || 'Consultation') + '\n';
      details += '   Amount: ‚Çπ' + v.total.toLocaleString('en-IN') + '\n';
    });
  } else {
    details += '\nNo previous visits';
  }
  
  if (treatmentPlans.length > 0) {
    details += '\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
    details += 'üìã TREATMENT PLANS: ' + treatmentPlans.length + '\n';
    details += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
    
    treatmentPlans.slice(-3).reverse().forEach(function(tp) {
      details += '\n' + formatIndianDate(tp.date) + ' - ' + tp.status.toUpperCase() + '\n';
      details += '   ' + tp.chiefComplaint + '\n';
      details += '   Cost: ‚Çπ' + tp.totalCost.toLocaleString('en-IN') + '\n';
    });
  }
  
  alert(details);
}

// View treatment plan details
function viewTreatmentPlanDetails(planId) {
  const plan = state.treatmentPlans.find(function(tp) { return tp.id === planId; });
  if (!plan) return;
  
  const patient = state.patients.find(function(p) { return p.id === plan.patientId; });
  const doctor = state.doctors.find(function(d) { return d.id === plan.doctorId; });
  
  let details = 'üìã TREATMENT PLAN DETAILS\n\n';
  details += 'Patient: ' + patient.name + '\n';
  details += 'Doctor: ' + doctor.name + '\n';
  details += 'Date: ' + formatIndianDate(plan.date) + '\n\n';
  details += 'Chief Complaint: ' + plan.chiefComplaint + '\n';
  details += 'Diagnosis: ' + plan.diagnosis + '\n\n';
  
  if (plan.labTests && plan.labTests.length > 0) {
    details += 'Lab Tests: ' + plan.labTests.join(', ') + '\n\n';
  }
  
  if (plan.teeth && plan.teeth.length > 0) {
    details += 'Teeth: ' + plan.teeth.join(', ') + '\n\n';
  }
  
  if (plan.treatments && plan.treatments.length > 0) {
    details += 'Treatments:\n';
    plan.treatments.forEach(function(t) {
      details += '  ‚Ä¢ ' + t.name + ' - ‚Çπ' + t.cost.toLocaleString('en-IN') + '\n';
    });
    details += '\n';
  }
  
  if (plan.medicines && plan.medicines.length > 0) {
    details += 'Medicines:\n';
    plan.medicines.forEach(function(m) {
      details += '  ‚Ä¢ ' + m.name + '\n';
    });
    details += '\n';
  }
  
  details += 'Total Cost: ‚Çπ' + plan.totalCost.toLocaleString('en-IN') + '\n';
  details += 'Payment Status: ' + (plan.paymentStatus === 'paid' ? 'PAID (' + plan.paymentMethod + ')' : 'PENDING') + '\n';
  details += 'Chair: ' + (plan.chairAssigned ? 'Chair ' + plan.chairAssigned : 'Not assigned') + '\n';
  
  alert(details);
}


// ========== FIXED WORKFLOW - OVERRIDES ABOVE ==========
// ========== UPDATED DOCTOR SECTION WITH IN-TREATMENT PATIENTS ==========
// ============================================================
// ü©∫ ACTIVE CONSULTATION FORM - FULL OPD WITH CHIEF COMPLAINT
// ============================================================

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO-MAPPING FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function autoSuggestTreatments(complaint) {
  if (!complaint || !state.treatmentMappings) return;
  const mappings = state.treatmentMappings.complaintToTreatments[complaint];
  if (!mappings) return;
  
  mappings.forEach(function(tid) {
    const cb = document.querySelector('.consult-t-cb[value="' + tid + '"]');
    if (cb && !cb.checked) {
      cb.checked = true;
      const treatment = state.treatments.find(function(t) { return t.id === tid; });
      if (treatment && !state.currentConsultation.selectedTreatments.some(function(st) { return st.id === tid; })) {
        state.currentConsultation.selectedTreatments.push(treatment);
      }
    }
  });
  
  updateConsultationTotal();
  showToast('‚úÖ Suggested treatments auto-selected');
}

function autoSuggestMedicines() {
  const treatmentIds = Array.from(document.querySelectorAll('.consult-t-cb:checked'))
    .map(function(cb) { return cb.value; });
  
  if (!state.treatmentMappings) return;
  const medicineIds = new Set();
  treatmentIds.forEach(function(tid) {
    const meds = state.treatmentMappings.treatmentToMedicines[tid];
    if (meds) meds.forEach(function(mid) { medicineIds.add(mid); });
  });
  
  medicineIds.forEach(function(mid) {
    const cb = document.querySelector('.consult-m-cb[value="' + mid + '"]');
    if (cb && !cb.checked) {
      cb.checked = true;
      const medicine = state.medicines.find(function(m) { return m.id === mid; });
      if (medicine && !state.currentConsultation.selectedMedicines.some(function(sm) { return sm.id === mid; })) {
        state.currentConsultation.selectedMedicines.push(medicine);
      }
    }
  });
  
  if (medicineIds.size > 0) showToast('‚úÖ Medicines auto-selected');
}

function updateConsultationTotal() {
  const selected = Array.from(document.querySelectorAll('.consult-t-cb:checked'));
  let total = 0;
  selected.forEach(function(cb) {
    const t = state.treatments.find(function(t) { return t.id === parseInt(cb.value); });
    if (t) total += t.cost;
  });
  
  const display = document.getElementById('consult-total-display');
  if (display) display.textContent = '‚Çπ' + total.toLocaleString('en-IN');
}

function showToast(message) {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = 'position:fixed;top:80px;right:20px;background:#10b981;color:white;padding:16px 24px;border-radius:8px;font-weight:600;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.2);';
  document.body.appendChild(toast);
  setTimeout(function() {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(function() { 
      if (toast.parentNode) document.body.removeChild(toast); 
    }, 300);
  }, 3000);
}


function renderActiveConsultationForm() {
  const consultation = state.currentConsultation;
  const patient = state.patients.find(function(p) { return p.id === consultation.patientId; });
  const queueEntry = state.doctorQueue.find(function(q) { return q.id === consultation.queueId; });
  
  if (!patient) {
    alert('‚ùå Patient data not found');
    state.currentConsultation = null;
    renderDoctorsSection();
    return;
  }
  
  // Get patient history
  const previousVisits = state.bills.filter(function(b) { return b.patientId === patient.id; });
  let historyHTML = '';
  if (previousVisits.length > 0) {
    historyHTML = '<div style="background:#e0e7ff;padding:16px;border-radius:12px;margin-bottom:20px;">' +
      '<div style="font-weight:700;color:#3730a3;margin-bottom:10px;">üìã Previous Visits (' + previousVisits.length + ')</div>';
    previousVisits.slice(0,3).forEach(function(v) {
      historyHTML += '<div style="font-size:13px;color:#4338ca;padding:8px 0;border-bottom:1px solid #c7d2fe;">' +
        '<strong>' + formatIndianDate(v.date) + '</strong> ‚Äî ' + (v.chiefComplaint || 'Consultation') +
        ' ‚Äî ‚Çπ' + (v.total||0).toLocaleString('en-IN') + '</div>';
    });
    historyHTML += '</div>';
  }
  
  // Tooth chart
  const quadrants = [
    {id:'Q1', label:'Upper Right (18‚Üí11)', teeth:['18','17','16','15','14','13','12','11']},
    {id:'Q2', label:'Upper Left  (21‚Üí28)', teeth:['21','22','23','24','25','26','27','28']},
    {id:'Q3', label:'Lower Left  (31‚Üí38)', teeth:['31','32','33','34','35','36','37','38']},
    {id:'Q4', label:'Lower Right (41‚Üí48)', teeth:['41','42','43','44','45','46','47','48']},
  ];
  
  const toothChartHTML =
    '<div class="card">' +
    '<h3 style="color:#1e293b;margin-bottom:8px;">ü¶∑ Tooth Chart <span style="font-size:13px;color:#64748b;font-weight:400;">(Click to select)</span></h3>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px;">' +
    quadrants.map(function(q) {
      return '<div><div style="font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;margin-bottom:6px;">' + q.label + '</div>' +
      '<div style="display:flex;flex-wrap:wrap;gap:5px;">' +
      q.teeth.map(function(t) {
        const sel = consultation.selectedTeeth.includes(t);
        return '<div id="ct-' + t + '" onclick="toggleConsultationTooth(\'' + t + '\')" ' +
          'style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;' +
          'border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;transition:all 0.15s;' +
          'background:' + (sel?'#10b981':'#f1f5f9') + ';color:' + (sel?'white':'#475569') + ';' +
          'border:2px solid ' + (sel?'#059669':'#cbd5e1') + ';">' + t + '</div>';
      }).join('') + '</div></div>';
    }).join('') +
    '</div>' +
    '<div id="consult-teeth-display" style="margin-top:12px;padding:10px;background:#f0fdf4;border-radius:8px;font-size:13px;font-weight:600;color:#065f46;">' +
    'ü¶∑ Selected: ' + (consultation.selectedTeeth.length ? consultation.selectedTeeth.join(', ') : 'None') +
    '</div></div>';
  
  const formHTML =
    '<div class="app-layout">' +
    renderSidebar('#doctors-section') +
    '<div class="main-wrapper">' +
    '<div class="top-bar">' +
    mobileMenuButton() +
    '<h1 class="page-title" style="margin:0;">üë®‚Äç‚öïÔ∏è OPD Consultation Form</h1>' +
    '<div class="user-profile">' +
    '<div class="user-avatar">' + state.currentUser.name.charAt(0) + '</div>' +
    '<div class="user-name">' + state.currentUser.name + '</div>' +
    '</div></div>' +
    '<div class="content-area">' +
    
    // Header Card
    '<div class="card" style="background:linear-gradient(135deg,#7c3aed,#5b21b6);color:white;margin-bottom:0;">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;">' +
    '<div>' +
    '<h2 style="margin:0;font-size:26px;">üìã ' + patient.name + '</h2>' +
    '<div style="font-size:14px;opacity:0.9;margin-top:6px;">' +
      patient.age + 'Y / ' + patient.gender + ' | ' + patient.contact + '</div>' +
    '</div>' +
    '<button onclick="cancelConsultationForm()" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:600;">‚úï Cancel</button>' +
    '</div></div>' +
    
    // Patient History
    (historyHTML ? '<div class="card" style="background:#f8fafc;">' + historyHTML + '</div>' : '') +
    
    // CONSULTATION FEE STATUS (if already paid, show green card)
    (function() {
      const queueEntry = state.doctorQueue.find(function(q) { return q.id === consultation.queueId; });
      const consultationPaid = queueEntry && queueEntry.consultationFee > 0;
      
      if (consultationPaid) {
        return '<div class="card" style="border-top:4px solid #10b981;background:#f0fdf4;">' +
          '<div style="display:flex;justify-content:space-between;align-items:center;">' +
          '<div>' +
          '<h3 style="color:#065f46;margin:0;font-size:20px;font-weight:800;">‚úÖ Consultation Fee Already Paid</h3>' +
          '<p style="color:#047857;font-size:14px;margin-top:8px;margin-bottom:0;">Consultation fee was collected at registration. No additional consultation charge needed.</p>' +
          '</div>' +
          '<div style="background:#10b981;color:white;padding:16px 24px;border-radius:12px;text-align:center;">' +
          '<div style="font-size:12px;opacity:0.9;">Paid</div>' +
          '<div style="font-size:28px;font-weight:900;">‚Çπ' + queueEntry.consultationFee + '</div>' +
          '</div>' +
          '</div>' +
          '</div>';
      }
      return ''; // No card if not paid
    })() +
    
    // ‚ë† CHIEF COMPLAINT (STARTS HERE!)
    '<div class="card" style="border-top:4px solid #7c3aed;">' +
    '<h3 style="color:#7c3aed;margin-bottom:8px;font-size:20px;">‚ë† Chief Complaint *</h3>' +
    '<p style="color:#64748b;font-size:13px;margin-bottom:12px;">Select primary reason for visit</p>' +
    '<select id="consult-chief-complaint" onchange="autoSuggestTreatments(this.value)" style="width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:8px;font-size:15px;background:white;">' +
    '<option value="">-- Select Chief Complaint --</option>' +
    chiefComplaintLibrary.map(function(cc) {
      return '<option value="' + cc + '"' + (consultation.chiefComplaint===cc?' selected':'') + '>' + cc + '</option>';
    }).join('') +
    '</select></div>' +
    
    // ‚ë° DIAGNOSIS
    '<div class="card" style="border-top:4px solid #3b82f6;">' +
    '<h3 style="color:#3b82f6;margin-bottom:8px;font-size:20px;">‚ë° Clinical Diagnosis</h3>' +
    '<textarea id="consult-diagnosis" rows="3" oninput="this.value=this.value.toUpperCase()" ' +
    'placeholder="ENTER CLINICAL FINDINGS..." ' +
    'style="width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;font-family:monospace;text-transform:uppercase;resize:vertical;">' +
    consultation.diagnosis + '</textarea></div>' +
    
    // ‚ë¢ LAB TESTS
    '<div class="card" style="border-top:4px solid #f59e0b;">' +
    '<h3 style="color:#92400e;margin-bottom:8px;font-size:20px;">‚ë¢ Investigations / Lab Tests</h3>' +
    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;">' +
    ['IOPA','OPG','CBCT','LATERAL CEPH','BLOOD TEST','BIOPSY'].map(function(test) {
      const sel = consultation.selectedTests.includes(test);
      return '<label style="display:flex;align-items:center;gap:8px;padding:12px;border-radius:8px;cursor:pointer;font-weight:600;border:2px solid ' + (sel?'#3b82f6':'#e2e8f0') + ';background:' + (sel?'#dbeafe':'#f8fafc') + ';">' +
        '<input type="checkbox" class="consult-lab-cb" value="' + test + '"' + (sel?' checked':'') + ' style="width:18px;height:18px;">' +
        '<span style="font-size:13px;">' + test + '</span></label>';
    }).join('') + '</div></div>' +
    
    // ‚ë£ TOOTH CHART
    toothChartHTML +
    
    // ‚ë§ TREATMENTS
    '<div class="card" style="border-top:4px solid #10b981;">' +
    '<h3 style="color:#065f46;margin-bottom:8px;font-size:20px;">‚ë§ Treatments / Procedures Recommended</h3>' +
    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;">' +
    state.treatments.map(function(t) {
      const sel = consultation.selectedTreatments.some(function(st) { return st.id === t.id; });
      return '<label style="display:flex;align-items:start;padding:12px;cursor:pointer;gap:10px;border-radius:8px;border:2px solid ' + (sel?'#10b981':'#e2e8f0') + ';background:' + (sel?'#d1fae5':'#f8fafc') + ';">' +
        '<input type="checkbox" class="consult-t-cb" onchange="autoSuggestMedicines()" value="' + t.id + '"' + (sel?' checked':'') + ' style="width:18px;height:18px;margin-top:2px;">' +
        '<div><div style="font-weight:600;color:#1e293b;">' + t.name + '</div>' +
        '<div style="font-size:13px;color:#10b981;font-weight:700;">‚Çπ' + t.cost.toLocaleString('en-IN') + '</div></div></label>';
    }).join('') + '</div></div>' +
    
    // ‚ë• MEDICINES
    '<div class="card" style="border-top:4px solid #8b5cf6;">' +
    '<h3 style="color:#5b21b6;margin-bottom:8px;font-size:20px;">‚ë• Medicines Prescribed</h3>' +
    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;">' +
    state.medicines.map(function(m) {
      const sel = consultation.selectedMedicines.some(function(sm) { return sm.id === m.id; });
      return '<label style="display:flex;align-items:start;padding:12px;cursor:pointer;gap:10px;border-radius:8px;border:2px solid ' + (sel?'#8b5cf6':'#e2e8f0') + ';background:' + (sel?'#ede9fe':'#f8fafc') + ';">' +
        '<input type="checkbox" class="consult-m-cb" value="' + m.id + '"' + (sel?' checked':'') + ' style="width:18px;height:18px;margin-top:2px;">' +
        '<div><div style="font-weight:600;color:#5b21b6;">' + m.name + '</div>' +
        '<div style="font-size:12px;color:#6d28d9;">' + m.dosage + ' | ' + m.frequency + ' | ' + m.duration + '</div></div></label>';
    }).join('') + '</div></div>' +
    
    // ‚ë¶ NOTES
    '<div class="card" style="border-top:4px solid #06b6d4;">' +
    '<h3 style="color:#0e7490;margin-bottom:8px;font-size:20px;">‚ë¶ Additional Notes / Advice</h3>' +
    '<textarea id="consult-notes" rows="3" placeholder="Any additional instructions, patient advice, follow-up recommendations..." ' +
    'style="width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;resize:vertical;">' +
    consultation.notes + '</textarea></div>' +
    
    // ‚ëß NEXT VISIT DATE
    '<div class="card" style="border-top:4px solid #ec4899;">' +
    '<h3 style="color:#be185d;margin-bottom:8px;font-size:20px;">‚ëß Next Visit Date <span style="font-size:13px;color:#64748b;font-weight:400;">(Optional)</span></h3>' +
    '<p style="color:#64748b;font-size:13px;margin-bottom:12px;">Schedule follow-up appointment if needed</p>' +
    '<input type="date" id="consult-next-visit" ' +
    'value="' + (consultation.nextVisitDate || '') + '" ' +
    'min="' + new Date().toISOString().split('T')[0] + '" ' +
    'style="width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:8px;font-size:15px;background:white;">' +
    '</div>' +
    
    // SAVE BUTTON
    '<div style="text-align:center;padding:24px 0 48px;">' +
    '<button onclick="saveConsultationForm()" ' +
    'style="background:linear-gradient(135deg,#7c3aed,#4f46e5);color:white;padding:18px 60px;' +
    'border:none;border-radius:12px;font-size:20px;font-weight:900;cursor:pointer;' +
    'box-shadow:0 8px 24px rgba(124,58,237,0.4);letter-spacing:0.5px;">üíæ SAVE TREATMENT PLAN</button>' +
    '<div style="color:#64748b;font-size:13px;margin-top:12px;">Creates treatment plan ‚Üí Sends to Reception for payment</div>' +
    '</div>' +
    
    '</div></div></div>';
  
  document.getElementById('app').innerHTML = formHTML;
}

function toggleConsultationTooth(tooth) {
  if (!state.currentConsultation) return;
  const idx = state.currentConsultation.selectedTeeth.indexOf(tooth);
  const el = document.getElementById('ct-' + tooth);
  if (idx === -1) {
    state.currentConsultation.selectedTeeth.push(tooth);
    if (el) Object.assign(el.style, {background:'#10b981', color:'white', borderColor:'#059669'});
  } else {
    state.currentConsultation.selectedTeeth.splice(idx, 1);
    if (el) Object.assign(el.style, {background:'#f1f5f9', color:'#475569', borderColor:'#cbd5e1'});
  }
  const disp = document.getElementById('consult-teeth-display');
  if (disp) disp.textContent = 'ü¶∑ Selected: ' + (state.currentConsultation.selectedTeeth.length ? state.currentConsultation.selectedTeeth.join(', ') : 'None');
}

function cancelConsultationForm() {
  if (confirm('Cancel consultation? Patient will remain in waiting queue.')) {
    // Reset queue status back to waiting
    const queueEntry = state.doctorQueue.find(function(q) { return q.id === state.currentConsultation.queueId; });
    if (queueEntry) queueEntry.status = 'waiting';
    state.currentConsultation = null;
    saveAllData();
    renderDoctorsSection();
  }
}

function saveConsultationForm() {
  const c = state.currentConsultation;
  const chiefComplaint = document.getElementById('consult-chief-complaint').value.trim();
  const diagnosis = document.getElementById('consult-diagnosis').value.trim().toUpperCase();
  const notes = document.getElementById('consult-notes').value.trim();
  const nextVisitDate = document.getElementById('consult-next-visit').value;
  
  if (!chiefComplaint) {
    alert('‚ö†Ô∏è Please select Chief Complaint');
    return;
  }
  if (!diagnosis) {
    alert('‚ö†Ô∏è Please enter Clinical Diagnosis');
    return;
  }
  
  // Get selected lab tests
  const labTests = Array.from(document.querySelectorAll('.consult-lab-cb:checked')).map(function(cb) { return cb.value; });
  
  // Get selected treatments
  const tIds = Array.from(document.querySelectorAll('.consult-t-cb:checked')).map(function(cb) { return parseInt(cb.value); });
  const treatments = tIds.map(function(id) { return state.treatments.find(function(t) { return t.id === id; }); }).filter(Boolean);
  
  // Get selected medicines
  const mIds = Array.from(document.querySelectorAll('.consult-m-cb:checked')).map(function(cb) { return parseInt(cb.value); });
  const medicines = mIds.map(function(id) { return state.medicines.find(function(m) { return m.id === id; }); }).filter(Boolean);
  
  const totalCost = treatments.reduce(function(sum, t) { return sum + (t.cost || 0); }, 0);
  
  // Create treatment plan
  const plan = {
    id: generateId(state.treatmentPlans),
    patientId: c.patientId,
    doctorId: c.doctorId,
    date: new Date().toISOString().split('T')[0],
    chiefComplaint: chiefComplaint,
    diagnosis: diagnosis,
    labTests: labTests,
    teeth: c.selectedTeeth,
    treatments: treatments,
    medicines: medicines,
    notes: notes,
    nextVisitDate: nextVisitDate || null,
    totalCost: totalCost,
    status: 'pending',
    chairAssigned: null
  };
  
  state.treatmentPlans.push(plan);
  
  // Mark queue entry as completed
  const queueEntry = state.doctorQueue.find(function(q) { return q.id === c.queueId; });
  if (queueEntry) queueEntry.status = 'completed';
  
  // Clear current consultation
  state.currentConsultation = null;
  
  saveAllData();
  
  alert('‚úÖ Treatment Plan Created!\n\n' +
    'Patient: ' + state.patients.find(function(p) { return p.id === plan.patientId; }).name + '\n' +
    'Chief Complaint: ' + chiefComplaint + '\n' +
    'Treatments: ' + treatments.map(function(t) { return t.name; }).join(', ') + '\n' +
    'Total Cost: ‚Çπ' + totalCost.toLocaleString('en-IN') + '\n\n' +
    'üì§ Plan sent to Reception for payment collection!');
  
  renderDoctorsSection();
}

function renderDoctorsSection() {
  // üî• CHECK IF CONSULTATION IS ACTIVE - SHOW OPD FORM!
  if (state.currentConsultation) {
    renderActiveConsultationForm();
    return;
  }
  
  // Get patients waiting for initial consultation
  const waitingPatients = state.doctorQueue.filter(function(q) {
    return q.status === 'waiting' && 
           (q.doctorId === state.currentUser.id || state.currentUser.role === 'admin');
  });
  
  // Get patients in treatment (paid, chair assigned)
  const inTreatmentPatients = state.treatmentPlans.filter(function(tp) {
    return tp.status === 'in-treatment' && 
           (tp.doctorId === state.currentUser.id || state.currentUser.role === 'admin');
  });
  
  // Get completed treatment plans
  const myTreatmentPlans = state.treatmentPlans.filter(function(tp) {
    return (tp.doctorId === state.currentUser.id || state.currentUser.role === 'admin') &&
           tp.status === 'completed';
  });
  
  const html = '<div class="app-layout">' +
    renderSidebar('#doctors-section') +
    '<div class="main-wrapper">' +
    '<div class="top-bar">' +
    mobileMenuButton() +
    '<h1 class="page-title" style="margin: 0;">üë®‚Äç‚öïÔ∏è Doctor Consultation</h1>' +
    '<div class="user-profile">' +
    '<div class="user-avatar">' + state.currentUser.name.charAt(0) + '</div>' +
    '<div class="user-name">' + state.currentUser.name + '</div>' +
    '</div>' +
    '</div>' +
    '<div class="content-area">' +
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üéØ BANNER CARDS - Patient Status Overview
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // BANNER 1: Waiting for Initial Consultation (Yellow)
    '<div class="card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">' +
    '<div style="display: flex; justify-content: space-between; align-items: center;">' +
    '<div style="flex: 1;">' +
    '<h2 style="margin: 0; font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px;">' +
    '<span>‚è≥</span>' +
    '<span>WAITING FOR INITIAL CONSULTATION</span>' +
    '</h2>' +
    '<div style="margin-top: 12px; font-size: 15px; opacity: 0.95; line-height: 1.6;">' +
    (waitingPatients.length === 0 ? 
      '<span style="color: rgba(255,255,255,0.9);">‚úÖ No patients waiting</span>' :
      '<strong>Patients:</strong> ' + waitingPatients.map(function(q) {
        const p = state.patients.find(function(pat) { return pat.id === q.patientId; });
        return '<span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px; display: inline-block; margin: 2px;">' + (p ? p.name : 'Unknown') + '</span>';
      }).join(' ')) +
    '</div>' +
    '</div>' +
    '<div style="background: rgba(255,255,255,0.2); padding: 18px 28px; border-radius: 12px; text-align: center;">' +
    '<div style="font-size: 40px; font-weight: 900; line-height: 1;">' + waitingPatients.length + '</div>' +
    '<div style="font-size: 11px; text-transform: uppercase; margin-top: 4px; opacity: 0.9; letter-spacing: 1px;">Waiting</div>' +
    '</div>' +
    '</div>' +
    '</div>' +
    
    // BANNER 2: Patients in Treatment (Red ‚Üí Green when all complete)
    (function() {
      const allCompleted = inTreatmentPatients.length > 0 && inTreatmentPatients.every(function(tp) { return tp.status === 'completed'; });
      const bannerColor = inTreatmentPatients.length === 0 ? '#94a3b8' : (allCompleted ? '#10b981' : '#ef4444');
      const bannerColorDark = inTreatmentPatients.length === 0 ? '#64748b' : (allCompleted ? '#059669' : '#dc2626');
      const icon = inTreatmentPatients.length === 0 ? 'üí§' : (allCompleted ? '‚úÖ' : 'üö®');
      
      return '<div class="card" style="background: linear-gradient(135deg, ' + bannerColor + ' 0%, ' + bannerColorDark + ' 100%); color: white; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">' +
        '<div style="display: flex; justify-content: space-between; align-items: center;">' +
        '<div style="flex: 1;">' +
        '<h2 style="margin: 0; font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px;">' +
        '<span>' + icon + '</span>' +
        '<span>PATIENTS IN TREATMENT</span>' +
        '</h2>' +
        '<div style="margin-top: 12px; font-size: 15px; opacity: 0.95; line-height: 1.6;">' +
        (inTreatmentPatients.length === 0 ?
          '<span style="color: rgba(255,255,255,0.9);">No patients in treatment</span>' :
          '<strong>Patients:</strong> ' + inTreatmentPatients.map(function(tp) {
            const p = state.patients.find(function(pat) { return pat.id === tp.patientId; });
            return '<span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px; display: inline-block; margin: 2px;">' + (p ? p.name : 'Unknown') + '</span>';
          }).join(' ')) +
        '</div>' +
        '</div>' +
        '<div style="background: rgba(255,255,255,0.2); padding: 18px 28px; border-radius: 12px; text-align: center;">' +
        '<div style="font-size: 40px; font-weight: 900; line-height: 1;">' + inTreatmentPatients.length + '</div>' +
        '<div style="font-size: 11px; text-transform: uppercase; margin-top: 4px; opacity: 0.9; letter-spacing: 1px;">' + (allCompleted ? 'Done' : 'Active') + '</div>' +
        '</div>' +
        '</div>' +
        '</div>';
    })() +
    
    // Continue with existing content
    '<div class="card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);">' +
    '<div style="display: flex; justify-content: space-between; align-items: center;">' +
    '<div>' +
    '<h2 style="margin: 0; font-size: 24px; font-weight: 900;">üö® PATIENTS IN TREATMENT (' + inTreatmentPatients.length + ') - ACTION REQUIRED</h2>' +
    '<p style="opacity: 0.95; margin-top: 8px; font-size: 15px; font-weight: 500;">Patients assigned to chair - Ready for procedure NOW!</p>' +
    '</div>' +
    (inTreatmentPatients.length > 0 ? '<div style="font-size: 64px; opacity: 0.3;">üîî</div>' : '') +
    '</div>' +
    '</div>' +
    (inTreatmentPatients.length === 0 ?
      '<div style="text-align: center; padding: 30px; color: #94a3b8; background: #f8fafc; border-radius: 8px; margin-bottom: 20px;">‚úÖ No patients in treatment currently</div>' :
      '<div class="data-table" style="margin-bottom: 20px;">' +
      '<table>' +
      '<thead><tr><th>Patient</th><th>Chief Complaint</th><th>Treatments Planned</th><th>Amount Paid</th><th>Chair</th><th>Actions</th></tr></thead>' +
      '<tbody>' +
      inTreatmentPatients.map(function(tp) {
        const patient = state.patients.find(function(p) { return p.id === tp.patientId; });
        const treatmentNames = tp.treatments.map(function(t) { return t.name; }).join(', ');
        return '<tr style="background: #fef3c7; border-left: 4px solid #f59e0b;">' +
          '<td><strong style="font-size: 16px;">' + (patient ? patient.name : 'N/A') + '</strong><br>' +
          '<span style="font-size: 12px; color: #64748b;">' + (patient ? patient.contact : '') + '</span></td>' +
          '<td><strong>' + tp.chiefComplaint + '</strong></td>' +
          '<td style="font-size: 13px;">' + treatmentNames.substring(0, 50) + (treatmentNames.length > 50 ? '...' : '') + '</td>' +
          '<td style="font-weight: 800; color: #10b981; font-size: 16px;">‚Çπ' + tp.totalCost.toLocaleString('en-IN') + '</td>' +
          '<td><div style="background: #3b82f6; color: white; padding: 8px 12px; border-radius: 8px; text-align: center; font-weight: 700;">Chair ' + tp.chairAssigned + '</div></td>' +
          '<td>' +
          '<button class="btn" style="background: #3b82f6; color: white; margin-right: 5px; padding: 10px 18px; font-weight: 600;" onclick="viewTreatmentPlanInDoctor(' + tp.id + ')">üëÅÔ∏è View</button>' +
          '<button class="btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 10px 18px; font-weight: 700; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);" onclick="completeTreatmentAndPrescribe(' + tp.id + ')">‚úÖ Start Treatment</button>' +
          '</td>' +
          '</tr>';
      }).join('') +
      '</tbody></table></div>') +
    
    // CHAIR STATUS DISPLAY
    '<div class="card" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; margin-bottom: 20px;">' +
    '<h2 style="margin: 0 0 15px 0; font-size: 18px;">üí∫ Chair Status</h2>' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">' +
    state.chairs.map(function(chair) {
      const isOccupied = chair.status === 'occupied';
      return '<div style="background: ' + (isOccupied ? 'rgba(239, 68, 68, 0.9)' : 'rgba(16, 185, 129, 0.9)') + '; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid ' + (isOccupied ? '#dc2626' : '#059669') + ';">' +
        '<div style="font-size: 24px; margin-bottom: 8px;">' + (isOccupied ? 'üî¥' : 'üü¢') + '</div>' +
        '<div style="font-weight: 700; font-size: 16px;">Chair ' + chair.id + '</div>' +
        '<div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">' + 
        (isOccupied ? 
          (chair.patientName || 'Occupied') + '<br>' + (chair.startTime || '') :
          'Available') +
        '</div>' +
        '</div>';
    }).join('') +
    '</div>' +
    '</div>' +
    
    // WAITING PATIENTS CARD
    '<div class="card">' +
    '<h2 class="section-title">‚è≥ Waiting for Initial Consultation (' + waitingPatients.length + ')</h2>' +
    (waitingPatients.length === 0 ?
      '<div style="text-align: center; padding: 40px; color: #94a3b8;">No patients waiting</div>' :
      '<div class="data-table">' +
      '<table>' +
      '<thead><tr><th>Time</th><th>Patient</th><th>Phone</th><th>Consultation Fee</th><th>Actions</th></tr></thead>' +
      '<tbody>' +
      waitingPatients.map(function(q) {
        const patient = state.patients.find(function(p) { return p.id === q.patientId; });
        return '<tr>' +
          '<td><strong>' + q.time + '</strong></td>' +
          '<td>' + (patient ? patient.name : 'N/A') + '</td>' +
          '<td>' + (patient ? patient.contact : 'N/A') + '</td>' +
          '<td style="color: #10b981; font-weight: 600;">‚Çπ' + q.consultationFee + ' Paid</td>' +
          '<td><button class="btn-primary" onclick="startConsultation(' + q.patientId + ', ' + q.id + ')">‚ñ∂Ô∏è Start Consultation</button></td>' +
          '</tr>';
      }).join('') +
      '</tbody></table></div>') +
    '</div>' +
    
    // CONSULTATION FORM (hidden until patient selected)
    '<div id="consultation-form" style="display: none;"></div>' +
    
    // PROCEDURE COMPLETION FORM (hidden until selected)
    '<div id="procedure-form" style="display: none;"></div>' +
    
    // COMPLETED TREATMENT PLANS
    '<div class="card" style="margin-top: 30px;">' +
    '<h2 class="section-title">‚úÖ Completed Today (' + myTreatmentPlans.length + ')</h2>' +
    (myTreatmentPlans.length === 0 ?
      '<div style="text-align: center; padding: 30px; color: #94a3b8;">No completed treatments today</div>' :
      '<div class="data-table">' +
      '<table>' +
      '<thead><tr><th>Date</th><th>Patient</th><th>Chief Complaint</th><th>Total</th><th>Status</th></tr></thead>' +
      '<tbody>' +
      myTreatmentPlans.map(function(tp) {
        const patient = state.patients.find(function(p) { return p.id === tp.patientId; });
        return '<tr>' +
          '<td>' + formatIndianDate(tp.date) + '</td>' +
          '<td>' + (patient ? patient.name : 'N/A') + '</td>' +
          '<td>' + tp.chiefComplaint + '</td>' +
          '<td>‚Çπ' + tp.totalCost.toLocaleString('en-IN') + '</td>' +
          '<td><span style="color: #10b981; font-weight: 600;">‚úÖ Done</span></td>' +
          '</tr>';
      }).join('') +
      '</tbody></table></div>') +
    '</div>' +
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üí∞ BILL HISTORY - Doctor's Financial Overview
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    (function() {
      const myBills = state.bills ? state.bills.filter(function(b) {
        return b.doctorId === state.currentUser.id || state.currentUser.role === 'admin';
      }).sort(function(a, b) { return new Date(b.date) - new Date(a.date); }) : [];
      
      const totalRevenue = myBills.reduce(function(sum, b) { return sum + (b.total || 0); }, 0);
      
      return '<div class="card" style="margin-top: 30px;">' +
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
        '<h2 class="section-title">üí∞ My Bill History (' + myBills.length + ' bills)</h2>' +
        '<div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 10px;">' +
        '<div style="font-size: 12px; opacity: 0.9;">Total Revenue</div>' +
        '<div style="font-size: 24px; font-weight: 900;">‚Çπ' + totalRevenue.toLocaleString('en-IN') + '</div>' +
        '</div>' +
        '</div>' +
        (myBills.length === 0 ?
          '<div style="text-align: center; padding: 40px; color: #94a3b8;">No bills generated yet</div>' :
          '<div class="data-table">' +
          '<table>' +
          '<thead><tr><th>Date</th><th>Patient</th><th>Chief Complaint</th><th>Treatments</th><th>Total</th><th>Actions</th></tr></thead>' +
          '<tbody>' +
          myBills.slice(0, 20).map(function(bill) {
            const patient = state.patients.find(function(p) { return p.id === bill.patientId; });
            const treatments = bill.treatments ? bill.treatments.map(function(t) { return t.name; }).join(', ') : 'Consultation';
            return '<tr>' +
              '<td><strong>' + formatIndianDate(bill.date) + '</strong></td>' +
              '<td>' + (patient ? patient.name : 'N/A') + '<br><span style="font-size: 12px; color: #64748b;">' + (patient ? patient.contact : '') + '</span></td>' +
              '<td>' + (bill.chiefComplaint || 'N/A') + '</td>' +
              '<td style="font-size: 13px;">' + (treatments.length > 50 ? treatments.substring(0, 50) + '...' : treatments) + '</td>' +
              '<td style="font-weight: 700; color: #10b981; font-size: 16px;">‚Çπ' + (bill.total || 0).toLocaleString('en-IN') + '</td>' +
              '<td><button class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="viewBillDetails(' + bill.id + ')">üìÑ View</button></td>' +
              '</tr>';
          }).join('') +
          '</tbody></table></div>') +
        '</div>';
    })() +
    
    '</div></div></div>';
  
  document.getElementById('app').innerHTML = html;
}

// Start consultation from queue (called by Doctor Section waiting list)
function startConsultation(patientId, queueId) {
  const patient = state.patients.find(function(p) { return p.id === patientId; });
  const queueEntry = state.doctorQueue.find(function(q) { return q.id === queueId; });
  
  if (!patient || !queueEntry) {
    alert('‚ùå Patient not found');
    return;
  }
  
  // Update queue status to with-doctor
  queueEntry.status = 'with-doctor';
  saveAllData();
  
  // Set current patient for consultation
  state.currentConsultation = {
    patientId: patientId,
    queueId: queueId,
    doctorId: state.currentUser.id,
    chiefComplaint: '',
    diagnosis: '',
    selectedTests: [],
    selectedTeeth: [],
    selectedTreatments: [],
    selectedMedicines: [],
    notes: '',
    nextVisitDate: ''
  };
  
  // Re-render doctors section which will now show consultation form
  renderDoctorsSection();
}

function completeTreatmentAndPrescribe(planId) {
  const plan = state.treatmentPlans.find(function(tp) { return tp.id === planId; });
  if (!plan) return;
  
  const patient = state.patients.find(function(p) { return p.id === plan.patientId; });
  
  // Show patient history
  const previousVisits = state.bills.filter(function(b) { return b.patientId === plan.patientId; });
  let historyHTML = '';
  
  if (previousVisits.length > 0) {
    historyHTML = '<div style="background: #e0e7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' +
      '<div style="font-weight: 600; color: #3730a3; margin-bottom: 10px;">üìã Previous Visits (' + previousVisits.length + ')</div>';
    
    previousVisits.slice(0, 3).forEach(function(v) {
      historyHTML += '<div style="font-size: 13px; color: #4338ca; padding: 6px 0; border-bottom: 1px solid #c7d2fe;">' +
        '<div><strong>' + formatIndianDate(v.date) + '</strong> - ' + (v.chiefComplaint || 'Consultation') + '</div>' +
        '<div style="font-size: 12px; margin-top: 2px;">Diagnosis: ' + (v.diagnosis || 'N/A') + ' | Total: ‚Çπ' + v.total.toLocaleString('en-IN') + '</div>' +
        '</div>';
    });
    
    historyHTML += '</div>';
  }
  
  // Create EDITABLE consultation form (pre-filled with treatment plan data)
  const formHTML = '<div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">' +
    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
    '<div>' +
    '<h2 style="margin: 0; font-size: 24px;">üë®‚Äç‚öïÔ∏è COMPLETE TREATMENT: ' + patient.name + '</h2>' +
    '<div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Chair ' + plan.chairAssigned + ' | Phone: ' + patient.contact + ' | Age: ' + patient.age + ' | Gender: ' + patient.gender + '</div>' +
    '</div>' +
    '<button class="btn-secondary" onclick="cancelProcedureForm()" style="background: rgba(255,255,255,0.2); color: white;">‚Üê Back</button>' +
    '</div>' +
    '</div>' +
    
    historyHTML +
    
    '<div class="card" style="background: #fef3c7; border: 2px solid #f59e0b;">' +
    '<div style="color: #92400e; font-weight: 600; font-size: 16px;">‚ö†Ô∏è EDITABLE FORM - You can change everything below before finalizing</div>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">1Ô∏è‚É£ CHIEF COMPLAINT *</h3>' +
    '<select id="chief-complaint-edit" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #667eea; border-radius: 8px;">' +
    '<option value="">-- Select Chief Complaint --</option>' +
    DENTAL_ISSUES.map(function(issue) {
      return '<option value="' + issue + '" ' + (plan.chiefComplaint === issue ? 'selected' : '') + '>' + issue + '</option>';
    }).join('') +
    '</select>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">2Ô∏è‚É£ DIAGNOSIS *</h3>' +
    '<textarea id="diagnosis-edit" rows="4" style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid #667eea; border-radius: 8px; text-transform: uppercase;" placeholder="Enter clinical diagnosis (auto-uppercase)" oninput="this.value = this.value.toUpperCase()">' + (plan.diagnosis || '') + '</textarea>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">3Ô∏è‚É£ LAB TESTS / INVESTIGATIONS</h3>' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">' +
    ['IOPA (Intraoral X-ray)', 'OPG (Panoramic X-ray)', 'CBCT (3D Scan)', 'Lateral Ceph', 'Blood Test', 'Biopsy'].map(function(test) {
      const isChecked = plan.labTests && plan.labTests.includes(test);
      return '<label style="display: flex; align-items: center; padding: 10px; background: #f8fafc; border-radius: 6px; cursor: pointer;">' +
        '<input type="checkbox" class="lab-test-checkbox-edit" value="' + test + '" ' + (isChecked ? 'checked' : '') + ' style="margin-right: 8px; width: 18px; height: 18px;">' +
        '<span>' + test + '</span>' +
        '</label>';
    }).join('') +
    '</div>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">4Ô∏è‚É£ TOOTH CHART (FDI Notation)</h3>' +
    renderToothChartForDoctorEdit(plan.teeth || []) +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">5Ô∏è‚É£ TREATMENTS PLANNED</h3>' +
    '<div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 15px;">' +
    '<div style="color: #92400e; font-weight: 600;">üí° Current Total: ‚Çπ' + plan.totalCost.toLocaleString('en-IN') + ' (Already Paid)</div>' +
    '<div style="color: #92400e; font-size: 13px; margin-top: 5px;">You can modify treatments - cost will update automatically</div>' +
    '</div>' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px;">' +
    state.treatments.map(function(t) {
      const isSelected = plan.treatments && plan.treatments.some(function(pt) { return pt.id === t.id; });
      return '<label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ' + (isSelected ? '#d1fae5' : '#f8fafc') + '; border: 2px solid ' + (isSelected ? '#10b981' : '#e2e8f0') + '; border-radius: 8px; cursor: pointer;" onmouseover="this.style.borderColor=\'#667eea\'" onmouseout="this.style.borderColor=\'' + (isSelected ? '#10b981' : '#e2e8f0') + '\'">' +
        '<div style="display: flex; align-items: center;">' +
        '<input type="checkbox" class="treatment-checkbox-edit" value="' + t.id + '" data-cost="' + t.cost + '" ' + (isSelected ? 'checked' : '') + ' style="margin-right: 10px; width: 18px; height: 18px;" onchange="updateTotalCostEdit()">' +
        '<span>' + t.name + '</span>' +
        '</div>' +
        '<span style="font-weight: 600; color: #10b981;">‚Çπ' + t.cost.toLocaleString('en-IN') + '</span>' +
        '</label>';
    }).join('') +
    '</div>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">6Ô∏è‚É£ MEDICINES</h3>' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px;">' +
    state.medicines.map(function(m) {
      const isSelected = plan.medicines && plan.medicines.some(function(pm) { return pm.id === m.id; });
      return '<label style="display: flex; align-items: start; padding: 12px; background: ' + (isSelected ? '#d1fae5' : '#f0fdf4') + '; border: 2px solid ' + (isSelected ? '#10b981' : '#d1fae5') + '; border-radius: 8px; cursor: pointer;">' +
        '<input type="checkbox" class="medicine-checkbox-edit" value="' + m.id + '" ' + (isSelected ? 'checked' : '') + ' style="margin-right: 10px; width: 18px; height: 18px; margin-top: 2px;">' +
        '<div>' +
        '<div style="font-weight: 600; color: #065f46;">' + m.name + '</div>' +
        '<div style="font-size: 12px; color: #059669; margin-top: 3px;">' + m.dosage + ' | ' + m.frequency + ' | ' + m.duration + '</div>' +
        '</div>' +
        '</label>';
    }).join('') +
    '</div>' +
    '</div>' +
    
    // Updated Total Cost Display
    '<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center;">' +
    '<h2 style="margin: 0; font-size: 20px; font-weight: 700; margin-bottom: 10px;">üí∞ UPDATED TREATMENT COST</h2>' +
    '<div id="total-cost-display-edit" style="font-size: 48px; font-weight: 900; margin: 20px 0;">‚Çπ ' + plan.totalCost.toLocaleString('en-IN') + '</div>' +
    '<div style="font-size: 14px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">' +
    'üí° Original amount paid: ‚Çπ' + plan.totalCost.toLocaleString('en-IN') + '<br>' +
    'If cost increased, collect difference. If decreased, refund will be shown below.' +
    '</div>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #10b981; margin-bottom: 15px; font-size: 20px;">üìù PROCEDURE DONE TODAY *</h3>' +
    '<textarea id="procedure-done" rows="6" style="width: 100%; padding: 15px; font-size: 15px; border: 3px solid #10b981; border-radius: 8px; text-transform: uppercase; font-family: monospace;" placeholder="Enter detailed procedure notes (auto-UPPERCASE)&#10;&#10;Example:&#10;- RCT COMPLETED ON TOOTH 46&#10;- CROWN PREPARATION DONE&#10;- TEMPORARY FILLING PLACED&#10;- PATIENT ADVISED REST" oninput="this.value = this.value.toUpperCase()"></textarea>' +
    '<div style="color: #64748b; font-size: 13px; margin-top: 8px;">üí° Be specific about what was done today</div>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 20px;">üìù NOTES / INSTRUCTIONS FOR PATIENT</h3>' +
    '<textarea id="notes-edit" rows="3" style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid #667eea; border-radius: 8px;" placeholder="Any special instructions or notes">' + (plan.notes || '') + '</textarea>' +
    '</div>' +
    
    '<div style="text-align: center; margin-top: 30px; padding-top: 30px; border-top: 3px solid #e2e8f0;">' +
    '<button class="btn-primary" onclick="finalizeTreatmentPrescription(' + planId + ')" style="padding: 20px 50px; font-size: 20px; font-weight: 700; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üíä FINALIZE & SEND PRESCRIPTION</button>' +
    '</div>';
  
  document.getElementById('procedure-form').innerHTML = formHTML;
  document.getElementById('procedure-form').style.display = 'block';
  document.getElementById('procedure-form').scrollIntoView({ behavior: 'smooth' });
}

// Update final amount based on discount
function updateFinalAmount(originalAmount) {
  const discount = parseInt(document.getElementById('discount-amount').value) || 0;
  const final = originalAmount - discount;
  
  document.getElementById('discount-display').textContent = '‚Çπ ' + discount.toLocaleString('en-IN');
  document.getElementById('final-amount-display').textContent = '‚Çπ ' + final.toLocaleString('en-IN');
}

// Cancel procedure form
function cancelProcedureForm() {
  document.getElementById('procedure-form').style.display = 'none';
  renderDoctorsSection();
}

// Render tooth chart for doctor (editable with pre-selected teeth)
function renderToothChartForDoctorEdit(selectedTeeth) {
  const quadrants = [
    { id: 'Q1', label: 'Upper Right', teeth: ["18","17","16","15","14","13","12","11"] },
    { id: 'Q2', label: 'Upper Left', teeth: ["21","22","23","24","25","26","27","28"] },
    { id: 'Q3', label: 'Lower Left', teeth: ["31","32","33","34","35","36","37","38"] },
    { id: 'Q4', label: 'Lower Right', teeth: ["41","42","43","44","45","46","47","48"] }
  ];
  
  let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';
  
  quadrants.forEach(function(q) {
    html += '<div style="background: #f8fafc; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0;">' +
      '<div style="font-weight: 600; color: #475569; margin-bottom: 10px; font-size: 14px;">' + q.label + '</div>' +
      '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">';
    
    q.teeth.forEach(function(tooth) {
      const isSelected = selectedTeeth && selectedTeeth.includes(tooth);
      html += '<label style="display: flex; flex-direction: column; align-items: center; padding: 10px; background: ' + 
        (isSelected ? '#d1fae5' : 'white') + '; border: 2px solid ' + 
        (isSelected ? '#10b981' : '#cbd5e1') + '; border-radius: 6px; cursor: pointer; transition: all 0.2s;" ' +
        'onmouseover="this.style.borderColor=\'#667eea\'" ' +
        'onmouseout="this.style.borderColor=\'' + (isSelected ? '#10b981' : '#cbd5e1') + '\'">' +
        '<input type="checkbox" class="tooth-checkbox-edit" value="' + tooth + '" ' + 
        (isSelected ? 'checked' : '') + ' style="margin-bottom: 5px; width: 16px; height: 16px;">' +
        '<span style="font-weight: 700; color: ' + (isSelected ? '#065f46' : '#64748b') + ';">' + tooth + '</span>' +
        '</label>';
    });
    
    html += '</div></div>';
  });
  
  html += '</div>';
  return html;
}

// Update total cost when treatments are changed in edit mode
function updateTotalCostEdit() {
  const selectedTreatments = Array.from(document.querySelectorAll('.treatment-checkbox-edit:checked'));
  let total = 0;
  
  selectedTreatments.forEach(function(cb) {
    total += parseInt(cb.dataset.cost) || 0;
  });
  
  document.getElementById('total-cost-display-edit').textContent = '‚Çπ ' + total.toLocaleString('en-IN');
}

// Finalize treatment and send prescription (NEW VERSION)
function finalizeTreatmentPrescription(planId) {
  const plan = state.treatmentPlans.find(function(tp) { return tp.id === planId; });
  if (!plan) return;
  
  // Get updated values from form
  const chiefComplaint = document.getElementById('chief-complaint-edit').value;
  const diagnosis = document.getElementById('diagnosis-edit').value.trim();
  const procedureDone = document.getElementById('procedure-done').value.trim();
  const notes = document.getElementById('notes-edit').value.trim();
  
  if (!chiefComplaint) {
    alert('‚ùå Please select Chief Complaint');
    return;
  }
  
  if (!diagnosis) {
    alert('‚ùå Please enter Diagnosis');
    return;
  }
  
  if (!procedureDone) {
    alert('‚ùå Please enter "Procedure Done Today" notes');
    return;
  }
  
  // Get selected lab tests
  const selectedLabTests = Array.from(document.querySelectorAll('.lab-test-checkbox-edit:checked'))
    .map(function(cb) { return cb.value; });
  
  // Get selected teeth
  const selectedTeeth = Array.from(document.querySelectorAll('.tooth-checkbox-edit:checked'))
    .map(function(cb) { return cb.value; });
  
  // Get selected treatments
  const selectedTreatmentIds = Array.from(document.querySelectorAll('.treatment-checkbox-edit:checked'))
    .map(function(cb) { return parseInt(cb.value); });
  
  const selectedTreatments = selectedTreatmentIds.map(function(id) {
    const treatment = state.treatments.find(function(t) { return t.id === id; });
    return {
      id: treatment.id,
      name: treatment.name,
      cost: treatment.cost
    };
  });
  
  // Get selected medicines
  const selectedMedicineIds = Array.from(document.querySelectorAll('.medicine-checkbox-edit:checked'))
    .map(function(cb) { return parseInt(cb.value); });
  
  const selectedMedicines = selectedMedicineIds.map(function(id) {
    return state.medicines.find(function(m) { return m.id === id; });
  });
  
  // Calculate new total
  const newTotalCost = selectedTreatments.reduce(function(sum, t) { return sum + t.cost; }, 0);
  const originalCost = plan.totalCost;
  const difference = newTotalCost - originalCost;
  
  // Update plan with all changes
  plan.chiefComplaint = chiefComplaint;
  plan.diagnosis = diagnosis;
  plan.labTests = selectedLabTests;
  plan.teeth = selectedTeeth;
  plan.treatments = selectedTreatments;
  plan.medicines = selectedMedicines;
  plan.notes = notes;
  plan.procedureDone = procedureDone;
  plan.totalCost = newTotalCost;
  plan.finalAmount = newTotalCost;
  plan.prescriptionGenerated = true;
  plan.status = 'completed';
  plan.completedAt = new Date().toISOString();
  
  // Create or update bill
  let bill = state.bills.find(function(b) { return b.treatmentPlanId === planId; });
  
  if (!bill) {
    bill = {
      id: generateId(state.bills),
      treatmentPlanId: planId,
      patientId: plan.patientId,
      doctorId: plan.doctorId,
      date: plan.date,
      chiefComplaint: chiefComplaint,
      diagnosis: diagnosis,
      procedureDone: procedureDone,
      teeth: selectedTeeth,
      treatments: selectedTreatments,
      medicines: selectedMedicines,
      labTests: selectedLabTests,
      total: newTotalCost,
      amountPaid: originalCost,
      paymentStatus: difference > 0 ? 'partial' : 'paid',
      paymentMethod: plan.paymentMethod || 'Paid',
      prescriptionPrinted: false,
      billPrinted: false,
      notes: notes,
      createdAt: new Date().toISOString()
    };
    state.bills.push(bill);
  } else {
    // Update existing bill
    bill.chiefComplaint = chiefComplaint;
    bill.diagnosis = diagnosis;
    bill.procedureDone = procedureDone;
    bill.teeth = selectedTeeth;
    bill.treatments = selectedTreatments;
    bill.medicines = selectedMedicines;
    bill.labTests = selectedLabTests;
    bill.total = newTotalCost;
    bill.notes = notes;
  }
  
  // Free up chair
  const chair = state.chairs.find(function(c) { return c.id === plan.chairAssigned; });
  if (chair) {
    chair.status = 'available';
    chair.patientName = null;
    chair.startTime = null;
  }
  
  saveAllData();
  
  // DO NOT print from doctor - prescription goes to reception!
  // printFinalPrescription(plan);  // COMMENTED OUT - Reception prints prescriptions
  
  // Mark bill as ready for printing at reception
  if (bill) {
    bill.prescriptionReady = true;
    bill.sentToReceptionAt = new Date().toISOString();
  }
  
  // Show appropriate message based on cost difference
  let message = '‚úÖ TREATMENT COMPLETED & FINALIZED!\n\n' +
        '‚úì All changes saved\n' +
        '‚úì Prescription sent to Reception\n' +
        '‚úì Chair ' + plan.chairAssigned + ' freed\n\n';
  
  if (difference > 0) {
    message += 'üí∞ COLLECT ADDITIONAL: ‚Çπ' + difference.toLocaleString('en-IN') + '\n' +
               '   (Cost increased from ‚Çπ' + originalCost.toLocaleString('en-IN') + ' to ‚Çπ' + newTotalCost.toLocaleString('en-IN') + ')\n\n';
  } else if (difference < 0) {
    message += 'üíµ REFUND: ‚Çπ' + Math.abs(difference).toLocaleString('en-IN') + '\n' +
               '   (Cost decreased from ‚Çπ' + originalCost.toLocaleString('en-IN') + ' to ‚Çπ' + newTotalCost.toLocaleString('en-IN') + ')\n\n';
  }
  
  message += 'üëâ Prescription sent to reception for printing!';
  
  alert(message);
  
  // üî¥ REAL-TIME: Notify reception instantly!
  const finalPatient = state.patients.find(function(p) { return p.id === plan.patientId; });
  emitPrescriptionSent(planId, finalPatient ? finalPatient.name : 'Patient', state.currentUser.name);
  addToActivityFeed('üì§ Prescription finalized for ' + (finalPatient ? finalPatient.name : 'Patient'));
  
  renderDoctorsSection();
}

// Generate final prescription
function generateFinalPrescription(planId) {
  const plan = state.treatmentPlans.find(function(tp) { return tp.id === planId; });
  if (!plan) return;
  
  const procedureDone = document.getElementById('procedure-done').value.trim();
  const discountAmount = parseInt(document.getElementById('discount-amount').value) || 0;
  const discountReason = document.getElementById('discount-reason').value.trim();
  
  if (!procedureDone) {
    alert('‚ùå Please enter "Procedure Done Today" notes');
    return;
  }
  
  // Get updated medicines
  const selectedMedicineIds = Array.from(document.querySelectorAll('.medicine-checkbox-update:checked'))
    .map(function(cb) { return parseInt(cb.value); });
  
  const updatedMedicines = selectedMedicineIds.map(function(id) {
    return state.medicines.find(function(m) { return m.id === id; });
  });
  
  // Update plan
  plan.procedureDone = procedureDone;
  plan.discount = discountAmount;
  plan.discountReason = discountReason;
  plan.finalAmount = plan.totalCost - discountAmount;
  plan.medicines = updatedMedicines;
  plan.prescriptionGenerated = true;
  plan.status = 'completed';
  plan.completedAt = new Date().toISOString();
  
  // Create a bill for reception (if medicines were prescribed or bill doesn't exist yet)
  if (updatedMedicines.length > 0 || !state.bills.find(b => b.treatmentPlanId === planId)) {
    const newBill = {
      id: generateId(state.bills),
      treatmentPlanId: planId,
      patientId: plan.patientId,
      doctorId: plan.doctorId,
      date: plan.date,
      chiefComplaint: plan.chiefComplaint,
      diagnosis: plan.diagnosis,
      procedureDone: procedureDone,
      teeth: plan.teeth || [],
      treatments: plan.treatments || [],
      medicines: updatedMedicines,
      discount: discountAmount,
      discountReason: discountReason,
      total: plan.finalAmount,
      amountPaid: plan.totalCost, // Already paid during treatment plan
      paymentStatus: 'paid',
      paymentMethod: plan.paymentMethod || 'Paid',
      prescriptionPrinted: false,
      billPrinted: false,
      notes: plan.notes || '',
      createdAt: new Date().toISOString()
    };
    
    state.bills.push(newBill);
  }
  
  // Free up chair
  const chair = state.chairs.find(function(c) { return c.id === plan.chairAssigned; });
  if (chair) {
    chair.status = 'available';
    chair.patientName = null;
    chair.startTime = null;
  }
  
  saveAllData();
  
  // Prescription goes to reception, not doctor
  // printFinalPrescription(plan);  // COMMENTED OUT - Reception prints
  
  alert('‚úÖ TREATMENT COMPLETED!\n\nPrescription sent to Reception for printing.\n\n' +
        '‚úì Procedure notes saved\n' +
        '‚úì Prescription generated\n' +
        '‚úì Bill sent to reception\n' +
        '‚úì Chair ' + plan.chairAssigned + ' freed\n\n' +
        'üëâ Prescription available at reception for printing!');
  
  renderDoctorsSection();
}

// Print final prescription
function printFinalPrescription(plan) {
  const patient = state.patients.find(function(p) { return p.id === plan.patientId; });
  const doctor = state.doctors.find(function(d) { return d.id === plan.doctorId; });
  
  // Build medicines list
  let medicinesList = '';
  if (plan.medicines && plan.medicines.length > 0) {
    plan.medicines.forEach(function(med, idx) {
      medicinesList += '<div style="background:white;border-left:4px solid #667eea;padding:15px;margin:15px 0;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">' +
        '<div style="font-size:18px;color:#1e293b;font-weight:600">' + (idx + 1) + '. ' + med.name + '</div>' +
        '<div style="color:#64748b;font-size:14px;margin-top:5px">Dosage: ' + med.dosage + '</div>' +
        '<div style="color:#10b981;font-size:14px;font-weight:600;margin-top:3px">' + med.frequency + ' - ' + med.duration + '</div>' +
        '</div>';
    });
  } else {
    medicinesList = '<div style="padding:20px;background:#f8fafc;border-radius:8px;text-align:center;color:#64748b">No medicines prescribed</div>';
  }
  
  const prescriptionHTML = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Prescription - ' + patient.name + '</title>' +
    '<style>@media print{@page{size:A4;margin:15mm}body{margin:0}}' +
    'body{font-family:Arial,sans-serif;padding:30px;max-width:800px;margin:0 auto;line-height:1.6}' +
    '.header{text-align:center;border-bottom:3px solid #667eea;padding-bottom:20px;margin-bottom:25px}' +
    '.header h1{color:#667eea;margin:0 0 10px 0;font-size:32px}' +
    '.header p{margin:3px 0;color:#64748b;font-size:14px}' +
    '.section{margin:20px 0}' +
    '.section-title{font-size:15px;font-weight:700;color:#1e293b;margin-bottom:12px;border-bottom:2px solid #e2e8f0;padding-bottom:5px;text-transform:uppercase}' +
    '.patient-info{background:#f8fafc;padding:15px;border-radius:8px;margin-bottom:20px}' +
    '.patient-info p{margin:5px 0;font-size:14px}' +
    '.rx{font-size:42px;color:#667eea;margin:15px 0;text-align:center}' +
    '.procedure{background:#d1fae5;border-left:4px solid #10b981;padding:15px;border-radius:8px;margin:15px 0}' +
    '.procedure-text{color:#065f46;font-size:13px;white-space:pre-wrap;font-family:monospace}' +
    '.advice{background:#fef3c7;padding:15px;border-radius:8px;border-left:4px solid #f59e0b;margin:15px 0}' +
    '.signature{margin-top:50px;text-align:right;border-top:2px solid #000;width:220px;margin-left:auto;padding-top:10px}' +
    '</style></head><body>' +
    '<div class="header">' +
    '<h1>ü¶∑ AURA DENTAL CARE</h1>' +
    '<p><strong>Dr. ' + doctor.name + '</strong> (' + (doctor.specialty || 'Dental Surgeon') + ')</p>' +
    '<p>Raipur, Chhattisgarh | Contact: ' + (state.config.clinicPhone || '+91-XXXXXXXXXX') + '</p>' +
    '</div>' +
    '<div class="patient-info">' +
    '<p><strong>Patient:</strong> ' + patient.name + ' | <strong>Age:</strong> ' + patient.age + ' | <strong>Gender:</strong> ' + patient.gender + '</p>' +
    '<p><strong>Contact:</strong> ' + patient.contact + '</p>' +
    '<p><strong>Date:</strong> ' + formatIndianDate(plan.date) + ' | <strong>Chair:</strong> ' + plan.chairAssigned + '</p>' +
    (plan.teeth && plan.teeth.length > 0 ? '<p><strong>Teeth Treated:</strong> ' + plan.teeth.join(', ') + '</p>' : '') +
    '</div>' +
    '<div class="section">' +
    '<div class="section-title">Diagnosis</div>' +
    '<div style="font-size:14px;color:#1e293b;font-weight:600">' + (plan.diagnosis || 'N/A') + '</div>' +
    '</div>' +
    '<div class="section">' +
    '<div class="section-title">Procedure Done Today</div>' +
    '<div class="procedure"><div class="procedure-text">' + plan.procedureDone + '</div></div>' +
    '</div>' +
    '<div class="rx">‚Ñû</div>' +
    '<div class="section">' +
    '<div class="section-title">Prescription</div>' +
    medicinesList +
    '</div>' +
    (plan.notes ? '<div class="section"><div class="section-title">Instructions / Advice</div><div class="advice">' + plan.notes + '</div></div>' : '') +
    (plan.discount > 0 ? 
      '<div class="section">' +
      '<div class="section-title">Payment Summary</div>' +
      '<div style="background:#f8fafc;padding:15px;border-radius:8px">' +
      '<div style="display:flex;justify-content:space-between;margin:5px 0"><span>Original Amount:</span><span style="font-weight:600">‚Çπ' + plan.totalCost.toLocaleString('en-IN') + '</span></div>' +
      '<div style="display:flex;justify-content:space-between;margin:5px 0;color:#ef4444"><span>Discount (' + plan.discountReason + '):</span><span style="font-weight:600">‚àí ‚Çπ' + plan.discount.toLocaleString('en-IN') + '</span></div>' +
      '<div style="display:flex;justify-content:space-between;margin:10px 0 5px 0;padding-top:10px;border-top:2px solid #e2e8f0"><span style="font-weight:700">Final Amount:</span><span style="font-weight:900;font-size:18px;color:#10b981">‚Çπ' + plan.finalAmount.toLocaleString('en-IN') + '</span></div>' +
      '</div></div>' : '') +
    '<div class="signature">' +
    '<div style="font-weight:700;font-size:16px">' + doctor.name + '</div>' +
    '<div style="font-size:12px;color:#64748b;margin-top:3px">' + (doctor.specialty || 'Dental Surgeon') + '</div>' +
    '<div style="font-size:11px;color:#94a3b8;margin-top:5px">Date: ' + formatIndianDate(new Date().toISOString().split('T')[0]) + '</div>' +
    '</div>' +
    '<script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script>' +
    '</body></html>';
  
  const printWindow = window.open('', '_blank', 'width=800,height=900');
  printWindow.document.write(prescriptionHTML);
  printWindow.document.close();
}



// View treatment plan details (for doctor to review before completing)
function viewTreatmentPlanInDoctor(planId) {
  const plan = state.treatmentPlans.find(function(tp) { return tp.id === planId; });
  if (!plan) return;
  
  const patient = state.patients.find(function(p) { return p.id === plan.patientId; });
  
  // Build treatment list
  let treatmentListHTML = '';
  if (plan.treatments && plan.treatments.length > 0) {
    plan.treatments.forEach(function(t, idx) {
      treatmentListHTML += '<div style="background: white; padding: 12px; margin: 8px 0; border-radius: 6px; border-left: 4px solid #667eea;">' +
        '<div style="font-weight: 600; color: #1e293b;">' + (idx + 1) + '. ' + t.name + '</div>' +
        '<div style="font-size: 18px; font-weight: 700; color: #10b981; margin-top: 5px;">‚Çπ ' + t.cost.toLocaleString('en-IN') + '</div>' +
        '</div>';
    });
  }
  
  // Build medicines list
  let medicinesListHTML = '';
  if (plan.medicines && plan.medicines.length > 0) {
    plan.medicines.forEach(function(m, idx) {
      medicinesListHTML += '<div style="background: white; padding: 12px; margin: 8px 0; border-radius: 6px; border-left: 4px solid #10b981;">' +
        '<div style="font-weight: 600; color: #065f46;">' + (idx + 1) + '. ' + m.name + '</div>' +
        '<div style="font-size: 13px; color: #059669; margin-top: 5px;">' + m.dosage + ' | ' + m.frequency + ' | ' + m.duration + '</div>' +
        '</div>';
    });
  }
  
  const detailsHTML = '<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">' +
    '<div style="display: flex; justify-content: space-between; align-items: center;">' +
    '<h2 style="margin: 0;">üìã TREATMENT PLAN DETAILS</h2>' +
    '<button class="btn-secondary" onclick="closePlanDetails()" style="background: rgba(255,255,255,0.2); color: white;">‚úï Close</button>' +
    '</div>' +
    '</div>' +
    
    '<div class="card" style="background: #f8fafc; border: 3px solid #667eea;">' +
    '<h3 style="color: #667eea; margin-bottom: 20px; font-size: 22px;">PATIENT: ' + patient.name + '</h3>' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">' +
    '<div><strong>Phone:</strong> ' + patient.contact + '</div>' +
    '<div><strong>Age/Gender:</strong> ' + patient.age + ' / ' + patient.gender + '</div>' +
    '<div><strong>Date:</strong> ' + formatIndianDate(plan.date) + '</div>' +
    '<div><strong>Chair Assigned:</strong> ' + plan.chairAssigned + '</div>' +
    '</div>' +
    '</div>' +
    
    '<div class="card" style="background: #fce7f3; border-left: 4px solid #ec4899;">' +
    '<h3 style="color: #831843; margin-bottom: 15px;">ü©∫ CLINICAL INFORMATION</h3>' +
    '<div style="margin-bottom: 15px;">' +
    '<div style="font-weight: 700; color: #831843; margin-bottom: 5px;">Chief Complaint:</div>' +
    '<div style="color: #1e293b; font-size: 16px;">' + plan.chiefComplaint + '</div>' +
    '</div>' +
    '<div style="margin-bottom: 15px;">' +
    '<div style="font-weight: 700; color: #831843; margin-bottom: 5px;">Diagnosis:</div>' +
    '<div style="color: #1e293b; font-size: 16px;">' + (plan.diagnosis || 'N/A') + '</div>' +
    '</div>' +
    (plan.teeth && plan.teeth.length > 0 ?
      '<div style="margin-bottom: 15px;">' +
      '<div style="font-weight: 700; color: #831843; margin-bottom: 5px;">Teeth Involved:</div>' +
      '<div style="color: #1e293b; font-size: 18px; font-weight: 600;">' + plan.teeth.join(', ') + '</div>' +
      '</div>' : '') +
    (plan.labTests && plan.labTests.length > 0 ?
      '<div>' +
      '<div style="font-weight: 700; color: #831843; margin-bottom: 5px;">Lab Tests Ordered:</div>' +
      '<div style="color: #1e293b;">' + plan.labTests.join(' ‚Ä¢ ') + '</div>' +
      '</div>' : '') +
    '</div>' +
    
    '<div class="card" style="background: #f0fdf4; border-left: 4px solid #10b981;">' +
    '<h3 style="color: #065f46; margin-bottom: 15px;">ü¶∑ TREATMENTS PLANNED</h3>' +
    treatmentListHTML +
    '<div style="background: white; padding: 15px; margin-top: 15px; border-radius: 8px; border: 2px solid #10b981;">' +
    '<div style="display: flex; justify-content: space-between; align-items: center;">' +
    '<span style="font-size: 18px; font-weight: 700; color: #065f46;">TOTAL COST:</span>' +
    '<span style="font-size: 32px; font-weight: 900; color: #10b981;">‚Çπ ' + plan.totalCost.toLocaleString('en-IN') + '</span>' +
    '</div>' +
    '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #d1fae5; color: #059669; font-size: 14px;">' +
    '‚úÖ Payment Status: ' + (plan.paymentStatus === 'paid' ? '<strong style="color: #10b981;">PAID (' + plan.paymentMethod + ')</strong>' : 'Pending') +
    '</div>' +
    '</div>' +
    '</div>' +
    
    '<div class="card" style="background: #f0fdf4; border-left: 4px solid #059669;">' +
    '<h3 style="color: #065f46; margin-bottom: 15px;">üíä MEDICINES PRESCRIBED</h3>' +
    (medicinesListHTML || '<div style="text-align: center; padding: 20px; color: #64748b;">No medicines prescribed</div>') +
    '</div>' +
    
    (plan.notes ?
      '<div class="card" style="background: #fef3c7; border-left: 4px solid #f59e0b;">' +
      '<h3 style="color: #92400e; margin-bottom: 15px;">üìù NOTES / INSTRUCTIONS</h3>' +
      '<div style="color: #1e293b; white-space: pre-wrap;">' + plan.notes + '</div>' +
      '</div>' : '') +
    
    '<div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">' +
    '<p style="color: #64748b; margin-bottom: 15px;">Ready to complete treatment and generate prescription?</p>' +
    '<button class="btn-primary" onclick="completeTreatmentAndPrescribe(' + planId + ')" style="padding: 15px 40px; font-size: 18px; background: #10b981;">‚úÖ Complete Treatment & Generate Prescription</button>' +
    '</div>';
  
  // Add "Open OPD Form" button at the bottom of details
  const opdFormButton = 
    '<div class="card" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); padding: 20px; text-align: center;">' +
    '<div style="color: white; font-size: 16px; font-weight: 600; margin-bottom: 15px;">ü©∫ Need additional diagnostics or treatment changes?</div>' +
    '<button onclick="openOPDFormForFurtherTreatment(' + planId + ')" ' +
    'style="background: white; color: #7c3aed; padding: 16px 32px; border: none; border-radius: 10px; ' +
    'font-size: 16px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">' +
    'üìã Open Full OPD Form (Pre-filled)</button>' +
    '<div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-top: 10px;">Chief Complaint, Diagnosis, Teeth, Treatments & Medicines ‚Äî all pre-filled from original plan</div>' +
    '</div>';

  document.getElementById('procedure-form').innerHTML = detailsHTML + opdFormButton;
  document.getElementById('procedure-form').style.display = 'block';
  document.getElementById('procedure-form').scrollIntoView({ behavior: 'smooth' });
}

// Close plan details
function closePlanDetails() {
  document.getElementById('procedure-form').style.display = 'none';
  document.getElementById('procedure-form').innerHTML = '';
}

// ============================================================
// ü©∫ OPD REVIEW FORM ‚Äî Full re-assessment after payment
// Starts fresh from Chief Complaint, everything pre-filled
// but fully editable ‚Äî doctor can add new observations,
// change treatments, add new medicines.
// ============================================================
function openOPDFormForFurtherTreatment(planId) {
  const plan    = state.treatmentPlans.find(tp => tp.id === planId);
  if (!plan) { alert('‚ùå Treatment plan not found'); return; }
  const patient = state.patients.find(p => p.id === plan.patientId);
  const doctor  = state.doctors.find(d => d.id === plan.doctorId);

  // Payment status badge
  const payStatus = plan.status === 'in-treatment'
    ? '<span style="background:#d1fae5;color:#065f46;padding:6px 14px;border-radius:20px;font-weight:700;font-size:13px;">üí∞ PAID ‚Äî In Treatment</span>'
    : '<span style="background:#fef3c7;color:#92400e;padding:6px 14px;border-radius:20px;font-weight:700;font-size:13px;">‚è≥ Partial / Pending</span>';

  // Previous visits (same patient, prior bills)
  const prevBills = state.bills.filter(b => b.patientId === plan.patientId);
  const historyHTML = prevBills.length > 0
    ? '<div style="background:#e0e7ff;padding:14px;border-radius:8px;margin-bottom:20px;">' +
      '<div style="font-weight:700;color:#3730a3;margin-bottom:8px;">üìã Previous Visits (' + prevBills.length + ')</div>' +
      prevBills.slice(0,4).map(v =>
        '<div style="font-size:13px;color:#4338ca;padding:5px 0;border-bottom:1px solid #c7d2fe;">' +
        '<strong>' + formatIndianDate(v.date) + '</strong> ‚Äî ' + (v.chiefComplaint||'Consultation') +
        ' ‚Äî ‚Çπ' + (v.total||0).toLocaleString('en-IN') + '</div>'
      ).join('') + '</div>'
    : '';

  // Tooth chart (pre-selected from plan)
  window._opdTeeth = plan.teeth ? [...plan.teeth] : [];
  const quadrants = [
    {id:'Q1', label:'Upper Right (18‚Üí11)', teeth:['18','17','16','15','14','13','12','11']},
    {id:'Q2', label:'Upper Left  (21‚Üí28)', teeth:['21','22','23','24','25','26','27','28']},
    {id:'Q3', label:'Lower Left  (31‚Üí38)', teeth:['31','32','33','34','35','36','37','38']},
    {id:'Q4', label:'Lower Right (41‚Üí48)', teeth:['41','42','43','44','45','46','47','48']},
  ];

  const toothChart =
    '<div class="card">' +
    '<h3 style="color:#1e293b;margin-bottom:4px;">ü¶∑ Tooth Chart <span style="font-size:13px;color:#64748b;font-weight:400;">(Click to select / deselect)</span></h3>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px;">' +
    quadrants.map(q =>
      '<div><div style="font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;margin-bottom:6px;">' + q.label + '</div>' +
      '<div style="display:flex;flex-wrap:wrap;gap:5px;">' +
      q.teeth.map(t => {
        const sel = window._opdTeeth.includes(t);
        return '<div id="ot-' + t + '" data-tooth="' + t + '" onclick="toggleOPDTooth(this.dataset.tooth)" title="Tooth ' + t + '" ' +
          'style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;' +
          'border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;transition:all 0.15s;' +
          'background:' + (sel?'#10b981':'#f1f5f9') + ';color:' + (sel?'white':'#475569') + ';' +
          'border:2px solid ' + (sel?'#059669':'#cbd5e1') + ';">' + t + '</div>';
      }).join('') + '</div></div>'
    ).join('') +
    '</div>' +
    '<div id="opd-teeth-display" style="margin-top:12px;padding:10px;background:#f0fdf4;border-radius:8px;font-size:13px;font-weight:600;color:#065f46;">' +
    'ü¶∑ Selected: ' + (window._opdTeeth.length > 0 ? window._opdTeeth.join(', ') : 'None') +
    '</div></div>';

  // Treatment checkboxes
  const treatmentCheck =
    '<div class="card">' +
    '<h3 style="color:#1e293b;margin-bottom:4px;">üîß Treatments / Procedures</h3>' +
    '<p style="color:#64748b;font-size:13px;margin-bottom:12px;">Pre-selected from original plan ‚Äî add or remove as needed</p>' +
    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;">' +
    state.treatments.map(t => {
      const sel = plan.treatments && plan.treatments.some(pt => pt.id === t.id);
      return '<label style="display:flex;align-items:start;padding:12px;cursor:pointer;gap:10px;border-radius:8px;border:2px solid ' + (sel?'#10b981':'#e2e8f0') + ';background:' + (sel?'#d1fae5':'#f8fafc') + ';">' +
        '<input type="checkbox" class="opd-t-cb" value="' + t.id + '" ' + (sel?'checked':'') + ' style="width:18px;height:18px;margin-top:2px;">' +
        '<div><div style="font-weight:600;color:#1e293b;">' + t.name + '</div>' +
        '<div style="font-size:13px;color:#10b981;font-weight:700;">‚Çπ' + t.cost.toLocaleString('en-IN') + '</div></div></label>';
    }).join('') + '</div></div>';

  // Medicine checkboxes
  const medicineCheck =
    '<div class="card">' +
    '<h3 style="color:#1e293b;margin-bottom:4px;">üíä Medicines</h3>' +
    '<p style="color:#64748b;font-size:13px;margin-bottom:12px;">Pre-selected from original plan ‚Äî add or remove as needed</p>' +
    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;">' +
    state.medicines.map(m => {
      const sel = plan.medicines && plan.medicines.some(pm => pm.id === m.id);
      return '<label style="display:flex;align-items:start;padding:12px;cursor:pointer;gap:10px;border-radius:8px;border:2px solid ' + (sel?'#10b981':'#e2e8f0') + ';background:' + (sel?'#d1fae5':'#f8fafc') + ';">' +
        '<input type="checkbox" class="opd-m-cb" value="' + m.id + '" ' + (sel?'checked':'') + ' style="width:18px;height:18px;margin-top:2px;">' +
        '<div><div style="font-weight:600;color:#065f46;">' + m.name + '</div>' +
        '<div style="font-size:12px;color:#059669;">' + m.dosage + ' | ' + m.frequency + ' | ' + m.duration + '</div></div></label>';
    }).join('') + '</div></div>';

  const formHTML =
    // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
    '<div class="card" style="background:linear-gradient(135deg,#7c3aed,#4f46e5);color:white;margin-bottom:0;">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;">' +
    '<div>' +
    '<div style="font-size:12px;opacity:0.8;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">OPD Review ‚Äî Further Assessment</div>' +
    '<h2 style="margin:0;font-size:22px;">üìã ' + (patient?patient.name:'') + '</h2>' +
    '<div style="font-size:13px;opacity:0.9;margin-top:5px;">' +
      (patient ? patient.age+'Y / '+patient.gender+' | ' : '') +
      (doctor ? doctor.name : '') + ' | Chair ' + plan.chairAssigned + '</div>' +
    '</div>' +
    '<div style="display:flex;gap:10px;align-items:center;">' + payStatus +
    '<button onclick="closePlanDetails()" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600;">‚úï Close</button>' +
    '</div></div></div>' +

    // ‚îÄ‚îÄ Patient + history ‚îÄ‚îÄ
    '<div class="card" style="background:#f8fafc;">' +
    historyHTML +
    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;">' +
    '<div><div style="font-size:11px;color:#64748b;text-transform:uppercase;font-weight:600;">Contact</div><div style="font-weight:600;">' + (patient?patient.contact:'‚Äî') + '</div></div>' +
    '<div><div style="font-size:11px;color:#64748b;text-transform:uppercase;font-weight:600;">Visit Date</div><div style="font-weight:600;">' + formatIndianDate(plan.date) + '</div></div>' +
    '<div><div style="font-size:11px;color:#64748b;text-transform:uppercase;font-weight:600;">Amount Paid</div><div style="font-weight:700;color:#10b981;font-size:16px;">‚Çπ' + plan.totalCost.toLocaleString('en-IN') + '</div></div>' +
    '</div></div>' +

    // ‚îÄ‚îÄ 1. CHIEF COMPLAINT ‚îÄ‚îÄ
    '<div class="card" style="border-top:4px solid #7c3aed;">' +
    '<h3 style="color:#7c3aed;margin-bottom:4px;font-size:18px;">‚ë† Chief Complaint</h3>' +
    '<p style="color:#64748b;font-size:13px;margin-bottom:12px;">Pre-filled from original ‚Äî change if new complaint observed today</p>' +
    '<select id="opd-cc" style="width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:8px;font-size:15px;background:white;" ' +
    'onchange="document.getElementById(\'opd-cc-note\').style.display=this.value?\'block\':\'none\'">' +
    '<option value="">-- Select Chief Complaint --</option>' +
    chiefComplaintLibrary.map(cc =>
      '<option value="' + cc + '" ' + (plan.chiefComplaint===cc?'selected':'') + '>' + cc + '</option>'
    ).join('') +
    '</select>' +
    '<div id="opd-cc-note" style="display:' + (plan.chiefComplaint?'block':'none') + ';margin-top:8px;padding:8px 12px;background:#f0fdf4;border-radius:6px;font-size:13px;color:#065f46;">' +
    '‚úÖ Current: <strong>' + (plan.chiefComplaint||'') + '</strong></div></div>' +

    // ‚îÄ‚îÄ 2. DIAGNOSIS ‚îÄ‚îÄ
    '<div class="card" style="border-top:4px solid #3b82f6;">' +
    '<h3 style="color:#3b82f6;margin-bottom:4px;font-size:18px;">‚ë° Clinical Diagnosis</h3>' +
    '<p style="color:#64748b;font-size:13px;margin-bottom:12px;">Add / update clinical findings from today\'s examination</p>' +
    '<textarea id="opd-dx" rows="3" oninput="this.value=this.value.toUpperCase()" ' +
    'placeholder="ENTER / UPDATE DIAGNOSIS IN UPPERCASE..." ' +
    'style="width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;font-family:monospace;text-transform:uppercase;resize:vertical;">' +
    (plan.diagnosis||'') + '</textarea></div>' +

    // ‚îÄ‚îÄ 3. LAB TESTS ‚îÄ‚îÄ
    '<div class="card" style="border-top:4px solid #f59e0b;">' +
    '<h3 style="color:#92400e;margin-bottom:4px;font-size:18px;">‚ë¢ Investigations / Lab Tests</h3>' +
    '<p style="color:#64748b;font-size:13px;margin-bottom:12px;">Order new tests if required today</p>' +
    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;">' +
    ['IOPA','OPG','CBCT','LATERAL CEPH','BLOOD TEST','BIOPSY'].map(test => {
      const sel = plan.labTests && plan.labTests.includes(test);
      return '<label style="display:flex;align-items:center;gap:8px;padding:11px;border-radius:8px;cursor:pointer;font-weight:600;border:2px solid ' + (sel?'#3b82f6':'#e2e8f0') + ';background:' + (sel?'#dbeafe':'#f8fafc') + ';">' +
        '<input type="checkbox" class="opd-lab-cb" value="' + test + '" ' + (sel?'checked':'') + ' style="width:16px;height:16px;">' +
        '<span style="font-size:13px;">' + test + '</span></label>';
    }).join('') + '</div></div>' +

    // ‚îÄ‚îÄ 4. TOOTH CHART ‚îÄ‚îÄ
    toothChart +

    // ‚îÄ‚îÄ 5. TREATMENTS ‚îÄ‚îÄ
    treatmentCheck +

    // ‚îÄ‚îÄ 6. MEDICINES ‚îÄ‚îÄ
    medicineCheck +

    // ‚îÄ‚îÄ 7. NOTES ‚îÄ‚îÄ
    '<div class="card" style="border-top:4px solid #10b981;">' +
    '<h3 style="color:#065f46;margin-bottom:4px;font-size:18px;">‚ë¶ Additional Notes</h3>' +
    '<textarea id="opd-notes" rows="3" placeholder="Further instructions, observations, patient advice..." ' +
    'style="width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;resize:vertical;">' +
    (plan.notes||'') + '</textarea></div>' +

    // ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
    '<div style="text-align:center;padding:24px 0 48px;">' +
    '<button onclick="saveOPDReview(' + planId + ')" ' +
    'style="background:linear-gradient(135deg,#7c3aed,#4f46e5);color:white;padding:18px 56px;' +
    'border:none;border-radius:12px;font-size:18px;font-weight:800;cursor:pointer;' +
    'box-shadow:0 6px 24px rgba(124,58,237,0.35);letter-spacing:0.5px;">üíæ SAVE & CONTINUE TO TREATMENT</button>' +
    '<div style="color:#64748b;font-size:13px;margin-top:12px;">Saves updated clinical data. Then click ‚úÖ Start Treatment to complete procedure.</div>' +
    '</div>';

  document.getElementById('procedure-form').innerHTML = formHTML;
  document.getElementById('procedure-form').style.display = 'block';
  document.getElementById('procedure-form').scrollIntoView({ behavior: 'smooth' });
}

// Toggle tooth in OPD review
function toggleOPDTooth(tooth) {
  if (!window._opdTeeth) window._opdTeeth = [];
  const idx = window._opdTeeth.indexOf(tooth);
  const el  = document.getElementById('ot-' + tooth);
  if (idx === -1) {
    window._opdTeeth.push(tooth);
    if (el) Object.assign(el.style, {background:'#10b981', color:'white', borderColor:'#059669'});
  } else {
    window._opdTeeth.splice(idx, 1);
    if (el) Object.assign(el.style, {background:'#f1f5f9', color:'#475569', borderColor:'#cbd5e1'});
  }
  const disp = document.getElementById('opd-teeth-display');
  if (disp) disp.textContent = 'ü¶∑ Selected: ' + (window._opdTeeth.length ? window._opdTeeth.join(', ') : 'None');
}

// Save updated OPD review to treatment plan
function saveOPDReview(planId) {
  const plan = state.treatmentPlans.find(tp => tp.id === planId);
  if (!plan) return;

  const chiefComplaint = document.getElementById('opd-cc').value || plan.chiefComplaint;
  const diagnosis      = (document.getElementById('opd-dx').value || '').trim().toUpperCase();
  const notes          = (document.getElementById('opd-notes').value || '').trim();

  const labTests  = Array.from(document.querySelectorAll('.opd-lab-cb:checked')).map(c => c.value);
  const teeth     = window._opdTeeth || [];

  const tIds = Array.from(document.querySelectorAll('.opd-t-cb:checked')).map(c => parseInt(c.value));
  const treatments = tIds.map(id => state.treatments.find(t => t.id === id)).filter(Boolean);

  const mIds = Array.from(document.querySelectorAll('.opd-m-cb:checked')).map(c => parseInt(c.value));
  const medicines  = mIds.map(id => state.medicines.find(m => m.id === id)).filter(Boolean);

  const newTotal = treatments.reduce((s, t) => s + (t.cost || 0), 0);

  // Update plan in-place
  plan.chiefComplaint   = chiefComplaint;
  plan.diagnosis        = diagnosis || plan.diagnosis;
  plan.notes            = notes;
  plan.labTests         = labTests;
  plan.teeth            = teeth;
  plan.treatments       = treatments;
  plan.medicines        = medicines;
  if (newTotal > 0) plan.totalCost = newTotal;
  plan.lastReviewedAt   = new Date().toISOString();

  saveAllData();

  const added = treatments.map(t => t.name).join(', ') || '‚Äî';
  const meds  = medicines.map(m => m.name).join(', ')  || '‚Äî';

  alert(
    '‚úÖ OPD Plan Updated!\n\n' +
    'üìã Chief Complaint: ' + chiefComplaint + '\n' +
    'üî¨ Diagnosis: ' + (plan.diagnosis||'‚Äî') + '\n' +
    'üîß Treatments: ' + added + '\n' +
    'üíä Medicines: ' + meds + '\n\n' +
    'üëâ Now click ‚úÖ START TREATMENT to complete the procedure.'
  );

  closePlanDetails();
  renderDoctorsSection();
}

// ========== NEW OPD WORKFLOW SECTIONS ==========
// ========== OPD SECTION (DOCTOR DASHBOARD) ==========

// Start OPD Consultation
function startOPDConsultation(patientId, queueId) {
  const patient = state.patients.find(function(p) { return p.id === patientId; });
  const queueEntry = state.doctorQueue.find(function(q) { return q.id === queueId; });
  
  if (!patient || !queueEntry) {
    alert('‚ùå Patient not found');
    return;
  }
  
  // Update queue status
  queueEntry.status = 'with-doctor';
  saveAllData();
  
  // Show patient history
  const previousVisits = state.opdRecords.filter(function(o) { return o.patientId === patientId; });
  let historyHTML = '';
  
  if (previousVisits.length > 0) {
    historyHTML = '<div style="background: #e0e7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' +
      '<div style="font-weight: 600; color: #3730a3; margin-bottom: 10px;">üìã Previous Visits (' + previousVisits.length + ')</div>';
    
    previousVisits.slice(0, 5).forEach(function(v) {
      historyHTML += '<div style="font-size: 13px; color: #4338ca; padding: 6px 0; border-bottom: 1px solid #c7d2fe;">' +
        '<div><strong>' + formatIndianDate(v.date) + '</strong> - ' + (v.chiefComplaint || 'Consultation') + '</div>' +
        '<div style="font-size: 12px; margin-top: 2px;">Diagnosis: ' + (v.diagnosis || 'N/A') + ' | Procedure: ' + (v.procedureRequired || 'N/A') + '</div>' +
        '</div>';
    });
    
    historyHTML += '</div>';
  }
  
  const formHTML = '<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">' +
    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
    '<div>' +
    '<h2 style="margin: 0; font-size: 24px;">OPD CONSULTATION: ' + patient.name + '</h2>' +
    '<div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Phone: ' + patient.contact + ' | Age: ' + patient.age + ' | Gender: ' + patient.gender + '</div>' +
    '</div>' +
    '<button class="btn-secondary" onclick="cancelOPDConsultation(' + queueId + ')" style="background: rgba(255,255,255,0.2); color: white;">‚Üê Back</button>' +
    '</div>' +
    '</div>' +
    
    historyHTML +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">1Ô∏è‚É£ CHIEF COMPLAINT (Ask Patient)</h3>' +
    '<select id="chief-complaint-opd" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #667eea; border-radius: 8px;">' +
    '<option value="">-- Select Chief Complaint --</option>' +
    chiefComplaintLibrary.map(function(issue) {
      return '<option value="' + issue + '">' + issue + '</option>';
    }).join('') +
    '</select>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">2Ô∏è‚É£ DIAGNOSIS *</h3>' +
    '<textarea id="diagnosis-opd" rows="4" style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid #667eea; border-radius: 8px; text-transform: uppercase;" placeholder="Enter clinical diagnosis (auto-uppercase)" oninput="this.value = this.value.toUpperCase()"></textarea>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">3Ô∏è‚É£ PROCEDURE REQUIRED *</h3>' +
    '<input type="text" id="procedure-required-opd" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #667eea; border-radius: 8px; text-transform: uppercase;" placeholder="e.g., RCT, EXTRACTION, FILLING" oninput="this.value = this.value.toUpperCase()">' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #10b981; margin-bottom: 15px; font-size: 18px;">4Ô∏è‚É£ PROCEDURE COST (‚Çπ) *</h3>' +
    '<input type="number" id="procedure-cost-opd" style="width: 100%; padding: 15px; font-size: 20px; border: 3px solid #10b981; border-radius: 8px; font-weight: 700;" placeholder="Enter cost in ‚Çπ" min="0">' +
    '<div style="color: #64748b; font-size: 13px; margin-top: 8px;">üí° This amount will be billed to patient (procedures only, no medicines)</div>' +
    '</div>' +
    
    '<div style="text-align: center; margin-top: 30px;">' +
    '<button class="btn-primary" onclick="createOPDBillAndSend(' + patientId + ', ' + queueId + ')" style="padding: 20px 40px; font-size: 18px; font-weight: 700;">üìÑ CREATE BILL & SEND TO PRINT BILL SECTION</button>' +
    '</div>';
  
  document.getElementById('opd-consultation-form').innerHTML = formHTML;
  document.getElementById('opd-consultation-form').style.display = 'block';
  document.getElementById('opd-consultation-form').scrollIntoView({ behavior: 'smooth' });
}

// Cancel OPD consultation
function cancelOPDConsultation(queueId) {
  const queueEntry = state.doctorQueue.find(function(q) { return q.id === queueId; });
  if (queueEntry) {
    queueEntry.status = 'waiting';
    saveAllData();
  }
  renderDoctorsSection();
}

// Create OPD Bill and send to Print Bill Section
function createOPDBillAndSend(patientId, queueId) {
  const chiefComplaint = document.getElementById('chief-complaint-opd').value;
  const diagnosis = document.getElementById('diagnosis-opd').value.trim();
  const procedureRequired = document.getElementById('procedure-required-opd').value.trim();
  const procedureCost = parseInt(document.getElementById('procedure-cost-opd').value);
  
  if (!chiefComplaint) {
    alert('‚ùå Please select Chief Complaint');
    return;
  }
  
  if (!diagnosis) {
    alert('‚ùå Please enter Diagnosis');
    return;
  }
  
  if (!procedureRequired) {
    alert('‚ùå Please enter Procedure Required');
    return;
  }
  
  if (!procedureCost || procedureCost <= 0) {
    alert('‚ùå Please enter valid Procedure Cost');
    return;
  }
  
  const patient = state.patients.find(function(p) { return p.id === patientId; });
  
  // Create OPD Record
  const opdRecord = {
    id: generateId(state.opdRecords),
    patientId: patientId,
    doctorId: state.currentUser.id,
    queueId: queueId,
    date: new Date().toISOString().split('T')[0],
    time: new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }),
    chiefComplaint: chiefComplaint,
    diagnosis: diagnosis,
    procedureRequired: procedureRequired,
    procedureCost: procedureCost,
    billSent: true,
    billPrinted: false,
    paymentReceived: false,
    procedureDone: '',
    prescriptionSent: false,
    prescriptionPrinted: false,
    medicines: [],
    tests: [],
    instructions: '',
    nextAppointment: '',
    createdAt: new Date().toISOString()
  };
  
  state.opdRecords.push(opdRecord);
  
  // Add to pending bills (for Print Bill Section)
  state.pendingBills.push({
    id: generateId(state.pendingBills),
    opdId: opdRecord.id,
    patientId: patientId,
    doctorId: state.currentUser.id,
    diagnosis: diagnosis,
    procedureRequired: procedureRequired,
    cost: procedureCost,
    status: 'pending',
    createdAt: new Date().toISOString()
  });
  
  // Update queue
  const queueEntry = state.doctorQueue.find(function(q) { return q.id === queueId; });
  if (queueEntry) {
    queueEntry.status = 'billed';
    queueEntry.opdId = opdRecord.id;
  }
  
  saveAllData();
  
  alert('‚úÖ BILL CREATED!\n\n' +
        'Patient: ' + patient.name + '\n' +
        'Diagnosis: ' + diagnosis + '\n' +
        'Procedure: ' + procedureRequired + '\n' +
        'Cost: ‚Çπ' + procedureCost.toLocaleString('en-IN') + '\n\n' +
        'üìÑ Bill sent to Print Bill Section!\n' +
        'Reception will print and collect payment.');
  
  renderDoctorsSection();
}
// Complete Procedure in OPD
function completeProcedureOPD(opdId) {
  const opd = state.opdRecords.find(function(o) { return o.id === opdId; });
  if (!opd) return;
  
  const patient = state.patients.find(function(p) { return p.id === opd.patientId; });
  
  const formHTML = '<div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">' +
    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
    '<div>' +
    '<h2 style="margin: 0; font-size: 24px;">‚úÖ COMPLETE PROCEDURE: ' + patient.name + '</h2>' +
    '<div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Payment Confirmed: ‚Çπ' + opd.procedureCost.toLocaleString('en-IN') + '</div>' +
    '</div>' +
    '<button class="btn-secondary" onclick="closeProcedureForm()" style="background: rgba(255,255,255,0.2); color: white;">‚Üê Back</button>' +
    '</div>' +
    '</div>' +
    
    '<div class="card" style="background: #f0fdf4; border: 3px solid #10b981;">' +
    '<h3 style="color: #065f46; margin-bottom: 15px;">üìã Consultation Summary</h3>' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">' +
    '<div><strong>Chief Complaint:</strong><br>' + opd.chiefComplaint + '</div>' +
    '<div><strong>Diagnosis:</strong><br>' + opd.diagnosis + '</div>' +
    '<div style="grid-column: 1 / -1;"><strong>Procedure Required:</strong><br>' + opd.procedureRequired + '</div>' +
    '</div>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #10b981; margin-bottom: 15px; font-size: 20px;">üìù PROCEDURE DONE TODAY * (Required)</h3>' +
    '<textarea id="procedure-done-opd" rows="8" style="width: 100%; padding: 15px; font-size: 15px; border: 3px solid #10b981; border-radius: 8px; text-transform: uppercase; font-family: monospace; line-height: 1.6;" placeholder="Enter detailed procedure notes (auto-UPPERCASE)&#10;&#10;Example:&#10;- RCT COMPLETED ON TOOTH 46&#10;- 3 CANALS CLEANED AND SHAPED&#10;- GP FILLING PLACED&#10;- TEMPORARY RESTORATION DONE&#10;- PATIENT ADVISED SOFT DIET FOR 24 HOURS&#10;- CROWN PREPARATION SCHEDULED FOR NEXT VISIT" oninput="this.value = this.value.toUpperCase()"></textarea>' +
    '<div style="color: #64748b; font-size: 13px; margin-top: 8px;">üí° This will be included in prescription</div>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">üíä MEDICINES PRESCRIBED</h3>' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px;">' +
    state.medicines.map(function(m) {
      return '<label style="display: flex; align-items: start; padding: 12px; background: #f0fdf4; border: 2px solid #d1fae5; border-radius: 8px; cursor: pointer;">' +
        '<input type="checkbox" class="medicine-opd-checkbox" value="' + m.id + '" style="margin-right: 10px; width: 18px; height: 18px; margin-top: 2px;">' +
        '<div>' +
        '<div style="font-weight: 600; color: #065f46;">' + m.name + '</div>' +
        '<div style="font-size: 12px; color: #059669; margin-top: 3px;">' + m.dosage + ' | ' + m.frequency + ' | ' + m.duration + '</div>' +
        '</div>' +
        '</label>';
    }).join('') +
    '</div>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">üî¨ LAB TESTS / INVESTIGATIONS</h3>' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">' +
    ['IOPA X-Ray', 'OPG X-Ray', 'CBCT Scan', 'Blood Test', 'Biopsy', 'Other'].map(function(test) {
      return '<label style="display: flex; align-items: center; padding: 10px; background: #f8fafc; border-radius: 6px; cursor: pointer;">' +
        '<input type="checkbox" class="test-opd-checkbox" value="' + test + '" style="margin-right: 8px; width: 18px; height: 18px;">' +
        '<span>' + test + '</span>' +
        '</label>';
    }).join('') +
    '</div>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">üìù INSTRUCTIONS / ADVICE FOR PATIENT</h3>' +
    '<textarea id="instructions-opd" rows="4" style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid #667eea; border-radius: 8px;" placeholder="Any special instructions, dietary restrictions, or care advice"></textarea>' +
    '</div>' +
    
    '<div class="card">' +
    '<h3 style="color: #f59e0b; margin-bottom: 15px; font-size: 18px;">üìÖ NEXT APPOINTMENT DATE (Optional)</h3>' +
    '<input type="date" id="next-appointment-opd" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #f59e0b; border-radius: 8px;">' +
    '</div>' +
    
    '<div style="text-align: center; margin-top: 30px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">' +
    '<p style="color: white; font-size: 16px; margin-bottom: 20px;">Ready to generate prescription and send to Print Prescription Section?</p>' +
    '<button class="btn-primary" onclick="generateOPDPrescriptionAndSend(' + opdId + ')" style="padding: 20px 50px; font-size: 20px; font-weight: 700; background: white; color: #667eea;">üìã GENERATE PRESCRIPTION & SEND</button>' +
    '</div>';
  
  document.getElementById('opd-procedure-form').innerHTML = formHTML;
  document.getElementById('opd-procedure-form').style.display = 'block';
  document.getElementById('opd-procedure-form').scrollIntoView({ behavior: 'smooth' });
}

// Close procedure form
function closeProcedureForm() {
  document.getElementById('opd-procedure-form').style.display = 'none';
  document.getElementById('opd-procedure-form').innerHTML = '';
}

// Generate OPD Prescription and send to Print Prescription Section
function generateOPDPrescriptionAndSend(opdId) {
  const procedureDone = document.getElementById('procedure-done-opd').value.trim();
  const instructions = document.getElementById('instructions-opd').value.trim();
  const nextAppointment = document.getElementById('next-appointment-opd').value;
  
  if (!procedureDone) {
    alert('‚ùå Please enter "Procedure Done Today" notes');
    return;
  }
  
  // Get selected medicines
  const selectedMedicineIds = Array.from(document.querySelectorAll('.medicine-opd-checkbox:checked'))
    .map(function(cb) { return parseInt(cb.value); });
  
  const medicines = selectedMedicineIds.map(function(id) {
    return state.medicines.find(function(m) { return m.id === id; });
  });
  
  // Get selected tests
  const tests = Array.from(document.querySelectorAll('.test-opd-checkbox:checked'))
    .map(function(cb) { return cb.value; });
  
  const opd = state.opdRecords.find(function(o) { return o.id === opdId; });
  if (!opd) return;
  
  // Update OPD record
  opd.procedureDone = procedureDone;
  opd.medicines = medicines;
  opd.tests = tests;
  opd.instructions = instructions;
  opd.nextAppointment = nextAppointment;
  opd.prescriptionSent = true;
  opd.prescriptionSentAt = new Date().toISOString();
  
  // Add to pending prescriptions (for Print Prescription Section)
  state.pendingPrescriptions.push({
    id: generateId(state.pendingPrescriptions),
    opdId: opdId,
    patientId: opd.patientId,
    doctorId: opd.doctorId,
    status: 'pending',
    createdAt: new Date().toISOString()
  });
  
  saveAllData();
  
  const patient = state.patients.find(function(p) { return p.id === opd.patientId; });
  
  alert('‚úÖ PROCEDURE COMPLETED!\n\n' +
        'Patient: ' + patient.name + '\n' +
        'Procedure: ' + opd.procedureRequired + '\n' +
        'Medicines: ' + medicines.length + '\n\n' +
        'üìã Prescription sent to Print Prescription Section!\n' +
        'Reception will print and give to patient.');
  
  renderDoctorsSection();
}
// ========== PRINT BILL SECTION (RECEPTIONIST) ==========

// Print Bill (Procedure Only)
function printBillOPD(billId) {
  const bill = state.pendingBills.find(function(b) { return b.id === billId; });
  if (!bill) return;
  
  const opd = state.opdRecords.find(function(o) { return o.id === bill.opdId; });
  const patient = state.patients.find(function(p) { return p.id === bill.patientId; });
  const doctor = state.doctors.find(function(d) { return d.id === bill.doctorId; });
  
  const billHTML = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Bill - ' + patient.name + '</title>' +
    '<style>@media print{@page{size:A4;margin:20mm}body{margin:0}}' +
    'body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}' +
    '.header{text-align:center;border-bottom:3px solid #667eea;padding-bottom:20px;margin-bottom:30px}' +
    '.header h1{color:#667eea;margin:0;font-size:36px}.header p{margin:5px 0;color:#64748b}' +
    '.section{margin:25px 0;background:#f8fafc;padding:20px;border-radius:8px}' +
    '.section-title{font-size:16px;font-weight:bold;color:#334155;margin-bottom:15px;border-bottom:2px solid #e2e8f0;padding-bottom:8px}' +
    '.patient-info{background:#f8fafc;padding:15px;border-radius:8px;margin-bottom:20px}' +
    '.patient-info p{margin:5px 0}' +
    '.amount-box{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;padding:30px;border-radius:12px;text-align:center;margin:30px 0}' +
    '.amount-box h2{margin:0 0 10px 0;font-size:20px;opacity:0.9}' +
    '.amount-box .amount{font-size:48px;font-weight:900;margin:15px 0}' +
    '.footer{margin-top:50px;text-align:center;padding-top:20px;border-top:2px solid #e2e8f0;color:#64748b;font-size:14px}' +
    '</style></head><body>' +
    '<div class="header"><h1>ü¶∑ AURA DENTAL CARE</h1>' +
    '<p>Raipur, Chhattisgarh | Contact: ' + (state.config.clinicPhone || '+91-XXXXXXXXXX') + '</p></div>' +
    '<h2 style="text-align:center;color:#667eea;margin:20px 0;">BILL - PROCEDURE CHARGES</h2>' +
    '<div class="patient-info">' +
    '<p><strong>Patient Name:</strong> ' + patient.name + '</p>' +
    '<p><strong>Patient ID:</strong> ' + patient.id + '</p>' +
    '<p><strong>Phone:</strong> ' + patient.contact + '</p>' +
    '<p><strong>Age/Gender:</strong> ' + patient.age + ' years / ' + patient.gender + '</p>' +
    '<p><strong>Date:</strong> ' + formatIndianDate(opd.date) + '</p>' +
    '<p><strong>Doctor:</strong> Dr. ' + doctor.name + '</p>' +
    '</div>' +
    '<div class="section">' +
    '<div class="section-title">PROCEDURE DETAILS</div>' +
    '<p><strong>Diagnosis:</strong> ' + opd.diagnosis + '</p>' +
    '<p><strong>Procedure Performed:</strong> ' + opd.procedureRequired + '</p>' +
    '</div>' +
    '<div class="amount-box">' +
    '<h2>PROCEDURE COST</h2>' +
    '<div class="amount">‚Çπ ' + bill.cost.toLocaleString('en-IN') + '</div>' +
    '<p style="opacity:0.9;font-size:14px">(Procedure charges only - Medicines not included)</p>' +
    '</div>' +
    '<div class="footer">' +
    '<p>Thank you for choosing Aura Dental Care</p>' +
    '<p>For queries, contact: ' + (state.config.clinicPhone || '+91-XXXXXXXXXX') + '</p>' +
    '<p style="margin-top:30px">________________<br>Receptionist Signature</p>' +
    '</div>' +
    '<script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script>' +
    '</body></html>';
  
  const printWindow = window.open('', '_blank', 'width=800,height=900');
  printWindow.document.write(billHTML);
  printWindow.document.close();
  
  // Mark as printed
  bill.printed = true;
  opd.billPrinted = true;
  saveAllData();
  
  alert('‚úÖ Bill printed!\n\nNow collect payment from patient.');
}

// Collect Payment
function collectPaymentOPD(billId) {
  const bill = state.pendingBills.find(function(b) { return b.id === billId; });
  if (!bill) return;
  
  const patient = state.patients.find(function(p) { return p.id === bill.patientId; });
  
  if (confirm('Confirm payment received?\n\nPatient: ' + patient.name + '\nAmount: ‚Çπ' + bill.cost.toLocaleString('en-IN'))) {
    const opd = state.opdRecords.find(function(o) { return o.id === bill.opdId; });
    
    // Update bill status
    bill.status = 'paid';
    bill.paidAt = new Date().toISOString();
    
    // Update OPD record
    opd.paymentReceived = true;
    opd.paymentReceivedAt = new Date().toISOString();
    
    saveAllData();
    
    alert('‚úÖ PAYMENT CONFIRMED!\n\n' +
          'Amount: ‚Çπ' + bill.cost.toLocaleString('en-IN') + '\n\n' +
          'üë®‚Äç‚öïÔ∏è Sent confirmation to OPD Section.\n' +
          'Doctor can now proceed with treatment.');
    
    renderPrescriptionSection();
  }
}
// ========== PRINT PRESCRIPTION SECTION (RECEPTIONIST) ==========

// Print OPD Prescription (NO BILLING AMOUNTS)
function printPrescriptionOPD(prescriptionId) {
  const prescription = state.pendingPrescriptions.find(function(p) { return p.id === prescriptionId; });
  if (!prescription) return;
  
  const opd = state.opdRecords.find(function(o) { return o.id === prescription.opdId; });
  const patient = state.patients.find(function(p) { return p.id === prescription.patientId; });
  const doctor = state.doctors.find(function(d) { return d.id === prescription.doctorId; });
  
  // Build medicines list
  let medicinesList = '';
  if (opd.medicines && opd.medicines.length > 0) {
    opd.medicines.forEach(function(med, idx) {
      medicinesList += '<div style="background:white;border-left:4px solid #667eea;padding:15px;margin:15px 0;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">' +
        '<div style="font-size:18px;color:#1e293b;font-weight:600">' + (idx + 1) + '. ' + med.name + '</div>' +
        '<div style="color:#64748b;font-size:14px;margin-top:5px">Dosage: ' + med.dosage + '</div>' +
        '<div style="color:#10b981;font-size:14px;font-weight:600;margin-top:3px">' + med.frequency + ' - ' + med.duration + '</div>' +
        '</div>';
    });
  } else {
    medicinesList = '<div style="padding:20px;background:#f8fafc;border-radius:8px;text-align:center;color:#64748b">No medicines prescribed</div>';
  }
  
  // Build tests list
  let testsList = '';
  if (opd.tests && opd.tests.length > 0) {
    testsList = '<div class="section">' +
      '<div class="section-title">üî¨ Tests / Investigations</div>' +
      '<div style="background:#e0e7ff;padding:15px;border-radius:8px">' +
      '<ul style="margin:0;padding-left:20px">' +
      opd.tests.map(function(test) {
        return '<li style="color:#3730a3;margin:5px 0">' + test + '</li>';
      }).join('') +
      '</ul></div></div>';
  }
  
  const prescriptionHTML = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Prescription - ' + patient.name + '</title>' +
    '<style>@media print{@page{size:A4;margin:15mm}body{margin:0}}' +
    'body{font-family:Arial,sans-serif;padding:30px;max-width:800px;margin:0 auto;line-height:1.6}' +
    '.header{text-align:center;border-bottom:3px solid #667eea;padding-bottom:20px;margin-bottom:25px}' +
    '.header h1{color:#667eea;margin:0 0 10px 0;font-size:32px}' +
    '.header p{margin:3px 0;color:#64748b;font-size:14px}' +
    '.section{margin:20px 0}' +
    '.section-title{font-size:15px;font-weight:700;color:#1e293b;margin-bottom:12px;border-bottom:2px solid #e2e8f0;padding-bottom:5px;text-transform:uppercase}' +
    '.patient-info{background:#f8fafc;padding:15px;border-radius:8px;margin-bottom:20px}' +
    '.patient-info p{margin:5px 0;font-size:14px}' +
    '.rx{font-size:42px;color:#667eea;margin:15px 0;text-align:center}' +
    '.procedure{background:#d1fae5;border-left:4px solid #10b981;padding:15px;border-radius:8px;margin:15px 0}' +
    '.procedure-text{color:#065f46;font-size:13px;white-space:pre-wrap;font-family:monospace;line-height:1.8}' +
    '.advice{background:#fef3c7;padding:15px;border-radius:8px;border-left:4px solid #f59e0b;margin:15px 0}' +
    '.signature{margin-top:50px;text-align:right;border-top:2px solid #000;width:220px;margin-left:auto;padding-top:10px}' +
    '</style></head><body>' +
    '<div class="header">' +
    '<h1>ü¶∑ AURA DENTAL CARE</h1>' +
    '<p><strong>Dr. ' + doctor.name + '</strong> (' + (doctor.specialty || 'Dental Surgeon') + ')</p>' +
    '<p>Raipur, Chhattisgarh | Contact: ' + (state.config.clinicPhone || '+91-XXXXXXXXXX') + '</p>' +
    '</div>' +
    '<h2 style="text-align:center;color:#667eea;margin:20px 0;">OPD FORM - PATIENT RECORD</h2>' +
    '<div class="patient-info">' +
    '<p><strong>Patient Name:</strong> ' + patient.name + '</p>' +
    '<p><strong>Age/Gender:</strong> ' + patient.age + ' years / ' + patient.gender + '</p>' +
    '<p><strong>Patient ID:</strong> ' + patient.id + '</p>' +
    '<p><strong>Contact:</strong> ' + patient.contact + '</p>' +
    '<p><strong>Date:</strong> ' + formatIndianDate(opd.date) + '</p>' +
    '</div>' +
    '<div class="section">' +
    '<div class="section-title">Chief Complaint</div>' +
    '<div style="background:#fce7f3;padding:15px;border-radius:8px;color:#831843;font-size:15px;font-weight:600">' + opd.chiefComplaint + '</div>' +
    '</div>' +
    '<div class="section">' +
    '<div class="section-title">Diagnosis</div>' +
    '<div style="font-size:15px;color:#1e293b;font-weight:600;background:#f8fafc;padding:15px;border-radius:8px">' + opd.diagnosis + '</div>' +
    '</div>' +
    '<div class="section">' +
    '<div class="section-title">Procedure Required</div>' +
    '<div style="font-size:15px;color:#1e293b;font-weight:600;background:#f8fafc;padding:15px;border-radius:8px">' + opd.procedureRequired + '</div>' +
    '</div>' +
    '<div class="section">' +
    '<div class="section-title">Procedure Done Today</div>' +
    '<div class="procedure"><div class="procedure-text">' + opd.procedureDone + '</div></div>' +
    '</div>' +
    testsList +
    '<div class="rx">‚Ñû</div>' +
    '<div class="section">' +
    '<div class="section-title">Prescription - Medicines</div>' +
    medicinesList +
    '</div>' +
    (opd.instructions ? 
      '<div class="section">' +
      '<div class="section-title">Instructions / Advice</div>' +
      '<div class="advice">' + opd.instructions + '</div>' +
      '</div>' : '') +
    (opd.nextAppointment ? 
      '<div class="section">' +
      '<div class="section-title">üìÖ Next Appointment Date</div>' +
      '<div style="background:#e0e7ff;padding:15px;border-radius:8px;text-align:center">' +
      '<div style="font-size:20px;font-weight:700;color:#3730a3">' + formatIndianDate(opd.nextAppointment) + '</div>' +
      '</div>' +
      '</div>' : '') +
    '<div style="background:#fef3c7;padding:15px;border-radius:8px;margin:20px 0;border-left:4px solid #f59e0b">' +
    '<p style="color:#92400e;margin:0;font-size:13px"><strong>Note:</strong> This prescription does not include billing details. For billing information, refer to the separate bill.</p>' +
    '</div>' +
    '<div class="signature">' +
    '<div style="font-weight:700;font-size:16px">' + doctor.name + '</div>' +
    '<div style="font-size:12px;color:#64748b;margin-top:3px">' + (doctor.specialty || 'Dental Surgeon') + '</div>' +
    '<div style="font-size:11px;color:#94a3b8;margin-top:5px">Date: ' + formatIndianDate(new Date().toISOString().split('T')[0]) + '</div>' +
    '</div>' +
    '<script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script>' +
    '</body></html>';
  
  const printWindow = window.open('', '_blank', 'width=800,height=900');
  printWindow.document.write(prescriptionHTML);
  printWindow.document.close();
  
  // Mark as printed
  prescription.status = 'printed';
  prescription.printedAt = new Date().toISOString();
  opd.prescriptionPrinted = true;
  
  saveAllData();
  
  alert('‚úÖ Prescription printed!\n\nGive to patient: ' + patient.name);
  
  renderPrescriptionSection();
}

// ========== UTILITY FUNCTIONS FOR NEW WORKFLOW ==========

// Reset all chairs to available (for testing/emergencies)
function resetAllChairs() {
  if (confirm('Reset all chairs to AVAILABLE?\n\nThis will free up all occupied chairs.')) {
    state.chairs.forEach(function(chair) {
      chair.status = 'available';
    });
    saveAllData();
    alert('‚úÖ All chairs reset to available!');
    navigate();
  }
}

// View current workflow data (for debugging)
function viewWorkflowData() {
  let report = '‚ïê‚ïê‚ïê WORKFLOW DATA ‚ïê‚ïê‚ïê\n\n';
  report += 'DOCTOR QUEUE: ' + state.doctorQueue.length + '\n';
  if (state.doctorQueue.length > 0) {
    state.doctorQueue.forEach(function(q) {
      const p = state.patients.find(function(pat) { return pat.id === q.patientId; });
      report += '  ‚Ä¢ ' + (p ? p.name : 'Unknown') + ' - ' + q.status + '\n';
    });
  }
  
  report += '\nTREATMENT PLANS: ' + state.treatmentPlans.length + '\n';
  if (state.treatmentPlans.length > 0) {
    state.treatmentPlans.forEach(function(tp) {
      const p = state.patients.find(function(pat) { return pat.id === tp.patientId; });
      report += '  ‚Ä¢ ' + (p ? p.name : 'Unknown') + ' - ‚Çπ' + tp.totalCost + ' - ' + tp.status + '\n';
    });
  }
  
  report += '\nCHAIRS:\n';
  state.chairs.forEach(function(c) {
    report += '  Chair ' + c.id + ': ' + c.status + '\n';
  });
  
  alert(report);
}

// Clear workflow data (for testing)
function clearWorkflowData() {
  if (confirm('Clear all doctor queues and treatment plans?\n\nThis will NOT delete patients or appointments.')) {
    state.doctorQueue = [];
    state.treatmentPlans = [];
    saveAllData();
    alert('‚úÖ Workflow data cleared!');
    navigate();
  }
}

// ========== UTILITY FUNCTIONS FOR TESTING/DEBUGGING ==========

// Reset all chairs to available

// Clear doctor queue
function clearDoctorQueue() {
  if (confirm('Clear all entries from doctor queue?')) {
    state.doctorQueue = [];
    saveAllData();
    alert('‚úÖ Doctor queue cleared!');
    location.reload();
  }
}

// Clear treatment plans
function clearTreatmentPlans() {
  if (confirm('Clear all treatment plans?')) {
    state.treatmentPlans = [];
    saveAllData();
    alert('‚úÖ Treatment plans cleared!');
    location.reload();
  }
}

// Create test patient for demo
function createTestPatient() {
  const testPatient = {
    id: generateId(state.patients),
    name: 'TEST PATIENT',
    contact: '9999999999',
    phone: '9999999999',
    age: 35,
    gender: 'Male',
    email: 'test@test.com',
    address: 'Test Address',
    registrationDate: new Date().toISOString().split('T')[0],
    source: 'walkin'
  };
  
  state.patients.push(testPatient);
  
  // Add to doctor queue with consultation payment
  const queueEntry = {
    id: generateId(state.doctorQueue),
    patientId: testPatient.id,
    date: new Date().toISOString().split('T')[0],
    time: new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }),
    consultationFee: 500,
    paymentMethod: 'Cash',
    paymentCode: 'TEST' + Date.now().toString().slice(-8),
    status: 'waiting',
    addedAt: new Date().toISOString()
  };
  
  state.doctorQueue.push(queueEntry);
  saveAllData();
  
  alert('‚úÖ Test patient created!\n\nName: TEST PATIENT\nPhone: 9999999999\nAdded to doctor queue\n\nRefresh the page to see.');
  location.reload();
}



// ========================================
// üÜï ENHANCED FEATURES - RECOMMENDED ACTIONS
// ========================================

// ========== 1. DATA BACKUP & EXPORT SYSTEM ==========
function exportAllData() {
  const exportData = {
    exportDate: new Date().toISOString(),
    clinicName: 'Aura Dental Care',
    patients: state.patients,
    doctors: state.doctors,
    staff: state.staff,
    appointments: state.appointments,
    bills: state.bills,
    treatments: state.treatments,
    medicines: state.medicines,
    expenses: state.expenses,
    doctorQueue: state.doctorQueue,
    treatmentPlans: state.treatmentPlans,
    opdRecords: state.opdRecords,
    chairs: state.chairs,
    config: state.config
  };
  
  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  const fileName = 'AuraDental_Backup_' + new Date().toISOString().split('T')[0] + '.json';
  link.href = url;
  link.download = fileName;
  link.click();
  URL.revokeObjectURL(url);
  
  alert('‚úÖ Data exported successfully!\n\nFile: ' + fileName + '\n\nKeep this file safe as a backup.');
}

function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const importedData = JSON.parse(event.target.result);
        
        if (!confirm('‚ö†Ô∏è WARNING: This will replace all current data!\n\nImported from: ' + (importedData.exportDate || 'Unknown') + '\n\nContinue?')) {
          return;
        }
        
        // Restore data
        state.patients = importedData.patients || [];
        state.doctors = importedData.doctors || state.doctors;
        state.staff = importedData.staff || state.staff;
        state.appointments = importedData.appointments || [];
        state.bills = importedData.bills || [];
        state.treatments = importedData.treatments || state.treatments;
        state.medicines = importedData.medicines || state.medicines;
        state.expenses = importedData.expenses || [];
        state.doctorQueue = importedData.doctorQueue || [];
        state.treatmentPlans = importedData.treatmentPlans || [];
        state.opdRecords = importedData.opdRecords || [];
        state.chairs = importedData.chairs || state.chairs;
        state.config = importedData.config || state.config;
        
        saveAllData();
        alert('‚úÖ Data imported successfully!\n\nRefreshing page...');
        location.reload();
      } catch (error) {
        alert('‚ùå Error importing data!\n\nPlease check the file format.');
      }
    };
    reader.readAsText(file);
  };
  
  input.click();
}

// ========== 2. PDF EXPORT FOR BILLS & PRESCRIPTIONS ==========
function downloadBillAsPDF(billId) {
  const bill = state.bills.find(b => b.id === billId);
  if (!bill) return;
  
  const patient = state.patients.find(p => p.id === bill.patientId);
  const doctor = state.doctors.find(d => d.id === bill.doctorId);
  
  if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
    alert('‚ö†Ô∏è PDF library loading...\n\nPlease try again in a moment.');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Header
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text('AURA DENTAL CARE', 105, 20, { align: 'center' });
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('Raipur, Chhattisgarh', 105, 27, { align: 'center' });
  doc.text('Contact: ' + (state.config.clinicPhone || '+91-XXXXXXXXXX'), 105, 32, { align: 'center' });
  
  doc.setLineWidth(0.5);
  doc.line(20, 35, 190, 35);
  
  // Bill Details
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.text('PAYMENT RECEIPT', 105, 45, { align: 'center' });
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('Bill No: ' + bill.id, 20, 55);
  doc.text('Date: ' + formatIndianDate(bill.date), 150, 55);
  
  // Patient Info
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('PATIENT DETAILS', 20, 65);
  doc.setFont(undefined, 'normal');
  doc.setFontSize(10);
  
  let y = 72;
  doc.text('Name: ' + (patient ? patient.name : 'N/A'), 20, y);
  y += 6;
  doc.text('Contact: ' + (patient ? patient.contact : 'N/A'), 20, y);
  y += 6;
  doc.text('Age: ' + (patient ? patient.age : 'N/A') + '     Gender: ' + (patient ? patient.gender : 'N/A'), 20, y);
  y += 10;
  
  // Treatments
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('TREATMENTS', 20, y);
  y += 7;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  
  if (bill.treatments && bill.treatments.length > 0) {
    bill.treatments.forEach((t, idx) => {
      doc.text((idx + 1) + '. ' + t.name, 25, y);
      doc.text('‚Çπ ' + t.cost.toLocaleString('en-IN'), 170, y, { align: 'right' });
      y += 6;
    });
  }
  
  y += 5;
  
  // Total
  doc.setLineWidth(0.3);
  doc.line(20, y, 190, y);
  y += 7;
  
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('TOTAL AMOUNT:', 20, y);
  doc.text('‚Çπ ' + bill.total.toLocaleString('en-IN'), 170, y, { align: 'right' });
  
  if (bill.discount && bill.discount > 0) {
    y += 7;
    doc.setFontSize(10);
    doc.text('Discount (' + (bill.discountReason || 'Applied') + '):', 20, y);
    doc.text('- ‚Çπ ' + bill.discount.toLocaleString('en-IN'), 170, y, { align: 'right' });
    
    y += 7;
    doc.setFontSize(12);
    doc.text('FINAL AMOUNT:', 20, y);
    doc.text('‚Çπ ' + (bill.total - bill.discount).toLocaleString('en-IN'), 170, y, { align: 'right' });
  }
  
  y += 7;
  doc.line(20, y, 190, y);
  y += 7;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('Payment Status: PAID', 20, y);
  doc.text('Method: ' + (bill.paymentMethod || 'Cash'), 150, y);
  
  // Footer
  y += 20;
  if (y > 250) y = 250;
  doc.setFontSize(8);
  doc.text('Thank you for choosing Aura Dental Care!', 105, y, { align: 'center' });
  
  // Save
  const fileName = 'Bill_' + bill.id + '_' + (patient ? patient.name.replace(/\s+/g, '_') : 'Patient') + '.pdf';
  doc.save(fileName);
  
  alert('‚úÖ Bill downloaded as PDF!\n\nFile: ' + fileName);
}

function downloadPrescriptionAsPDF(billId) {
  const bill = state.bills.find(b => b.id === billId);
  if (!bill || !bill.medicines || bill.medicines.length === 0) {
    alert('‚ö†Ô∏è No prescription to download');
    return;
  }
  
  const patient = state.patients.find(p => p.id === bill.patientId);
  const doctor = state.doctors.find(d => d.id === bill.doctorId);
  
  if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
    alert('‚ö†Ô∏è PDF library loading...\n\nPlease try again in a moment.');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Header
  doc.setFontSize(22);
  doc.setFont(undefined, 'bold');
  doc.text('AURA DENTAL CARE', 105, 20, { align: 'center' });
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('Dr. ' + (doctor ? doctor.name : 'Doctor'), 105, 28, { align: 'center' });
  doc.text((doctor ? doctor.specialty : 'Dental Surgeon'), 105, 33, { align: 'center' });
  doc.text('Raipur, Chhattisgarh | Contact: ' + (state.config.clinicPhone || '+91-XXXXXXXXXX'), 105, 38, { align: 'center' });
  
  doc.setLineWidth(0.5);
  doc.line(20, 42, 190, 42);
  
  // Patient Info
  doc.setFontSize(10);
  let y = 50;
  doc.text('Date: ' + formatIndianDate(bill.date), 20, y);
  y += 6;
  doc.text('Patient: ' + (patient ? patient.name : 'N/A') + '    Age: ' + (patient ? patient.age : 'N/A') + '    Gender: ' + (patient ? patient.gender : 'N/A'), 20, y);
  y += 6;
  doc.text('Contact: ' + (patient ? patient.contact : 'N/A'), 20, y);
  y += 10;
  
  // Rx Symbol
  doc.setFontSize(40);
  doc.setFont(undefined, 'bold');
  doc.text('‚Ñû', 105, y + 5, { align: 'center' });
  y += 20;
  
  // Medicines
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('PRESCRIPTION', 20, y);
  y += 8;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  
  bill.medicines.forEach((med, idx) => {
    if (y > 270) {
      doc.addPage();
      y = 20;
    }
    
    doc.setFont(undefined, 'bold');
    doc.text((idx + 1) + '. ' + med.name, 25, y);
    y += 5;
    
    doc.setFont(undefined, 'normal');
    doc.text('    Dosage: ' + med.dosage, 25, y);
    y += 5;
    doc.text('    Frequency: ' + med.frequency + '  |  Duration: ' + med.duration, 25, y);
    y += 8;
  });
  
  // Instructions
  if (bill.notes) {
    y += 5;
    if (y > 250) {
      doc.addPage();
      y = 20;
    }
    doc.setFont(undefined, 'bold');
    doc.text('INSTRUCTIONS:', 20, y);
    y += 6;
    doc.setFont(undefined, 'normal');
    const lines = doc.splitTextToSize(bill.notes, 170);
    doc.text(lines, 25, y);
    y += lines.length * 5 + 10;
  }
  
  // Signature
  if (y > 240) {
    doc.addPage();
    y = 20;
  }
  y = 260;
  doc.setLineWidth(0.3);
  doc.line(130, y, 185, y);
  y += 5;
  doc.setFontSize(10);
  doc.setFont(undefined, 'bold');
  doc.text('Dr. ' + (doctor ? doctor.name : 'Doctor'), 157, y, { align: 'center' });
  y += 5;
  doc.setFontSize(8);
  doc.setFont(undefined, 'normal');
  doc.text((doctor ? doctor.specialty : 'Dental Surgeon'), 157, y, { align: 'center' });
  
  // Save
  const fileName = 'Prescription_' + bill.id + '_' + (patient ? patient.name.replace(/\s+/g, '_') : 'Patient') + '.pdf';
  doc.save(fileName);
  
  alert('‚úÖ Prescription downloaded as PDF!\n\nFile: ' + fileName);
}

// ========== 3. WHATSAPP REMINDER SYSTEM ==========
function sendAppointmentReminder(appointmentId) {
  const appointment = state.appointments.find(a => a.id === appointmentId);
  if (!appointment) return;
  
  const patient = state.patients.find(p => p.id === appointment.patientId);
  const doctor = state.doctors.find(d => d.id === appointment.doctorId);
  
  const message = 'ü¶∑ *AURA DENTAL CARE* - Appointment Reminder\n\n' +
    'Dear ' + patient.name + ',\n\n' +
    'This is a reminder for your dental appointment:\n\n' +
    'üìÖ *Date:* ' + formatIndianDate(appointment.date) + '\n' +
    '‚è∞ *Time:* ' + appointment.time + '\n' +
    'üë®‚Äç‚öïÔ∏è *Doctor:* ' + (doctor ? doctor.name : 'Aura Dental') + '\n\n' +
    'üìç *Location:* Aura Dental Care, Raipur\n\n' +
    '‚ö†Ô∏è Please arrive 10 minutes early.\n' +
    'üí° In case of any changes, please call us.\n\n' +
    'Contact: ' + (state.config.clinicPhone || '+91-XXXXXXXXXX') + '\n\n' +
    'Thank you!\n' +
    'ü¶∑ Aura Dental Care Team';
  
  const phone = patient.contact.replace(/\D/g, '');
  const encodedMessage = encodeURIComponent(message);
  const whatsappURL = 'https://wa.me/91' + phone + '?text=' + encodedMessage;
  
  window.open(whatsappURL, '_blank');
}

function sendPaymentReminder(billId) {
  const bill = state.bills.find(b => b.id === billId);
  if (!bill) return;
  
  const patient = state.patients.find(p => p.id === bill.patientId);
  const amountDue = bill.total - (bill.amountPaid || 0);
  
  if (amountDue <= 0) {
    alert('‚ö†Ô∏è No payment pending for this bill');
    return;
  }
  
  const message = 'ü¶∑ *AURA DENTAL CARE* - Payment Reminder\n\n' +
    'Dear ' + patient.name + ',\n\n' +
    'This is a gentle reminder regarding your pending payment:\n\n' +
    'üí∞ *Amount Due:* ‚Çπ' + amountDue.toLocaleString('en-IN') + '\n' +
    'üìÖ *Bill Date:* ' + formatIndianDate(bill.date) + '\n' +
    'üî¢ *Bill No:* ' + bill.id + '\n\n' +
    'Please visit our clinic to clear the payment at your earliest convenience.\n\n' +
    'üìç Aura Dental Care, Raipur\n' +
    'üìû Contact: ' + (state.config.clinicPhone || '+91-XXXXXXXXXX') + '\n\n' +
    'Thank you for your cooperation!\n' +
    'ü¶∑ Aura Dental Care Team';
  
  const phone = patient.contact.replace(/\D/g, '');
  const encodedMessage = encodeURIComponent(message);
  const whatsappURL = 'https://wa.me/91' + phone + '?text=' + encodedMessage;
  
  window.open(whatsappURL, '_blank');
}


// ========== FORGOT PASSWORD & RESET SYSTEM ==========

function showForgotPassword() {
  const modalHTML = `
    <div id="forgotPasswordModal" class="modal show" style="display: flex;">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h2>üîë Reset Password</h2>
          <button class="close-modal" onclick="closeForgotPasswordModal()">&times;</button>
        </div>
        
        <div id="forgot-password-step-1" style="display: block;">
          <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #3b82f6;">
            <p style="margin: 0; font-size: 14px; color: #1e40af;">
              <strong>üìå How it works:</strong><br>
              Enter your email and 4-digit Security PIN to reset your password.
            </p>
          </div>
          
          <div id="forgot-password-error"></div>
          
          <form onsubmit="verifySecurityPin();return false;" autocomplete="on">
          <div class="form-group">
            <label>Your Email *</label>
            <input type="email" id="reset-email" name="email" autocomplete="username" placeholder="Enter your email">
          </div>
          
          <div class="form-group">
            <label>Security PIN (4 digits) *</label>
            <input type="password" id="reset-security-pin" name="pin" autocomplete="current-password" placeholder="Enter your security PIN" maxlength="4" pattern="[0-9]*" inputmode="numeric">
            <small style="color: #64748b; font-size: 12px;">The 4-digit PIN you set when your account was created</small>
          </div>
          
          <button type="submit" class="btn-primary" style="width: 100%; padding: 15px; font-size: 16px;">
            Verify & Continue
          </button>
          </form>
          
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
            <p style="font-size: 13px; color: #64748b; text-align: center;">
              <strong>‚ùì Don't know your Security PIN?</strong><br>
              Contact your clinic administrator for help.
            </p>
          </div>
        </div>
        
        <div id="forgot-password-step-2" style="display: none;">
          <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #10b981;">
            <p style="margin: 0; font-size: 14px; color: #065f46;">
              ‚úÖ <strong>Identity Verified!</strong><br>
              You can now set a new password.
            </p>
          </div>
          
          <div id="new-password-error"></div>
          
          <form onsubmit="resetPasswordNow();return false;" autocomplete="new-password">
          <div class="form-group">
            <label>New Password *</label>
            <input type="password" id="new-password" name="new-password" autocomplete="new-password" placeholder="Enter new password (min 6 characters)">
          </div>
          
          <div class="form-group">
            <label>Confirm New Password *</label>
            <input type="password" id="confirm-password" name="confirm-password" autocomplete="new-password" placeholder="Re-enter new password">
          </div>
          
          <button type="submit" class="btn-primary" style="width: 100%; padding: 15px; font-size: 16px; background: #10b981;">
            Reset Password
          </button>
          </form>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeForgotPasswordModal() {
  const modal = document.getElementById('forgotPasswordModal');
  if (modal) modal.remove();
}

function verifySecurityPin() {
  const email = document.getElementById('reset-email').value.trim();
  const pin = document.getElementById('reset-security-pin').value.trim();
  
  if (!email || !pin) {
    document.getElementById('forgot-password-error').innerHTML = '<div class="alert alert-error">Please enter both email and security PIN</div>';
    return;
  }
  
  if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
    document.getElementById('forgot-password-error').innerHTML = '<div class="alert alert-error">Security PIN must be exactly 4 digits</div>';
    return;
  }
  
  // Check admin
  if (email === 'admin@auradental.com') {
    document.getElementById('forgot-password-error').innerHTML = '<div class="alert alert-error">Admin password cannot be reset. Please contact system administrator.</div>';
    return;
  }
  
  // Check doctors
  let user = state.doctors.find(d => d.email === email);
  let userType = 'doctor';
  
  // Check staff
  if (!user) {
    user = state.staff.find(s => s.email === email);
    userType = 'staff';
  }
  
  // Check default receptionist
  if (!user && email === 'receptionist@auradental.com') {
    document.getElementById('forgot-password-error').innerHTML = '<div class="alert alert-error">Default receptionist password cannot be reset. Contact administrator.</div>';
    return;
  }
  
  if (!user) {
    document.getElementById('forgot-password-error').innerHTML = '<div class="alert alert-error">Email not found in system</div>';
    return;
  }
  
  if (!user.securityPin) {
    document.getElementById('forgot-password-error').innerHTML = '<div class="alert alert-error">No security PIN set for this account. Contact administrator to set one.</div>';
    return;
  }
  
  if (user.securityPin !== pin) {
    document.getElementById('forgot-password-error').innerHTML = '<div class="alert alert-error">Incorrect security PIN. Please try again.</div>';
    return;
  }
  
  // PIN verified - show step 2
  document.getElementById('forgot-password-step-1').style.display = 'none';
  document.getElementById('forgot-password-step-2').style.display = 'block';
  
  // Store for password reset
  window.resetUserEmail = email;
  window.resetUserType = userType;
}

function resetPasswordNow() {
  const newPassword = document.getElementById('new-password').value.trim();
  const confirmPassword = document.getElementById('confirm-password').value.trim();
  
  if (!newPassword || !confirmPassword) {
    document.getElementById('new-password-error').innerHTML = '<div class="alert alert-error">Please enter and confirm your new password</div>';
    return;
  }
  
  if (newPassword.length < 6) {
    document.getElementById('new-password-error').innerHTML = '<div class="alert alert-error">Password must be at least 6 characters long</div>';
    return;
  }
  
  if (newPassword !== confirmPassword) {
    document.getElementById('new-password-error').innerHTML = '<div class="alert alert-error">Passwords do not match</div>';
    return;
  }
  
  const email = window.resetUserEmail;
  const userType = window.resetUserType;
  
  // Update password
  if (userType === 'doctor') {
    const doctor = state.doctors.find(d => d.email === email);
    if (doctor) {
      doctor.password = newPassword;
      DataStore.save('doctors', state.doctors);
    }
  } else if (userType === 'staff') {
    const staff = state.staff.find(s => s.email === email);
    if (staff) {
      staff.password = newPassword;
      DataStore.save('staff', state.staff);
    }
  }
  
  closeForgotPasswordModal();
  
  alert('‚úÖ PASSWORD RESET SUCCESSFUL!\n\n' +
        'Your password has been changed.\n\n' +
        'üìß Email: ' + email + '\n' +
        'üîí New Password: ' + newPassword + '\n\n' +
        'You can now log in with your new password.');
  
  // Auto-fill login
  document.getElementById('login-email').value = email;
  document.getElementById('login-password').value = newPassword;
  
  // Clean up
  delete window.resetUserEmail;
  delete window.resetUserType;
}

// ========== SECURITY PIN MANAGEMENT ==========

function showSetSecurityPinPrompt(userName, userEmail, userType) {
  if (confirm('üîê SET SECURITY PIN\n\n' + userName + ', would you like to set a 4-digit Security PIN now?\n\nThis PIN will allow you to reset your password if you forget it.\n\nSet PIN now?')) {
    showSetSecurityPinModal(userEmail, userType);
  }
}

function showSetSecurityPinModal(userEmail, userType) {
  const modalHTML = `
    <div id="setSecurityPinModal" class="modal show" style="display: flex;">
      <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
          <h2>üîê Set Security PIN</h2>
          <button class="close-modal" onclick="closeSecurityPinModal()">&times;</button>
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #f59e0b;">
          <p style="margin: 0; font-size: 14px; color: #92400e;">
            <strong>‚ö†Ô∏è Important:</strong><br>
            This PIN will be used to reset your password if you forget it. Remember it or write it down in a safe place.
          </p>
        </div>
        
        <div id="security-pin-error"></div>
        
        <form onsubmit="saveSecurityPin('${userEmail}', '${userType}');return false;" autocomplete="new-password">
        <div class="form-group">
          <label>Create 4-Digit Security PIN *</label>
          <input type="password" id="new-security-pin" name="new-pin" autocomplete="new-password" placeholder="Enter 4 digits" maxlength="4" pattern="[0-9]*" inputmode="numeric" style="font-size: 24px; text-align: center; letter-spacing: 10px;">
        </div>
        
        <div class="form-group">
          <label>Confirm Security PIN *</label>
          <input type="password" id="confirm-security-pin" name="confirm-pin" autocomplete="new-password" placeholder="Re-enter 4 digits" maxlength="4" pattern="[0-9]*" inputmode="numeric" style="font-size: 24px; text-align: center; letter-spacing: 10px;">
        </div>
        
        <button type="submit" class="btn-primary" style="width: 100%; padding: 15px; font-size: 16px;">
          Set Security PIN
        </button>
        </form>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeSecurityPinModal() {
  const modal = document.getElementById('setSecurityPinModal');
  if (modal) modal.remove();
}

function saveSecurityPin(email, userType) {
  const newPin = document.getElementById('new-security-pin').value.trim();
  const confirmPin = document.getElementById('confirm-security-pin').value.trim();
  
  if (!newPin || !confirmPin) {
    document.getElementById('security-pin-error').innerHTML = '<div class="alert alert-error">Please enter and confirm your security PIN</div>';
    return;
  }
  
  if (newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
    document.getElementById('security-pin-error').innerHTML = '<div class="alert alert-error">Security PIN must be exactly 4 digits (0-9)</div>';
    return;
  }
  
  if (newPin !== confirmPin) {
    document.getElementById('security-pin-error').innerHTML = '<div class="alert alert-error">PINs do not match</div>';
    return;
  }
  
  // Save PIN
  if (userType === 'doctor') {
    const doctor = state.doctors.find(d => d.email === email);
    if (doctor) {
      doctor.securityPin = newPin;
      DataStore.save('doctors', state.doctors);
    }
  } else if (userType === 'staff') {
    const staff = state.staff.find(s => s.email === email);
    if (staff) {
      staff.securityPin = newPin;
      DataStore.save('staff', state.staff);
    }
  }
  
  closeSecurityPinModal();
  alert('‚úÖ Security PIN set successfully!\n\n' +
        'üîê PIN: ' + newPin + '\n\n' +
        '‚ö†Ô∏è IMPORTANT: Write this down in a safe place.\n' +
        'You will need this PIN to reset your password.');
}

// ============================================================
// üî¥ REAL-TIME SOCKET.IO SYSTEM
// ============================================================

// Global socket instance
let socket = null;
let notificationCount = 0;

// Initialize socket connection when app loads
function initSocketIO() {
  try {
    // Only connect if socket.io is available (when running with server)
    if (typeof io === 'undefined') {
      console.log('‚ÑπÔ∏è Socket.io not available - running in offline mode');
      return;
    }
    
    socket = io();
    
    socket.on('connect', function() {
      console.log('üîå Real-time connected:', socket.id);
      showConnectionStatus(true);
    });
    
    socket.on('disconnect', function() {
      console.log('‚ùå Real-time disconnected');
      showConnectionStatus(false);
    });
    
    // ==============================
    // RECEPTION LISTENERS
    // ==============================
    
    // New prescription sent from doctor
    socket.on('newPrescription', function(data) {
      incrementNotificationBadge();
      playReceptionAlert();
      showGreenPopup('üìã New Prescription: ' + data.patientName);
      addToActivityFeed('üü¢ Prescription sent for: ' + data.patientName + ' (Visit #' + data.visitId + ')');
      
      // Flash the print prescription sidebar item
      flashSidebarItem('#print-prescription');
      
      // If already on print bill/prescription page, reload it
      const hash = window.location.hash;
      if (hash === '#print-prescription' || hash === '#print-bill') {
        renderCurrentPage();
      }
    });
    
    // Prescription printed confirmation
    socket.on('prescriptionPrinted', function(data) {
      addToActivityFeed('üñ®Ô∏è Prescription printed for Visit #' + data.visitId);
    });
    
    // Doctor started consultation
    socket.on('doctorStartedConsultation', function(data) {
      addToActivityFeed('üë®‚Äç‚öïÔ∏è Dr. ' + data.doctorName + ' started consultation for ' + data.patientName);
    });
    
    // Payment confirmed
    socket.on('paymentConfirmed', function(data) {
      addToActivityFeed('üí∞ Payment confirmed for ' + data.patientName + ' - ‚Çπ' + data.amount);
    });
    
    console.log('‚úÖ Socket.io real-time system initialized');
  } catch (error) {
    console.log('‚ÑπÔ∏è Socket.io initialization skipped:', error.message);
  }
}

// ==============================
// üîä SOUND ALERT
// ==============================
function playReceptionAlert() {
  try {
    const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    audio.volume = 0.7;
    audio.play().catch(function() {
      // Browser may block autoplay - that's ok
      console.log('Sound blocked by browser policy');
    });
  } catch (error) {
    console.log('Sound not available');
  }
}

// ==============================
// üü¢ GREEN SLIDE-IN POPUP
// ==============================
function showGreenPopup(message) {
  const banner = document.createElement('div');
  banner.innerHTML = message;
  
  Object.assign(banner.style, {
    position: 'fixed',
    top: '20px',
    right: '20px',
    background: 'linear-gradient(135deg, #16a34a 0%, #059669 100%)',
    color: 'white',
    padding: '16px 24px',
    borderRadius: '12px',
    boxShadow: '0 8px 24px rgba(0,0,0,0.3)',
    zIndex: '99999',
    fontWeight: '600',
    fontSize: '15px',
    transform: 'translateX(120%)',
    transition: 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
    maxWidth: '320px',
    cursor: 'pointer'
  });
  
  // Click to dismiss
  banner.onclick = function() {
    banner.style.transform = 'translateX(120%)';
    setTimeout(function() { banner.remove(); }, 400);
  };
  
  document.body.appendChild(banner);
  
  // Slide in
  setTimeout(function() {
    banner.style.transform = 'translateX(0)';
  }, 50);
  
  // Auto dismiss after 5 seconds
  setTimeout(function() {
    banner.style.transform = 'translateX(120%)';
    setTimeout(function() { 
      if (banner.parentNode) banner.remove(); 
    }, 400);
  }, 5000);
}

// ==============================
// üî¥ NOTIFICATION BADGE
// ==============================
function incrementNotificationBadge() {
  notificationCount++;
  updateBadgeDisplay();
}

function clearNotificationBadge() {
  notificationCount = 0;
  updateBadgeDisplay();
}

function updateBadgeDisplay() {
  const badges = document.querySelectorAll('.notification-badge');
  badges.forEach(function(badge) {
    if (notificationCount > 0) {
      badge.textContent = notificationCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  });
}

// ==============================
// üì° ACTIVITY FEED
// ==============================
function addToActivityFeed(message) {
  // Store in memory
  if (!window.activityFeedItems) window.activityFeedItems = [];
  const item = {
    time: new Date().toLocaleTimeString('en-IN'),
    message: message
  };
  window.activityFeedItems.unshift(item);
  
  // Keep only last 50 items
  if (window.activityFeedItems.length > 50) {
    window.activityFeedItems.pop();
  }
  
  // Update visible feed if exists
  const feed = document.getElementById('activity-feed');
  if (feed) {
    renderActivityFeed(feed);
  }
}

function renderActivityFeed(container) {
  if (!window.activityFeedItems) return;
  
  container.innerHTML = window.activityFeedItems.slice(0, 20).map(function(item) {
    const color = item.message.includes('üü¢') ? '#16a34a' :
                  item.message.includes('üí∞') ? '#0284c7' :
                  item.message.includes('üë®‚Äç‚öïÔ∏è') ? '#7c3aed' :
                  item.message.includes('üñ®Ô∏è') ? '#ea580c' : '#64748b';
    return '<div style="padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: ' + color + ';">' +
      '<span style="font-weight: 700; color: #94a3b8; font-size: 11px;">' + item.time + '</span>' +
      ' ' + item.message + '</div>';
  }).join('');
}

// Get the activity feed HTML to insert into pages
function getActivityFeedHTML() {
  return '<div class="card" style="background: #0f172a; color: white; margin-top: 20px;">' +
    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">' +
    '<h2 style="margin: 0; font-size: 16px; color: #10b981;">üì° Live Activity Feed</h2>' +
    '<div style="display: flex; align-items: center; gap: 8px;">' +
    '<div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse-dot 1.5s infinite;"></div>' +
    '<span style="font-size: 12px; color: #94a3b8;">LIVE</span>' +
    '</div>' +
    '</div>' +
    '<div id="activity-feed" style="max-height: 200px; overflow-y: auto; background: #1e293b; border-radius: 8px; padding: 10px;">' +
    '<div style="text-align: center; color: #475569; padding: 20px; font-size: 13px;">No activity yet...</div>' +
    '</div>' +
    '</div>';
}

// ==============================
// ‚ú® SIDEBAR FLASH EFFECT
// ==============================
function flashSidebarItem(hash) {
  const items = document.querySelectorAll('.sidebar-item');
  items.forEach(function(item) {
    if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(hash)) {
      item.style.animation = 'sidebar-flash 0.5s ease 3';
      setTimeout(function() {
        item.style.animation = '';
      }, 1500);
    }
  });
}

// ==============================
// üü¢ CONNECTION STATUS INDICATOR
// ==============================
function showConnectionStatus(connected) {
  let statusEl = document.getElementById('realtime-status');
  if (!statusEl) {
    statusEl = document.createElement('div');
    statusEl.id = 'realtime-status';
    Object.assign(statusEl.style, {
      position: 'fixed',
      bottom: '20px',
      right: '20px',
      padding: '8px 14px',
      borderRadius: '20px',
      fontSize: '12px',
      fontWeight: '600',
      zIndex: '9998',
      transition: 'all 0.3s'
    });
    document.body.appendChild(statusEl);
  }
  
  if (connected) {
    statusEl.innerHTML = 'üü¢ Real-time Connected';
    statusEl.style.background = '#d1fae5';
    statusEl.style.color = '#065f46';
    // Hide after 3 seconds
    setTimeout(function() {
      statusEl.style.opacity = '0';
    }, 3000);
  } else {
    statusEl.innerHTML = 'üî¥ Real-time Disconnected';
    statusEl.style.background = '#fee2e2';
    statusEl.style.color = '#991b1b';
    statusEl.style.opacity = '1';
  }
}

// ==============================
// üì§ EMIT FUNCTIONS (Doctor sends)
// ==============================

// Doctor sends prescription to reception
function emitPrescriptionSent(visitId, patientName, doctorName) {
  if (!socket || !socket.connected) return;
  
  socket.emit('sendPrescription', {
    visitId: visitId,
    patientName: patientName,
    doctorName: doctorName,
    time: new Date().toISOString()
  });
  
  addToActivityFeed('üì§ Sent prescription for ' + patientName + ' to Reception');
}

// Reception confirms payment
function emitPaymentConfirmed(visitId, patientName, amount) {
  if (!socket || !socket.connected) return;
  
  socket.emit('confirmPayment', {
    visitId: visitId,
    patientName: patientName,
    amount: amount,
    time: new Date().toISOString()
  });
}

// Reception prints prescription
async function printPrescriptionRealtime(visitId, billId) {
  // Notify server
  if (socket && socket.connected) {
    socket.emit('prescriptionPrinted', { visitId: visitId });
  }
  
  // Also notify via API if connected
  try {
    await fetch('/api/prescription-printed', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ visitId: visitId })
    });
  } catch (error) {
    // Offline mode - just print locally
  }
  
  // Print
  if (billId) {
    printPrescriptionFromBill(billId);
  } else {
    window.print();
  }
  
  addToActivityFeed('üñ®Ô∏è Prescription printed for Visit #' + visitId);
}

// ==============================
// üé® REAL-TIME CSS STYLES
// ==============================
(function addRealtimeStyles() {
  const style = document.createElement('style');
  style.textContent = `
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }
    
    @keyframes sidebar-flash {
      0% { background: inherit; }
      50% { background: rgba(16, 185, 129, 0.3) !important; }
      100% { background: inherit; }
    }
    
    @keyframes green-pulse {
      0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
      100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
    
    @keyframes new-item-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    .new-prescription-row {
      background: #dcfce7 !important;
      border-left: 4px solid #16a34a !important;
      animation: new-item-pulse 1s ease 2;
    }
    
    .notification-badge {
      background: #ef4444;
      color: white;
      border-radius: 50%;
      padding: 2px 7px;
      font-size: 11px;
      font-weight: 700;
      display: none;
      vertical-align: middle;
      margin-left: 6px;
      line-height: 1.5;
    }
    
    .realtime-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #10b981;
    }
    
    .realtime-dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse-dot 1.5s infinite;
    }
  `;
  document.head.appendChild(style);
})();

// ==============================
// üîî INJECT BADGE INTO SIDEBAR
// ==============================
function injectNotificationBadge() {
  // Add badge to Print Prescription sidebar item
  const allSidebarItems = document.querySelectorAll('.sidebar-item');
  allSidebarItems.forEach(function(item) {
    const onclick = item.getAttribute('onclick') || '';
    if (onclick.includes('print-prescription') || onclick.includes('print-bill')) {
      // Only add badge if not already there
      if (!item.querySelector('.notification-badge')) {
        const badge = document.createElement('span');
        badge.className = 'notification-badge';
        if (notificationCount > 0) {
          badge.textContent = notificationCount;
          badge.style.display = 'inline-block';
        }
        item.appendChild(badge);
      }
    }
  });
}

// Re-inject badge whenever DOM changes (sidebar re-renders)
const originalInnerHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML');
const appEl = document.getElementById('app');
if (appEl) {
  const observer = new MutationObserver(function() {
    injectNotificationBadge();
    
    // Re-populate activity feed if visible
    const feed = document.getElementById('activity-feed');
    if (feed && window.activityFeedItems && window.activityFeedItems.length > 0) {
      renderActivityFeed(feed);
    }
  });
  observer.observe(appEl, { childList: true, subtree: false });
}

// ==============================
// üöÄ AUTO-INITIALIZE
// ==============================
// Initialize socket when page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSocketIO);
} else {
  initSocketIO();
}

// Also expose for manual call
window.initSocketIO = initSocketIO;


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR FEATURE - Complete Implementation
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderCalendar() {
  const role = state.currentUser.role;
  
  // Initialize calendar state if not exists
  if (!state.calendar) {
    const now = new Date();
    state.calendar = {
      currentMonth: now.getMonth(),
      currentYear: now.getFullYear(),
      selectedDoctor: 'all'
    };
  }
  
  const { currentMonth, currentYear, selectedDoctor } = state.calendar;
  
  // Get calendar data
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const today = new Date();
  const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
  const todayDate = today.getDate();
  
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
  
  // Get appointments for this month
  let appointments = state.appointments ? state.appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
  }) : [];
  
  // Filter by doctor if selected
  if (selectedDoctor !== 'all') {
    appointments = appointments.filter(function(apt) {
      return apt.doctorId === parseInt(selectedDoctor);
    });
  }
  
  // Separate today's and upcoming appointments
  const todaysApts = appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate.toDateString() === today.toDateString();
  });
  
  const upcomingApts = appointments.filter(function(apt) {
    const aptDate = new Date(apt.date);
    return aptDate > today && aptDate.toDateString() !== today.toDateString();
  }).sort(function(a, b) {
    return new Date(a.date) - new Date(b.date);
  });
  
  const html = '<div class="app-layout">' +
    renderSidebar('#calendar') +
    '<div class="main-wrapper">' +
    '<div class="top-bar">' +
    mobileMenuButton() +
    '<h1 class="page-title">üìÖ Appointment Calendar</h1>' +
    '<div class="user-profile">' +
    '<div class="user-avatar">' + state.currentUser.name.charAt(0) + '</div>' +
    '<div class="user-name">' + state.currentUser.name + '</div>' +
    '</div></div>' +
    '<div class="content-area">' +
    
    // Calendar Controls
    '<div class="card">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px;">' +
    
    // Month/Year Navigation
    '<div style="display:flex;align-items:center;gap:10px;">' +
    '<button onclick="changeMonth(-1)" style="padding:10px 15px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;">‚óÄ</button>' +
    '<h2 style="margin:0;font-size:24px;font-weight:700;min-width:200px;text-align:center;">' +
    monthNames[currentMonth] + ' ' + currentYear +
    '</h2>' +
    '<button onclick="changeMonth(1)" style="padding:10px 15px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;">‚ñ∂</button>' +
    '<button onclick="goToToday()" style="padding:10px 20px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin-left:10px;">Today</button>' +
    '</div>' +
    
    // Doctor Filter
    '<div style="display:flex;align-items:center;gap:10px;">' +
    '<label style="font-weight:600;">Filter by Doctor:</label>' +
    '<select onchange="filterByDoctor(this.value)" style="padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;">' +
    '<option value="all"' + (selectedDoctor === 'all' ? ' selected' : '') + '>All Doctors</option>' +
    state.doctors.map(function(d) {
      return '<option value="' + d.id + '"' + (selectedDoctor === d.id ? ' selected' : '') + '>' + d.name + '</option>';
    }).join('') +
    '</select>' +
    '</div>' +
    
    '</div>' +
    
    // Calendar Grid
    '<div style="background:#f8fafc;border-radius:12px;padding:20px;">' +
    
    // Day Headers
    '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:10px;">' +
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(function(day, i) {
      return '<div style="text-align:center;font-weight:700;font-size:14px;padding:10px;color:' + (i === 0 ? '#ef4444' : '#64748b') + ';">' + day + '</div>';
    }).join('') +
    '</div>' +
    
    // Calendar Days
    '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;">' +
    (function() {
      let days = '';
      
      // Empty cells before first day
      for (let i = 0; i < firstDay; i++) {
        days += '<div style="padding:40px 10px;"></div>';
      }
      
      // Days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dayOfWeek = date.getDay();
        const isSunday = dayOfWeek === 0;
        const isToday = isCurrentMonth && day === todayDate;
        const isPast = date < today && !isToday;
        const dateStr = currentYear + '-' + String(currentMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        
        // Count appointments for this date
        const dayApts = appointments.filter(function(apt) {
          return apt.date === dateStr;
        });
        
        const bgColor = isToday ? '#ef4444' : (isSunday ? '#fee2e2' : (isPast ? '#f1f5f9' : 'white'));
        const textColor = isToday ? 'white' : (isPast ? '#94a3b8' : (isSunday ? '#dc2626' : '#1e293b'));
        const cursor = isPast ? 'not-allowed' : 'pointer';
       const onClick = isPast ? '' : `onclick="openRegistrationForDate('${dateStr}')"`;

        
        days += '<div ' + onClick + ' style="' +
          'background:' + bgColor + ';' +
          'color:' + textColor + ';' +
          'padding:10px;' +
          'border-radius:8px;' +
          'text-align:center;' +
          'cursor:' + cursor + ';' +
          'border:2px solid ' + (isToday ? '#dc2626' : (dayApts.length > 0 ? '#3b82f6' : '#e2e8f0')) + ';' +
          'transition:all 0.2s;' +
          'min-height:80px;' +
          'display:flex;' +
          'flex-direction:column;' +
          'justify-content:space-between;' +
          (isPast ? 'opacity:0.5;' : '') +
          '"' +
          (isPast ? '' : ' onmouseover="this.style.transform=\'scale(1.05)\'" onmouseout="this.style.transform=\'scale(1)\'"') +
          '>' +
          '<div style="font-size:18px;font-weight:700;">' + day + '</div>' +
          (dayApts.length > 0 ? '<div style="font-size:11px;background:' + (isToday ? 'rgba(255,255,255,0.3)' : '#3b82f6') + ';color:' + (isToday ? 'white' : 'white') + ';padding:3px 6px;border-radius:4px;margin-top:5px;">' + dayApts.length + ' apt' + (dayApts.length > 1 ? 's' : '') + '</div>' : '') +
          '</div>';
      }
      
      return days;
    })() +
    '</div>' +
    '</div>' +
    '</div>' +
    
    // Today's Appointments
    '<div class="card" style="margin-top:20px;border-top:4px solid #10b981;">' +
    '<h3 style="margin:0 0 15px 0;font-size:18px;font-weight:700;color:#065f46;">üìå Today\'s Appointments (' + todaysApts.length + ')</h3>' +
    (todaysApts.length === 0 ?
      '<div style="text-align:center;padding:30px;color:#94a3b8;">No appointments today</div>' :
      '<div style="display:grid;gap:10px;">' +
      todaysApts.map(function(apt) {
        const patient = state.patients.find(function(p) { return p.id === apt.patientId; });
        const doctor = state.doctors.find(function(d) { return d.id === apt.doctorId; });
        return '<div style="padding:12px;background:#f0fdf4;border-left:4px solid #10b981;border-radius:8px;">' +
          '<div style="font-weight:600;color:#065f46;">' + (patient ? patient.name : 'Unknown') + '</div>' +
          '<div style="font-size:13px;color:#64748b;margin-top:4px;">' +
          'Doctor: ' + (doctor ? doctor.name : 'N/A') + ' | Time: ' + (apt.time || 'Not set') +
          '</div>' +
          '</div>';
      }).join('') +
      '</div>') +
    '</div>' +
    
    // Upcoming Appointments
    '<div class="card" style="margin-top:20px;border-top:4px solid #3b82f6;">' +
    '<h3 style="margin:0 0 15px 0;font-size:18px;font-weight:700;color:#1e40af;">üìÖ Upcoming Appointments (' + upcomingApts.length + ')</h3>' +
    (upcomingApts.length === 0 ?
      '<div style="text-align:center;padding:30px;color:#94a3b8;">No upcoming appointments this month</div>' :
      '<div style="display:grid;gap:10px;">' +
      upcomingApts.slice(0, 10).map(function(apt) {
        const patient = state.patients.find(function(p) { return p.id === apt.patientId; });
        const doctor = state.doctors.find(function(d) { return d.id === apt.doctorId; });
        const aptDate = new Date(apt.date);
        return '<div style="padding:12px;background:#eff6ff;border-left:4px solid #3b82f6;border-radius:8px;">' +
          '<div style="font-weight:600;color:#1e40af;">' + (patient ? patient.name : 'Unknown') + '</div>' +
          '<div style="font-size:13px;color:#64748b;margin-top:4px;">' +
          formatIndianDate(apt.date) + ' | Doctor: ' + (doctor ? doctor.name : 'N/A') + ' | Time: ' + (apt.time || 'Not set') +
          '</div>' +
          '</div>';
      }).join('') +
      (upcomingApts.length > 10 ? '<div style="text-align:center;padding:10px;color:#64748b;font-size:14px;">... and ' + (upcomingApts.length - 10) + ' more</div>' : '') +
      '</div>') +
    '</div>' +
    
    '</div></div></div>';
  
  document.getElementById('app').innerHTML = html;
}



function openRegistrationForDate(dateStr) {
  // Store selected date
  state.selectedDate = dateStr;
  
  // Navigate to walk-in/registration page
  window.location.hash = '#dashboard';
  
  // Show notification
  showToast('üìÖ Date selected: ' + dateStr + ' - Register patient now');
  
  // Pre-fill date in appointment if possible
  setTimeout(function() {
    const dateInput = document.getElementById('appointment-date');
    if (dateInput) {
      dateInput.value = dateStr;
    }
  }, 100);
}


// ‚îÄ‚îÄ Calendar Navigation Globals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Must be global so onclick handlers generated by renderCalendar can reach them.
function changeMonth(delta) {
  if (typeof state === 'undefined' || !state.calendar) return;
  state.calendar.currentMonth += delta;
  if (state.calendar.currentMonth > 11) {
    state.calendar.currentMonth = 0;
    state.calendar.currentYear++;
  } else if (state.calendar.currentMonth < 0) {
    state.calendar.currentMonth = 11;
    state.calendar.currentYear--;
  }
  renderCalendar();
}

function goToToday() {
  if (typeof state === 'undefined' || !state.calendar) return;
  var now = new Date();
  state.calendar.currentMonth = now.getMonth();
  state.calendar.currentYear = now.getFullYear();
  renderCalendar();
}

function filterByDoctor(doctorId) {
  if (typeof state === 'undefined' || !state.calendar) return;
  state.calendar.selectedDoctor = doctorId === 'all' ? 'all' : parseInt(doctorId);
  renderCalendar();
}
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Advanced Notification System
function showNotification(message, type, duration) {
  type = type || 'info';
  duration = duration || 3000;
  
  const colors = {
    success: '#10b981',
    error: '#ef4444',
    warning: '#f59e0b',
    info: '#3b82f6'
  };
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  const notification = document.createElement('div');
  notification.innerHTML = icons[type] + ' ' + message;
  notification.style.cssText = 
    'position:fixed;top:80px;right:20px;background:' + colors[type] + ';' +
    'color:white;padding:16px 24px;border-radius:8px;font-weight:600;' +
    'z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.2);' +
    'animation:slideInRight 0.3s ease;max-width:400px;';
  
  document.body.appendChild(notification);
  
  setTimeout(function() {
    notification.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(function() {
      if (notification.parentNode) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, duration);
}

// Notification animations
if (!document.getElementById('notification-styles')) {
  const style = document.createElement('style');
  style.id = 'notification-styles';
  style.textContent = `
    @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
}


// Form Validation Helpers
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function validatePhone(phone) {
  const re = /^[6-9]\d{9}$/;
  return re.test(phone.replace(/\s+/g, ''));
}

function validateRequired(value, fieldName) {
  if (!value || value.trim() === '') {
    showNotification(fieldName + ' is required', 'error');
    return false;
  }
  return true;
}

function formatPhone(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length > 10) value = value.slice(0, 10);
  input.value = value;
}

function formatAge(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length > 3) value = value.slice(0, 3);
  if (parseInt(value) > 150) value = '150';
  input.value = value;
}

// Auto-capitalize name fields
function capitalizeName(input) {
  const words = input.value.split(' ');
  const capitalized = words.map(word => {
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  }).join(' ');
  input.value = capitalized;
}


// Print & Export Utilities

// Export to CSV
function exportToCSV(data, filename) {
  if (!data || data.length === 0) {
    showNotification('No data to export', 'warning');
    return;
  }
  
  const headers = Object.keys(data[0]);
  let csv = headers.join(',') + '\n';
  
  data.forEach(function(row) {
    const values = headers.map(function(header) {
      const val = row[header] || '';
      return '"' + String(val).replace(/"/g, '""') + '"';
    });
    csv += values.join(',') + '\n';
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename + '.csv';
  a.click();
  window.URL.revokeObjectURL(url);
  
  showNotification('Exported ' + data.length + ' records', 'success');
}

// Export patients to CSV
function exportPatients() {
  const data = state.patients.map(function(p) {
    return {
      ID: p.id,
      Name: p.name,
      Age: p.age,
      Gender: p.gender,
      Contact: p.contact,
      Email: p.email,
      'Created Date': formatIndianDate(p.createdAt)
    };
  });
  exportToCSV(data, 'patients_' + new Date().toISOString().split('T')[0]);
}

// Export treatments to CSV
function exportTreatments() {
  const data = state.treatmentPlans.map(function(tp) {
    const patient = state.patients.find(p => p.id === tp.patientId);
    const doctor = state.doctors.find(d => d.id === tp.doctorId);
    return {
      ID: tp.id,
      Patient: patient ? patient.name : 'Unknown',
      Doctor: doctor ? doctor.name : 'Unknown',
      Date: formatIndianDate(tp.visitDate),
      'Chief Complaint': tp.chiefComplaint,
      Status: tp.status,
      'Total Cost': tp.totalCost,
      'Amount Paid': tp.amountPaid
    };
  });
  exportToCSV(data, 'treatments_' + new Date().toISOString().split('T')[0]);
}

// Enhanced print with better formatting
function printWithLogo(title, content) {
  const printWindow = window.open('', '', 'width=800,height=600');
  printWindow.document.write('<html><head><title>' + title + '</title>');
  printWindow.document.write('<style>');
  printWindow.document.write('body { font-family: Arial, sans-serif; padding: 20px; }');
  printWindow.document.write('.header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }');
  printWindow.document.write('.clinic-name { font-size: 28px; font-weight: bold; color: #667eea; }');
  printWindow.document.write('.content { margin-top: 20px; }');
  printWindow.document.write('table { width: 100%; border-collapse: collapse; margin-top: 20px; }');
  printWindow.document.write('th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }');
  printWindow.document.write('th { background: #f8fafc; font-weight: bold; }');
  printWindow.document.write('@media print { button { display: none; } }');
  printWindow.document.write('</style></head><body>');
  printWindow.document.write('<div class="header">');
  printWindow.document.write('<div class="clinic-name">ü¶∑ AURA DENTAL CARE</div>');
  printWindow.document.write('<div>' + title + '</div>');
  printWindow.document.write('</div>');
  printWindow.document.write('<div class="content">');
  printWindow.document.write(content);
  printWindow.document.write('</div>');
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.print();
}


// Advanced Search Functionality

// Search patients by multiple criteria
function searchPatients(query) {
  if (!query || query.trim() === '') {
    return state.patients;
  }
  
  query = query.toLowerCase().trim();
  
  return state.patients.filter(function(p) {
    return (
      (p.name && p.name.toLowerCase().includes(query)) ||
      (p.contact && p.contact.includes(query)) ||
      (p.email && p.email.toLowerCase().includes(query)) ||
      (p.id && p.id.toString() === query)
    );
  });
}

// Search treatments
function searchTreatments(query) {
  if (!query || query.trim() === '') {
    return state.treatmentPlans;
  }
  
  query = query.toLowerCase().trim();
  
  return state.treatmentPlans.filter(function(tp) {
    const patient = state.patients.find(p => p.id === tp.patientId);
    const patientName = patient ? patient.name.toLowerCase() : '';
    
    return (
      (tp.chiefComplaint && tp.chiefComplaint.toLowerCase().includes(query)) ||
      (tp.diagnosis && tp.diagnosis.toLowerCase().includes(query)) ||
      patientName.includes(query) ||
      (tp.id && tp.id.toString() === query)
    );
  });
}

// Global search across all entities
function globalSearch(query) {
  if (!query || query.trim() === '') {
    return { patients: [], treatments: [], appointments: [] };
  }
  
  return {
    patients: searchPatients(query).slice(0, 5),
    treatments: searchTreatments(query).slice(0, 5),
    appointments: []
  };
}

// Debounce function for search
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = function() {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}


// Keyboard Shortcuts
document.addEventListener('keydown', function(e) {
  // Alt + shortcuts
  if (e.altKey) {
    switch(e.key) {
      case 'h': // Alt+H: Home/Dashboard
        e.preventDefault();
        window.location.hash = state.currentUser.role === 'doctor' ? '#doctors-section' : '#walkin';
        break;
      case 'p': // Alt+P: Patients
        e.preventDefault();
        window.location.hash = '#patients';
        break;
      case 'c': // Alt+C: Calendar
        e.preventDefault();
        window.location.hash = '#calendar';
        break;
      case 's': // Alt+S: Settings
        e.preventDefault();
        window.location.hash = '#settings';
        break;
      case 'l': // Alt+L: Logout
        e.preventDefault();
        if (confirm('Are you sure you want to logout?')) {
          logout();
        }
        break;
    }
  }
  
  // Escape key: Close modals
  if (e.key === 'Escape') {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
      modal.style.display = 'none';
    });
  }
});

// Show keyboard shortcuts help
function showKeyboardShortcuts() {
  const shortcuts = [
    { keys: 'Alt + H', action: 'Go to Home/Dashboard' },
    { keys: 'Alt + P', action: 'Go to Patients' },
    { keys: 'Alt + C', action: 'Go to Calendar' },
    { keys: 'Alt + S', action: 'Go to Settings' },
    { keys: 'Alt + L', action: 'Logout' },
    { keys: 'Esc', action: 'Close modals' }
  ];
  
  let html = '<div style="padding:20px;">';
  html += '<h2 style="margin-top:0;">‚å®Ô∏è Keyboard Shortcuts</h2>';
  html += '<table style="width:100%;"><tr><th>Keys</th><th>Action</th></tr>';
  shortcuts.forEach(function(s) {
    html += '<tr><td><code style="background:#f1f5f9;padding:4px 8px;border-radius:4px;">' + 
            s.keys + '</code></td><td>' + s.action + '</td></tr>';
  });
  html += '</table></div>';
  
  showModal('Keyboard Shortcuts', html);
}


// Loading Indicators & UI Feedback

// Show loading overlay
function showLoading(message) {
  message = message || 'Loading...';
  
  let loader = document.getElementById('global-loader');
  if (!loader) {
    loader = document.createElement('div');
    loader.id = 'global-loader';
    loader.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    `;
    
    loader.innerHTML = `
      <div style="background: white; padding: 30px 50px; border-radius: 12px; text-align: center;">
        <div class="spinner" style="margin: 0 auto 15px; width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <div style="font-size: 16px; font-weight: 600; color: #1e293b;">${message}</div>
      </div>
    `;
    
    document.body.appendChild(loader);
    
    // Add spinner animation if not exists
    if (!document.getElementById('spinner-animation')) {
      const style = document.createElement('style');
      style.id = 'spinner-animation';
      style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
      document.head.appendChild(style);
    }
  }
  
  loader.style.display = 'flex';
}

// Hide loading overlay
function hideLoading() {
  const loader = document.getElementById('global-loader');
  if (loader) {
    loader.style.display = 'none';
  }
}

// Progress bar for operations
function showProgress(percent, message) {
  let progress = document.getElementById('global-progress');
  if (!progress) {
    progress = document.createElement('div');
    progress.id = 'global-progress';
    progress.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 99998;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
    `;
    
    progress.innerHTML = `
      <div id="progress-message" style="font-size: 14px; margin-bottom: 8px; color: #64748b;"></div>
      <div style="width: 100%; background: #e2e8f0; border-radius: 10px; overflow: hidden;">
        <div id="progress-bar" style="height: 8px; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease;"></div>
      </div>
    `;
    
    document.body.appendChild(progress);
  }
  
  document.getElementById('progress-message').textContent = message || 'Processing...';
  document.getElementById('progress-bar').style.width = percent + '%';
  progress.style.display = 'block';
  
  if (percent >= 100) {
    setTimeout(function() {
      progress.style.display = 'none';
    }, 500);
  }
}


// Data Backup & Restore System

// Backup all data
function backupAllData() {
  showLoading('Creating backup...');
  
  try {
    const backup = {
      version: '2.0',
      timestamp: new Date().toISOString(),
      data: {
        patients: state.patients,
        doctors: state.doctors,
        treatments: state.treatments,
        medicines: state.medicines,
        treatmentPlans: state.treatmentPlans,
        doctorQueue: state.doctorQueue,
        chairs: state.chairs,
        appointments: state.appointments || [],
        bills: state.bills || [],
        treatmentMappings: state.treatmentMappings || {}
      }
    };
    
    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'aura-dental-backup-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    
    URL.revokeObjectURL(url);
    hideLoading();
    showNotification('‚úÖ Backup created successfully!', 'success');
    
  } catch (error) {
    hideLoading();
    showNotification('‚ùå Backup failed: ' + error.message, 'error');
  }
}

// Restore from backup
function restoreFromBackup() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    showLoading('Restoring backup...');
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const backup = JSON.parse(event.target.result);
        
        if (!backup.version || !backup.data) {
          throw new Error('Invalid backup file');
        }
        
        // Restore data
        state.patients = backup.data.patients || [];
        state.doctors = backup.data.doctors || [];
        state.treatments = backup.data.treatments || [];
        state.medicines = backup.data.medicines || [];
        state.treatmentPlans = backup.data.treatmentPlans || [];
        state.doctorQueue = backup.data.doctorQueue || [];
        state.chairs = backup.data.chairs || [];
        state.appointments = backup.data.appointments || [];
        state.bills = backup.data.bills || [];
        state.treatmentMappings = backup.data.treatmentMappings || {};
        
        // Save to localStorage
        DataStore.save('patients', state.patients);
        DataStore.save('doctors', state.doctors);
        DataStore.save('treatments', state.treatments);
        DataStore.save('medicines', state.medicines);
        DataStore.save('treatmentPlans', state.treatmentPlans);
        DataStore.save('doctorQueue', state.doctorQueue);
        DataStore.save('chairs', state.chairs);
        DataStore.save('appointments', state.appointments);
        DataStore.save('bills', state.bills);
        DataStore.save('treatmentMappings', state.treatmentMappings);
        
        hideLoading();
        showNotification('‚úÖ Backup restored successfully! Reloading...', 'success');
        
        setTimeout(function() {
          location.reload();
        }, 1500);
        
      } catch (error) {
        hideLoading();
        showNotification('‚ùå Restore failed: ' + error.message, 'error');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

// Auto-backup reminder
function checkAutoBackup() {
  const lastBackup = localStorage.getItem('lastBackupDate');
  const today = new Date().toDateString();
  
  if (lastBackup !== today) {
    const daysSinceBackup = lastBackup ? 
      Math.floor((new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24)) : 999;
    
    if (daysSinceBackup >= 7) {
      showNotification('‚ö†Ô∏è Backup reminder: Last backup was ' + daysSinceBackup + ' days ago', 'warning', 5000);
    }
  }
}

// Mark backup as done
function markBackupDone() {
  localStorage.setItem('lastBackupDate', new Date().toDateString());
}

// Check on load
if (typeof state !== 'undefined' && state.currentUser) {
  setTimeout(checkAutoBackup, 3000);
}


// Performance Optimizations

// Lazy load images
function lazyLoadImages() {
  const images = document.querySelectorAll('img[data-src]');
  const imageObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.removeAttribute('data-src');
        imageObserver.unobserve(img);
      }
    });
  });
  
  images.forEach(function(img) {
    imageObserver.observe(img);
  });
}



// Cache DOM queries
const DOMCache = {
  cache: {},
  get: function(selector) {
    if (!this.cache[selector]) {
      this.cache[selector] = document.querySelector(selector);
    }
    return this.cache[selector];
  },
  clear: function() {
    this.cache = {};
  }
};

</script>

<!-- Socket.io Client (only works when running with Node.js server) -->
<script>
// Gracefully load socket.io - won\'t break if server not running
(function() {
  const script = document.createElement('script');
  script.src = '/socket.io/socket.io.js';
  script.onload = function() {
    console.log('‚úÖ Socket.io client loaded');
    if (typeof initSocketIO === 'function') initSocketIO();
  };
  script.onerror = function() {
    console.log('‚ÑπÔ∏è Running in offline mode (no server)');
  };
  document.head.appendChild(script);
})();
</script>
<script>
if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
  window.addEventListener('load', function () {
    navigator.serviceWorker.register('/service-worker.js').catch(err => {
      console.log('Service Worker registration failed:', err);
    });
  });
}
</script>

<script>

(function() {
  function initMobileMenu() {
    if (document.getElementById('mobile-overlay')) return;
    var overlay = document.createElement('div');
    overlay.id = 'mobile-overlay';
    overlay.className = 'mobile-overlay';
    overlay.onclick = closeMobileMenu;
    document.body.appendChild(overlay);
    injectHamburger();
  }
  function injectHamburger() {
    var header = document.querySelector('.header');
    if (!header || document.getElementById('mobile-menu-btn')) return;
    var btn = document.createElement('button');
    btn.id = 'mobile-menu-btn';
    btn.className = 'mobile-menu-btn';
    btn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>';
    btn.onclick = toggleMobileMenu;
    header.insertBefore(btn, header.firstChild);
  }
  window.toggleMobileMenu = function() {
    var s = document.querySelector('.sidebar');
    var o = document.getElementById('mobile-overlay');
    if (s) s.classList.toggle('mobile-open');
    if (o) o.classList.toggle('active');
  };
  window.closeMobileMenu = function() {
    var s = document.querySelector('.sidebar');
    var o = document.getElementById('mobile-overlay');
    if (s) s.classList.remove('mobile-open');
    if (o) o.classList.remove('active');
  };
  document.addEventListener('click', function(e) {
    if (window.innerWidth <= 768 && e.target.closest && e.target.closest('.sidebar-item')) {
      setTimeout(window.closeMobileMenu, 150);
    }
  });
  var _orig = window.renderDashboard;
  function afterRender() { setTimeout(initMobileMenu, 100); }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { setTimeout(initMobileMenu, 500); });
  } else {
    setTimeout(initMobileMenu, 500);
  }
  // Re-inject hamburger after any hash change
  window.addEventListener('hashchange', function() { setTimeout(injectHamburger, 300); });
})();

</script>

<script>

(function() {
  function initMobileMenu() {
    if (document.getElementById('mobile-overlay')) return;
    var overlay = document.createElement('div');
    overlay.id = 'mobile-overlay';
    overlay.className = 'mobile-overlay';
    overlay.onclick = closeMobileMenu;
    document.body.appendChild(overlay);
    injectHamburger();
  }
  function injectHamburger() {
    var header = document.querySelector('.header');
    if (!header || document.getElementById('mobile-menu-btn')) return;
    var btn = document.createElement('button');
    btn.id = 'mobile-menu-btn';
    btn.className = 'mobile-menu-btn';
    btn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>';
    btn.onclick = toggleMobileMenu;
    header.insertBefore(btn, header.firstChild);
  }
  window.toggleMobileMenu = function() {
    var s = document.querySelector('.sidebar');
    var o = document.getElementById('mobile-overlay');
    if (s) s.classList.toggle('mobile-open');
    if (o) o.classList.toggle('active');
  };
  window.closeMobileMenu = function() {
    var s = document.querySelector('.sidebar');
    var o = document.getElementById('mobile-overlay');
    if (s) s.classList.remove('mobile-open');
    if (o) o.classList.remove('active');
  };
  document.addEventListener('click', function(e) {
    if (window.innerWidth <= 768 && e.target.closest && e.target.closest('.sidebar-item')) {
      setTimeout(window.closeMobileMenu, 150);
    }
  });
  var _orig = window.renderDashboard;
  function afterRender() { setTimeout(initMobileMenu, 100); }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { setTimeout(initMobileMenu, 500); });
  } else {
    setTimeout(initMobileMenu, 500);
  }
  // Re-inject hamburger after any hash change
  window.addEventListener('hashchange', function() { setTimeout(injectHamburger, 300); });
})();

</script>

<script>

(function() {
  function initMobileMenu() {
    if (document.getElementById('mobile-overlay')) return;
    var overlay = document.createElement('div');
    overlay.id = 'mobile-overlay';
    overlay.className = 'mobile-overlay';
    overlay.onclick = closeMobileMenu;
    document.body.appendChild(overlay);
    injectHamburger();
  }
  function injectHamburger() {
    var header = document.querySelector('.header');
    if (!header || document.getElementById('mobile-menu-btn')) return;
    var btn = document.createElement('button');
    btn.id = 'mobile-menu-btn';
    btn.className = 'mobile-menu-btn';
    btn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>';
    btn.onclick = toggleMobileMenu;
    header.insertBefore(btn, header.firstChild);
  }
  window.toggleMobileMenu = function() {
    var s = document.querySelector('.sidebar');
    var o = document.getElementById('mobile-overlay');
    if (s) s.classList.toggle('mobile-open');
    if (o) o.classList.toggle('active');
  };
  window.closeMobileMenu = function() {
    var s = document.querySelector('.sidebar');
    var o = document.getElementById('mobile-overlay');
    if (s) s.classList.remove('mobile-open');
    if (o) o.classList.remove('active');
  };
  document.addEventListener('click', function(e) {
    if (window.innerWidth <= 768 && e.target.closest && e.target.closest('.sidebar-item')) {
      setTimeout(window.closeMobileMenu, 150);
    }
  });
  var _orig = window.renderDashboard;
  function afterRender() { setTimeout(initMobileMenu, 100); }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { setTimeout(initMobileMenu, 500); });
  } else {
    setTimeout(initMobileMenu, 500);
  }
  // Re-inject hamburger after any hash change
  window.addEventListener('hashchange', function() { setTimeout(injectHamburger, 300); });
})();

</script>

<script>
(function() {
  function fixMobileLayout() {
    var isMobile = window.innerWidth <= 768;
    var main = document.getElementById('main-content') || document.querySelector('.main-content');
    if (main) {
      main.style.marginLeft = isMobile ? '0' : '280px';
      main.style.width = isMobile ? '100%' : 'calc(100% - 280px)';
    }
    var sidebar = document.querySelector('.sidebar');
    if (sidebar && isMobile) {
      sidebar.style.transform = sidebar.classList.contains('mobile-open') ? 'translateX(0)' : 'translateX(-100%)';
    } else if (sidebar) {
      sidebar.style.transform = '';
    }
  }

  function initMobile() {
    fixMobileLayout();
    if (document.getElementById('mobile-overlay')) return;
    // Add overlay
    var overlay = document.createElement('div');
    overlay.id = 'mobile-overlay';
    overlay.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999;';
    overlay.onclick = closeMobileMenu;
    document.body.appendChild(overlay);
    injectHamburger();
  }

  function injectHamburger() {
    if (document.getElementById('mobile-menu-btn')) return;
    var header = document.querySelector('.header');
    if (!header) return;
    var btn = document.createElement('button');
    btn.id = 'mobile-menu-btn';
    btn.style.cssText = 'display:' + (window.innerWidth<=768?'flex':'none') + ';align-items:center;justify-content:center;width:40px;height:40px;background:none;border:none;cursor:pointer;border-radius:8px;margin-right:8px;flex-shrink:0;';
    btn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>';
    btn.onclick = toggleMobileMenu;
    header.insertBefore(btn, header.firstChild);
  }

  window.toggleMobileMenu = function() {
    var s = document.querySelector('.sidebar');
    var o = document.getElementById('mobile-overlay');
    if (!s) return;
    var isOpen = s.classList.toggle('mobile-open');
    s.style.transform = isOpen ? 'translateX(0)' : 'translateX(-100%)';
    if (o) o.style.display = isOpen ? 'block' : 'none';
  };

  window.closeMobileMenu = function() {
    var s = document.querySelector('.sidebar');
    var o = document.getElementById('mobile-overlay');
    if (s) { s.classList.remove('mobile-open'); s.style.transform = 'translateX(-100%)'; }
    if (o) o.style.display = 'none';
  };

  // Close on sidebar item click
  document.addEventListener('click', function(e) {
    if (window.innerWidth <= 768 && e.target.closest && e.target.closest('.sidebar-item')) {
      setTimeout(window.closeMobileMenu, 150);
    }
  });

  // Re-run on resize
  window.addEventListener('resize', fixMobileLayout);

  // Re-run after hash changes (page re-renders)
  window.addEventListener('hashchange', function() {
    setTimeout(function() { initMobile(); fixMobileLayout(); }, 400);
  });

  // Initial run
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { setTimeout(initMobile, 300); });
  } else {
    setTimeout(initMobile, 300);
  }
})();
</script>

<script>
(function() {
  function fixLayout() {
    var isMobile = window.innerWidth <= 768;
    var main = document.getElementById('main-content') || document.querySelector('.main-content');
    if (main) {
      main.style.marginLeft = isMobile ? '0' : '280px';
      main.style.width = isMobile ? '100%' : '';
    }
    var btn = document.getElementById('mobile-menu-btn');
    if (btn) btn.style.display = isMobile ? 'flex' : 'none';
  }
  function init() {
    fixLayout();
    if (document.getElementById('mobile-overlay')) { fixLayout(); return; }
    var overlay = document.createElement('div');
    overlay.id = 'mobile-overlay';
    overlay.className = 'mobile-overlay';
    overlay.onclick = function() { closeSidebar(); };
    document.body.appendChild(overlay);
    injectBtn();
  }
  function injectBtn() {
    if (document.getElementById('mobile-menu-btn')) return;
    var header = document.querySelector('.header');
    if (!header) return;
    var btn = document.createElement('button');
    btn.id = 'mobile-menu-btn';
    btn.className = 'mobile-menu-btn';
    btn.style.display = window.innerWidth <= 768 ? 'flex' : 'none';
    btn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>';
    btn.onclick = toggleSidebar;
    header.insertBefore(btn, header.firstChild);
  }
  function toggleSidebar() {
    var s = document.querySelector('.sidebar');
    var o = document.getElementById('mobile-overlay');
    if (!s) return;
    var open = s.classList.toggle('mobile-open');
    if (o) o.classList.toggle('active', open);
  }
  function closeSidebar() {
    var s = document.querySelector('.sidebar');
    var o = document.getElementById('mobile-overlay');
    if (s) s.classList.remove('mobile-open');
    if (o) o.classList.remove('active');
  }
  document.addEventListener('click', function(e) {
    if (window.innerWidth <= 768 && e.target.closest && e.target.closest('.sidebar-item')) {
      setTimeout(closeSidebar, 150);
    }
  });
  window.addEventListener('resize', fixLayout);
  window.addEventListener('hashchange', function() { setTimeout(function(){ init(); fixLayout(); }, 400); });
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { setTimeout(init, 400); });
  } else {
    setTimeout(init, 400);
  }
})();
</script>
</body>
</html>

<style>
/* ===== FORCE DESKTOP LAYOUT ON MOBILE ===== */

@media (max-width: 768px) {

  .sidebar {
    position: fixed !important;
    left: 0 !important;
    transform: none !important;
    width: 250px !important;
  }

  .main-wrapper {
    
  }

  .mobile-overlay {
    display: none !important;
  }

  .mobile-menu-btn {
    display: none !important;
  }

}
</style>


<style>
/* ===== PERMANENT DESKTOP MODE (ALL DEVICES) ===== */

.sidebar {
  position: fixed !important;
  left: 0 !important;
  transform: none !important;
  width: 250px !important;
}

.main-wrapper {
  
}

.mobile-overlay,
.mobile-menu-btn {
  display: none !important;
}

@media (max-width: 768px) {
  .sidebar {
    transform: none !important;
  }
}
</style>


<style>
/* ===== DESKTOP LAYOUT WITH MOBILE SCROLL ===== */

body {
  overflow-x: auto !important;
}

.app-layout {
  min-width: 1200px !important;
}

.sidebar {
  position: fixed !important;
  left: 0 !important;
  transform: none !important;
  width: 250px !important;
}

.mobile-overlay,
.mobile-menu-btn {
  display: none !important;
}

</style>


<style>
/* ===== TRUE DESKTOP MODE WITH SCROLL ===== */

html, body {
  width: 100% !important;
  overflow-x: auto !important;
}

.app-layout {
  min-width: 1300px !important;
}

.main-wrapper {
  min-width: 1050px !important;
}

.sidebar {
  position: fixed !important;
  left: 0 !important;
  width: 250px !important;
  transform: none !important;
}

.mobile-overlay,
.mobile-menu-btn {
  display: none !important;
}

</style>


<style>
/* ============================= */
/* TRUE RESPONSIVE MOBILE UI */
/* ============================= */

@media (max-width: 768px) {

  .sidebar {
    position: relative !important;
    width: 100% !important;
    height: auto !important;
    display: flex !important;
    overflow-x: auto !important;
    flex-direction: row !important;
  }

  .sidebar-menu {
    display: flex !important;
    flex-direction: row !important;
    gap: 8px;
  }

  .sidebar-item {
    flex: 0 0 auto;
    padding: 10px 14px !important;
    font-size: 14px !important;
  }

  .main-wrapper {
    margin-left: 0 !important;
  }

  .content-area {
    padding: 16px !important;
  }

  .page-title {
    font-size: 22px !important;
  }

  .data-table {
    overflow-x: auto !important;
  }

}
</style>


<style>
/* ===== FIX MOBILE TOP NAVIGATION ===== */

@media (max-width: 768px) {

  .sidebar {
    width: 100% !important;
    overflow-x: auto !important;
    white-space: nowrap !important;
  }

  .sidebar-menu {
    display: inline-flex !important;
    flex-wrap: nowrap !important;
  }

  .sidebar-item {
    display: inline-flex !important;
    flex: 0 0 auto !important;
    white-space: nowrap !important;
  }

}
</style>

